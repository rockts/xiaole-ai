# 文档检索与细节问答问题 (2025-11-24)

## 问题描述
用户上传了包含详细硬件信息的文档 `电脑硬件信息.txt`，但询问具体细节（如 "CPU型号"）时，小乐无法回答，回复不知道。

## 现象分析
1.  **文件已上传**：文件确实存在于 `backend/uploads/` 目录下（带时间戳前缀）。
2.  **记忆已存在**：数据库中有 `document:电脑硬件信息.txt` 的记忆，包含摘要。
3.  **意图识别不足**：
    *   意图识别阶段虽然注入了文档摘要（前150字），但摘要可能不包含用户询问的具体细节（如CPU型号可能在文档后半部分）。
    *   Agent 看到摘要里没有 CPU 信息，可能错误地判断为“文档里没有”，从而决定不调用 `file_tool` 读取全文。
    *   或者 Agent 即使调用了 `file_tool`，可能因为文件名匹配问题（已修复模糊匹配）或读取内容过长被截断而失败。

## 已尝试的修复
1.  **修复记忆检索**：在 `_think_with_context` 中恢复了被删除的文档记忆检索逻辑。
2.  **增强文件工具**：升级 `file_tool` 支持 PDF/DOCX 读取，并支持在 `uploads` 目录进行模糊文件名匹配（忽略时间戳）。
3.  **优化意图提示词**：在 `_analyze_intent` 中增加了文档摘要的预览长度（100->150字），并明确指示“如果询问细节必须调用 file 工具”。

## 依然存在的问题
尽管做了上述修复，用户反馈依然无法回答 CPU 型号。这表明：
1.  **摘要长度不足**：150字的摘要对于长文档来说太短，关键信息（如CPU型号）可能未被包含。
2.  **检索策略单一**：目前仅依赖“摘要”来判断是否需要读取全文，这在逻辑上是有缺陷的。如果摘要没提到 CPU，Agent 应该**更倾向于**去查全文，而不是认为没有。
3.  **工具调用门槛**：Agent 可能过于自信地依赖记忆中的摘要，而吝啬于调用工具。

## 待优化方案
1.  **RAG (检索增强生成) 引入**：对于文档问答，不能仅依赖简短摘要。需要引入向量搜索（Vector Search）或更高级的分块检索机制，将文档切片存入向量数据库。
2.  **强制工具调用**：当用户明确询问文档内容时，如果记忆中没有确切答案，应强制调用 `file_tool` 读取全文（或搜索全文），而不是直接回答不知道。
3.  **多阶段检索**：
    *   阶段1：检查摘要。
    *   阶段2：如果摘要无果，调用 `file_tool` 的 `search` 功能或 `read` 功能读取全文。
    *   阶段3：基于全文回答。

## 记录状态
- **状态**: 待解决 (Pending Optimization)
- **优先级**: 高
- **相关文件**: `backend/agent.py`, `backend/document_summarizer.py`
