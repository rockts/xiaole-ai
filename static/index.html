<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¹ AI ç®¡å®¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ä¼šè¯ä¿¡æ¯æ  */
        .session-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .session-title-display {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* èŠå¤©ç•Œé¢ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Markdown æ ·å¼ */
        .message.assistant .message-content p {
            margin: 0.5em 0;
        }

        .message.assistant .message-content strong {
            color: #667eea;
            font-weight: bold;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 0.5em 0;
            padding-left: 20px;
        }

        .message.assistant .message-content li {
            margin: 0.3em 0;
        }

        .message.assistant .message-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message.assistant .message-content pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .message.assistant .message-content blockquote {
            border-left: 3px solid #667eea;
            padding-left: 10px;
            margin: 0.5em 0;
            color: #666;
        }

        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin: 0.8em 0 0.4em 0;
            color: #667eea;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #messageInput:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }

        #messageInput:focus:before {
            content: none;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ä¼šè¯åˆ—è¡¨ */
        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .session-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .session-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .session-item.active {
            border-left: 4px solid #667eea;
            background: #f0f4ff;
        }

        .session-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .session-time {
            font-size: 12px;
            color: #999;
        }

        /* è®°å¿†æŸ¥çœ‹ */
        .memory-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .memory-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .memory-content {
            color: #333;
            margin-bottom: 8px;
        }

        .memory-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
        }
    </style>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            ğŸ¤– å°ä¹ AI ç®¡å®¶
            <span style="font-size: 12px; opacity: 0.8; margin-left: 10px;">v0.2.0</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ èŠå¤©</div>
            <div class="tab" onclick="switchTab('sessions')">ğŸ“‹ ä¼šè¯</div>
            <div class="tab" onclick="switchTab('memory')">ğŸ§  è®°å¿†</div>
            <div class="tab" onclick="switchTab('analytics')">ğŸ“Š è¡Œä¸ºåˆ†æ</div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div id="chat" class="tab-content active">
            <div id="sessionInfo" class="session-info" style="display: none;">
                <div class="session-title-display">ğŸ’¬ <span id="currentSessionTitle"></span></div>
            </div>
            <div class="chat-container" id="chatContainer"></div>
            <div class="input-container">
                <div id="messageInput" contenteditable="true" data-placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œï¼‰..."
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; min-height: 40px; max-height: 120px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">
                </div>
                <button onclick="sendMessageFromDiv()" id="sendBtn">å‘é€</button>
                <button onclick="newChat()">æ–°å¯¹è¯</button>
            </div>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div id="sessions" class="tab-content">
            <div class="sessions-list" id="sessionsList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è®°å¿†æŸ¥çœ‹ -->
        <div id="memory" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ“Š è®°å¿†ç»Ÿè®¡
                        <span style="font-size: 12px; color: #667eea; font-weight: normal;">
                            v0.2.0 - ğŸ§  æ”¯æŒè¯­ä¹‰æœç´¢
                        </span>
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢è®°å¿†ï¼ˆæ”¯æŒè¯­ä¹‰ç†è§£ï¼‰..."
                        style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                    <button onclick="searchMemories()">ğŸ” å…³é”®è¯</button>
                    <button onclick="semanticSearch()" title="æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œå¦‚'å¤šå¤§å¹´çºª'">ğŸ§  è¯­ä¹‰</button>
                    <button onclick="loadRecentMemories()">ğŸ“‹ å…¨éƒ¨</button>
                </div>

                <div id="memoryList"></div>
            </div>
        </div>

        <!-- è¡Œä¸ºåˆ†æ -->
        <div id="analytics" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ“Š ç”¨æˆ·è¡Œä¸ºåˆ†æ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.3.0
                            Learningå±‚</span></h3>
                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadBehaviorAnalytics()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„
                            åˆ·æ–°æ•°æ®</button>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()"
                                style="cursor: pointer;">
                            <span>è‡ªåŠ¨åˆ·æ–° (30ç§’)</span>
                        </label>
                        <span id="refreshStatus" style="font-size: 12px; color: #999;"></span>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">â° æ´»è·ƒæ—¶é—´åˆ†å¸ƒ</h4>
                        <div id="activityPattern"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ’¬ è¯é¢˜åå¥½</h4>
                        <div id="topicPreferences"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“ˆ å¯¹è¯ç»Ÿè®¡</h4>
                        <div id="behaviorStats"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #ff6b6b;">âš ï¸ è®°å¿†å†²çªæ£€æµ‹</h4>
                        <div id="conflictDetection"
                            style="background: #fff5f5; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #ff6b6b;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #764ba2;">ğŸ’¡ ä¸»åŠ¨é—®ç­”å†å²</h4>
                        <div id="proactiveQA"
                            style="background: #f8f4ff; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #764ba2;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #10b981;">ğŸ§  å­¦ä¹ æ¨¡å¼</h4>
                        <div id="learningPatterns"
                            style="background: #f0fdf4; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #10b981;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        const API_BASE = '';

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'sessions') loadSessions();
            if (tabName === 'memory') loadMemoryStats();
            if (tabName === 'analytics') {
                // è‡ªåŠ¨åŠ è½½è¡Œä¸ºåˆ†ææ•°æ®
                loadBehaviorAnalytics();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆä»contenteditable divï¼‰
        async function sendMessageFromDiv() {
            const input = document.getElementById('messageInput');
            const message = input.textContent.trim();
            if (!message) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.contentEditable = 'false';

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.textContent = '';

            try {
                const url = currentSessionId
                    ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}`
                    : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}`;

                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                addMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆä¿ç•™æ—§å‡½æ•°å…¼å®¹æ€§ï¼‰
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            // æ£€æŸ¥æ˜¯å¦æ˜¯contenteditable
            if (input.contentEditable === 'true') {
                sendMessageFromDiv();
                return;
            }

            const message = input.value.trim();
            if (!message) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';
            // é‡ç½®textareaé«˜åº¦
            input.style.height = 'auto';

            try {
                const url = currentSessionId
                    ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}`
                    : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}`;

                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                addMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ï¼Œä½¿ç”¨Markdownæ¸²æŸ“ï¼›ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
            if (role === 'assistant') {
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ–°å¯¹è¯
        function newChat() {
            currentSessionId = null;
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('messageInput').focus();
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions() {
            const container = document.getElementById('sessionsList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/sessions`);
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    container.innerHTML = data.sessions.map(session => `
                        <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}"
                             onclick="loadSession('${session.session_id}')">
                            <div class="session-title">${session.title}</div>
                            <div class="session-time">
                                åˆ›å»º: ${session.created_at} | æ›´æ–°: ${session.updated_at}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">è¿˜æ²¡æœ‰ä¼šè¯è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æŒ‡å®šä¼šè¯
        async function loadSession(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                const data = await response.json();

                currentSessionId = sessionId;
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';

                // æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
                const sessionInfo = document.getElementById('sessionInfo');
                const titleSpan = document.getElementById('currentSessionTitle');
                titleSpan.textContent = data.title;
                sessionInfo.style.display = 'block';

                data.history.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });

                switchTab('chat');
            } catch (error) {
                alert('åŠ è½½ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½è®°å¿†ç»Ÿè®¡
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats`);
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                const tags = data.by_tag || {};

                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${data.total}</div>
                        <div class="stat-label">æ€»è®°å¿†æ•°</div>
                    </div>
                    ${Object.entries(tags).map(([tag, count]) => `
                        <div class="stat-item">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${tag}</div>
                        </div>
                    `).join('')}
                `;

                loadRecentMemories();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML =
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æœ€è¿‘è®°å¿†
        async function loadRecentMemories() {
            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/recent?hours=24&limit=20`);
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰è®°å¿†è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æœç´¢è®°å¿†ï¼ˆå…³é”®è¯ï¼‰
        async function searchMemories() {
            const keywords = document.getElementById('searchInput').value.trim();
            if (!keywords) {
                loadRecentMemories();
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">å…³é”®è¯æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/search?keywords=${encodeURIComponent(keywords)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¯­ä¹‰æœç´¢è®°å¿†
        async function semanticSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">ğŸ§  è¯­ä¹‰æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/semantic?query=${encodeURIComponent(query)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                                <span>ğŸ“Š ç›¸ä¼¼åº¦: ${(mem.score * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('refreshStatus');

            if (checkbox.checked) {
                // å¯ç”¨è‡ªåŠ¨åˆ·æ–°
                loadBehaviorAnalytics();
                lastRefreshTime = Date.now();
                updateRefreshStatus();

                autoRefreshInterval = setInterval(() => {
                    loadBehaviorAnalytics();
                    lastRefreshTime = Date.now();
                    updateRefreshStatus();
                }, 30000); // 30ç§’

                statusSpan.style.color = '#51cf66';
                console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨ (30ç§’)');
            } else {
                // ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = '';
                console.log('â¸ï¸ è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
            }
        }

        // æ›´æ–°åˆ·æ–°çŠ¶æ€
        function updateRefreshStatus() {
            const statusSpan = document.getElementById('refreshStatus');
            if (lastRefreshTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - lastRefreshTime) / 1000);
                statusSpan.textContent = `ä¸Šæ¬¡åˆ·æ–°: ${elapsed}ç§’å‰`;
            }
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€æ˜¾ç¤º
        setInterval(() => {
            if (autoRefreshInterval && lastRefreshTime) {
                updateRefreshStatus();
            }
        }, 1000);

        // åŠ è½½è¡Œä¸ºåˆ†ææ•°æ®
        async function loadBehaviorAnalytics() {
            const userId = 'default_user';

            // åŠ è½½æ´»è·ƒæ—¶é—´åˆ†å¸ƒ
            loadActivityPattern(userId);

            // åŠ è½½è¯é¢˜åå¥½
            loadTopicPreferences(userId);

            // åŠ è½½å¯¹è¯ç»Ÿè®¡
            loadBehaviorStats(userId);

            // åŠ è½½å†²çªæ£€æµ‹
            loadConflictDetection();

            // åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
            loadProactiveQA(userId);

            // åŠ è½½å­¦ä¹ æ¨¡å¼
            loadLearningPatterns(userId);
        }

        // åŠ è½½æ´»è·ƒæ—¶é—´åˆ†å¸ƒ
        async function loadActivityPattern(userId) {
            const container = document.getElementById('activityPattern');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/activity?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

                // å°æ—¶åˆ†å¸ƒ
                if (data.hourly_distribution && Object.keys(data.hourly_distribution).length > 0) {
                    html += '<div><strong>ğŸ“… æ´»è·ƒæ—¶æ®µï¼ˆå°æ—¶ï¼‰</strong><div style="margin-top: 8px;">';
                    const sortedHours = Object.entries(data.hourly_distribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    sortedHours.forEach(([hour, count]) => {
                        html += `<div style="margin: 5px 0;">ğŸ• ${hour}:00 - ${count}æ¬¡</div>`;
                    });
                    html += '</div></div>';
                }

                // æ˜ŸæœŸåˆ†å¸ƒ
                if (data.daily_distribution && Object.keys(data.daily_distribution).length > 0) {
                    const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                    html += '<div><strong>ğŸ“† æ´»è·ƒæ˜ŸæœŸ</strong><div style="margin-top: 8px;">';
                    const sortedDays = Object.entries(data.daily_distribution).sort((a, b) => b[1] - a[1]);
                    sortedDays.forEach(([day, count]) => {
                        html += `<div style="margin: 5px 0;">${weekdays[day] || 'å‘¨' + day} - ${count}æ¬¡</div>`;
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html || '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½è¯é¢˜åå¥½
        async function loadTopicPreferences(userId) {
            const container = document.getElementById('topicPreferences');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/topics?user_id=${userId}`);
                const data = await response.json();

                if (data.error || !data.top_topics || data.top_topics.length === 0) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— è¯é¢˜æ•°æ®</div>';
                    return;
                }

                let html = '<div>';
                data.top_topics.slice(0, 10).forEach((item, index) => {
                    const [topic, count] = item;
                    html += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${index + 1}. ğŸ·ï¸ ${topic}</span>
                            <span style="color: #667eea; font-weight: bold;">${count}æ¬¡</span>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å¯¹è¯ç»Ÿè®¡
        async function loadBehaviorStats(userId) {
            const container = document.getElementById('behaviorStats');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/behavior?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
                    return;
                }

                // ä¿®å¤ï¼šä½¿ç”¨ conversation_stats è€Œä¸æ˜¯ stats
                const stats = data.conversation_stats || {};
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_sessions || 0}</div>
                            <div style="color: #999; margin-top: 5px;">æ€»ä¼šè¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_messages || 0}</div>
                            <div style="color: #999; margin-top: 5px;">æ€»æ¶ˆæ¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_messages_per_session || 0}</div>
                            <div style="color: #999; margin-top: 5px;">å¹³å‡æ¶ˆæ¯/ä¼šè¯</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_message_length || 0}</div>
                            <div style="color: #999; margin-top: 5px;">å¹³å‡æ¶ˆæ¯é•¿åº¦</div>
                        </div>
                    </div>
                `;

                if (stats.last_session_time) {
                    html += `<div style="margin-top: 15px; text-align: center; color: #666;">
                        æœ€åæ´»è·ƒ: ${new Date(stats.last_session_time).toLocaleString('zh-CN')}
                    </div>`;
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å†²çªæ£€æµ‹
        async function loadConflictDetection() {
            const container = document.getElementById('conflictDetection');
            container.innerHTML = '<div class="loading">æ£€æµ‹ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/conflicts`);
                const data = await response.json();

                if (data.conflicts && data.conflicts.length > 0) {
                    let html = `<div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">
                        âš ï¸ å‘ç° ${data.conflicts.length} ç»„å†²çªè®°å¿†
                    </div>`;

                    data.conflicts.forEach((conflict, index) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #ff6b6b; border-radius: 5px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">å†²çª ${index + 1}: ${conflict.type_cn}</div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    ğŸ“„ æ—§å€¼: ${conflict.old_value} - ${conflict.old_memory}
                                </div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    ğŸ“„ æ–°å€¼: ${conflict.new_value} - ${conflict.new_memory}
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 12px;">
                                    æ£€æµ‹æ—¶é—´: ${conflict.conflict_detected_at}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #51cf66; text-align: center;">âœ… æ²¡æœ‰å‘ç°å†²çªè®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
        async function loadProactiveQA(userId) {
            const container = document.getElementById('proactiveQA');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/proactive/history?user_id=${userId}&limit=10`);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    let html = `<div style="color: #764ba2; font-weight: bold; margin-bottom: 10px;">
                        ğŸ’¡ å…± ${data.total} æ¡è¿½é—®è®°å½•ï¼ˆæ˜¾ç¤ºæœ€è¿‘10æ¡ï¼‰
                    </div>`;

                    data.history.forEach((item, index) => {
                        const confidenceColor = item.confidence >= 70 ? '#51cf66' : item.confidence >= 50 ? '#ffd43b' : '#ff6b6b';
                        const askedBadge = item.followup_asked
                            ? '<span style="background: #51cf66; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">å·²è¿½é—®</span>'
                            : '<span style="background: #999; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">å¾…è¿½é—®</span>';

                        html += `
                            <div style="margin: 10px 0; padding: 12px; background: white; border-left: 3px solid #764ba2; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold;">è®°å½• ${index + 1}</span>
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        ${askedBadge}
                                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                            ç½®ä¿¡åº¦ ${item.confidence}%
                                        </span>
                                    </div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #f8f4ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">åŸå§‹é—®é¢˜:</div>
                                    <div>â“ ${item.original_question}</div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #e7f5ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">å»ºè®®è¿½é—®:</div>
                                    <div>ğŸ’¬ ${item.followup_question}</div>
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 11px;">
                                    åˆ›å»ºæ—¶é—´: ${new Date(item.created_at).toLocaleString('zh-CN')}
                                    ${item.asked_at ? ` | è¿½é—®æ—¶é—´: ${new Date(item.asked_at).toLocaleString('zh-CN')}` : ''}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— è¿½é—®è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å­¦ä¹ æ¨¡å¼
        async function loadLearningPatterns(userId) {
            const container = document.getElementById('learningPatterns');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // å¹¶è¡Œè·å–ä¸‰ä¸ªAPIæ•°æ®
                const [frequentRes, questionsRes, insightsRes] = await Promise.all([
                    fetch(`${API_BASE}/patterns/frequent?user_id=${userId}&limit=10`),
                    fetch(`${API_BASE}/patterns/common_questions?user_id=${userId}&limit=5`),
                    fetch(`${API_BASE}/patterns/insights?user_id=${userId}`)
                ]);

                const frequentData = await frequentRes.json();
                const questionsData = await questionsRes.json();
                const insightsData = await insightsRes.json();

                let html = '';

                // æ˜¾ç¤ºç»Ÿè®¡æ¦‚è§ˆ
                if (insightsData && insightsData.statistics) {
                    const stats = insightsData.statistics;
                    html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.total_patterns || 0}</div>
                        <div style="font-size: 12px; color: #999;">æ€»å­¦ä¹ æ¨¡å¼</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.frequent_words_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">é«˜é¢‘è¯æ±‡</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.common_questions_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">å¸¸è§é—®é¢˜</div>
                    </div>`;
                    html += `</div>`;
                }

                // æ˜¾ç¤ºé«˜é¢‘è¯
                if (frequentData.frequent_words && frequentData.frequent_words.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">ğŸ“ é«˜é¢‘è¯æ±‡ TOP10</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                    frequentData.frequent_words.forEach(item => {
                        const confidence = item.confidence || 50;
                        const bgColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#3b82f6' : '#6b7280';
                        html += `<span style="background: ${bgColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                            ${item.word} (${item.frequency}æ¬¡)
                        </span>`;
                    });

                    html += `</div></div>`;
                }

                // æ˜¾ç¤ºå¸¸è§é—®é¢˜åˆ†ç±»
                if (questionsData.common_questions && questionsData.common_questions.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">â“ å¸¸è§é—®é¢˜åˆ†ç±»</div>`;

                    questionsData.common_questions.forEach(item => {
                        const typeEmoji = {
                            'å¤©æ°”æŸ¥è¯¢': 'ğŸŒ¤ï¸',
                            'æ—¶é—´æ—¥æœŸ': 'â°',
                            'ä¸ªäººä¿¡æ¯': 'ğŸ‘¤',
                            'åŠŸèƒ½å’¨è¯¢': 'ğŸ”§',
                            'æ¨èå»ºè®®': 'ğŸ’¡',
                            'é—²èŠ': 'ğŸ’¬'
                        };

                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #10b981; border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${typeEmoji[item.category] || 'ğŸ“Œ'} ${item.category} 
                                <span style="color: #999; font-size: 12px; font-weight: normal;">(${item.frequency}æ¬¡)</span>
                            </div>`;

                        if (item.examples && item.examples.length > 0) {
                            html += `<div style="font-size: 12px; color: #666; margin-top: 5px;">`;
                            item.examples.slice(0, 2).forEach(example => {
                                html += `<div style="margin: 3px 0;">â€¢ ${example}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                }

                if (!html) {
                    html = '<div style="color: #999; text-align: center;">æš‚æ— å­¦ä¹ æ•°æ®ï¼Œå¤šèŠå‡ å¥è®©å°ä¹äº†è§£ä½ å§~</div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶èšç„¦è¾“å…¥æ¡†
        window.onload = () => {
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessageFromDiv();
                }
            });

            // æœç´¢æ¡†å›è½¦æœç´¢
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchMemories();
                    }
                });
            }
        };
    </script>
</body>

</html>