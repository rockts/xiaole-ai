<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¹ AI ç®¡å®¶ v0.4.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ä¼šè¯ä¿¡æ¯æ  */
        .session-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .session-title-display {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* èŠå¤©ç•Œé¢ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Markdown æ ·å¼ */
        .message.assistant .message-content p {
            margin: 0.5em 0;
        }

        .message.assistant .message-content strong {
            color: #667eea;
            font-weight: bold;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 0.5em 0;
            padding-left: 20px;
        }

        .message.assistant .message-content li {
            margin: 0.3em 0;
        }

        .message.assistant .message-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message.assistant .message-content pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .message.assistant .message-content blockquote {
            border-left: 3px solid #667eea;
            padding-left: 10px;
            margin: 0.5em 0;
            color: #666;
        }

        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin: 0.8em 0 0.4em 0;
            color: #667eea;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #messageInput:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }

        #messageInput:focus:before {
            content: none;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ä¼šè¯åˆ—è¡¨ */
        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .session-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .session-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .session-item.active {
            border-left: 4px solid #667eea;
            background: #f0f4ff;
        }

        .session-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .session-time {
            font-size: 12px;
            color: #999;
        }

        /* è®°å¿†æŸ¥çœ‹ */
        .memory-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .memory-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .memory-content {
            color: #333;
            margin-bottom: 8px;
        }

        .memory-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
        }

        /* WebSocketæé†’å¼¹çª—æ ·å¼ */
        .reminder-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            opacity: 1;
            transition: opacity 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .reminder-notification-content {
            padding: 16px;
        }

        .reminder-notification-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reminder-notification-icon {
            font-size: 24px;
        }

        .reminder-notification-title {
            flex: 1;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .reminder-notification-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .reminder-notification-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .reminder-notification-body {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reminder-notification-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reminder-notification-actions button {
            padding: 6px 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reminder-notification-actions button:first-child {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .reminder-notification-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            ğŸ¤– å°ä¹ AI ç®¡å®¶
            <span style="font-size: 12px; opacity: 0.8; margin-left: 10px;">v0.5.0</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ èŠå¤©</div>
            <div class="tab" onclick="switchTab('sessions')">ğŸ“‹ ä¼šè¯</div>
            <div class="tab" onclick="switchTab('memory')">ğŸ§  è®°å¿†</div>
            <div class="tab" onclick="switchTab('analytics')">ğŸ“Š è¡Œä¸ºåˆ†æ</div>
            <div class="tab" onclick="switchTab('reminders')">ğŸ”” æé†’</div>
            <div class="tab" onclick="switchTab('tools')">ğŸ”§ å·¥å…·ç®¡ç†</div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div id="chat" class="tab-content active">
            <div id="sessionInfo" class="session-info" style="display: none;">
                <div class="session-title-display">ğŸ’¬ <span id="currentSessionTitle"></span></div>
            </div>
            <div class="chat-container" id="chatContainer"></div>
            <div class="input-container">
                <div id="messageInput" contenteditable="true" data-placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œï¼‰..."
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; min-height: 40px; max-height: 120px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">
                </div>
                <button onclick="sendMessageFromDiv()" id="sendBtn">å‘é€</button>
                <button onclick="newChat()">æ–°å¯¹è¯</button>
            </div>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div id="sessions" class="tab-content">
            <div class="sessions-list" id="sessionsList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è®°å¿†æŸ¥çœ‹ -->
        <div id="memory" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ“Š è®°å¿†ç»Ÿè®¡
                        <span style="font-size: 12px; color: #667eea; font-weight: normal;">
                            v0.2.0 - ğŸ§  æ”¯æŒè¯­ä¹‰æœç´¢
                        </span>
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢è®°å¿†ï¼ˆæ”¯æŒè¯­ä¹‰ç†è§£ï¼‰..."
                        style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                    <button onclick="searchMemories()">ğŸ” å…³é”®è¯</button>
                    <button onclick="semanticSearch()" title="æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œå¦‚'å¤šå¤§å¹´çºª'">ğŸ§  è¯­ä¹‰</button>
                    <button onclick="loadRecentMemories()">ğŸ“‹ å…¨éƒ¨</button>
                </div>

                <div id="memoryList"></div>
            </div>
        </div>

        <!-- è¡Œä¸ºåˆ†æ -->
        <div id="analytics" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ“Š ç”¨æˆ·è¡Œä¸ºåˆ†æ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.3.0
                            Learningå±‚</span></h3>
                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadBehaviorAnalytics()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„
                            åˆ·æ–°æ•°æ®</button>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()"
                                style="cursor: pointer;">
                            <span>è‡ªåŠ¨åˆ·æ–° (30ç§’)</span>
                        </label>
                        <span id="refreshStatus" style="font-size: 12px; color: #999;"></span>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">â° æ´»è·ƒæ—¶é—´åˆ†å¸ƒ</h4>
                        <div id="activityPattern"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ’¬ è¯é¢˜åå¥½</h4>
                        <div id="topicPreferences"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“ˆ å¯¹è¯ç»Ÿè®¡</h4>
                        <div id="behaviorStats"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #ff6b6b;">âš ï¸ è®°å¿†å†²çªæ£€æµ‹</h4>
                        <div id="conflictDetection"
                            style="background: #fff5f5; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #ff6b6b;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #764ba2;">ğŸ’¡ ä¸»åŠ¨é—®ç­”å†å²</h4>
                        <div id="proactiveQA"
                            style="background: #f8f4ff; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #764ba2;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #10b981;">ğŸ§  å­¦ä¹ æ¨¡å¼</h4>
                        <div id="learningPatterns"
                            style="background: #f0fdf4; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #10b981;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æé†’ç®¡ç† v0.5.0 -->
        <div id="reminders" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ”” æé†’ç®¡ç† <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.5.0
                            Active Perceptionå±‚</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="loadReminders()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”„ åˆ·æ–°
                        </button>
                        <button onclick="showCreateReminderDialog()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            â• åˆ›å»ºæé†’
                        </button>
                        <button onclick="toggleExpiredReminders()"
                            style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <span id="toggleExpiredBtn">ï¿½ï¸ æ˜¾ç¤ºå·²è¿‡æœŸ</span>
                        </button>
                        <button onclick="checkReminders()"
                            style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ï¿½ ç«‹å³æ£€æŸ¥
                        </button>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="reminderStats" style="margin: 15px 0; display: flex; gap: 15px; font-size: 13px;">
                        <span style="color: #10b981;">âœ… æ´»è·ƒ: <strong id="activeCount">0</strong></span>
                        <span style="color: #999;">â¸ï¸ å·²ç¦ç”¨: <strong id="disabledCount">0</strong></span>
                        <span style="color: #f59e0b;">ğŸ“œ å·²è§¦å‘: <strong id="triggeredCount">0</strong></span>
                    </div>

                    <!-- æé†’åˆ—è¡¨ï¼ˆåˆå¹¶ç‰ˆï¼‰ -->
                    <div style="margin: 20px 0;">
                        <div id="remindersList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°"åŠ è½½æé†’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å·¥å…·ç®¡ç† -->
        <div id="tools" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ”§ å·¥å…·ç®¡ç† <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.4.0
                            Actionå±‚</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadTools()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”„ åˆ·æ–°å·¥å…·åˆ—è¡¨
                        </button>
                    </div>

                    <!-- å·¥å…·åˆ—è¡¨ -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“‹ å¯ç”¨å·¥å…·</h4>
                        <div id="toolsList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 150px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°å·¥å…·åˆ—è¡¨"åŠ è½½</div>
                        </div>
                    </div>

                    <!-- å·¥å…·æ‰§è¡Œå†å² -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“Š å·¥å…·æ‰§è¡Œå†å²</h4>
                        <div style="margin-bottom: 10px;">
                            <button onclick="loadToolHistory()"
                                style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                ğŸ”„ åˆ·æ–°å†å²
                            </button>
                            <select id="historyLimit"
                                style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="10">æœ€è¿‘10æ¡</option>
                                <option value="20" selected>æœ€è¿‘20æ¡</option>
                                <option value="50">æœ€è¿‘50æ¡</option>
                            </select>
                        </div>
                        <div id="toolHistory"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°å†å²"åŠ è½½</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        const API_BASE = '';

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'sessions') loadSessions();
            if (tabName === 'memory') loadMemoryStats();
            if (tabName === 'analytics') {
                // è‡ªåŠ¨åŠ è½½è¡Œä¸ºåˆ†ææ•°æ®
                loadBehaviorAnalytics();
            }
            if (tabName === 'reminders') {
                // è‡ªåŠ¨åŠ è½½æé†’åˆ—è¡¨
                loadReminders();
                loadReminderHistory();
            }
            if (tabName === 'tools') {
                // è‡ªåŠ¨åŠ è½½å·¥å…·åˆ—è¡¨
                loadTools();
                loadToolHistory();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆä»contenteditable divï¼‰
        async function sendMessageFromDiv() {
            const input = document.getElementById('messageInput');
            const message = input.textContent.trim();
            if (!message) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.contentEditable = 'false';

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.textContent = '';

            try {
                const url = currentSessionId
                    ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}`
                    : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}`;

                // è®¾ç½®60ç§’è¶…æ—¶ä»¥å¤„ç†å¤æ‚é—®é¢˜
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(url, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', 'è¯·æ±‚è¶…æ—¶ï¼Œé—®é¢˜å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œè¯·ç¨åå†è¯•ã€‚');
                } else {
                    addMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆä¿ç•™æ—§å‡½æ•°å…¼å®¹æ€§ï¼‰
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            // æ£€æŸ¥æ˜¯å¦æ˜¯contenteditable
            if (input.contentEditable === 'true') {
                sendMessageFromDiv();
                return;
            }

            const message = input.value.trim();
            if (!message) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';
            // é‡ç½®textareaé«˜åº¦
            input.style.height = 'auto';

            try {
                const url = currentSessionId
                    ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}`
                    : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}`;

                // è®¾ç½®60ç§’è¶…æ—¶ä»¥å¤„ç†å¤æ‚é—®é¢˜
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(url, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', 'è¯·æ±‚è¶…æ—¶ï¼Œé—®é¢˜å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œè¯·ç¨åå†è¯•ã€‚');
                } else {
                    addMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ï¼Œä½¿ç”¨Markdownæ¸²æŸ“ï¼›ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
            if (role === 'assistant') {
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ–°å¯¹è¯
        function newChat() {
            currentSessionId = null;
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('messageInput').focus();
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions() {
            const container = document.getElementById('sessionsList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/sessions`);
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    container.innerHTML = data.sessions.map(session => `
                        <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}"
                             onclick="loadSession('${session.session_id}')">
                            <div class="session-title">${session.title}</div>
                            <div class="session-time">
                                åˆ›å»º: ${session.created_at} | æ›´æ–°: ${session.updated_at}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">è¿˜æ²¡æœ‰ä¼šè¯è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æŒ‡å®šä¼šè¯
        async function loadSession(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                const data = await response.json();

                currentSessionId = sessionId;
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';

                // æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
                const sessionInfo = document.getElementById('sessionInfo');
                const titleSpan = document.getElementById('currentSessionTitle');
                titleSpan.textContent = data.title;
                sessionInfo.style.display = 'block';

                data.history.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });

                switchTab('chat');
            } catch (error) {
                alert('åŠ è½½ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½è®°å¿†ç»Ÿè®¡
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats`);
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                const tags = data.by_tag || {};

                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${data.total}</div>
                        <div class="stat-label">æ€»è®°å¿†æ•°</div>
                    </div>
                    ${Object.entries(tags).map(([tag, count]) => `
                        <div class="stat-item">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${tag}</div>
                        </div>
                    `).join('')}
                `;

                loadRecentMemories();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML =
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æœ€è¿‘è®°å¿†
        async function loadRecentMemories() {
            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/recent?hours=24&limit=20`);
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰è®°å¿†è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æœç´¢è®°å¿†ï¼ˆå…³é”®è¯ï¼‰
        async function searchMemories() {
            const keywords = document.getElementById('searchInput').value.trim();
            if (!keywords) {
                loadRecentMemories();
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">å…³é”®è¯æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/search?keywords=${encodeURIComponent(keywords)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¯­ä¹‰æœç´¢è®°å¿†
        async function semanticSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">ğŸ§  è¯­ä¹‰æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/semantic?query=${encodeURIComponent(query)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                                <span>ğŸ“Š ç›¸ä¼¼åº¦: ${(mem.score * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('refreshStatus');

            if (checkbox.checked) {
                // å¯ç”¨è‡ªåŠ¨åˆ·æ–°
                loadBehaviorAnalytics();
                lastRefreshTime = Date.now();
                updateRefreshStatus();

                autoRefreshInterval = setInterval(() => {
                    loadBehaviorAnalytics();
                    lastRefreshTime = Date.now();
                    updateRefreshStatus();
                }, 30000); // 30ç§’

                statusSpan.style.color = '#51cf66';
                console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨ (30ç§’)');
            } else {
                // ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = '';
                console.log('â¸ï¸ è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
            }
        }

        // æ›´æ–°åˆ·æ–°çŠ¶æ€
        function updateRefreshStatus() {
            const statusSpan = document.getElementById('refreshStatus');
            if (lastRefreshTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - lastRefreshTime) / 1000);
                statusSpan.textContent = `ä¸Šæ¬¡åˆ·æ–°: ${elapsed}ç§’å‰`;
            }
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€æ˜¾ç¤º
        setInterval(() => {
            if (autoRefreshInterval && lastRefreshTime) {
                updateRefreshStatus();
            }
        }, 1000);

        // åŠ è½½è¡Œä¸ºåˆ†ææ•°æ®
        async function loadBehaviorAnalytics() {
            const userId = 'default_user';

            // åŠ è½½æ´»è·ƒæ—¶é—´åˆ†å¸ƒ
            loadActivityPattern(userId);

            // åŠ è½½è¯é¢˜åå¥½
            loadTopicPreferences(userId);

            // åŠ è½½å¯¹è¯ç»Ÿè®¡
            loadBehaviorStats(userId);

            // åŠ è½½å†²çªæ£€æµ‹
            loadConflictDetection();

            // åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
            loadProactiveQA(userId);

            // åŠ è½½å­¦ä¹ æ¨¡å¼
            loadLearningPatterns(userId);
        }

        // åŠ è½½æ´»è·ƒæ—¶é—´åˆ†å¸ƒ
        async function loadActivityPattern(userId) {
            const container = document.getElementById('activityPattern');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/activity?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

                // å°æ—¶åˆ†å¸ƒ
                if (data.hourly_distribution && Object.keys(data.hourly_distribution).length > 0) {
                    html += '<div><strong>ğŸ“… æ´»è·ƒæ—¶æ®µï¼ˆå°æ—¶ï¼‰</strong><div style="margin-top: 8px;">';
                    const sortedHours = Object.entries(data.hourly_distribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    sortedHours.forEach(([hour, count]) => {
                        html += `<div style="margin: 5px 0;">ğŸ• ${hour}:00 - ${count}æ¬¡</div>`;
                    });
                    html += '</div></div>';
                }

                // æ˜ŸæœŸåˆ†å¸ƒ
                if (data.daily_distribution && Object.keys(data.daily_distribution).length > 0) {
                    const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                    html += '<div><strong>ğŸ“† æ´»è·ƒæ˜ŸæœŸ</strong><div style="margin-top: 8px;">';
                    const sortedDays = Object.entries(data.daily_distribution).sort((a, b) => b[1] - a[1]);
                    sortedDays.forEach(([day, count]) => {
                        html += `<div style="margin: 5px 0;">${weekdays[day] || 'å‘¨' + day} - ${count}æ¬¡</div>`;
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html || '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½è¯é¢˜åå¥½
        async function loadTopicPreferences(userId) {
            const container = document.getElementById('topicPreferences');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/topics?user_id=${userId}`);
                const data = await response.json();

                if (data.error || !data.top_topics || data.top_topics.length === 0) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— è¯é¢˜æ•°æ®</div>';
                    return;
                }

                let html = '<div>';
                data.top_topics.slice(0, 10).forEach((item, index) => {
                    const [topic, count] = item;
                    html += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${index + 1}. ğŸ·ï¸ ${topic}</span>
                            <span style="color: #667eea; font-weight: bold;">${count}æ¬¡</span>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å¯¹è¯ç»Ÿè®¡
        async function loadBehaviorStats(userId) {
            const container = document.getElementById('behaviorStats');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/behavior?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
                    return;
                }

                // ä¿®å¤ï¼šä½¿ç”¨ conversation_stats è€Œä¸æ˜¯ stats
                const stats = data.conversation_stats || {};
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_sessions || 0}</div>
                            <div style="color: #999; margin-top: 5px;">æ€»ä¼šè¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_messages || 0}</div>
                            <div style="color: #999; margin-top: 5px;">æ€»æ¶ˆæ¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_messages_per_session || 0}</div>
                            <div style="color: #999; margin-top: 5px;">å¹³å‡æ¶ˆæ¯/ä¼šè¯</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_message_length || 0}</div>
                            <div style="color: #999; margin-top: 5px;">å¹³å‡æ¶ˆæ¯é•¿åº¦</div>
                        </div>
                    </div>
                `;

                if (stats.last_session_time) {
                    html += `<div style="margin-top: 15px; text-align: center; color: #666;">
                        æœ€åæ´»è·ƒ: ${new Date(stats.last_session_time).toLocaleString('zh-CN')}
                    </div>`;
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å†²çªæ£€æµ‹
        async function loadConflictDetection() {
            const container = document.getElementById('conflictDetection');
            container.innerHTML = '<div class="loading">æ£€æµ‹ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/conflicts`);
                const data = await response.json();

                if (data.conflicts && data.conflicts.length > 0) {
                    let html = `<div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">
                        âš ï¸ å‘ç° ${data.conflicts.length} ç»„å†²çªè®°å¿†
                    </div>`;

                    data.conflicts.forEach((conflict, index) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #ff6b6b; border-radius: 5px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">å†²çª ${index + 1}: ${conflict.type_cn}</div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    ğŸ“„ æ—§å€¼: ${conflict.old_value} - ${conflict.old_memory}
                                </div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    ğŸ“„ æ–°å€¼: ${conflict.new_value} - ${conflict.new_memory}
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 12px;">
                                    æ£€æµ‹æ—¶é—´: ${conflict.conflict_detected_at}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #51cf66; text-align: center;">âœ… æ²¡æœ‰å‘ç°å†²çªè®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
        async function loadProactiveQA(userId) {
            const container = document.getElementById('proactiveQA');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/proactive/history?user_id=${userId}&limit=10`);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    let html = `<div style="color: #764ba2; font-weight: bold; margin-bottom: 10px;">
                        ğŸ’¡ å…± ${data.total} æ¡è¿½é—®è®°å½•ï¼ˆæ˜¾ç¤ºæœ€è¿‘10æ¡ï¼‰
                    </div>`;

                    data.history.forEach((item, index) => {
                        const confidenceColor = item.confidence >= 70 ? '#51cf66' : item.confidence >= 50 ? '#ffd43b' : '#ff6b6b';
                        const askedBadge = item.followup_asked
                            ? '<span style="background: #51cf66; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">å·²è¿½é—®</span>'
                            : '<span style="background: #999; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">å¾…è¿½é—®</span>';

                        html += `
                            <div style="margin: 10px 0; padding: 12px; background: white; border-left: 3px solid #764ba2; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold;">è®°å½• ${index + 1}</span>
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        ${askedBadge}
                                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                            ç½®ä¿¡åº¦ ${item.confidence}%
                                        </span>
                                    </div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #f8f4ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">åŸå§‹é—®é¢˜:</div>
                                    <div>â“ ${item.original_question}</div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #e7f5ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">å»ºè®®è¿½é—®:</div>
                                    <div>ğŸ’¬ ${item.followup_question}</div>
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 11px;">
                                    åˆ›å»ºæ—¶é—´: ${new Date(item.created_at).toLocaleString('zh-CN')}
                                    ${item.asked_at ? ` | è¿½é—®æ—¶é—´: ${new Date(item.asked_at).toLocaleString('zh-CN')}` : ''}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— è¿½é—®è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å­¦ä¹ æ¨¡å¼
        async function loadLearningPatterns(userId) {
            const container = document.getElementById('learningPatterns');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // å¹¶è¡Œè·å–ä¸‰ä¸ªAPIæ•°æ®
                const [frequentRes, questionsRes, insightsRes] = await Promise.all([
                    fetch(`${API_BASE}/patterns/frequent?user_id=${userId}&limit=10`),
                    fetch(`${API_BASE}/patterns/common_questions?user_id=${userId}&limit=5`),
                    fetch(`${API_BASE}/patterns/insights?user_id=${userId}`)
                ]);

                const frequentData = await frequentRes.json();
                const questionsData = await questionsRes.json();
                const insightsData = await insightsRes.json();

                let html = '';

                // æ˜¾ç¤ºç»Ÿè®¡æ¦‚è§ˆ
                if (insightsData && insightsData.statistics) {
                    const stats = insightsData.statistics;
                    html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.total_patterns || 0}</div>
                        <div style="font-size: 12px; color: #999;">æ€»å­¦ä¹ æ¨¡å¼</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.frequent_words_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">é«˜é¢‘è¯æ±‡</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.common_questions_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">å¸¸è§é—®é¢˜</div>
                    </div>`;
                    html += `</div>`;
                }

                // æ˜¾ç¤ºé«˜é¢‘è¯
                if (frequentData.frequent_words && frequentData.frequent_words.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">ğŸ“ é«˜é¢‘è¯æ±‡ TOP10</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                    frequentData.frequent_words.forEach(item => {
                        const confidence = item.confidence || 50;
                        const bgColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#3b82f6' : '#6b7280';
                        html += `<span style="background: ${bgColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                            ${item.word} (${item.frequency}æ¬¡)
                        </span>`;
                    });

                    html += `</div></div>`;
                }

                // æ˜¾ç¤ºå¸¸è§é—®é¢˜åˆ†ç±»
                if (questionsData.common_questions && questionsData.common_questions.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">â“ å¸¸è§é—®é¢˜åˆ†ç±»</div>`;

                    questionsData.common_questions.forEach(item => {
                        const typeEmoji = {
                            'å¤©æ°”æŸ¥è¯¢': 'ğŸŒ¤ï¸',
                            'æ—¶é—´æ—¥æœŸ': 'â°',
                            'ä¸ªäººä¿¡æ¯': 'ğŸ‘¤',
                            'åŠŸèƒ½å’¨è¯¢': 'ğŸ”§',
                            'æ¨èå»ºè®®': 'ğŸ’¡',
                            'é—²èŠ': 'ğŸ’¬'
                        };

                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #10b981; border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${typeEmoji[item.category] || 'ğŸ“Œ'} ${item.category} 
                                <span style="color: #999; font-size: 12px; font-weight: normal;">(${item.frequency}æ¬¡)</span>
                            </div>`;

                        if (item.examples && item.examples.length > 0) {
                            html += `<div style="font-size: 12px; color: #666; margin-top: 5px;">`;
                            item.examples.slice(0, 2).forEach(example => {
                                html += `<div style="margin: 3px 0;">â€¢ ${example}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                }

                if (!html) {
                    html = '<div style="color: #999; text-align: center;">æš‚æ— å­¦ä¹ æ•°æ®ï¼Œå¤šèŠå‡ å¥è®©å°ä¹äº†è§£ä½ å§~</div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ============ å·¥å…·ç®¡ç†åŠŸèƒ½ (v0.4.0) ============

        // åŠ è½½å·¥å…·åˆ—è¡¨
        async function loadTools() {
            const container = document.getElementById('toolsList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/list?enabled_only=true`);
                const data = await response.json();

                if (!data.tools || data.tools.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— å¯ç”¨å·¥å…·</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                data.tools.forEach(tool => {
                    const categoryEmoji = {
                        'weather': 'ğŸŒ¤ï¸',
                        'system': 'ğŸ’»',
                        'search': 'ğŸ”',
                        'file': 'ğŸ“'
                    };

                    const emoji = categoryEmoji[tool.category] || 'ğŸ”§';
                    const statusColor = tool.enabled ? '#10b981' : '#9ca3af';
                    const statusText = tool.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';

                    html += `
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${emoji} ${tool.name}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        ${tool.description}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            ğŸ“¦ ${tool.category}
                                        </span>
                                        <span style="background: ${tool.enabled ? '#d1fae5' : '#f3f4f6'}; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            â— ${statusText}
                                        </span>
                                        ${tool.version ? `<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">v${tool.version}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${tool.parameters && tool.parameters.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ“ å‚æ•°:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                        ${tool.parameters.map(p => `
                                            <span style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: #4b5563;">
                                                ${p.name}${p.required ? '*' : ''}: ${p.type}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // æ˜¾ç¤ºå·¥å…·æ€»æ•°
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `ğŸ“‹ å¯ç”¨å·¥å…· <span style="font-size: 12px; color: #999; font-weight: normal;">(å…± ${data.tools.length} ä¸ª)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å·¥å…·æ‰§è¡Œå†å²
        async function loadToolHistory() {
            const container = document.getElementById('toolHistory');
            const limit = document.getElementById('historyLimit').value;

            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/history?user_id=default_user&limit=${limit}`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— æ‰§è¡Œå†å²</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach((record, index) => {
                    const statusColor = record.success ? '#10b981' : '#ef4444';
                    const statusIcon = record.success ? 'âœ…' : 'âŒ';
                    const executionTime = record.execution_time ? record.execution_time.toFixed(3) : 'N/A';

                    // æ ¼å¼åŒ–æ—¶é—´
                    const date = new Date(record.executed_at);
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 16px;">${statusIcon}</span>
                                    <span style="font-weight: bold; color: #333;">${record.tool_name}</span>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 11px; color: #999;">${timeStr}</span>
                                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        ${executionTime}s
                                    </span>
                                </div>
                            </div>
                            
                            ${record.error_message ? `
                                <div style="margin-top: 5px; padding: 8px; background: #fef2f2; border-radius: 5px; font-size: 12px; color: #991b1b;">
                                    âš ï¸ ${record.error_message}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæ€»æ•°
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `ğŸ“Š å·¥å…·æ‰§è¡Œå†å² <span style="font-size: 12px; color: #999; font-weight: normal;">(å…± ${data.total} æ¡)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ============ å·¥å…·ç®¡ç†åŠŸèƒ½ç»“æŸ ============

        // ============ v0.5.0 æé†’ç®¡ç†åŠŸèƒ½ ============

        // åŠ è½½æé†’åˆ—è¡¨
        // å…¨å±€å˜é‡ï¼šæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºå·²è¿‡æœŸæé†’
        let showExpired = false;

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders?user_id=default_user&enabled_only=false`);
                const data = await response.json();

                if (!data.reminders || data.reminders.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">è¿˜æ²¡æœ‰æé†’ï¼Œç‚¹å‡»"åˆ›å»ºæé†’"æ¥æ·»åŠ ï¼</div>';
                    updateReminderStats(0, 0, 0);
                    return;
                }

                // ç»Ÿè®¡æ•°æ®
                let activeCount = 0;
                let disabledCount = 0;
                let triggeredCount = 0;

                data.reminders.forEach(r => {
                    if (r.trigger_count > 0 || r.last_triggered) {
                        triggeredCount++;
                    } else if (r.enabled) {
                        activeCount++;
                    } else {
                        disabledCount++;
                    }
                });

                updateReminderStats(activeCount, disabledCount, triggeredCount);

                // è¿‡æ»¤ï¼šæ ¹æ®showExpiredå†³å®šæ˜¯å¦æ˜¾ç¤ºå·²è§¦å‘çš„æé†’
                let displayReminders;
                if (showExpired) {
                    displayReminders = data.reminders;
                } else {
                    // åªæ˜¾ç¤ºæœªè§¦å‘çš„æé†’ï¼ˆåŒ…æ‹¬å¯ç”¨å’Œç¦ç”¨ï¼‰
                    displayReminders = data.reminders.filter(r => !r.trigger_count && !r.last_triggered);
                }

                if (displayReminders.length === 0) {
                    if (showExpired) {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æ²¡æœ‰æé†’è®°å½•ã€‚</div>';
                    } else {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æ²¡æœ‰å¾…è§¦å‘çš„æé†’ã€‚<br><br>ç‚¹å‡»"ğŸ‘ï¸ æ˜¾ç¤ºå·²è¿‡æœŸ"æŸ¥çœ‹å·²è§¦å‘çš„æé†’ã€‚</div>';
                    }
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                displayReminders.forEach(reminder => {
                    const priorityColors = {
                        1: { color: '#ef4444', emoji: 'ğŸ”´', label: 'æœ€é«˜' },
                        2: { color: '#f59e0b', emoji: 'ğŸŸ ', label: 'é«˜' },
                        3: { color: '#eab308', emoji: 'ğŸŸ¡', label: 'ä¸­' },
                        4: { color: '#10b981', emoji: 'ğŸŸ¢', label: 'ä½' },
                        5: { color: '#6b7280', emoji: 'âšª', label: 'æœ€ä½' }
                    };

                    const priority = priorityColors[reminder.priority] || priorityColors[3];
                    
                    // åˆ¤æ–­æ˜¯å¦å·²è§¦å‘
                    const isTriggered = reminder.trigger_count > 0 || reminder.last_triggered;
                    const statusColor = isTriggered ? '#9ca3af' : (reminder.enabled ? '#10b981' : '#9ca3af');
                    const statusText = isTriggered ? 'å·²è§¦å‘' : (reminder.enabled ? 'å¯ç”¨' : 'ç¦ç”¨');
                    
                    // å·²è§¦å‘çš„æé†’ç”¨ç°è‰²èƒŒæ™¯
                    const cardBg = isTriggered ? '#f3f4f6' : 'white';
                    const cardOpacity = isTriggered ? 'opacity: 0.8;' : '';

                    const typeEmoji = {
                        'time': 'â°',
                        'weather': 'ğŸŒ¤ï¸',
                        'behavior': 'ğŸ‘¤',
                        'habit': 'ğŸ¯'
                    };

                    html += `
                        <div style="background: ${cardBg}; padding: 15px; border-radius: 10px; border-left: 4px solid ${priority.color}; ${cardOpacity}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${priority.emoji} ${reminder.title || 'æ— æ ‡é¢˜'}
                                        ${isTriggered ? '<span style="font-size: 12px; color: #9ca3af; margin-left: 8px;">ğŸ“œ å·²è§¦å‘</span>' : ''}
                                    </div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                        ${reminder.content}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            ${typeEmoji[reminder.reminder_type] || 'ğŸ“Œ'} ${reminder.reminder_type}
                                        </span>
                                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            â— ${statusText}
                                        </span>
                                        <span style="background: ${priority.color}20; color: ${priority.color}; padding: 3px 8px; border-radius: 4px;">
                                            ä¼˜å…ˆçº§: ${priority.label}
                                        </span>
                                        ${reminder.repeat ? '<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">ğŸ”„ é‡å¤</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px; margin-left: 10px;">
                                    ${!isTriggered ? `
                                        <button onclick="toggleReminder(${reminder.reminder_id})" 
                                            style="padding: 6px 12px; background: ${reminder.enabled ? '#ef4444' : '#10b981'}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                            ${reminder.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteReminder(${reminder.reminder_id})" 
                                        style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            ${reminder.last_triggered ? `
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    ä¸Šæ¬¡è§¦å‘: ${new Date(reminder.last_triggered).toLocaleString('zh-CN')}
                                    ${reminder.trigger_count ? ` | è§¦å‘æ¬¡æ•°: ${reminder.trigger_count}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateReminderStats(activeCount, disabledCount, triggeredCount) {
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('disabledCount').textContent = disabledCount;
            document.getElementById('triggeredCount').textContent = triggeredCount;
        }

        // åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºå·²è¿‡æœŸæé†’
        function toggleExpiredReminders() {
            showExpired = !showExpired;
            const btn = document.getElementById('toggleExpiredBtn');
            btn.textContent = showExpired ? 'ğŸš« éšè—å·²è¿‡æœŸ' : 'ğŸ‘ï¸ æ˜¾ç¤ºå·²è¿‡æœŸ';
            loadReminders();
        }

        // åŠ è½½æé†’å†å²
        async function loadReminderHistory() {
            const container = document.getElementById('reminderHistory');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders/history/default_user?limit=20`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach(record => {
                    const typeEmoji = {
                        'time': 'â°',
                        'weather': 'ğŸŒ¤ï¸',
                        'behavior': 'ğŸ‘¤',
                        'habit': 'ğŸ¯'
                    };

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                ${typeEmoji[record.reminder_type] || 'ğŸ“Œ'} ${record.title || 'æ— æ ‡é¢˜'}
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                ${record.content}
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                è§¦å‘æ—¶é—´: ${new Date(record.triggered_at).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºæé†’å¯¹è¯æ¡†
        function showCreateReminderDialog() {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="reminderDialog">
                    <div style="background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">â• åˆ›å»ºæ–°æé†’</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡é¢˜:</label>
                            <input type="text" id="reminderTitle" placeholder="ä¾‹å¦‚ï¼šå›¢é˜Ÿä¼šè®®" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å†…å®¹:</label>
                            <textarea id="reminderContent" placeholder="æé†’çš„è¯¦ç»†å†…å®¹..." rows="3"
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">è§¦å‘æ—¶é—´:</label>
                            <input type="datetime-local" id="reminderTime" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¼˜å…ˆçº§:</label>
                            <select id="reminderPriority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="1">ğŸ”´ æœ€é«˜</option>
                                <option value="2">ğŸŸ  é«˜</option>
                                <option value="3" selected>ğŸŸ¡ ä¸­</option>
                                <option value="4">ğŸŸ¢ ä½</option>
                                <option value="5">âšª æœ€ä½</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button onclick="closeReminderDialog()" 
                                style="padding: 10px 20px; background: #9ca3af; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                            <button onclick="createReminder()" 
                                style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                åˆ›å»º
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialog);
        }

        function closeReminderDialog() {
            const dialog = document.getElementById('reminderDialog');
            if (dialog) dialog.remove();
        }

        // åˆ›å»ºæé†’
        async function createReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const content = document.getElementById('reminderContent').value.trim();
            const time = document.getElementById('reminderTime').value;
            const priority = parseInt(document.getElementById('reminderPriority').value);

            if (!content) {
                alert('è¯·è¾“å…¥æé†’å†…å®¹');
                return;
            }

            if (!time) {
                alert('è¯·é€‰æ‹©è§¦å‘æ—¶é—´');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        reminder_type: 'time',
                        trigger_condition: { datetime: time.replace('T', ' ') + ':00' },
                        title: title || 'æ–°æé†’',
                        content: content,
                        priority: priority,
                        repeat: false
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeReminderDialog();
                    loadReminders();
                    alert('âœ… æé†’åˆ›å»ºæˆåŠŸï¼');
                } else {
                    alert('âŒ åˆ›å»ºå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢æé†’çŠ¶æ€
        async function toggleReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤æé†’
        async function deleteReminder(reminderId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æé†’å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç«‹å³æ£€æŸ¥æé†’
        async function checkReminders() {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'default_user' })
                });

                const data = await response.json();

                if (data.triggered && data.triggered.length > 0) {
                    alert(`âœ… æ£€æŸ¥å®Œæˆï¼è§¦å‘äº† ${data.triggered.length} æ¡æé†’`);
                    loadReminderHistory();
                } else {
                    alert('âœ… æ£€æŸ¥å®Œæˆï¼å½“å‰æ²¡æœ‰éœ€è¦è§¦å‘çš„æé†’');
                }
            } catch (error) {
                alert('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // ============ æé†’ç®¡ç†åŠŸèƒ½ç»“æŸ ============

        // ============ WebSocketå®æ—¶æ¨é€ ============
        let ws = null;
        let wsReconnectTimer = null;
        let unreadReminderCount = 0;

        function connectWebSocket() {
            try {
                // å»ºç«‹WebSocketè¿æ¥
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('âœ… WebSocketå·²è¿æ¥');
                    clearTimeout(wsReconnectTimer);

                    // å‘é€å¿ƒè·³
                    setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send('ping');
                        }
                    }, 30000); // æ¯30ç§’å‘é€å¿ƒè·³
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'reminder') {
                            // æ”¶åˆ°æé†’æ¨é€
                            handleReminderPush(message.data);
                        } else if (message.type === 'pong') {
                            // å¿ƒè·³å“åº”
                            console.log('å¿ƒè·³å“åº”');
                        }
                    } catch (error) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                };

                ws.onclose = () => {
                    console.log('âŒ WebSocketå·²æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
                    wsReconnectTimer = setTimeout(connectWebSocket, 5000);
                };

            } catch (error) {
                console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                wsReconnectTimer = setTimeout(connectWebSocket, 5000);
            }
        }

        function handleReminderPush(reminder) {
            console.log('æ”¶åˆ°æé†’æ¨é€:', reminder);

            // æ’­æ”¾æç¤ºéŸ³
            playReminderSound();

            // å¢åŠ æœªè¯»è®¡æ•°
            unreadReminderCount++;
            updateReminderBadge();

            // æ˜¾ç¤ºæé†’å¼¹çª—
            showReminderNotification(reminder);

            // å¦‚æœé¡µé¢ä¸åœ¨å‰å°ï¼Œå‘é€æµè§ˆå™¨é€šçŸ¥
            if (document.hidden) {
                sendBrowserNotification(reminder);
            }

            // åˆ·æ–°æé†’åˆ—è¡¨
            if (document.getElementById('reminders').style.display !== 'none') {
                loadReminders();
            }
        }

        // æ’­æ”¾æé†’å£°éŸ³
        function playReminderSound() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºéœ‡è¡å™¨ï¼ˆç”Ÿæˆå£°éŸ³ï¼‰
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // è¿æ¥èŠ‚ç‚¹
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®éŸ³è°ƒå’ŒéŸ³é‡
                oscillator.type = 'sine'; // æ­£å¼¦æ³¢ï¼ŒæŸ”å’Œçš„å£°éŸ³
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz
                
                // éŸ³é‡æ¸å˜æ•ˆæœï¼ˆé¿å…çªå…€ï¼‰
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                // æ’­æ”¾å£°éŸ³
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // ç¬¬äºŒå£°ï¼ˆåŒå“ï¼‰
                setTimeout(() => {
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode2 = audioContext.createGain();
                    
                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext.destination);
                    
                    oscillator2.type = 'sine';
                    oscillator2.frequency.setValueAtTime(1000, audioContext.currentTime);
                    
                    gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode2.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                    gainNode2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                    
                    oscillator2.start(audioContext.currentTime);
                    oscillator2.stop(audioContext.currentTime + 0.5);
                }, 200);
                
            } catch (error) {
                console.error('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
            }
        }

        function showReminderNotification(reminder) {
            // åˆ›å»ºæé†’å¼¹çª—
            const notification = document.createElement('div');
            notification.className = 'reminder-notification';
            notification.id = `reminder-notif-${reminder.reminder_id}`;

            const priorityEmoji = { 1: 'ğŸ”´', 2: 'ğŸŸ ', 3: 'ğŸŸ¡', 4: 'ğŸŸ¢', 5: 'âšª' };
            const emoji = priorityEmoji[reminder.priority] || 'ğŸ””';

            notification.innerHTML = `
                <div class="reminder-notification-content">
                    <div class="reminder-notification-header">
                        <span class="reminder-notification-icon">${emoji}</span>
                        <span class="reminder-notification-title">${reminder.title || 'æé†’'}</span>
                        <button class="reminder-notification-close" onclick="closeReminderNotif(${reminder.reminder_id})">âœ•</button>
                    </div>
                    <div class="reminder-notification-body">
                        ${reminder.content}
                    </div>
                    <div class="reminder-notification-actions">
                        <button onclick="handleReminderRead(${reminder.reminder_id})">
                            âœ… å·²çŸ¥é“
                        </button>
                        <button onclick="handleReminderSnooze(${reminder.reminder_id})">
                            â° ç¨åæé†’
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 30ç§’åè‡ªåŠ¨æ·¡å‡ºï¼ˆç»™ç”¨æˆ·æ›´å¤šæ—¶é—´æŸ¥çœ‹ï¼‰
            setTimeout(() => {
                if (document.getElementById(`reminder-notif-${reminder.reminder_id}`)) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 30000);
        }

        // å…³é—­æé†’é€šçŸ¥
        function closeReminderNotif(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (notif) {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }
        }

        // å¤„ç†"å·²çŸ¥é“"
        async function handleReminderRead(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;
            
            // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #10b981;">âœ… å·²æ ‡è®°ä¸ºå·²è¯»</span>';
            
            // æ ‡è®°å·²è¯»
            markReminderAsRead(reminderId);
            
            // 1ç§’åå…³é—­
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        // å¤„ç†"ç¨åæé†’"
        async function handleReminderSnooze(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;
            
            // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #f59e0b;">â° æ­£åœ¨å»¶è¿Ÿ...</span>';
            
            // æ‰§è¡Œå»¶è¿Ÿæ“ä½œ
            await snoozeReminder(reminderId, 5);
            
            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            actionsDiv.innerHTML = '<span style="color: #10b981;">âœ… å·²å»¶è¿Ÿ5åˆ†é’Ÿ</span>';
            
            // 1ç§’åå…³é—­
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        function sendBrowserNotification(reminder) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(reminder.title || 'å°ä¹æé†’', {
                    body: reminder.content,
                    icon: '/static/favicon.ico',
                    tag: `reminder-${reminder.reminder_id}`,
                    requireInteraction: false
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        function updateReminderBadge() {
            // æ›´æ–°æé†’æ•°é‡çº¢ç‚¹ï¼ˆåç»­å®ç°ï¼‰
            console.log(`æœªè¯»æé†’: ${unreadReminderCount}`);
        }

        function markReminderAsRead(reminderId) {
            // æ ‡è®°æé†’å·²è¯»ï¼ˆåç»­å¯æ‰©å±•ï¼‰
            unreadReminderCount = Math.max(0, unreadReminderCount - 1);
            updateReminderBadge();
        }

        // å»¶è¿Ÿæé†’ï¼ˆç¨åæé†’ï¼‰
        async function snoozeReminder(reminderId, minutes = 5) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/snooze?minutes=${minutes}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`âœ… æé†’å·²å»¶è¿Ÿ ${minutes} åˆ†é’Ÿï¼Œæ–°è§¦å‘æ—¶é—´: ${data.new_trigger_time}`);
                    
                    // æ˜¾ç¤ºæç¤º
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
                    toast.textContent = `â° æé†’å·²å»¶è¿Ÿ ${minutes} åˆ†é’Ÿ`;
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s';
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                    
                    // åˆ·æ–°æé†’åˆ—è¡¨
                    if (document.getElementById('reminders').style.display !== 'none') {
                        loadReminders();
                    }
                } else {
                    console.error('âŒ å»¶è¿Ÿæé†’å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('âŒ å»¶è¿Ÿæé†’å¤±è´¥:', error);
            }
        }

        // è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('é€šçŸ¥æƒé™:', permission);
                });
            }
        }

        // ============ WebSocketåŠŸèƒ½ç»“æŸ ============

        // é¡µé¢åŠ è½½æ—¶èšç„¦è¾“å…¥æ¡†
        window.onload = () => {
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessageFromDiv();
                }
            });

            // æœç´¢æ¡†å›è½¦æœç´¢
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchMemories();
                    }
                });
            }

            // å»ºç«‹WebSocketè¿æ¥
            connectWebSocket();

            // è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
            requestNotificationPermission();
        };
    </script>
</body>

</html>