<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞è‰πê AI ÁÆ°ÂÆ∂ v0.8.0</title>
    <style>
        /* CSS ÂèòÈáè - ‰∫ÆËâ≤‰∏ªÈ¢ò */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #dddddd;
            --tab-bg: #f5f5f5;
            --tab-hover: #e8e8e8;
            --tab-active-bg: #ffffff;
            --input-bg: #f8f8f8;
            --input-border: #ddd;
            --button-gradient-start: #667eea;
            --button-gradient-end: #764ba2;
            --message-user-bg: #667eea;
            --message-ai-bg: #f0f0f0;
            --message-ai-text: #333333;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --shadow-heavy: rgba(0, 0, 0, 0.3);
            --card-bg: #ffffff;
            --card-border: #e0e0e0;
            --code-bg: #f5f5f5;
            --code-text: #d63384;
            --success-bg: #f0fdf4;
            --success-border: #10b981;
            --warning-bg: #fef3c7;
            --warning-border: #f59e0b;
            --info-bg: #f8f4ff;
            --info-border: #764ba2;
            --danger-bg: #fff5f5;
            --danger-border: #ff6b6b;
        }

        /* ÊöóËâ≤‰∏ªÈ¢ò */
        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #1f1f1f;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border-color: #3a3a3a;
            --tab-bg: #2a2a2a;
            --tab-hover: #333333;
            --tab-active-bg: #1f1f1f;
            --input-bg: #2a2a2a;
            --input-border: #3a3a3a;
            --button-gradient-start: #667eea;
            --button-gradient-end: #764ba2;
            --message-user-bg: #667eea;
            --message-ai-bg: #2a2a2a;
            --message-ai-text: #e0e0e0;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-medium: rgba(0, 0, 0, 0.5);
            --shadow-heavy: rgba(0, 0, 0, 0.7);
            --card-bg: #2a2a2a;
            --card-border: #3a3a3a;
            --code-bg: #1a1a1a;
            --code-text: #ff6b9d;
            --success-bg: #1a2e22;
            --success-border: #10b981;
            --warning-bg: #2e2414;
            --warning-border: #f59e0b;
            --info-bg: #25213a;
            --info-border: #764ba2;
            --danger-bg: #2e1a1a;
            --danger-border: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            flex: 1;
            text-align: center;
        }

        .theme-toggle {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 20px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(20deg);
        }

        .tabs {
            display: flex;
            background: var(--tab-bg);
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
        }

        .tab:hover {
            background: var(--tab-hover);
        }

        .tab.active {
            background: var(--tab-active-bg);
            border-bottom: 3px solid var(--button-gradient-start);
            color: var(--button-gradient-start);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ‰ºöËØù‰ø°ÊÅØÊ†è */
        .session-info {
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: box-shadow 0.3s ease;
        }

        .session-title-display {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* ËÅäÂ§©ÁïåÈù¢ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
            position: relative;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }

        .message-image {
            margin-bottom: 8px;
        }

        .message-image img {
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: var(--message-user-bg);
            color: white;
        }

        /* Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆ v0.6.0 */
        .message-actions {
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .message.user:hover .message-actions {
            opacity: 1;
            pointer-events: all;
        }

        .message-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            padding: 0;
        }

        .message-action-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .message-action-btn.edit:hover {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .message-action-btn.delete:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .message-action-btn.copy:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ÁºñËæëÁä∂ÊÄÅÊ†áËØÜ */
        .editing-indicator {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFA726;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInUp 0.3s;
        }

        .editing-indicator button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .editing-indicator button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Ê∂àÊÅØÊêúÁ¥¢Ê°Ü v0.6.0 */
        .message-search-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .message-search-container input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-search-container input:focus {
            border-color: var(--button-gradient-start);
        }

        .clear-search-btn {
            padding: 6px 12px;
            background: var(--button-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .clear-search-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .search-result-count {
            color: var(--text-secondary);
            font-size: 12px;
            white-space: nowrap;
        }

        .message.search-highlight {
            background: rgba(255, 235, 59, 0.2);
            border-left: 3px solid #FFC107;
            animation: highlightPulse 0.5s ease-in-out;
        }

        @keyframes highlightPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .message .search-match {
            background: #FFEB3B;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .message.ai .message-content {
            background: var(--message-ai-bg);
            color: var(--message-ai-text);
        }

        .message-content code {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .message.assistant .message-content {
            background: var(--message-ai-bg);
            color: var(--message-ai-text);
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Markdown Ê†∑Âºè */
        .message.assistant .message-content p {
            margin: 0.5em 0;
        }

        .message.assistant .message-content strong {
            color: var(--button-gradient-start);
            font-weight: bold;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 0.5em 0;
            padding-left: 20px;
        }

        .message.assistant .message-content li {
            margin: 0.3em 0;
        }

        .message.assistant .message-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--code-text);
        }

        .message.assistant .message-content pre {
            background: var(--code-bg);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .message.assistant .message-content blockquote {
            border-left: 3px solid var(--button-gradient-start);
            padding-left: 10px;
            margin: 0.5em 0;
            color: var(--text-secondary);
        }

        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin: 0.8em 0 0.4em 0;
            color: var(--button-gradient-start);
        }

        .input-container {
            padding: 20px;
            background: var(--container-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        #messageInput:focus {
            border-color: var(--button-gradient-start);
        }

        #messageInput:empty:before {
            content: attr(data-placeholder);
            color: var(--text-tertiary);
        }

        #messageInput:focus:before {
            content: none;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ‰ºöËØùÂàóË°® */
        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }

        .session-item {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: all 0.3s;
            border: 1px solid var(--card-border);
            position: relative;
        }

        .session-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }

        .session-item:hover .session-actions {
            opacity: 1;
            pointer-events: all;
        }

        .session-item.active {
            border-left: 4px solid var(--button-gradient-start);
            background: var(--input-bg);
        }

        /* ‰ºöËØùÊìç‰ΩúÊåâÈíÆ */
        .session-actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .session-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            background: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .session-action-btn:hover {
            transform: scale(1.1);
        }

        .session-action-btn.export-md {
            color: #10b981;
            border: 2px solid #10b981;
        }

        .session-action-btn.export-md:hover {
            background: #10b981;
            color: white;
        }

        .session-action-btn.export-json {
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }

        .session-action-btn.export-json:hover {
            background: #3b82f6;
            color: white;
        }

        .session-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ËÆ∞ÂøÜÊü•Áúã */
        .memory-container {
            flex: 1;
            overflow-y: auto;
            background: var(--container-bg);
            transition: background 0.3s ease;
            padding: 20px;
        }

        .stats-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--button-gradient-start);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .memory-item {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .memory-content {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .memory-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        .error {
            background: var(--message-ai-bg);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
            border: 1px solid #ff6b6b;
            transition: all 0.3s ease;
        }

        /* WebSocketÊèêÈÜíÂºπÁ™óÊ†∑Âºè */
        .reminder-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow-heavy);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            opacity: 1;
            transition: opacity 0.3s, background 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--card-border);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .reminder-notification-content {
            padding: 16px;
        }

        .reminder-notification-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reminder-notification-icon {
            font-size: 24px;
        }

        .reminder-notification-title {
            flex: 1;
            font-weight: bold;
            font-size: 16px;
            color: var(--text-primary);
        }

        .reminder-notification-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .reminder-notification-close:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .reminder-notification-body {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reminder-notification-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reminder-notification-actions button {
            padding: 6px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reminder-notification-actions button:first-child {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .reminder-notification-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* ‰∏ªÂä®ÂØπËØùÂä®Áîª */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ËøΩÈóÆÊèêÁ§∫Âä®Áîª */
        @keyframes slideInUp {
            from {
                transform: translate(-50%, 20px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideOutDown {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }

            to {
                transform: translate(-50%, 20px);
                opacity: 0;
            }
        }

        /* ËÆæÁΩÆÈù¢ÊùøÊ†∑Âºè v0.6.0 */
        .settings-section {
            margin: 25px 0;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--button-gradient-start);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .setting-select {
            padding: 8px 15px;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .setting-select:hover {
            border-color: var(--button-gradient-start);
        }

        .setting-select:focus {
            border-color: var(--button-gradient-start);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ÂºÄÂÖ≥ÊåâÈíÆÊ†∑Âºè */
        .setting-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .setting-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .setting-switch input:checked+.switch-slider {
            background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
        }

        .setting-switch input:checked+.switch-slider:before {
            transform: translateX(24px);
        }

        /* v0.6.0 Phase 4: ÂõæÁâá‰∏ä‰º†ÂäüËÉΩ */
        .upload-image-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .upload-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* v0.8.0 ËØ≠Èü≥ËæìÂÖ•ÂäüËÉΩ */
        .voice-input-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .voice-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
        }

        .voice-input-btn.recording {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ËøûÁª≠ÂØπËØùÊ®°ÂºèÊåâÈíÆ */
        .conversation-mode-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .conversation-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .conversation-mode-btn.active {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            animation: breathe 2s ease-in-out infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(79, 172, 254, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(79, 172, 254, 0);
            }
        }

        /* ËøûÁª≠ÂØπËØùÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .conversation-mode-status {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(79, 172, 254, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 999;
            text-align: center;
        }

        .conversation-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .conversation-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        #conversationHint {
            font-size: 12px;
            opacity: 0.9;
        }

        /* ÂÅúÊ≠¢ËØ≠Èü≥ÊåâÈíÆ */
        .stop-speaking-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .stop-speaking-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .stop-speaking-btn:active {
            transform: scale(0.95);
        }

        /* ÂÖ®Â±ÄÂÅúÊ≠¢ËØ≠Èü≥ÊåâÈíÆ */
        .global-stop-speaking {
            position: fixed;
            bottom: 150px;
            right: 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            animation: shake 0.5s ease-in-out infinite;
        }

        .global-stop-speaking:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }

        .global-stop-speaking:active {
            transform: scale(0.95);
        }

        .global-stop-speaking span:first-child {
            font-size: 20px;
        }

        .stop-text {
            font-weight: 600;
            font-size: 14px;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-3px);
            }

            75% {
                transform: translateX(3px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(245, 87, 108, 0);
            }
        }

        .voice-status {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(245, 87, 108, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .voice-wave span {
            width: 3px;
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) {
            animation-delay: 0s;
        }

        .voice-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .voice-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .voice-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .voice-wave span:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes wave {

            0%,
            100% {
                height: 30%;
            }

            50% {
                height: 100%;
            }
        }

        .voice-status #voiceText {
            font-size: 14px;
            font-weight: 500;
        }

        /* ËØ≠Èü≥Êí≠ÊîæÁä∂ÊÄÅÊ†∑Âºè */
        .speaking-status {
            position: fixed;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        .speaking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speaking-icon {
            font-size: 20px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .speaking-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .speaking-wave span {
            display: inline-block;
            width: 3px;
            background: white;
            border-radius: 3px;
            animation: speakWave 1s ease-in-out infinite;
        }

        .speaking-wave span:nth-child(1) {
            animation-delay: 0s;
        }

        .speaking-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .speaking-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .speaking-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        @keyframes speakWave {

            0%,
            100% {
                height: 30%;
            }

            50% {
                height: 100%;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .speaking-status #speakingText {
            font-size: 14px;
            font-weight: 500;
        }

        .image-preview {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
        }

        .image-preview-actions {
            display: flex;
            gap: 8px;
        }

        /* v0.8.0 ‰ªªÂä°ÁÆ°ÁêÜÊ†∑Âºè */
        .task-card {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-light);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-heavy);
        }

        .task-card.status-pending {
            border-left-color: #f59e0b;
        }

        .task-card.status-in_progress {
            border-left-color: #3b82f6;
        }

        .task-card.status-completed {
            border-left-color: #10b981;
        }

        .task-card.status-failed {
            border-left-color: #ef4444;
        }

        .task-card.status-cancelled {
            border-left-color: #6b7280;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .task-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .task-status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .task-status-badge.in_progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .task-status-badge.waiting {
            background: #e0e7ff;
            color: #3730a3;
        }

        .task-status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .task-status-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .task-status-badge.cancelled {
            background: #f3f4f6;
            color: #374151;
        }

        .task-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .task-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .task-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--input-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .task-progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            min-width: 50px;
            text-align: right;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .task-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-btn-primary {
            background: #667eea;
            color: white;
        }

        .task-btn-primary:hover {
            background: #5568d3;
        }

        .task-btn-success {
            background: #10b981;
            color: white;
        }

        .task-btn-success:hover {
            background: #059669;
        }

        .task-btn-danger {
            background: #ef4444;
            color: white;
        }

        .task-btn-danger:hover {
            background: #dc2626;
        }

        .task-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .task-btn-secondary:hover {
            background: #4b5563;
        }

        .task-step {
            background: var(--input-bg);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #cbd5e1;
        }

        .task-step.completed {
            border-left-color: #10b981;
            opacity: 0.7;
        }

        .task-step.failed {
            border-left-color: #ef4444;
        }

        .task-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .task-step-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .task-step-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 8px;
            background: var(--card-bg);
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-0 {
            background: #f3f4f6;
            color: #6b7280;
        }

        .priority-1 {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-2 {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
    <!-- Markdown Ëß£ÊûêÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">
                <span id="themeIcon">üåô</span>
            </button>
            <div class="header-title">
                ü§ñ Â∞è‰πê AI ÁÆ°ÂÆ∂
                <span style="font-size: 12px; opacity: 0.8; margin-left: 10px;">v0.8.0</span>
            </div>
            <div style="width: 40px;"></div> <!-- Âç†‰Ωç‰øùÊåÅÂ±Ö‰∏≠ -->
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat', event)">üí¨ ËÅäÂ§©</div>
            <div class="tab" onclick="switchTab('sessions', event)">üìã ‰ºöËØù</div>
            <div class="tab" onclick="switchTab('memory', event)">üß† ËÆ∞ÂøÜ</div>
            <!-- <div class="tab" onclick="switchTab('analytics', event)">üìä Ë°å‰∏∫ÂàÜÊûê</div> -->
            <div class="tab" onclick="switchTab('tasks', event)">‚úÖ ‰ªªÂä°</div>
            <div class="tab" onclick="switchTab('reminders', event)">üîî ÊèêÈÜí</div>
            <div class="tab" onclick="switchTab('documents', event)">üìÑ ÊñáÊ°£ÊÄªÁªì</div>
            <div class="tab" onclick="switchTab('schedule', event)">üìÖ ËØæÁ®ãË°®</div>
            <div class="tab" onclick="switchTab('tools', event)">üîß Â∑•ÂÖ∑ÁÆ°ÁêÜ</div>
            <div class="tab" onclick="switchTab('settings', event)">‚öôÔ∏è ËÆæÁΩÆ</div>
        </div>

        <!-- ËÅäÂ§©ÁïåÈù¢ -->
        <div id="chat" class="tab-content active">
            <div id="sessionInfo" class="session-info" style="display: none;">
                <div class="session-title-display">üí¨ <span id="currentSessionTitle"></span></div>
            </div>
            <!-- Ê∂àÊÅØÊêúÁ¥¢Ê°Ü v0.6.0 -->
            <div class="message-search-container">
                <input type="text" id="messageSearchInput" placeholder="ÊêúÁ¥¢ÂØπËØùÂÜÖÂÆπ..." onkeyup="searchMessages()">
                <button onclick="clearMessageSearch()" class="clear-search-btn" title="Ê∏ÖÈô§ÊêúÁ¥¢">‚úï</button>
                <span id="searchResultCount" class="search-result-count"></span>
            </div>
            <div class="chat-container" id="chatContainer"></div>
            <!-- ÂõæÁâá‰∏ä‰º†ËæìÂÖ•ÔºàÈöêËóèÔºâ -->
            <input type="file" id="imageUpload" accept="image/*" style="display: none;"
                onchange="handleImageUpload(event)" onclick="console.log('üìÇ File input clicked')"
                oncancel="console.log('‚ùå File selection cancelled')">
            <div class="input-container">
                <button onclick="triggerImageUpload()" class="upload-image-btn" title="‰∏ä‰º†ÂõæÁâá">üì∑</button>
                <button onclick="toggleVoiceInput()" class="voice-input-btn" id="voiceBtn"
                    title="ËØ≠Èü≥ËæìÂÖ•ÔºàÂèØÊâìÊñ≠AIÔºâ">üé§</button>
                <button onclick="toggleConversationMode()" class="conversation-mode-btn" id="conversationModeBtn"
                    title="ËøûÁª≠ÂØπËØùÊ®°Âºè">üí¨</button>
                <div id="messageInput" contenteditable="true" data-placeholder="ËæìÂÖ•Ê∂àÊÅØÔºàEnterÂèëÈÄÅÔºåShift+EnterÊç¢Ë°åÔºâ..."
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; min-height: 40px; max-height: 120px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">
                </div>
                <button onclick="sendMessageFromDiv()" id="sendBtn">ÂèëÈÄÅ</button>
                <button onclick="newChat()">Êñ∞ÂØπËØù</button>
            </div>
            <!-- ÂÖ®Â±ÄÂÅúÊ≠¢ËØ≠Èü≥ÊåâÈíÆ -->
            <div id="globalStopSpeakingBtn" class="global-stop-speaking" style="display: none;" onclick="stopSpeaking()"
                title="ÂÅúÊ≠¢ËØ≠Èü≥Êí≠ÊîæÔºàÊàñÁÇπÂáªÂΩïÈü≥ÊåâÈíÆÊâìÊñ≠Ôºâ">
                <span>üîá</span>
                <span class="stop-text">ÂÅúÊ≠¢Êí≠Êîæ</span>
            </div>
            <!-- ËøûÁª≠ÂØπËØùÊ®°ÂºèÁä∂ÊÄÅ -->
            <div id="conversationModeStatus" class="conversation-mode-status" style="display: none;">
                <div class="conversation-indicator">
                    <span class="conversation-dot"></span>
                    <span id="conversationStateText">ÂØπËØùÊ®°ÂºèÂ∑≤ÂºÄÂêØ</span>
                    <button onclick="stopSpeaking()" class="stop-speaking-btn" title="ÂÅúÊ≠¢ËØ≠Èü≥">üîá</button>
                </div>
                <span id="conversationHint">ËØ¥ÂÆåËØùÂêé‰ºöËá™Âä®ËØÜÂà´Âπ∂ÂèëÈÄÅ</span>
            </div>
            <!-- ËØ≠Èü≥ËØÜÂà´Áä∂ÊÄÅÊèêÁ§∫ -->
            <div id="voiceStatus" class="voice-status" style="display: none;">
                <div class="voice-wave">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
                <span id="voiceText">Ê≠£Âú®ËÅÜÂê¨...</span>
            </div>
            <!-- ËØ≠Èü≥Êí≠ÊîæÁä∂ÊÄÅÊèêÁ§∫ -->
            <div id="speakingStatus" class="speaking-status" style="display: none;">
                <div class="speaking-indicator">
                    <span class="speaking-icon">üîä</span>
                    <div class="speaking-wave">
                        <span></span><span></span><span></span><span></span>
                    </div>
                </div>
                <span id="speakingText">Ê≠£Âú®Êí≠Êîæ...</span>
            </div>
        </div>

        <!-- ‰ºöËØùÂàóË°® -->
        <div id="sessions" class="tab-content">
            <div class="sessions-list" id="sessionsList">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>

        <!-- ËÆ∞ÂøÜÊü•Áúã -->
        <div id="memory" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>üìä ËÆ∞ÂøÜÁªüËÆ°
                        <span style="font-size: 12px; color: #667eea; font-weight: normal;">
                            v0.2.0 - üß† ÊîØÊåÅËØ≠‰πâÊêúÁ¥¢
                        </span>
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢ËÆ∞ÂøÜÔºàÊîØÊåÅËØ≠‰πâÁêÜËß£Ôºâ..."
                        style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                    <button onclick="searchMemories()">üîç ÂÖ≥ÈîÆËØç</button>
                    <button onclick="semanticSearch()" title="ÊîØÊåÅËá™ÁÑ∂ËØ≠Ë®ÄÊü•ËØ¢ÔºåÂ¶Ç'Â§öÂ§ßÂπ¥Á∫™'">üß† ËØ≠‰πâ</button>
                    <button onclick="loadRecentMemories()">üìã ÂÖ®ÈÉ®</button>
                </div>

                <div id="memoryList"></div>
            </div>
        </div>

        <!-- Ë°å‰∏∫ÂàÜÊûê - Â∑≤ÈöêËóèÔºå‰ª£Á†Å‰øùÁïô -->
        <div id="analytics" class="tab-content" style="display: none !important;">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>üìä Áî®Êà∑Ë°å‰∏∫ÂàÜÊûê <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.3.0
                            LearningÂ±Ç</span></h3>
                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadBehaviorAnalytics()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">üîÑ
                            Âà∑Êñ∞Êï∞ÊçÆ</button>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()"
                                style="cursor: pointer;">
                            <span>Ëá™Âä®Âà∑Êñ∞ (30Áßí)</span>
                        </label>
                        <span id="refreshStatus" style="font-size: 12px; color: #999;"></span>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">‚è∞ Ê¥ªË∑ÉÊó∂Èó¥ÂàÜÂ∏É</h4>
                        <div id="activityPattern"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Êï∞ÊçÆ"Âä†ËΩΩ</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üí¨ ËØùÈ¢òÂÅèÂ•Ω</h4>
                        <div id="topicPreferences"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Êï∞ÊçÆ"Âä†ËΩΩ</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üìà ÂØπËØùÁªüËÆ°</h4>
                        <div id="behaviorStats"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Êï∞ÊçÆ"Âä†ËΩΩ</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #ff6b6b;">‚ö†Ô∏è ËÆ∞ÂøÜÂÜ≤Á™ÅÊ£ÄÊµã</h4>
                        <div id="conflictDetection"
                            style="background: #fff5f5; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #ff6b6b;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Êï∞ÊçÆ"Âä†ËΩΩ</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #764ba2;">üí° ‰∏ªÂä®ÈóÆÁ≠îÂéÜÂè≤</h4>
                        <div id="proactiveQA"
                            style="background: #f8f4ff; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #764ba2;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Êï∞ÊçÆ"Âä†ËΩΩ</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #10b981;">üß† Â≠¶‰π†Ê®°Âºè</h4>
                        <div id="learningPatterns"
                            style="background: #f0fdf4; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #10b981;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Êï∞ÊçÆ"Âä†ËΩΩ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰ªªÂä°ÁÆ°ÁêÜ v0.8.0 -->
        <div id="tasks" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>‚úÖ ‰ªªÂä°ÁÆ°ÁêÜ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.8.0 Â§öËΩÆ‰ªªÂä°ËßÑÂàí</span>
                    </h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="loadTasks()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üîÑ Âà∑Êñ∞
                        </button>
                        <button onclick="showCreateTaskDialog()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚ûï ÂàõÂª∫‰ªªÂä°
                        </button>
                        <select id="taskStatusFilter" onchange="loadTasks()"
                            style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                            <option value="pending">ÂæÖÂ§ÑÁêÜ</option>
                            <option value="in_progress">ÊâßË°å‰∏≠</option>
                            <option value="waiting">Á≠âÂæÖ‰∏≠</option>
                            <option value="completed">Â∑≤ÂÆåÊàê</option>
                            <option value="failed">Â§±Ë¥•</option>
                            <option value="cancelled">Â∑≤ÂèñÊ∂à</option>
                        </select>
                    </div>

                    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                    <div id="taskStats"
                        style="margin: 15px 0; display: flex; gap: 15px; font-size: 13px; flex-wrap: wrap;">
                        <span style="color: #f59e0b;">üìã ÂæÖÂ§ÑÁêÜ: <strong id="taskPendingCount">0</strong></span>
                        <span style="color: #3b82f6;">‚ö° ÊâßË°å‰∏≠: <strong id="taskInProgressCount">0</strong></span>
                        <span style="color: #10b981;">‚úÖ Â∑≤ÂÆåÊàê: <strong id="taskCompletedCount">0</strong></span>
                        <span style="color: #ef4444;">‚ùå Â§±Ë¥•: <strong id="taskFailedCount">0</strong></span>
                    </div>

                    <!-- ‰ªªÂä°ÂàóË°® -->
                    <div style="margin: 20px 0;">
                        <div id="tasksList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">Ê≠£Âú®Âä†ËΩΩ‰ªªÂä°...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊèêÈÜíÁÆ°ÁêÜ v0.5.0 -->
        <div id="reminders" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>üîî ÊèêÈÜíÁÆ°ÁêÜ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.5.0
                            Active PerceptionÂ±Ç</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="loadReminders()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üîÑ Âà∑Êñ∞
                        </button>
                        <button onclick="showCreateReminderDialog()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚ûï ÂàõÂª∫ÊèêÈÜí
                        </button>
                        <button onclick="toggleExpiredReminders()"
                            style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <span id="toggleExpiredBtn">ÔøΩÔ∏è ÊòæÁ§∫Â∑≤ËøáÊúü</span>
                        </button>
                        <button onclick="checkReminders()"
                            style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ÔøΩ Á´ãÂç≥Ê£ÄÊü•
                        </button>
                    </div>

                    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                    <div id="reminderStats" style="margin: 15px 0; display: flex; gap: 15px; font-size: 13px;">
                        <span style="color: #10b981;">‚úÖ Ê¥ªË∑É: <strong id="activeCount">0</strong></span>
                        <span style="color: #999;">‚è∏Ô∏è Â∑≤Á¶ÅÁî®: <strong id="disabledCount">0</strong></span>
                        <span style="color: #f59e0b;">üìú Â∑≤Ëß¶Âèë: <strong id="triggeredCount">0</strong></span>
                    </div>

                    <!-- ÊèêÈÜíÂàóË°®ÔºàÂêàÂπ∂ÁâàÔºâ -->
                    <div style="margin: 20px 0;">
                        <div id="remindersList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞"Âä†ËΩΩÊèêÈÜí</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊñáÊ°£ÊÄªÁªì v0.8.0 Phase 3 -->
        <div id="documents" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>üìÑ ÊñáÊ°£ÊÄªÁªì <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.8.0 Phase
                            3</span></h3>

                    <!-- ‰∏ä‰º†Âå∫Âüü -->
                    <div style="margin: 20px 0;">
                        <div
                            style="border: 2px dashed #667eea; border-radius: 12px; padding: 40px; text-align: center; background: #f8f9fa;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì§</div>
                            <h4 style="margin: 10px 0; color: #333;">‰∏ä‰º†ÊñáÊ°£ËøõË°åÊô∫ËÉΩÊÄªÁªì</h4>
                            <p style="color: #666; margin: 10px 0; font-size: 14px;">
                                ÊîØÊåÅ PDF„ÄÅWord (DOCX)„ÄÅÊñáÊú¨Êñá‰ª∂ (TXT„ÄÅMD)<br>
                                ÊúÄÂ§ßÊñá‰ª∂Â§ßÂ∞è: 10 MB
                            </p>
                            <input type="file" id="documentFileInput" accept=".pdf,.docx,.txt,.md"
                                style="display: none;" onchange="handleDocumentUpload(event)">
                            <button onclick="document.getElementById('documentFileInput').click()"
                                style="margin-top: 15px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                       color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                üìÅ ÈÄâÊã©Êñá‰ª∂
                            </button>
                        </div>
                    </div>

                    <!-- ÊñáÊ°£ÂàóË°® -->
                    <div style="margin: 20px 0;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">üìö ÊñáÊ°£ÂàóË°®</h4>
                            <button onclick="loadDocuments()"
                                style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                üîÑ Âà∑Êñ∞
                            </button>
                        </div>
                        <div id="documentsList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞"Âä†ËΩΩÊñáÊ°£ÂàóË°®</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËØæÁ®ãË°®ÁÆ°ÁêÜ v0.7.0 -->
        <div id="schedule" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>üìÖ ËØæÁ®ãË°®ÁÆ°ÁêÜ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.7.0</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px;">
                        <button onclick="loadSchedule()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üîÑ Âà∑Êñ∞ËØæÁ®ãË°®
                        </button>
                        <button onclick="saveSchedule()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üíæ ‰øùÂ≠ò‰øÆÊîπ
                        </button>
                    </div>

                    <!-- ËØæÁ®ãË°®Ê†º -->
                    <div id="scheduleTable" style="overflow-x: auto; margin-top: 20px;">
                        <table
                            style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead style="background: #667eea; color: white;">
                                <tr>
                                    <th style="padding: 12px; border: 1px solid #ddd;">Êó∂ÊÆµ</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">Âë®‰∏Ä</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">Âë®‰∫å</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">Âë®‰∏â</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">Âë®Âõõ</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">Âë®‰∫î</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody">
                                <!-- Â∞ÜÁî±JavaScriptÂä®ÊÄÅÁîüÊàê -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∑•ÂÖ∑ÁÆ°ÁêÜ -->
        <div id="tools" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>üîß Â∑•ÂÖ∑ÁÆ°ÁêÜ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.4.0
                            ActionÂ±Ç</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadTools()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üîÑ Âà∑Êñ∞Â∑•ÂÖ∑ÂàóË°®
                        </button>
                    </div>

                    <!-- Â∑•ÂÖ∑ÂàóË°® -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üìã ÂèØÁî®Â∑•ÂÖ∑</h4>
                        <div id="toolsList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 150px;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞Â∑•ÂÖ∑ÂàóË°®"Âä†ËΩΩ</div>
                        </div>
                    </div>

                    <!-- Â∑•ÂÖ∑ÊâßË°åÂéÜÂè≤ -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">üìä Â∑•ÂÖ∑ÊâßË°åÂéÜÂè≤</h4>
                        <div style="margin-bottom: 10px;">
                            <button onclick="loadToolHistory()"
                                style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                üîÑ Âà∑Êñ∞ÂéÜÂè≤
                            </button>
                            <select id="historyLimit"
                                style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="10">ÊúÄËøë10Êù°</option>
                                <option value="20" selected>ÊúÄËøë20Êù°</option>
                                <option value="50">ÊúÄËøë50Êù°</option>
                            </select>
                        </div>
                        <div id="toolHistory"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <div class="loading">ÁÇπÂáª"Âà∑Êñ∞ÂéÜÂè≤"Âä†ËΩΩ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆÈù¢Êùø v0.6.0 Phase 2 -->
        <div id="settings" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>‚öôÔ∏è Áî®Êà∑ËÆæÁΩÆ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.6.0 Áî®Êà∑‰ΩìÈ™å</span>
                    </h3>

                    <!-- Â§ñËßÇËÆæÁΩÆ -->
                    <div class="settings-section">
                        <h4 class="settings-title">üé® Â§ñËßÇËÆæÁΩÆ</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">‰∏ªÈ¢òÊ®°Âºè</span>
                                <span class="setting-desc">ÈÄâÊã©ÁïåÈù¢‰∏ªÈ¢òÂÅèÂ•Ω</span>
                            </div>
                            <select id="themePreference" class="setting-select"
                                onchange="updateThemePreference(this.value)">
                                <option value="system">Ë∑üÈöèÁ≥ªÁªü</option>
                                <option value="light">ÂßãÁªà‰∫ÆËâ≤</option>
                                <option value="dark">ÂßãÁªàÊöóËâ≤</option>
                            </select>
                        </div>
                    </div>

                    <!-- ‰∫§‰∫íËÆæÁΩÆ -->
                    <div class="settings-section">
                        <h4 class="settings-title">‚å®Ô∏è ‰∫§‰∫íËÆæÁΩÆ</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">Âø´Êç∑ÈîÆ</span>
                                <span class="setting-desc">ÂêØÁî®/Á¶ÅÁî®ÈîÆÁõòÂø´Êç∑ÈîÆÂäüËÉΩ</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="keyboardShortcuts" checked
                                    onchange="toggleKeyboardShortcuts(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">Âø´Êç∑ÈîÆÊèêÁ§∫Ê†è</span>
                                <span class="setting-desc">ÊòæÁ§∫/ÈöêËóèÂ∫ïÈÉ®Âø´Êç∑ÈîÆÊèêÁ§∫</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="shortcutHintsEnabled" checked
                                    onchange="toggleShortcutHints(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- AIÂìçÂ∫îËÆæÁΩÆ -->
                    <div class="settings-section">
                        <h4 class="settings-title">ü§ñ AIÂìçÂ∫îËÆæÁΩÆ</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ÂõûÂ§çÈ£éÊ†º</span>
                                <span class="setting-desc">ÈÄâÊã©AIÁöÑÂõûÂ§çËØ¶ÁªÜÁ®ãÂ∫¶</span>
                            </div>
                            <select id="responseStyle" class="setting-select"
                                onchange="updateResponseStyle(this.value)">
                                <option value="concise">ÁÆÄÊ¥ÅÊ®°Âºè</option>
                                <option value="balanced" selected>Âπ≥Ë°°Ê®°Âºè</option>
                                <option value="detailed">ËØ¶ÁªÜÊ®°Âºè</option>
                                <option value="professional">‰∏ì‰∏öÊ®°Âºè</option>
                            </select>
                        </div>
                    </div>

                    <!-- ÈÄöÁü•ËÆæÁΩÆ -->
                    <div class="settings-section">
                        <h4 class="settings-title">üîî ÈÄöÁü•ËÆæÁΩÆ</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">‰∏ªÂä®ÈóÆÁ≠îÊèêÁ§∫</span>
                                <span class="setting-desc">ÊòæÁ§∫ËøΩÈóÆÂª∫ËÆÆÊèêÁ§∫</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="proactiveQA" checked
                                    onchange="toggleProactiveQA(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ÊèêÈÜíÈÄöÁü•</span>
                                <span class="setting-desc">ÂêØÁî®ÊèêÈÜíÂºπÁ™óÈÄöÁü•</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="reminderNotifications" checked
                                    onchange="toggleReminderNotifications(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- v0.8.0 ËØ≠Èü≥ËÆæÁΩÆ -->
                    <div class="settings-section">
                        <h4 class="settings-title">üé§ ËØ≠Èü≥‰∫§‰∫íËÆæÁΩÆ <span
                                style="font-size: 11px; color: #f5576c; font-weight: normal;">Êñ∞ÂäüËÉΩ</span></h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ËØ≠Èü≥ËØÜÂà´ÊúçÂä°</span>
                                <span class="setting-desc">ÈÄâÊã©ËØ≠Èü≥ËØÜÂà´Êèê‰æõÂïÜ</span>
                            </div>
                            <select id="voiceProvider" class="setting-select"
                                onchange="updateVoiceProvider(this.value)">
                                <option value="google">Google (ÈúÄÁßëÂ≠¶‰∏äÁΩë)</option>
                                <option value="baidu">ÁôæÂ∫¶ËØ≠Èü≥ (Êé®Ëçê)</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">Ëá™Âä®Êí≠ÊîæAIÂõûÂ§ç</span>
                                <span class="setting-desc">AIÂõûÂ§çÂêéËá™Âä®Êí≠ÊîæËØ≠Èü≥</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="voiceAutoPlay" onchange="updateVoiceAutoPlay(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ËØ≠Èü≥ÂêàÊàêÊúçÂä°</span>
                                <span class="setting-desc">ÈÄâÊã©AIÂõûÂ§çÁöÑËØ≠Èü≥ÂêàÊàêÊñπÂºè</span>
                            </div>
                            <select id="ttsProvider" class="setting-select" onchange="updateTTSProvider(this.value)">
                                <option value="web">ÊµèËßàÂô®ËØ≠Èü≥ (ÂÖçË¥π)</option>
                                <option value="baidu">ÁôæÂ∫¶ËØ≠Èü≥ (Êõ¥Ëá™ÁÑ∂)</option>
                            </select>
                        </div>

                        <div class="setting-item" id="baiduTTSPersonSetting" style="display: none;">
                            <div class="setting-label">
                                <span class="setting-name">ÁôæÂ∫¶TTSÈü≥Ëâ≤</span>
                                <span class="setting-desc">ÈÄâÊã©AIÂõûÂ§çÁöÑÂ£∞Èü≥ÔºàÂü∫Á°ÄÂÖçË¥πÁâàÔºâ</span>
                            </div>
                            <select id="ttsPerson" class="setting-select" onchange="updateTTSPerson(this.value)">
                                <option value="0">Â∫¶Â∞èÁæéÔºàÂ•≥Â£∞ÔºåÊ∏©ÊüîÔºâ</option>
                                <option value="1">Â∫¶Â∞èÂÆáÔºàÁî∑Â£∞ÔºåÊ∏©ÂíåÔºâ</option>
                                <option value="3">Â∫¶ÈÄçÈÅ•ÔºàÁî∑Â£∞ÔºåÂπ¥ËΩªÊ¥ªÂäõÔºâ</option>
                                <option value="4">Â∫¶‰∏´‰∏´ÔºàÂ•≥Â£∞ÔºåÊ¥ªÊ≥ºÂèØÁà±Ôºâ</option>
                            </select>
                            <div
                                style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 6px; font-size: 12px; color: #856404;">
                                üí° ÊèêÁ§∫Ôºö‰ªÖÊòæÁ§∫Âü∫Á°ÄÂÖçË¥πÁâàÈü≥Ëâ≤„ÄÇÈ´òÁ∫ßÈü≥Ëâ≤ÔºàÂ∫¶Â∞èÂ®á„ÄÅÂ∫¶Â∞èÈπøÁ≠âÔºâÈúÄË¶Å‰ªòË¥πÁâàÊú¨„ÄÇ
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ËØ≠ÈÄü</span>
                                <span class="setting-desc">Ë∞ÉËäÇËØ≠Èü≥Êí≠ÊîæÈÄüÂ∫¶</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1.0"
                                    oninput="updateVoiceRate(this.value)"
                                    style="flex: 1; height: 4px; border-radius: 2px; outline: none; cursor: pointer;">
                                <span id="voiceRateValue"
                                    style="min-width: 40px; text-align: right; font-weight: 500;">1.0x</span>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">Èü≥Èáè</span>
                                <span class="setting-desc">Ë∞ÉËäÇËØ≠Èü≥Êí≠ÊîæÈü≥Èáè</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="voiceVolume" min="0" max="1" step="0.1" value="1.0"
                                    oninput="updateVoiceVolume(this.value)"
                                    style="flex: 1; height: 4px; border-radius: 2px; outline: none; cursor: pointer;">
                                <span id="voiceVolumeValue"
                                    style="min-width: 40px; text-align: right; font-weight: 500;">100%</span>
                            </div>
                        </div>

                        <div class="setting-item" style="background: #f8f9fa; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">üí°</span>
                                <span style="font-weight: 500; color: #333;">ËØ≠Èü≥ÂäüËÉΩ‰ΩøÁî®ÊèêÁ§∫</span>
                            </div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #666; line-height: 1.8;">
                                <li>ÁÇπÂáªËæìÂÖ•Ê°ÜÊóÅÁöÑ üé§ ÊåâÈíÆÂºÄÂßãËØ≠Èü≥ËæìÂÖ•</li>
                                <li>ÊîØÊåÅ‰∏≠ÊñáËØ≠Èü≥ËØÜÂà´ÔºåËØÜÂà´ÂêéËá™Âä®Â°´ÂÖ•ËæìÂÖ•Ê°Ü</li>
                                <li>ÂºÄÂêØËá™Âä®Êí≠ÊîæÂêéÔºåAIÂõûÂ§ç‰ºöËá™Âä®ÊúóËØª</li>
                                <li>Âª∫ËÆÆ‰ΩøÁî® Chrome„ÄÅEdge Êàñ Safari ÊµèËßàÂô®</li>
                                <li>È¶ñÊ¨°‰ΩøÁî®ÈúÄÊéà‰∫àÈ∫¶ÂÖãÈ£éÊùÉÈôê</li>
                                <li><strong style="color: #f5576c;">‚ö†Ô∏è ËØ≠Èü≥ËØÜÂà´ÈúÄË¶ÅÁΩëÁªúËøûÊé•</strong></li>
                            </ul>
                        </div>

                        <div class="setting-item"
                            style="background: #fff3cd; border-radius: 8px; padding: 12px; border-left: 4px solid #f5576c;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">‚ö†Ô∏è</span>
                                <span style="font-weight: 500; color: #856404;">ÈÅáÂà∞"network"ÈîôËØØÔºü</span>
                            </div>
                            <ul
                                style="margin: 0; padding-left: 20px; font-size: 12px; color: #856404; line-height: 1.8;">
                                <li>ËØ≠Èü≥ËØÜÂà´‰ΩøÁî®GoogleÁöÑWeb Speech APIÔºåÈúÄË¶ÅÁΩëÁªúËøûÊé•</li>
                                <li>ËØ∑Á°Æ‰øùÁΩëÁªúËøûÊé•Ê≠£Â∏∏ÔºåÂèØ‰ª•ËÆøÈóÆGoogleÊúçÂä°</li>
                                <li>Â¶ÇÊûúÂú®ÂõΩÂÜÖ‰ΩøÁî®ÔºåÂèØËÉΩÈúÄË¶ÅÁßëÂ≠¶‰∏äÁΩë</li>
                                <li>Â§áÈÄâÊñπÊ°àÔºöÂèØ‰ª•ÊâãÂä®ËæìÂÖ•ÊñáÂ≠óÔºåÊàñÁ≠âÂæÖÂêéÁª≠ÁâàÊú¨ÈõÜÊàêÂõΩÂÜÖËØ≠Èü≥API</li>
                            </ul>
                        </div>
                    </div>

                    <!-- ÈáçÁΩÆÊåâÈíÆ -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
                        <button onclick="resetSettings()" style="
                            padding: 12px 30px;
                            background: #ff6b6b;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.2s;
                        ">
                            üîÑ ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ
                        </button>
                        <p style="margin-top: 10px; font-size: 12px; color: #999;">
                            Â∞ÜÊÅ¢Â§çÊâÄÊúâËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- v0.6.0 Âø´Êç∑ÈîÆÊèêÁ§∫Ê†è -->
    <div id="shortcutHints" style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea15, #764ba215);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 12px;
        color: #666;
        border-top: 1px solid #ddd;
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
    ">
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+Enter</kbd>
            ÂèëÈÄÅ
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Esc</kbd>
            Ê∏ÖÁ©∫
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+K</kbd>
            Êñ∞ÂØπËØù
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+/</kbd>
            ËÅäÂ§©
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+1-6</kbd>
            ÂàáÊç¢Ê†áÁ≠æ
        </span>
    </div>

    <!-- v0.6.0 ÊÄßËÉΩ‰ºòÂåñÊ®°Âùó -->
    <script src="/static/performance.js"></script>

    <script>
        let currentSessionId = null;
        const API_BASE = '';

        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Êõ¥Êñ∞ÂõæÊ†á
            themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            // Ê£ÄÊü•Áî®Êà∑ÂÅèÂ•Ω
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Á°ÆÂÆö‰ΩøÁî®ÁöÑ‰∏ªÈ¢ò
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

            html.setAttribute('data-theme', theme);
            themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰∏ªÈ¢ò
        document.addEventListener('DOMContentLoaded', initTheme);

        // ===== ËÆæÁΩÆÁÆ°ÁêÜÂäüËÉΩ v0.6.0 =====

        // ËÆæÁΩÆÈ°πÈªòËÆ§ÂÄº
        const DEFAULT_SETTINGS = {
            themePreference: 'system',
            keyboardShortcuts: true,
            shortcutHintsEnabled: true,
            responseStyle: 'balanced',
            proactiveQA: true,
            reminderNotifications: true
        };

        // ÂàùÂßãÂåñËÆæÁΩÆ
        function initSettings() {
            const settings = getSettings();

            // Â∫îÁî®ÊâÄÊúâËÆæÁΩÆ
            document.getElementById('themePreference').value = settings.themePreference;
            document.getElementById('keyboardShortcuts').checked = settings.keyboardShortcuts;
            document.getElementById('shortcutHintsEnabled').checked = settings.shortcutHintsEnabled;
            document.getElementById('responseStyle').value = settings.responseStyle;
            document.getElementById('proactiveQA').checked = settings.proactiveQA;
            document.getElementById('reminderNotifications').checked = settings.reminderNotifications;

            // Â∫îÁî®‰∏ªÈ¢òÂÅèÂ•Ω
            applyThemePreference(settings.themePreference);

            // Â∫îÁî®Âø´Êç∑ÈîÆÊèêÁ§∫
            if (settings.shortcutHintsEnabled) {
                showShortcutHints();
            }

            // ÂàùÂßãÂåñËØ≠Èü≥ËÆæÁΩÆ v0.8.0
            initVoiceSettings();
        }

        // Ëé∑ÂèñËÆæÁΩÆ
        function getSettings() {
            const saved = localStorage.getItem('userSettings');
            return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        function saveSettings(settings) {
            localStorage.setItem('userSettings', JSON.stringify(settings));
        }

        // Êõ¥Êñ∞‰∏ªÈ¢òÂÅèÂ•Ω
        function updateThemePreference(value) {
            const settings = getSettings();
            settings.themePreference = value;
            saveSettings(settings);
            applyThemePreference(value);
            showToast(`‚úÖ ‰∏ªÈ¢òÂÅèÂ•ΩÂ∑≤ËÆæÁΩÆ‰∏∫Ôºö${getThemeLabel(value)}`, 'success');
        }

        // Â∫îÁî®‰∏ªÈ¢òÂÅèÂ•Ω
        function applyThemePreference(preference) {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            if (preference === 'system') {
                // Ë∑üÈöèÁ≥ªÁªü
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = systemPrefersDark ? 'dark' : 'light';
                html.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            } else {
                // Âõ∫ÂÆö‰∏ªÈ¢ò
                html.setAttribute('data-theme', preference);
                themeIcon.textContent = preference === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem('theme', preference);
            }
        }

        // Ëé∑Âèñ‰∏ªÈ¢òÊ†áÁ≠æ
        function getThemeLabel(value) {
            const labels = {
                'system': 'Ë∑üÈöèÁ≥ªÁªü',
                'light': 'ÂßãÁªà‰∫ÆËâ≤',
                'dark': 'ÂßãÁªàÊöóËâ≤'
            };
            return labels[value] || value;
        }

        // ÂàáÊç¢Âø´Êç∑ÈîÆÂäüËÉΩ
        function toggleKeyboardShortcuts(enabled) {
            const settings = getSettings();
            settings.keyboardShortcuts = enabled;
            saveSettings(settings);
            showToast(enabled ? '‚úÖ Âø´Êç∑ÈîÆÂ∑≤ÂêØÁî®' : '‚ö†Ô∏è Âø´Êç∑ÈîÆÂ∑≤Á¶ÅÁî®', enabled ? 'success' : 'warning');
        }

        // ÂàáÊç¢Âø´Êç∑ÈîÆÊèêÁ§∫Ê†è
        function toggleShortcutHints(enabled) {
            const settings = getSettings();
            settings.shortcutHintsEnabled = enabled;
            saveSettings(settings);

            const hints = document.getElementById('shortcutHints');
            if (enabled) {
                showShortcutHints();
            } else {
                hints.style.opacity = '0';
                setTimeout(() => {
                    hints.style.display = 'none';
                }, 300);
            }
            showToast(enabled ? '‚úÖ Âø´Êç∑ÈîÆÊèêÁ§∫Â∑≤ÊòæÁ§∫' : '‚ö†Ô∏è Âø´Êç∑ÈîÆÊèêÁ§∫Â∑≤ÈöêËóè', enabled ? 'success' : 'warning');
        }

        // Êõ¥Êñ∞AIÂìçÂ∫îÈ£éÊ†º
        function updateResponseStyle(style) {
            const settings = getSettings();
            settings.responseStyle = style;
            saveSettings(settings);

            const labels = {
                'concise': 'ÁÆÄÊ¥ÅÊ®°Âºè',
                'balanced': 'Âπ≥Ë°°Ê®°Âºè',
                'detailed': 'ËØ¶ÁªÜÊ®°Âºè',
                'professional': '‰∏ì‰∏öÊ®°Âºè'
            };
            showToast(`‚úÖ AIÂìçÂ∫îÈ£éÊ†ºÂ∑≤ËÆæÁΩÆ‰∏∫Ôºö${labels[style]}`, 'success');
        }

        // ÂàáÊç¢‰∏ªÂä®ÈóÆÁ≠î
        function toggleProactiveQA(enabled) {
            const settings = getSettings();
            settings.proactiveQA = enabled;
            saveSettings(settings);
            showToast(enabled ? '‚úÖ ‰∏ªÂä®ÈóÆÁ≠îÊèêÁ§∫Â∑≤ÂêØÁî®' : '‚ö†Ô∏è ‰∏ªÂä®ÈóÆÁ≠îÊèêÁ§∫Â∑≤Á¶ÅÁî®', enabled ? 'success' : 'warning');
        }

        // ÂàáÊç¢ÊèêÈÜíÈÄöÁü•
        function toggleReminderNotifications(enabled) {
            const settings = getSettings();
            settings.reminderNotifications = enabled;
            saveSettings(settings);
            showToast(enabled ? '‚úÖ ÊèêÈÜíÈÄöÁü•Â∑≤ÂêØÁî®' : '‚ö†Ô∏è ÊèêÈÜíÈÄöÁü•Â∑≤Á¶ÅÁî®', enabled ? 'success' : 'warning');
        }

        // ==================== v0.8.0 ËØ≠Èü≥ËÆæÁΩÆÂäüËÉΩ ====================

        // Êõ¥Êñ∞ËØ≠Èü≥ÊúçÂä°Êèê‰æõÂïÜ
        function updateVoiceProvider(provider) {
            localStorage.setItem('useBaiduVoice', provider === 'baidu');
            const providerName = provider === 'baidu' ? 'ÁôæÂ∫¶ËØ≠Èü≥' : 'GoogleËØ≠Èü≥';
            showToast(`‚úÖ Â∑≤ÂàáÊç¢Âà∞${providerName}ËØÜÂà´`, 'success');
        }

        // Êõ¥Êñ∞TTSÊèê‰æõÂïÜ
        function updateTTSProvider(provider) {
            localStorage.setItem('ttsProvider', provider);
            const ttsName = provider === 'baidu' ? 'ÁôæÂ∫¶ËØ≠Èü≥ÂêàÊàê' : 'ÊµèËßàÂô®ËØ≠Èü≥ÂêàÊàê';
            showToast(`‚úÖ Â∑≤ÂàáÊç¢Âà∞${ttsName}`, 'success');

            // ÊòæÁ§∫/ÈöêËóèÁôæÂ∫¶TTSÈü≥Ëâ≤ÈÄâÊã©
            const personSetting = document.getElementById('baiduTTSPersonSetting');
            if (personSetting) {
                personSetting.style.display = provider === 'baidu' ? 'flex' : 'none';
            }
        }

        // Êõ¥Êñ∞TTSÈü≥Ëâ≤
        function updateTTSPerson(person) {
            localStorage.setItem('ttsPerson', person);
            const personNames = {
                '0': 'Â∫¶Â∞èÁæéÔºàÂ•≥Â£∞ÔºåÊ∏©ÊüîÔºâ',
                '1': 'Â∫¶Â∞èÂÆáÔºàÁî∑Â£∞ÔºåÊ∏©ÂíåÔºâ',
                '3': 'Â∫¶ÈÄçÈÅ•ÔºàÁî∑Â£∞ÔºåÂπ¥ËΩªÊ¥ªÂäõÔºâ',
                '4': 'Â∫¶‰∏´‰∏´ÔºàÂ•≥Â£∞ÔºåÊ¥ªÊ≥ºÂèØÁà±Ôºâ'
            };
            showToast(`‚úÖ Èü≥Ëâ≤Â∑≤ËÆæÁΩÆ‰∏∫Ôºö${personNames[person] || 'Â∫¶Â∞èÁæé'}`, 'success');
        }

        // Êõ¥Êñ∞ËØ≠Èü≥Ëá™Âä®Êí≠ÊîæËÆæÁΩÆ
        function updateVoiceAutoPlay(enabled) {
            localStorage.setItem('voiceAutoPlay', enabled);
            showToast(enabled ? '‚úÖ Â∑≤ÂºÄÂêØËØ≠Èü≥Ëá™Âä®Êí≠Êîæ' : '‚ùå Â∑≤ÂÖ≥Èó≠ËØ≠Èü≥Ëá™Âä®Êí≠Êîæ', 'info');
        }

        // Êõ¥Êñ∞ËØ≠ÈÄü
        function updateVoiceRate(value) {
            localStorage.setItem('voiceRate', value);
            document.getElementById('voiceRateValue').textContent = value + 'x';
        }

        // Êõ¥Êñ∞Èü≥Èáè
        function updateVoiceVolume(value) {
            localStorage.setItem('voiceVolume', value);
            const percentage = Math.round(value * 100);
            document.getElementById('voiceVolumeValue').textContent = percentage + '%';
        }

        // ÂàùÂßãÂåñËØ≠Èü≥ËÆæÁΩÆ
        function initVoiceSettings() {
            // È¶ñÊ¨°ËÆøÈóÆÊó∂ÈªòËÆ§‰ΩøÁî®ÁôæÂ∫¶ËØ≠Èü≥ÔºàÂõΩÂÜÖÊõ¥Á®≥ÂÆöÔºâ
            if (localStorage.getItem('useBaiduVoice') === null) {
                localStorage.setItem('useBaiduVoice', 'true');
            }

            const useBaiduVoice = localStorage.getItem('useBaiduVoice') === 'true';
            const ttsProvider = localStorage.getItem('ttsProvider') || 'web';
            const ttsPerson = localStorage.getItem('ttsPerson') || '0'; // ÈªòËÆ§Â∫¶Â∞èÁæé(Â•≥Â£∞)
            const autoPlay = localStorage.getItem('voiceAutoPlay') === 'true';
            const rate = localStorage.getItem('voiceRate') || '1.0';
            const volume = localStorage.getItem('voiceVolume') || '1.0';

            document.getElementById('voiceProvider').value = useBaiduVoice ? 'baidu' : 'google';
            document.getElementById('ttsProvider').value = ttsProvider;
            document.getElementById('ttsPerson').value = ttsPerson;
            document.getElementById('voiceAutoPlay').checked = autoPlay;
            document.getElementById('voiceRate').value = rate;
            document.getElementById('voiceRateValue').textContent = rate + 'x';
            document.getElementById('voiceVolume').value = volume;
            document.getElementById('voiceVolumeValue').textContent = Math.round(volume * 100) + '%';

            // ÊòæÁ§∫/ÈöêËóèÁôæÂ∫¶TTSÈü≥Ëâ≤ÈÄâÊã©
            const personSetting = document.getElementById('baiduTTSPersonSetting');
            if (personSetting) {
                personSetting.style.display = ttsProvider === 'baidu' ? 'flex' : 'none';
            }
        }

        // ==================== ËÆæÁΩÆÁÆ°ÁêÜÂäüËÉΩ ====================

        // ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ
        function resetSettings() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÂêóÔºü')) {
                localStorage.removeItem('userSettings');
                localStorage.removeItem('theme');
                initSettings();
                applyThemePreference('system');
                showToast('‚úÖ ÊâÄÊúâËÆæÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº', 'success');
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñËÆæÁΩÆ
        document.addEventListener('DOMContentLoaded', function () {
            initSettings();
        });

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tabName, event) {
            // ÁßªÈô§ÊâÄÊúâtabÂíåÂÜÖÂÆπÁöÑactiveÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ÊøÄÊ¥ªÂØπÂ∫îÁöÑtabÊåâÈíÆÔºàÂ¶ÇÊûúÊòØÈÄöËøáÁÇπÂáªËß¶ÂèëÔºâ
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Â¶ÇÊûúÊòØÁ®ãÂ∫èË∞ÉÁî®ÔºåÊü•ÊâæÂØπÂ∫îÁöÑtabÊåâÈíÆÂπ∂ÊøÄÊ¥ª
                const tabButton = document.querySelector(`.tab[onclick*="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }

            // ÊøÄÊ¥ªÂØπÂ∫îÁöÑÂÜÖÂÆπÂå∫Âüü
            document.getElementById(tabName).classList.add('active');

            // Âä†ËΩΩÂØπÂ∫îtabÁöÑÊï∞ÊçÆ
            if (tabName === 'sessions') loadSessions();
            if (tabName === 'memory') loadMemoryStats();
            if (tabName === 'analytics') {
                // Ëá™Âä®Âä†ËΩΩË°å‰∏∫ÂàÜÊûêÊï∞ÊçÆ
                loadBehaviorAnalytics();
                // Ëá™Âä®Âä†ËΩΩ‰∏ªÂä®ÈóÆÁ≠îÂéÜÂè≤
                const userId = 'default_user';
                loadProactiveQA(userId);
            }
            if (tabName === 'tasks') {
                // Ëá™Âä®Âä†ËΩΩ‰ªªÂä°ÂàóË°®ÔºåÈªòËÆ§ÊòæÁ§∫ÂæÖÂÆåÊàê‰ªªÂä°
                document.getElementById('taskStatusFilter').value = 'pending';
                loadTasks();
            }
            if (tabName === 'reminders') {
                // Ëá™Âä®Âä†ËΩΩÊèêÈÜíÂàóË°®
                loadReminders();
                loadReminderHistory();
            }
            if (tabName === 'documents') {
                // Ëá™Âä®Âä†ËΩΩÊñáÊ°£ÂàóË°®
                loadDocuments();
            }
            if (tabName === 'tools') {
                // Ëá™Âä®Âä†ËΩΩÂ∑•ÂÖ∑ÂàóË°®
                loadTools();
                loadToolHistory();
            }
            if (tabName === 'schedule') {
                // Ëá™Âä®Âä†ËΩΩËØæÁ®ãË°®
                loadSchedule();
            }
        }

        // ==================== v0.8.0 ËØ≠Èü≥‰∫§‰∫íÂäüËÉΩ ====================

        let recognition = null;
        let isRecording = false;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let recognitionRetryCount = 0;
        const MAX_RETRY = 2;

        // v0.8.1 ËøûÁª≠ÂØπËØùÊ®°Âºè
        let isConversationMode = false;
        let isSpeaking = false; // AIÊ≠£Âú®ËØ¥ËØù
        let currentAudio = null; // ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥È¢ë

        // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅ
        window.addEventListener('online', function () {
            console.log('‚úÖ ÁΩëÁªúÂ∑≤ËøûÊé•ÔºåËØ≠Èü≥ËØÜÂà´ÂèØÁî®');
        });

        window.addEventListener('offline', function () {
            console.warn('‚ö†Ô∏è ÁΩëÁªúÂ∑≤Êñ≠ÂºÄÔºåËØ≠Èü≥ËØÜÂà´‰∏çÂèØÁî®');
            if (isRecording) {
                stopVoiceInput();
                showToast('ÁΩëÁªúÊñ≠ÂºÄÔºåËØ≠Èü≥ËØÜÂà´Â∑≤ÂÅúÊ≠¢', 'error');
            }
        });

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËØ≠Èü≥ËµÑÊ∫ê
        window.addEventListener('beforeunload', function () {
            console.log('üßπ È°µÈù¢Âç∏ËΩΩÔºåÊ∏ÖÁêÜËØ≠Èü≥ËµÑÊ∫ê...');

            // ÂÅúÊ≠¢ËØ≠Èü≥ÂêàÊàê
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            // ÂÅúÊ≠¢Èü≥È¢ëÊí≠Êîæ
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // ÂÅúÊ≠¢ÂΩïÈü≥
            if (isRecording) {
                stopVoiceInput();
            }

            // ÂÖ≥Èó≠ÂØπËØùÊ®°Âºè
            if (isConversationMode) {
                isConversationMode = false;
            }
        });

        // È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúËØ≠Èü≥ÔºàÂàáÊç¢Ê†áÁ≠æÈ°µ„ÄÅÊúÄÂ∞èÂåñÁ™óÂè£Á≠âÔºâ
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                console.log('üìµ È°µÈù¢ÈöêËóèÔºåÊöÇÂÅúËØ≠Èü≥Êí≠Êîæ');

                // ÊöÇÂÅúËØ≠Èü≥ÂêàÊàê
                if (speechSynthesis.speaking) {
                    speechSynthesis.pause();
                }

                // ÊöÇÂÅúÈü≥È¢ë
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                }
            } else {
                console.log('üì± È°µÈù¢ÊòæÁ§∫ÔºåÊÅ¢Â§çËØ≠Èü≥Êí≠Êîæ');

                // ÊÅ¢Â§çËØ≠Èü≥ÂêàÊàê
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                }

                // ÊÅ¢Â§çÈü≥È¢ëÔºàÂèØÈÄâÔºåÈÅøÂÖçÁ™ÅÁÑ∂Êí≠ÊîæÔºâ
                // if (currentAudio && currentAudio.paused) {
                //     currentAudio.play();
                // }
            }
        });

        // ÂàùÂßãÂåñËØ≠Èü≥ËØÜÂà´
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.lang = 'zh-CN';  // ‰∏≠ÊñáËØÜÂà´
            recognition.continuous = false;  // ‰∏çÊåÅÁª≠ËØÜÂà´
            recognition.interimResults = true;  // ÊòæÁ§∫‰∏¥Êó∂ÁªìÊûú
            recognition.maxAlternatives = 1;  // Âè™ËøîÂõûÊúÄ‰Ω≥ÁªìÊûú

            // Ê∑ªÂä†ËØ¶ÁªÜÊó•Âøó
            console.log('üîß ËØ≠Èü≥ËØÜÂà´ÈÖçÁΩÆ:', {
                lang: recognition.lang,
                continuous: recognition.continuous,
                interimResults: recognition.interimResults
            });

            recognition.onstart = function () {
                console.log('üé§ ËØ≠Èü≥ËØÜÂà´ÂºÄÂßã');
                isRecording = true;
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceStatus = document.getElementById('voiceStatus');
                const voiceText = document.getElementById('voiceText');

                voiceBtn.classList.add('recording');
                voiceStatus.style.display = 'flex';
                voiceText.textContent = 'Ê≠£Âú®ËÅÜÂê¨...';
            };

            recognition.onresult = function (event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const voiceText = document.getElementById('voiceText');
                if (interimTranscript) {
                    voiceText.textContent = interimTranscript;
                }

                if (finalTranscript) {
                    console.log('‚úÖ ËØÜÂà´ÁªìÊûú:', finalTranscript);
                    const input = document.getElementById('messageInput');
                    input.textContent = finalTranscript;
                    input.focus();

                    // ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöËá™Âä®ÂèëÈÄÅ
                    if (isConversationMode) {
                        setTimeout(() => autoSendInConversationMode(finalTranscript), 500);
                    }
                }
            };

            recognition.onerror = function (event) {
                console.error('‚ùå ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', event.error, event);
                const voiceText = document.getElementById('voiceText');

                switch (event.error) {
                    case 'no-speech':
                        voiceText.textContent = 'Ê≤°ÊúâÊ£ÄÊµãÂà∞ËØ≠Èü≥ÔºåËØ∑ÈáçËØï';
                        break;
                    case 'audio-capture':
                        voiceText.textContent = 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é';
                        break;
                    case 'not-allowed':
                        voiceText.textContent = 'È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªù';
                        break;
                    case 'network':
                        voiceText.textContent = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï';
                        console.warn('üí° ÊèêÁ§∫: ËØ≠Èü≥ËØÜÂà´ÈúÄË¶ÅÁΩëÁªúËøûÊé•ÔºåËØ∑Á°Æ‰øùÁΩëÁªúÊ≠£Â∏∏');
                        break;
                    case 'service-not-allowed':
                        voiceText.textContent = 'ËØ≠Èü≥ÊúçÂä°‰∏çÂèØÁî®';
                        break;
                    case 'aborted':
                        voiceText.textContent = 'ËØÜÂà´Â∑≤ÂèñÊ∂à';
                        break;
                    default:
                        voiceText.textContent = `ËØÜÂà´Âá∫Èîô: ${event.error}`;
                        console.error('Êú™Áü•ÈîôËØØÁ±ªÂûã:', event.error);
                }

                setTimeout(() => {
                    stopVoiceInput();
                }, 3000);
            };

            recognition.onend = function () {
                console.log('üé§ ËØ≠Èü≥ËØÜÂà´ÁªìÊùü');
                stopVoiceInput();
            };

            return recognition;
        }

        // ÂàáÊç¢ËØ≠Èü≥ËæìÂÖ•
        function toggleVoiceInput() {
            // ‰ºòÂÖà‰ΩøÁî®ÁôæÂ∫¶ËØ≠Èü≥ËØÜÂà´
            const useBaiduVoice = localStorage.getItem('useBaiduVoice') === 'true';

            if (useBaiduVoice) {
                toggleBaiduVoiceInput();
            } else {
                toggleGoogleVoiceInput();
            }
        }

        // Google ËØ≠Èü≥ËØÜÂà´ÔºàÂéüÊñπÊ≥ïÔºâ
        function toggleGoogleVoiceInput() {
            // Ê£ÄÊü•ÁΩëÁªúËøûÊé•
            if (!navigator.onLine) {
                alert('‚ö†Ô∏è ÁΩëÁªúÊú™ËøûÊé•\n\nËØ≠Èü≥ËØÜÂà´ÈúÄË¶ÅÁΩëÁªúËøûÊé•ÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËÆæÁΩÆ„ÄÇ');
                return;
            }

            // ËØäÊñ≠ËØ≠Èü≥ËØÜÂà´ÂèØÁî®ÊÄß
            console.log('üîç GoogleËØ≠Èü≥ËØÜÂà´ËØäÊñ≠:');
            console.log('- ÊµèËßàÂô®:', navigator.userAgent);
            console.log('- Âú®Á∫øÁä∂ÊÄÅ:', navigator.onLine);
            console.log('- ËØ≠Èü≥ËØÜÂà´ÊîØÊåÅ:', 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window);

            if (!recognition) {
                recognition = initSpeechRecognition();
                if (!recognition) {
                    alert('‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´\n\nÂª∫ËÆÆ‰ΩøÁî®:\n‚úÖ Chrome ÊµèËßàÂô®ÔºàÊé®ËçêÔºâ\n‚úÖ Edge ÊµèËßàÂô®\n‚úÖ Safari ÊµèËßàÂô®\n\nüí° ÊèêÁ§∫ÔºöËØ≠Èü≥ËØÜÂà´ÈúÄË¶ÅÁΩëÁªúËøûÊé•');
                    return;
                }
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    // ÊòæÁ§∫ÂáÜÂ§áÊèêÁ§∫
                    const voiceStatus = document.getElementById('voiceStatus');
                    const voiceText = document.getElementById('voiceText');
                    voiceStatus.style.display = 'flex';
                    voiceText.textContent = 'Ê≠£Âú®ÂáÜÂ§á...';

                    recognition.start();
                } catch (e) {
                    console.error('ÂêØÂä®ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•:', e);

                    // Êõ¥ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    let errorMsg = 'ÂêØÂä®ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•';
                    if (e.message.includes('already started')) {
                        errorMsg = 'ËØ≠Èü≥ËØÜÂà´Â∑≤ÁªèÂú®ËøêË°å‰∏≠ÔºåËØ∑Á®çÂÄô';
                        // ÈáçÁΩÆÁä∂ÊÄÅ
                        stopVoiceInput();
                        setTimeout(() => {
                            toggleVoiceInput();
                        }, 500);
                        return;
                    } else if (e.message.includes('not allowed')) {
                        errorMsg = 'È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªù\n\nËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ';
                    } else {
                        errorMsg += '\n\n' + e.message;
                    }

                    alert('‚ùå ' + errorMsg + '\n\nüí° Âª∫ËÆÆÔºöÂà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                    stopVoiceInput();
                }
            }
        }

        // ÂÅúÊ≠¢ËØ≠Èü≥ËæìÂÖ•
        function stopVoiceInput() {
            isRecording = false;
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');

            voiceBtn.classList.remove('recording');
            voiceStatus.style.display = 'none';

            // ÂÅúÊ≠¢ÁôæÂ∫¶ÂΩïÈü≥Âô®
            if (baiduRecorder && baiduRecorder.recording) {
                baiduRecorder.recording = false;

                try {
                    if (baiduRecorder.processor) {
                        baiduRecorder.processor.disconnect();
                        baiduRecorder.processor = null;
                    }
                    if (baiduRecorder.source) {
                        baiduRecorder.source.disconnect();
                        baiduRecorder.source = null;
                    }
                    if (baiduRecorder.stream) {
                        baiduRecorder.stream.getTracks().forEach(t => t.stop());
                        baiduRecorder.stream = null;
                    }
                    if (baiduRecorder.audioContext) {
                        baiduRecorder.audioContext.close();
                        baiduRecorder.audioContext = null;
                    }
                    baiduRecorder.bufferL = [];
                } catch (e) {
                    console.error('ÂÅúÊ≠¢ÁôæÂ∫¶ÂΩïÈü≥Âô®Âá∫Èîô:', e);
                }
            }
        }

        // ==================== ÁôæÂ∫¶ËØ≠Èü≥ËØÜÂà´ ====================

        // Âü∫‰∫é Web Audio API ÁöÑ WAV(PCM16) ÂΩïÈü≥Âô®ÔºåÈááÊ†∑Áéá 16k ‰ª•ÈÄÇÈÖçÁôæÂ∫¶ASR
        let baiduRecorder = {
            audioContext: null,
            source: null,
            processor: null,
            analyser: null,
            stream: null,
            bufferL: [],
            sampleRate: 16000,
            recording: false,
            silenceStart: 0,
            silenceThreshold: 0.01, // ÈùôÈü≥ÈòàÂÄº
            silenceDuration: 1500,  // ÈùôÈü≥ÊåÅÁª≠Êó∂Èó¥ÔºàÊØ´ÁßíÔºâÔºå1.5ÁßíÂêéËá™Âä®ÂÅúÊ≠¢
            hasSpoken: false,       // ÊòØÂê¶Ê£ÄÊµãÂà∞ËØ¥ËØù
            listeningMode: false,   // ÁõëÂê¨Ê®°ÂºèÔºöÁ≠âÂæÖÁî®Êà∑ÊâìÊñ≠AIËØ¥ËØù
        };

        function mergeBuffers(bufferArray) {
            let length = 0;
            bufferArray.forEach(b => length += b.length);
            const result = new Float32Array(length);
            let offset = 0;
            bufferArray.forEach(b => { result.set(b, offset); offset += b.length; });
            return result;
        }

        // Èü≥È¢ëÂΩí‰∏ÄÂåñÂíåÂ¢ûÁõä
        function normalizeAndBoost(buffer, targetPeak = 0.95, minGain = 1.5) {
            // ÊâæÂà∞ÊúÄÂ§ßÊåØÂπÖ
            let max = 0;
            for (let i = 0; i < buffer.length; i++) {
                const abs = Math.abs(buffer[i]);
                if (abs > max) max = abs;
            }

            // ËÆ°ÁÆóÂ¢ûÁõä
            let gain = 1.0;
            if (max > 0) {
                gain = Math.max(targetPeak / max, minGain);
            } else {
                gain = minGain;
            }

            // ÈôêÂà∂ÊúÄÂ§ßÂ¢ûÁõäÔºåÈÅøÂÖçËøáÂ∫¶ÊîæÂ§ßÂô™Èü≥
            gain = Math.min(gain, 8.0);

            console.log(`üîä Èü≥È¢ëÂ¢ûÁõä: ${gain.toFixed(2)}x (ÂéüÂßãÂ≥∞ÂÄº: ${(max * 100).toFixed(1)}%)`);

            // Â∫îÁî®Â¢ûÁõä
            const result = new Float32Array(buffer.length);
            for (let i = 0; i < buffer.length; i++) {
                result[i] = Math.max(-1, Math.min(1, buffer[i] * gain));
            }

            return result;
        }

        function downsampleBuffer(buffer, inSampleRate, outSampleRate) {
            if (outSampleRate === inSampleRate) return buffer;
            const ratio = inSampleRate / outSampleRate;
            const newLength = Math.round(buffer.length / ratio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
                let accum = 0, count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            const bytesPerSample = 2;
            const numChannels = 1;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');

            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // PCM
            view.setUint16(20, 1, true);  // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // 16-bit

            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * bytesPerSample, true);

            // PCM samples
            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // üéß ÂêØÂä®ÁõëÂê¨Ê®°ÂºèÔºöÂú®AIËØ¥ËØùÊó∂ÁõëÂê¨Áî®Êà∑ÊâìÊñ≠
        async function startListeningForInterrupt() {
            if (!isConversationMode || !isSpeaking) return;
            if (baiduRecorder.listeningMode) return; // Â∑≤ÁªèÂú®ÁõëÂê¨‰∏≠

            console.log('üéß ÂêØÂä®ÊâìÊñ≠ÁõëÂê¨Ê®°Âºè...');

            try {
                // ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£éÊùÉÈôê
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // ÂàõÂª∫Èü≥È¢ëÂàÜÊûêÂô®
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂØπË±°
                baiduRecorder.listeningStream = stream;
                baiduRecorder.listeningContext = audioContext;
                baiduRecorder.listeningSource = source;
                baiduRecorder.listeningAnalyser = analyser;
                baiduRecorder.listeningProcessor = processor;
                baiduRecorder.listeningMode = true;

                // ÊâìÊñ≠Ê£ÄÊµãÂèÇÊï∞
                let interruptThreshold = 0.05; // ÊèêÈ´òÈòàÂÄºÔºåÈÅøÂÖçËØØËß¶ÂèëÔºàÂéüÊù•0.01Â§™‰ΩéÔºâ
                let interruptCount = 0;        // ËøûÁª≠Ê£ÄÊµãËÆ°Êï∞
                let requiredCount = 3;         // ÈúÄË¶ÅËøûÁª≠3Ê¨°Ê£ÄÊµãÂà∞Â£∞Èü≥ÊâçËß¶ÂèëÔºàÁ∫¶0.3ÁßíÔºâ
                let startDelay = 500;          // ÂêØÂä®ÂêéÂª∂Ëøü500msÊâçÂºÄÂßãÊ£ÄÊµãÔºåÈÅøÂÖçÂõûÂ£∞
                let startTime = Date.now();

                // ÁõëÂê¨Èü≥È¢ëËæìÂÖ•
                processor.onaudioprocess = function (e) {
                    if (!baiduRecorder.listeningMode) return;

                    // ÂêØÂä®Âª∂Ëøü‰øùÊä§ÔºöÂâç500ms‰∏çÊ£ÄÊµã
                    if (Date.now() - startTime < startDelay) {
                        return;
                    }

                    const channel = e.inputBuffer.getChannelData(0);

                    // ËÆ°ÁÆóÈü≥Èáè
                    let sum = 0;
                    for (let i = 0; i < channel.length; i++) {
                        sum += channel[i] * channel[i];
                    }
                    const rms = Math.sqrt(sum / channel.length);

                    // ËøûÁª≠ÊÄßÊ£ÄÊµãÔºöÈúÄË¶ÅËøûÁª≠Â§öÊ¨°Ê£ÄÊµãÂà∞Â£∞Èü≥ÊâçËß¶Âèë
                    if (rms > interruptThreshold) {
                        interruptCount++;
                        console.log(`üé§ Ê£ÄÊµãÂà∞Â£∞Èü≥ (${interruptCount}/${requiredCount}): RMS=${rms.toFixed(4)}`);

                        if (interruptCount >= requiredCount) {
                            console.log('‚úÖ Á°ÆËÆ§Áî®Êà∑ËØ¥ËØùÔºåÊâìÊñ≠AI');

                            // ÂÅúÊ≠¢ÁõëÂê¨Ê®°Âºè
                            stopListeningMode();

                            // ÊâìÊñ≠AIÂπ∂ÂºÄÂßãÊ≠£ÂºèÂΩïÈü≥
                            if (isSpeaking) {
                                stopSpeaking();
                            }

                            // Á´ãÂç≥ÂºÄÂßãÂΩïÈü≥
                            setTimeout(() => {
                                if (isConversationMode && !isRecording) {
                                    console.log('üé§ ‰ªéÁõëÂê¨Ê®°ÂºèÂàáÊç¢Âà∞ÂΩïÈü≥Ê®°Âºè');
                                    toggleBaiduVoiceInput();
                                }
                            }, 100);
                        }
                    } else {
                        // Ê≤°ÊúâÂ£∞Èü≥ÔºåÈáçÁΩÆËÆ°Êï∞
                        if (interruptCount > 0) {
                            console.log(`üîá Â£∞Èü≥‰∏≠Êñ≠ÔºåÈáçÁΩÆËÆ°Êï∞ (‰πãÂâç: ${interruptCount})`);
                        }
                        interruptCount = 0;
                    }
                };

                // ËøûÊé•Èü≥È¢ëËäÇÁÇπ
                source.connect(analyser);
                analyser.connect(processor);
                processor.connect(audioContext.destination);

                console.log('‚úÖ ÊâìÊñ≠ÁõëÂê¨Ê®°ÂºèÂ∑≤ÊøÄÊ¥ª');

            } catch (error) {
                console.error('‚ùå ÂêØÂä®ÁõëÂê¨Ê®°ÂºèÂ§±Ë¥•:', error);
                baiduRecorder.listeningMode = false;
            }
        }

        // ÂÅúÊ≠¢ÁõëÂê¨Ê®°Âºè
        function stopListeningMode() {
            if (!baiduRecorder.listeningMode) return;

            console.log('üõë ÂÅúÊ≠¢ÊâìÊñ≠ÁõëÂê¨Ê®°Âºè');

            try {
                if (baiduRecorder.listeningProcessor) {
                    baiduRecorder.listeningProcessor.disconnect();
                    baiduRecorder.listeningProcessor = null;
                }
                if (baiduRecorder.listeningAnalyser) {
                    baiduRecorder.listeningAnalyser.disconnect();
                    baiduRecorder.listeningAnalyser = null;
                }
                if (baiduRecorder.listeningSource) {
                    baiduRecorder.listeningSource.disconnect();
                    baiduRecorder.listeningSource = null;
                }
                if (baiduRecorder.listeningStream) {
                    baiduRecorder.listeningStream.getTracks().forEach(track => track.stop());
                    baiduRecorder.listeningStream = null;
                }
                if (baiduRecorder.listeningContext) {
                    baiduRecorder.listeningContext.close();
                    baiduRecorder.listeningContext = null;
                }
            } catch (e) {
                console.log('Ê∏ÖÁêÜÁõëÂê¨Ê®°ÂºèËµÑÊ∫ê:', e);
            }

            baiduRecorder.listeningMode = false;
        }

        async function toggleBaiduVoiceInput() {
            if (isRecording) {
                // ÊâãÂä®ÂÅúÊ≠¢ÂΩïÈü≥Âπ∂ËØÜÂà´
                await processBaiduRecording();
                return;
            }

            // Â¶ÇÊûúAIÊ≠£Âú®ËØ¥ËØùÔºåÂÖàÂÅúÊ≠¢
            if (isSpeaking) {
                console.log('‚è∏Ô∏è ÊâìÊñ≠AIËØ¥ËØùÔºåÂºÄÂßãÂΩïÈü≥');
                stopSpeaking();
            }

            try {
                // ÂÖàÊ∏ÖÁêÜ‰πãÂâçÁöÑÂΩïÈü≥Âô®Áä∂ÊÄÅ
                if (baiduRecorder.audioContext) {
                    try {
                        await baiduRecorder.audioContext.close();
                    } catch (e) {
                        console.log('ÂÖ≥Èó≠ÊóßAudioContext:', e);
                    }
                }

                // ÈáçÁΩÆÂΩïÈü≥Âô®ÂØπË±°
                baiduRecorder = {
                    audioContext: null,
                    source: null,
                    processor: null,
                    analyser: null,
                    stream: null,
                    bufferL: [],
                    sampleRate: 16000,
                    recording: false,
                    silenceStart: 0,
                    silenceThreshold: 0.01,
                    silenceDuration: 1500,
                    hasSpoken: false,
                };

                // ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£éÊùÉÈôê
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // ÊòæÁ§∫ÂΩïÈü≥Áä∂ÊÄÅ
                isRecording = true;
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceStatus = document.getElementById('voiceStatus');
                const voiceText = document.getElementById('voiceText');

                voiceBtn.classList.add('recording');
                voiceStatus.style.display = 'flex';
                voiceText.textContent = 'ËØ∑ÂºÄÂßãËØ¥ËØù...';

                // ÂàõÂª∫ Web Audio ÂΩïÈü≥ÊµÅÁ®ã
                baiduRecorder.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                baiduRecorder.stream = stream;
                baiduRecorder.source = baiduRecorder.audioContext.createMediaStreamSource(stream);
                baiduRecorder.analyser = baiduRecorder.audioContext.createAnalyser();
                baiduRecorder.analyser.fftSize = 2048;
                baiduRecorder.processor = baiduRecorder.audioContext.createScriptProcessor(4096, 1, 1);
                baiduRecorder.bufferL = [];
                baiduRecorder.recording = true;
                baiduRecorder.silenceStart = Date.now();

                // Èü≥È¢ëÂ§ÑÁêÜÂíåÈùôÈü≥Ê£ÄÊµã
                baiduRecorder.processor.onaudioprocess = function (e) {
                    if (!baiduRecorder.recording) return;

                    const channel = e.inputBuffer.getChannelData(0);
                    // Êã∑Ë¥ùÊï∞ÊçÆ
                    baiduRecorder.bufferL.push(new Float32Array(channel));

                    // ËÆ°ÁÆóÈü≥ÈáèÔºàRMSÔºâ
                    let sum = 0;
                    for (let i = 0; i < channel.length; i++) {
                        sum += channel[i] * channel[i];
                    }
                    const rms = Math.sqrt(sum / channel.length);

                    // ÈùôÈü≥Ê£ÄÊµã
                    if (rms > baiduRecorder.silenceThreshold) {
                        // Ê£ÄÊµãÂà∞Â£∞Èü≥
                        if (!baiduRecorder.hasSpoken) {
                            // Á¨¨‰∏ÄÊ¨°Ê£ÄÊµãÂà∞Â£∞Èü≥
                            baiduRecorder.hasSpoken = true;

                            // üéØ ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöÊ£ÄÊµãÂà∞Áî®Êà∑ËØ¥ËØùÔºåÁ´ãÂç≥ÊâìÊñ≠AI
                            if (isConversationMode && isSpeaking) {
                                console.log('üëÇ Ê£ÄÊµãÂà∞Áî®Êà∑ËØ¥ËØùÔºåÊâìÊñ≠AIÊí≠Êîæ');
                                stopSpeaking();
                                const stateText = document.getElementById('conversationStateText');
                                if (stateText) {
                                    stateText.textContent = 'Ê≠£Âú®ÂΩïÈü≥...';
                                }
                            }
                        }

                        baiduRecorder.silenceStart = Date.now();
                        voiceText.textContent = 'Ê≠£Âú®ÂΩïÈü≥...üé§';
                    } else if (baiduRecorder.hasSpoken) {
                        // ËØ¥ËØùÂêéÁöÑÈùôÈü≥
                        const silenceDuration = Date.now() - baiduRecorder.silenceStart;
                        if (silenceDuration > baiduRecorder.silenceDuration) {
                            console.log('üîá Ê£ÄÊµãÂà∞ÈùôÈü≥ÔºåËá™Âä®ÂÅúÊ≠¢ÂΩïÈü≥');
                            voiceText.textContent = 'Ê£ÄÊµãÂà∞ÈùôÈü≥ÔºåÊ≠£Âú®ËØÜÂà´...';
                            // Ëá™Âä®ÂÅúÊ≠¢Âπ∂ËØÜÂà´
                            setTimeout(() => processBaiduRecording(), 100);
                        }
                    }
                };

                // ËøûÊé•Èü≥È¢ëËäÇÁÇπ
                baiduRecorder.source.connect(baiduRecorder.analyser);
                baiduRecorder.analyser.connect(baiduRecorder.processor);
                baiduRecorder.processor.connect(baiduRecorder.audioContext.destination);

                console.log('üé§ ÁôæÂ∫¶ËØ≠Èü≥ÂΩïÈü≥ÂºÄÂßã (Ëá™Âä®ÈùôÈü≥Ê£ÄÊµã)');
                console.log('   AudioContextÈááÊ†∑Áéá:', baiduRecorder.audioContext.sampleRate);
                console.log('   ÈùôÈü≥ÈòàÂÄº:', baiduRecorder.silenceThreshold);
                console.log('   ÈùôÈü≥Êó∂Èïø:', baiduRecorder.silenceDuration + 'ms');

            } catch (error) {
                console.error('‚ùå È∫¶ÂÖãÈ£éËÆøÈóÆÂ§±Ë¥•:', error);

                let errorMsg = 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªù\n\nËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'Êú™ÊâæÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á\n\nËØ∑Ê£ÄÊü•È∫¶ÂÖãÈ£éÊòØÂê¶Ê≠£Â∏∏ËøûÊé•';
                } else if (error.name === 'NotReadableError') {
                    errorMsg = 'È∫¶ÂÖãÈ£éË¢´ÂÖ∂‰ªñÁ®ãÂ∫èÂç†Áî®\n\nËØ∑ÂÖ≥Èó≠ÂÖ∂‰ªñ‰ΩøÁî®È∫¶ÂÖãÈ£éÁöÑÁ®ãÂ∫è';
                }

                showToast('‚ùå ' + errorMsg, 'error');
                stopVoiceInput();
            }
        }

        // Â§ÑÁêÜÁôæÂ∫¶ÂΩïÈü≥ËØÜÂà´
        async function processBaiduRecording() {
            if (!baiduRecorder || !baiduRecorder.recording) return;

            try {
                baiduRecorder.recording = false;

                if (baiduRecorder.processor) {
                    baiduRecorder.processor.disconnect();
                }
                if (baiduRecorder.analyser) {
                    baiduRecorder.analyser.disconnect();
                }
                if (baiduRecorder.source) {
                    baiduRecorder.source.disconnect();
                }
                if (baiduRecorder.stream) {
                    baiduRecorder.stream.getTracks().forEach(t => t.stop());
                }

                // Ê£ÄÊü•ÊòØÂê¶ÂΩïÂà∞Èü≥È¢ë
                if (baiduRecorder.bufferL.length === 0) {
                    showToast('‚ö†Ô∏è Êú™Ê£ÄÊµãÂà∞Èü≥È¢ëËæìÂÖ•', 'warning');
                    stopVoiceInput();
                    return;
                }

                // ÂêàÂπ∂„ÄÅÂ¢ûÁõä„ÄÅÈôçÈááÊ†∑Âπ∂ÁºñÁ†Å‰∏∫ WAV 16k
                const raw = mergeBuffers(baiduRecorder.bufferL);
                const boosted = normalizeAndBoost(raw);
                const inRate = baiduRecorder.audioContext.sampleRate;
                const down = downsampleBuffer(boosted, inRate, 16000);
                const wavBlob = encodeWAV(down, 16000);

                // ‰∏ä‰º†ËØÜÂà´
                const voiceText = document.getElementById('voiceText');
                voiceText.textContent = 'Ê≠£Âú®ËØÜÂà´...';

                const formData = new FormData();
                formData.append('file', wavBlob, 'audio.wav');
                const response = await fetch('/api/voice/recognize', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    const input = document.getElementById('messageInput');
                    input.textContent = result.text;
                    input.focus();
                    showToast('‚úÖ ËØÜÂà´ÊàêÂäü', 'success');

                    // ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöËá™Âä®ÂèëÈÄÅ
                    if (isConversationMode) {
                        setTimeout(() => autoSendInConversationMode(result.text), 500);
                    }
                } else {
                    showToast('‚ùå ËØÜÂà´Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
                }
            } catch (e) {
                console.error('ÂÅúÊ≠¢ÊàñËØÜÂà´Âá∫Èîô:', e);
                showToast('‚ùå ËØÜÂà´ËØ∑Ê±ÇÂ§±Ë¥•', 'error');
            } finally {
                stopVoiceInput();
            }
        }

        // ==================== v0.8.1 ËøûÁª≠ÂØπËØùÊ®°Âºè ====================

        // ÂàáÊç¢ËøûÁª≠ÂØπËØùÊ®°Âºè
        function toggleConversationMode() {
            isConversationMode = !isConversationMode;

            const btn = document.getElementById('conversationModeBtn');
            const statusDiv = document.getElementById('conversationModeStatus');
            const stateText = document.getElementById('conversationStateText');

            if (isConversationMode) {
                // ÂºÄÂêØÂØπËØùÊ®°Âºè
                btn.classList.add('active');
                statusDiv.style.display = 'block';
                stateText.textContent = 'ÂØπËØùÊ®°ÂºèÂ∑≤ÂºÄÂêØ';
                showToast('üé§ ËøûÁª≠ÂØπËØùÊ®°ÂºèÂ∑≤ÂºÄÂêØ', 'success');
                console.log('üîä ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöÂ∑≤ÂºÄÂêØ');

                // Ëá™Âä®ÂºÄÂßãÁ¨¨‰∏ÄËΩÆÂΩïÈü≥
                setTimeout(() => {
                    if (isConversationMode && !isRecording && !isSpeaking) {
                        startConversationRound();
                    }
                }, 500);
            } else {
                // ÂÖ≥Èó≠ÂØπËØùÊ®°Âºè
                btn.classList.remove('active');
                statusDiv.style.display = 'none';
                showToast('‚è∏Ô∏è ËøûÁª≠ÂØπËØùÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠', 'info');
                console.log('üîá ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöÂ∑≤ÂÖ≥Èó≠');

                // ÂÅúÊ≠¢ÂΩìÂâçÂΩïÈü≥
                if (isRecording) {
                    stopVoiceInput();
                }
                // ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                if (currentUtterance) {
                    speechSynthesis.cancel();
                    currentUtterance = null;
                }
                isSpeaking = false;
            }
        }

        // ÂºÄÂßã‰∏ÄËΩÆÂØπËØùÔºàÂΩïÈü≥Ôºâ
        function startConversationRound() {
            if (!isConversationMode) return;
            if (isRecording) return; // Âè™Ê£ÄÊü•ÂΩïÈü≥Áä∂ÊÄÅÔºåÂÖÅËÆ∏ÊâìÊñ≠AIËØ¥ËØù

            // Â¶ÇÊûúAIÊ≠£Âú®ËØ¥ËØùÔºåÂÖàÂÅúÊ≠¢
            if (isSpeaking) {
                console.log('‚è∏Ô∏è ÊâìÊñ≠AIËØ¥ËØùÔºåÂºÄÂßãÊñ∞ÂΩïÈü≥');
                stopSpeaking();
            }

            console.log('üé§ ÂºÄÂßãÊñ∞‰∏ÄËΩÆÂØπËØùÂΩïÈü≥...');
            const stateText = document.getElementById('conversationStateText');
            stateText.textContent = 'ËØ∑ÂºÄÂßãËØ¥ËØù...';

            // Ëß¶ÂèëËØ≠Èü≥ËæìÂÖ•
            toggleVoiceInput();
        }

        // Âú®ËØÜÂà´ÊàêÂäüÂêéËá™Âä®ÂèëÈÄÅÔºàËøûÁª≠ÂØπËØùÊ®°Âºè‰∏ìÁî®Ôºâ
        async function autoSendInConversationMode(text) {
            if (!isConversationMode) return;

            console.log('üì§ ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöËá™Âä®ÂèëÈÄÅÊ∂àÊÅØ');
            const stateText = document.getElementById('conversationStateText');
            stateText.textContent = 'AIÊ≠£Âú®ÊÄùËÄÉ...';

            // Â°´ÂÖ•ËæìÂÖ•Ê°Ü
            const input = document.getElementById('messageInput');
            input.textContent = text;

            // Ëá™Âä®ÂèëÈÄÅ
            await sendMessageFromDiv();
        }

        // Âú®AIÂõûÂ§çÊí≠ÊîæÂÆåÊàêÂêéÁªßÁª≠‰∏ã‰∏ÄËΩÆ
        function onSpeechEnd() {
            isSpeaking = false;
            console.log('üîö ËØ≠Èü≥Êí≠ÊîæÂÆåÊàê');

            // ÂÅúÊ≠¢ÁõëÂê¨Ê®°Âºè
            stopListeningMode();

            if (isConversationMode) {
                console.log('‚ôªÔ∏è ËøûÁª≠ÂØπËØùÊ®°ÂºèÔºöÂáÜÂ§á‰∏ã‰∏ÄËΩÆ');
                const stateText = document.getElementById('conversationStateText');
                stateText.textContent = 'ËØ∑ÁªßÁª≠ËØ¥ËØù...';

                // Á≠âÂæÖ1ÁßíÂêéÂºÄÂßã‰∏ã‰∏ÄËΩÆ
                setTimeout(() => {
                    if (isConversationMode && !isRecording && !isSpeaking) {
                        startConversationRound();
                    }
                }, 1000);
            }
        }

        // ËØ≠Èü≥Êí≠ÊîæAIÂõûÂ§çÔºàÊîØÊåÅ WebSpeech Êàñ ÁôæÂ∫¶TTSÔºâ
        async function speakText(text) {
            // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®Ëá™Âä®Êí≠ÊîæÔºàËøûÁª≠ÂØπËØùÊ®°ÂºèÂº∫Âà∂Êí≠ÊîæÔºâ
            const autoPlay = localStorage.getItem('voiceAutoPlay') === 'true' || isConversationMode;
            if (!autoPlay) return;

            isSpeaking = true;

            // ÊòæÁ§∫ÂÖ®Â±ÄÂÅúÊ≠¢ÊåâÈíÆ
            const globalStopBtn = document.getElementById('globalStopSpeakingBtn');
            if (globalStopBtn) {
                globalStopBtn.style.display = 'flex';
            }

            // ÊòæÁ§∫Êí≠ÊîæÁä∂ÊÄÅÊåáÁ§∫Âô®
            const speakingStatus = document.getElementById('speakingStatus');
            if (speakingStatus) {
                speakingStatus.style.display = 'flex';
            }

            if (isConversationMode) {
                const stateText = document.getElementById('conversationStateText');
                stateText.textContent = 'AIÊ≠£Âú®ÂõûÂ§ç...ÔºàÁÇπÂáªüé§ÊàñÊåâÁ©∫Ê†ºÊâìÊñ≠Ôºâ';

                // ‰∏çÂÜçËá™Âä®ÂêØÂä®ÁõëÂê¨Ê®°ÂºèÔºåÊîπ‰∏∫Áî®Êà∑‰∏ªÂä®ÊâìÊñ≠
                // startListeningForInterrupt();
            }

            const ttsProvider = (localStorage.getItem('ttsProvider') || 'web').toLowerCase();
            if (ttsProvider === 'baidu') {
                try {
                    const resp = await fetch('/api/voice/synthesize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text,
                            person: parseInt(localStorage.getItem('ttsPerson') || '0', 10),
                            speed: parseInt(localStorage.getItem('voiceRateNum') || '5', 10),
                            pitch: 5,
                            volume: Math.round(parseFloat(localStorage.getItem('voiceVolume') || '1.0') * 10),
                            audio_format: 'mp3'
                        })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        currentAudio = new Audio(`data:${data.mime};base64,${data.audio_base64}`);
                        currentAudio.onended = () => {
                            currentAudio = null;
                            // ÈöêËóèÂÅúÊ≠¢ÊåâÈíÆÂíåÊí≠ÊîæÁä∂ÊÄÅ
                            if (globalStopBtn) {
                                globalStopBtn.style.display = 'none';
                            }
                            const speakingStatus = document.getElementById('speakingStatus');
                            if (speakingStatus) {
                                speakingStatus.style.display = 'none';
                            }
                            onSpeechEnd();
                        };
                        currentAudio.onerror = () => {
                            currentAudio = null;
                            isSpeaking = false;
                            // ÈöêËóèÂÅúÊ≠¢ÊåâÈíÆÂíåÊí≠ÊîæÁä∂ÊÄÅ
                            if (globalStopBtn) {
                                globalStopBtn.style.display = 'none';
                            }
                            const speakingStatus = document.getElementById('speakingStatus');
                            if (speakingStatus) {
                                speakingStatus.style.display = 'none';
                            }
                        };
                        currentAudio.play().catch(e => {
                            console.warn('Ëá™Âä®Êí≠ÊîæÂèóÈòª:', e);
                            isSpeaking = false;
                            // ÈöêËóèÂÅúÊ≠¢ÊåâÈíÆÂíåÊí≠ÊîæÁä∂ÊÄÅ
                            if (globalStopBtn) {
                                globalStopBtn.style.display = 'none';
                            }
                            const speakingStatus = document.getElementById('speakingStatus');
                            if (speakingStatus) {
                                speakingStatus.style.display = 'none';
                            }
                        });
                        return;
                    } else {
                        console.warn('ÁôæÂ∫¶TTSÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞WebSpeech:', data.error);
                    }
                } catch (e) {
                    console.warn('ÁôæÂ∫¶TTSË∞ÉÁî®ÂºÇÂ∏∏ÔºåÂõûÈÄÄÂà∞WebSpeech:', e);
                }
            }

            // ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            // ÂàõÂª∫Êñ∞ÁöÑËØ≠Èü≥ÂêàÊàêÂÆû‰æã
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'zh-CN';
            currentUtterance.rate = parseFloat(localStorage.getItem('voiceRate') || '1.0');
            currentUtterance.volume = parseFloat(localStorage.getItem('voiceVolume') || '1.0');

            currentUtterance.onstart = function () {
                console.log('üîä ÂºÄÂßãÊí≠ÊîæËØ≠Èü≥');
            };

            currentUtterance.onend = function () {
                console.log('üîä Êí≠ÊîæÁªìÊùü');
                currentUtterance = null;
                // ÈöêËóèÂÅúÊ≠¢ÊåâÈíÆÂíåÊí≠ÊîæÁä∂ÊÄÅ
                if (globalStopBtn) {
                    globalStopBtn.style.display = 'none';
                }
                const speakingStatus = document.getElementById('speakingStatus');
                if (speakingStatus) {
                    speakingStatus.style.display = 'none';
                }
                onSpeechEnd();
            };

            currentUtterance.onerror = function (event) {
                console.error('ËØ≠Èü≥Êí≠ÊîæÈîôËØØ:', event.error);
                currentUtterance = null;
                isSpeaking = false;
                // ÈöêËóèÂÅúÊ≠¢ÊåâÈíÆÂíåÊí≠ÊîæÁä∂ÊÄÅ
                if (globalStopBtn) {
                    globalStopBtn.style.display = 'none';
                }
                const speakingStatus = document.getElementById('speakingStatus');
                if (speakingStatus) {
                    speakingStatus.style.display = 'none';
                }
            };

            speechSynthesis.speak(currentUtterance);
        }

        // ÂÅúÊ≠¢ËØ≠Èü≥Êí≠Êîæ
        // ÂÅúÊ≠¢ËØ≠Èü≥Êí≠Êîæ
        function stopSpeaking() {
            console.log('üõë ÂÅúÊ≠¢ÊâÄÊúâËØ≠Èü≥Êí≠Êîæ');

            // ÂÅúÊ≠¢ Web Speech API
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                currentUtterance = null;
            }

            // ÂÅúÊ≠¢ÁôæÂ∫¶TTSÈü≥È¢ë
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0; // ÈáçÁΩÆÊí≠Êîæ‰ΩçÁΩÆ
                currentAudio = null;
            }

            // ÂÅúÊ≠¢ÁõëÂê¨Ê®°Âºè
            stopListeningMode();

            // ÈáçÁΩÆËØ¥ËØùÁä∂ÊÄÅ
            isSpeaking = false;

            // ÈöêËóèÂÖ®Â±ÄÂÅúÊ≠¢ÊåâÈíÆÂíåÊí≠ÊîæÁä∂ÊÄÅ
            const globalStopBtn = document.getElementById('globalStopSpeakingBtn');
            if (globalStopBtn) {
                globalStopBtn.style.display = 'none';
            }

            const speakingStatus = document.getElementById('speakingStatus');
            if (speakingStatus) {
                speakingStatus.style.display = 'none';
            }

            showToast('‚è∏Ô∏è ËØ≠Èü≥Êí≠ÊîæÂ∑≤ÂÅúÊ≠¢', 'info');
        }

        // ==================== ÂèëÈÄÅÊ∂àÊÅØÂäüËÉΩ ====================

        // ÂèëÈÄÅÊ∂àÊÅØÔºà‰ªécontenteditable divÔºâ
        async function sendMessageFromDiv() {
            const input = document.getElementById('messageInput');
            const message = input.textContent.trim();

            // Â¶ÇÊûúÊó¢Ê≤°ÊúâÊñáÂ≠ó‰πüÊ≤°ÊúâÂõæÁâáÔºåÁõ¥Êé•ËøîÂõû
            if (!message && !uploadedImagePath) return;

            // Â¶ÇÊûúÊúâÂõæÁâá‰ΩÜÊ≤°ÊúâÊñáÂ≠óÔºå‰ΩøÁî®ÈªòËÆ§ÊèêÁ§∫ËØç
            const actualMessage = message || 'ËØ∑ËØ¶ÁªÜÊèèËø∞ËøôÂº†ÂõæÁâáÁöÑÂÜÖÂÆπ';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.contentEditable = 'false';

            // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÁºñËæëÊ®°Âºè v0.6.0
            if (editingMessage) {
                // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπ
                const contentDiv = editingMessage.querySelector('.message-content');
                contentDiv.textContent = message;

                // Ê∏ÖÈô§ÁºñËæëÁä∂ÊÄÅ
                clearEditingState();
                input.textContent = '';
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();

                showToast('Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞', 'success');
                return;
            }

            // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØÔºàÂåÖÂê´ÂõæÁâáÔºâ
            let displayMessage = message || 'ËØÜÂà´ÂõæÁâá';
            addMessage('user', displayMessage, null, uploadedImagePath);
            input.textContent = '';

            // ‰øùÂ≠òÂΩìÂâçÂõæÁâáË∑ØÂæÑÔºàÁî®‰∫éAPIË∞ÉÁî®Ôºâ
            const currentImagePath = uploadedImagePath;

            // Á´ãÂç≥Ê∏ÖÈô§ÂõæÁâáÈ¢ÑËßàÂíå‰∏ä‰º†Áä∂ÊÄÅ
            removeImagePreview();

            try {
                // Ëé∑ÂèñËÆæÁΩÆ
                const settings = getSettings();
                const responseStyle = settings.responseStyle || 'balanced';

                // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´"ËÆ∞‰Ωè"Á≠âÂÖ≥ÈîÆËØç
                const memorizeKeywords = ['ËÆ∞‰Ωè', '‰øùÂ≠ò', 'ËÆ∞‰∏ã', 'Â≠ò‰∏Ä‰∏ã', 'ËÆ∞ÂΩï'];
                const shouldMemorize = message && memorizeKeywords.some(kw => message.includes(kw));

                // ÊûÑÂª∫ËØ∑Ê±Ç URLÔºàÊ∑ªÂä†ÂõæÁâáË∑ØÂæÑÂíåËÆ∞ÂøÜÊ†áÂøóÔºâ
                let url = `${API_BASE}/chat?prompt=${encodeURIComponent(message || '')}&response_style=${responseStyle}`;

                if (currentSessionId) {
                    url += `&session_id=${currentSessionId}`;
                }

                if (currentImagePath) {
                    url += `&image_path=${encodeURIComponent(currentImagePath)}`;
                }

                if (shouldMemorize) {
                    url += `&memorize=true`;
                    console.log('üß† Ê£ÄÊµãÂà∞ËÆ∞ÂøÜÂÖ≥ÈîÆËØçÔºåÂ∞Ü‰øùÂ≠òÂõæÁâáÂÜÖÂÆπÂà∞ËÆ∞ÂøÜÂ∫ì');
                }

                console.log('üì§ ÂèëÈÄÅËØ∑Ê±Ç:', url);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(url, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);

                    if (data.followup) {
                        showFollowupSuggestion(data.followup);
                    }
                } else {
                    addMessage('assistant', 'Êä±Ê≠âÔºåÂá∫Áé∞ÈîôËØØÔºö' + (data.detail || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåÈóÆÈ¢òÂèØËÉΩÊØîËæÉÂ§çÊùÇÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
                } else {
                    addMessage('assistant', 'ÁΩëÁªúÈîôËØØÔºö' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();
            }
        }

        // ÂèëÈÄÅÊ∂àÊÅØÔºà‰øùÁïôÊóßÂáΩÊï∞ÂÖºÂÆπÊÄßÔºâ
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            // Ê£ÄÊü•ÊòØÂê¶ÊòØcontenteditable
            if (input.contentEditable === 'true') {
                sendMessageFromDiv();
                return;
            }

            const message = input.value.trim();

            // Â¶ÇÊûúÊúâÂõæÁâá‰ΩÜÊ≤°ÊúâÊñáÂ≠óÔºåÊèêÁ§∫Áî®Êà∑
            if (!message && uploadedImagePath) {
                showNotification('ËØ∑ËæìÂÖ•ÂØπÂõæÁâáÁöÑÊèêÈóÆ', 'warning');
                return;
            }

            if (!message && !uploadedImagePath) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
            let displayMessage = message;
            if (uploadedImagePath) {
                displayMessage = `üì∑ [ÂõæÁâá]\n${message}`;
            }
            addMessage('user', displayMessage);
            input.value = '';
            // ÈáçÁΩÆtextareaÈ´òÂ∫¶
            input.style.height = 'auto';

            try {
                // Â¶ÇÊûúÊúâ‰∏ä‰º†ÁöÑÂõæÁâáÔºåÂÖàË∞ÉÁî®ÂõæÁâáËØÜÂà´APIÂπ∂Â∞ÜÂàÜÊûêÁªìÊûú‰Ωú‰∏∫‰∏ä‰∏ãÊñáÂèëÈÄÅÂà∞ËÅäÂ§©Êé•Âè£
                if (uploadedImagePath) {
                    console.log('üñºÔ∏è ÂèëÈÄÅÂõæÁâáËØÜÂà´ËØ∑Ê±Ç:', uploadedImagePath);
                    const response = await fetch('/api/vision/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            image_path: uploadedImagePath,
                            prompt: message || 'ËØ∑ËØ¶ÁªÜÊèèËø∞ËøôÂº†ÂõæÁâáÁöÑÂÜÖÂÆπ'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫ÂõæÁâáÁöÑÂàÜÊûêÔºà‰Ωú‰∏∫ÂèØËßÅÁöÑ‰∏ä‰∏ãÊñáÔºâ
                        addMessage('assistant', `üì∑ ÂõæÁâáÂàÜÊûêÔºö${result.description}\n\n_${result.model}_`);

                        // Â∞ÜÁî®Êà∑ÁöÑÊñáÊú¨ÂíåÂõæÁâáÂàÜÊûêÂêàÂπ∂ÔºåÂèëÈÄÅÂà∞ËÅäÂ§©Êé•Âè£ÔºåËÆ©Â∞è‰πêÂü∫‰∫éÂõæÁâá‰∏éÈóÆÈ¢ò‰ΩúÁ≠î
                        const settings = getSettings();
                        const responseStyle = settings.responseStyle || 'balanced';

                        const combinedPrompt = message
                            ? `${message}\n\nÊ†πÊçÆ‰∏äÈù¢ÁöÑÂõæÁâáÂàÜÊûêÔºåÂõûÁ≠îÁî®Êà∑ÁöÑÈóÆÈ¢ò„ÄÇÂõæÁâáÂàÜÊûêÊëòË¶ÅÔºö${result.description}`
                            : `ËØ∑Âü∫‰∫éÂõæÁâáÂÜÖÂÆπÁªôÂá∫ËØ¶ÁªÜÊèèËø∞Ôºö${result.description}`;

                        const url = currentSessionId
                            ? `${API_BASE}/chat?prompt=${encodeURIComponent(combinedPrompt)}&session_id=${currentSessionId}&response_style=${responseStyle}`
                            : `${API_BASE}/chat?prompt=${encodeURIComponent(combinedPrompt)}&response_style=${responseStyle}`;

                        // ËÆæÁΩÆ60ÁßíË∂ÖÊó∂
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 60000);

                        const chatResp = await fetch(url, {
                            method: 'POST',
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        const chatData = await chatResp.json();

                        if (chatResp.ok) {
                            currentSessionId = chatData.session_id;
                            addMessage('assistant', chatData.reply);
                        } else {
                            addMessage('assistant', 'Êä±Ê≠âÔºåÂõæÁâáÁõ∏ÂÖ≥ÁöÑÈóÆÈ¢òÂ§ÑÁêÜÂ§±Ë¥•Ôºö' + (chatData.detail || chatData.error || 'Êú™Áü•ÈîôËØØ'));
                        }

                        // Ê∏ÖÁêÜÂõæÁâáÈ¢ÑËßàÔºà‰øùÁïôÔºåÂ¶ÇÈúÄÂéÜÂè≤ÂèØÊîπ‰∏∫‰øùÁïôÔºâ
                        removeImagePreview();
                    } else {
                        addMessage('assistant', `‚ùå ÂõæÁâáËØÜÂà´Â§±Ë¥•: ${result.error}`);
                    }
                } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                    // v0.6.0: Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆÁöÑÂìçÂ∫îÈ£éÊ†º
                    const settings = getSettings();
                    const responseStyle = settings.responseStyle || 'balanced';

                    const url = currentSessionId
                        ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}&response_style=${responseStyle}`
                        : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&response_style=${responseStyle}`;

                    // ËÆæÁΩÆ60ÁßíË∂ÖÊó∂‰ª•Â§ÑÁêÜÂ§çÊùÇÈóÆÈ¢ò
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);

                    const response = await fetch(url, {
                        method: 'POST',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    const data = await response.json();

                    if (response.ok) {
                        currentSessionId = data.session_id;
                        addMessage('assistant', data.reply);
                    } else {
                        addMessage('assistant', 'Êä±Ê≠âÔºåÂá∫Áé∞ÈîôËØØÔºö' + (data.detail || 'Êú™Áü•ÈîôËØØ'));
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåÈóÆÈ¢òÂèØËÉΩÊØîËæÉÂ§çÊùÇÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
                } else {
                    addMessage('assistant', 'ÁΩëÁªúÈîôËØØÔºö' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÁïåÈù¢
        function addMessage(role, content, messageId = null, imagePath = null, shouldPlayVoice = true) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // ËÆæÁΩÆÊ∂àÊÅØIDÁî®‰∫éÁºñËæë/Âà†Èô§
            if (messageId) {
                messageDiv.dataset.messageId = messageId;
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÂÖàÊòæÁ§∫ÂõæÁâá
            if (imagePath && role === 'user') {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'message-image';
                imageDiv.innerHTML = `<img src="/${imagePath}" alt="‰∏ä‰º†ÁöÑÂõæÁâá" style="max-width: 300px; max-height: 300px; border-radius: 8px; margin-bottom: 8px;">`;
                contentDiv.appendChild(imageDiv);
            }

            // Ê∑ªÂä†ÊñáÊú¨ÂÜÖÂÆπ
            const textDiv = document.createElement('div');
            // Â¶ÇÊûúÊòØÂä©ÊâãÊ∂àÊÅØÔºå‰ΩøÁî®MarkdownÊ∏≤ÊüìÔºõÁî®Êà∑Ê∂àÊÅØ‰øùÊåÅÁ∫ØÊñáÊú¨
            if (role === 'assistant') {
                textDiv.innerHTML = marked.parse(content);

                // v0.8.0 ËØ≠Èü≥Êí≠ÊîæAIÂõûÂ§çÔºàÊ£ÄÊü•Ëá™Âä®Êí≠ÊîæËÆæÁΩÆÔºâ
                const autoPlayEnabled = localStorage.getItem('voiceAutoPlay') === 'true';
                if (shouldPlayVoice && autoPlayEnabled) {
                    setTimeout(() => {
                        speakText(content);
                    }, 100);
                }
            } else {
                textDiv.textContent = content;

                // ‰∏∫Áî®Êà∑Ê∂àÊÅØÊ∑ªÂä†Êìç‰ΩúÊåâÈíÆ v0.6.0
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                // ÁºñËæëÊåâÈíÆ
                const editBtn = document.createElement('button');
                editBtn.className = 'message-action-btn edit';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.title = 'ÁºñËæëÊ∂àÊÅØ';
                editBtn.onclick = () => editMessage(messageDiv, content);

                // Âà†Èô§ÊåâÈíÆ
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn delete';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.title = 'Âà†Èô§Ê∂àÊÅØ';
                deleteBtn.onclick = () => deleteMessage(messageDiv);

                // Â§çÂà∂ÊåâÈíÆ
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn copy';
                copyBtn.innerHTML = 'üìã';
                copyBtn.title = 'Â§çÂà∂Ê∂àÊÅØ';
                copyBtn.onclick = () => copyMessage(content, copyBtn);

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                actionsDiv.appendChild(copyBtn);
                messageDiv.appendChild(actionsDiv);
            }

            contentDiv.appendChild(textDiv);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Êñ∞ÂØπËØù
        function newChat() {
            currentSessionId = null;
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('messageInput').focus();

            // Ê∏ÖÈô§ÁºñËæëÁä∂ÊÄÅ
            clearEditingState();
        }

        // ============ v0.6.0 Ê∂àÊÅØÊìç‰ΩúÂäüËÉΩ ============

        let editingMessage = null;
        let originalContent = '';

        // ÁºñËæëÊ∂àÊÅØ
        function editMessage(messageDiv, content) {
            const input = document.getElementById('messageInput');

            // ‰øùÂ≠òÁºñËæëÁä∂ÊÄÅ
            editingMessage = messageDiv;
            originalContent = input.textContent;

            // Â∞ÜÊ∂àÊÅØÂÜÖÂÆπÂä†ËΩΩÂà∞ËæìÂÖ•Ê°Ü
            input.textContent = content;
            input.focus();

            // ÊòæÁ§∫ÁºñËæëÊèêÁ§∫
            showEditingIndicator();
        }

        // ÊòæÁ§∫ÁºñËæëÁä∂ÊÄÅÊèêÁ§∫
        function showEditingIndicator() {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊèêÁ§∫
            const existing = document.querySelector('.editing-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.className = 'editing-indicator';
            indicator.innerHTML = `
                <span>‚úèÔ∏è Ê≠£Âú®ÁºñËæëÊ∂àÊÅØ</span>
                <button onclick="clearEditingState()">ÂèñÊ∂à</button>
            `;
            document.body.appendChild(indicator);
        }

        // Ê∏ÖÈô§ÁºñËæëÁä∂ÊÄÅ
        function clearEditingState() {
            editingMessage = null;
            originalContent = '';

            const indicator = document.querySelector('.editing-indicator');
            if (indicator) indicator.remove();
        }

        // Âà†Èô§Ê∂àÊÅØ
        function deleteMessage(messageDiv) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü')) {
                // ÊâæÂà∞ÂØπÂ∫îÁöÑAIÂõûÂ§çÂπ∂‰∏ÄËµ∑Âà†Èô§
                let nextElement = messageDiv.nextElementSibling;
                if (nextElement && nextElement.classList.contains('message') &&
                    (nextElement.classList.contains('ai') || nextElement.classList.contains('assistant'))) {
                    nextElement.remove();
                }

                // Âà†Èô§Áî®Êà∑Ê∂àÊÅØ
                messageDiv.remove();

                // ÊòæÁ§∫Âà†Èô§ÊàêÂäüÊèêÁ§∫
                showToast('Ê∂àÊÅØÂ∑≤Âà†Èô§', 'success');
            }
        }

        // Â§çÂà∂Ê∂àÊÅØ
        async function copyMessage(content, button) {
            try {
                await navigator.clipboard.writeText(content);

                // ‰∏¥Êó∂ÊîπÂèòÊåâÈíÆÊòæÁ§∫
                const originalText = button.innerHTML;
                button.innerHTML = '‚úì';
                button.style.background = '#4CAF50';
                button.style.color = 'white';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.style.color = '';
                }, 1000);

                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            } catch (err) {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                showToast('Â§çÂà∂Â§±Ë¥•', 'error');
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#ff6b6b' : '#667eea'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                animation: slideInRight 0.3s;
                font-size: 14px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ============ Ê∂àÊÅØÊìç‰ΩúÂäüËÉΩÁªìÊùü ============

        // ============ Ê∂àÊÅØÊêúÁ¥¢ÂäüËÉΩ v0.6.0 ============

        /**
         * ÊêúÁ¥¢ÂΩìÂâçÂØπËØù‰∏≠ÁöÑÊ∂àÊÅØ
         */
        function searchMessages() {
            const searchInput = document.getElementById('messageSearchInput');
            const query = searchInput.value.trim().toLowerCase();
            const messages = document.querySelectorAll('#chatContainer .message');
            const countSpan = document.getElementById('searchResultCount');

            // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÊ∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
            if (!query) {
                clearMessageSearch();
                return;
            }

            let matchCount = 0;
            let firstMatch = null;

            messages.forEach(msg => {
                // ÁßªÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
                msg.classList.remove('search-highlight');
                const contentDiv = msg.querySelector('.message-content');
                if (!contentDiv) return;

                // Ëé∑ÂèñÂéüÂßãÊñáÊú¨ÂÜÖÂÆπ
                const textContent = contentDiv.textContent.toLowerCase();

                if (textContent.includes(query)) {
                    matchCount++;
                    msg.classList.add('search-highlight');

                    // ËÆ∞ÂΩïÁ¨¨‰∏Ä‰∏™ÂåπÈÖçÈ°π
                    if (!firstMatch) {
                        firstMatch = msg;
                    }

                    // È´ò‰∫ÆÂåπÈÖçÁöÑÊñáÂ≠ó
                    highlightText(contentDiv, query);
                }
            });

            // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÊï∞Èáè
            if (matchCount > 0) {
                countSpan.textContent = `ÊâæÂà∞ ${matchCount} Êù°ÁªìÊûú`;
                countSpan.style.color = '#4CAF50';

                // ÊªöÂä®Âà∞Á¨¨‰∏Ä‰∏™ÂåπÈÖçÈ°π
                if (firstMatch) {
                    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                countSpan.textContent = 'Êú™ÊâæÂà∞ÂåπÈÖçÁªìÊûú';
                countSpan.style.color = '#ff6b6b';
            }
        }

        /**
         * È´ò‰∫ÆÊòæÁ§∫ÂåπÈÖçÁöÑÊñáÊú¨
         */
        function highlightText(element, query) {
            // Â¶ÇÊûúÊòØÁî®Êà∑Ê∂àÊÅØÔºàÁ∫ØÊñáÊú¨Ôºâ
            if (element.parentElement.classList.contains('user')) {
                const text = element.textContent;
                const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
                const highlighted = text.replace(regex, '<span class="search-match">$1</span>');
                element.innerHTML = highlighted;
            }
            // Â¶ÇÊûúÊòØAIÊ∂àÊÅØÔºàMarkdownÊ∏≤ÊüìÂêéÁöÑHTMLÔºâÔºåÈÅçÂéÜÊñáÊú¨ËäÇÁÇπ
            else {
                highlightTextNodes(element, query);
            }
        }

        /**
         * ÈÄíÂΩíÈ´ò‰∫ÆÊñáÊú¨ËäÇÁÇπ
         */
        function highlightTextNodes(node, query) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent;
                const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
                if (regex.test(text)) {
                    const span = document.createElement('span');
                    span.innerHTML = text.replace(regex, '<span class="search-match">$1</span>');
                    node.parentNode.replaceChild(span, node);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE') {
                Array.from(node.childNodes).forEach(child => highlightTextNodes(child, query));
            }
        }

        /**
         * ËΩ¨‰πâÊ≠£ÂàôË°®ËææÂºèÁâπÊÆäÂ≠óÁ¨¶
         */
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        /**
         * Ê∏ÖÈô§Ê∂àÊÅØÊêúÁ¥¢
         */
        function clearMessageSearch() {
            const searchInput = document.getElementById('messageSearchInput');
            const countSpan = document.getElementById('searchResultCount');
            const messages = document.querySelectorAll('#chatContainer .message');

            // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
            searchInput.value = '';
            countSpan.textContent = '';

            // ÁßªÈô§ÊâÄÊúâÈ´ò‰∫Æ
            messages.forEach(msg => {
                msg.classList.remove('search-highlight');
                const contentDiv = msg.querySelector('.message-content');
                if (!contentDiv) return;

                // ÊÅ¢Â§çÂéüÂßãÂÜÖÂÆπ
                if (msg.classList.contains('user')) {
                    // Áî®Êà∑Ê∂àÊÅØÔºöÁßªÈô§ span Ê†áÁ≠æ
                    const matches = contentDiv.querySelectorAll('.search-match');
                    matches.forEach(match => {
                        const text = document.createTextNode(match.textContent);
                        match.parentNode.replaceChild(text, match);
                    });
                } else {
                    // AIÊ∂àÊÅØÔºöÈúÄË¶ÅÈáçÊñ∞Ê∏≤ÊüìMarkdown
                    // ËøôÈáåÁÆÄÂçïÂ§ÑÁêÜÔºåÁßªÈô§ÊâÄÊúâ search-match Ê†áÁ≠æ
                    const matches = contentDiv.querySelectorAll('.search-match');
                    matches.forEach(match => {
                        const text = document.createTextNode(match.textContent);
                        match.parentNode.replaceChild(text, match);
                    });
                }
            });
        }

        // ============ Ê∂àÊÅØÊêúÁ¥¢ÂäüËÉΩÁªìÊùü ============

        // Âä†ËΩΩ‰ºöËØùÂàóË°®
        async function loadSessions() {
            const container = document.getElementById('sessionsList');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/sessions?limit=20`);
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    // ÊåâÊó∂Èó¥ÂéªÈáçÔºöÂ¶ÇÊûúÂ§ö‰∏™‰ºöËØùtitleÁõ∏ÂêåÔºåÂè™ÊòæÁ§∫ÊúÄÊñ∞ÁöÑ
                    const uniqueSessions = [];
                    const seenTitles = new Set();

                    for (const session of data.sessions) {
                        if (!seenTitles.has(session.title)) {
                            seenTitles.add(session.title);
                            uniqueSessions.push(session);
                        }
                    }

                    container.innerHTML = uniqueSessions.map(session => `
                        <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}"
                             data-session-id="${session.session_id}"
                             style="cursor: pointer;">
                            <div class="session-title">${session.title}</div>
                            <div class="session-time">
                                ÂàõÂª∫: ${session.created_at} | Êõ¥Êñ∞: ${session.updated_at}
                            </div>
                            <div class="session-actions">
                                <button class="session-action-btn export-md" 
                                        onclick="exportSession('${session.session_id}', 'markdown'); event.stopPropagation();"
                                        title="ÂØºÂá∫‰∏∫Markdown">
                                    üìù
                                </button>
                                <button class="session-action-btn export-json" 
                                        onclick="exportSession('${session.session_id}', 'json'); event.stopPropagation();"
                                        title="ÂØºÂá∫‰∏∫JSON">
                                    üì¶
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // ‰∏∫ÊØè‰∏™‰ºöËØùÈ°πÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÊõ¥ÂÆâÂÖ®ÁöÑÊñπÂºèÔºâ
                    container.querySelectorAll('.session-item').forEach(item => {
                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            const sessionId = this.getAttribute('data-session-id');
                            if (sessionId) {
                                loadSession(sessionId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="loading">ËøòÊ≤°Êúâ‰ºöËØùËÆ∞ÂΩï</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•:', error);
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ===== ‰ºöËØùÂØºÂá∫ÂäüËÉΩ =====

        /**
         * ÂØºÂá∫‰ºöËØù‰∏∫ÊåáÂÆöÊ†ºÂºè
         * @param {string} sessionId - ‰ºöËØùID
         * @param {string} format - ÂØºÂá∫Ê†ºÂºè ('markdown' Êàñ 'json')
         */
        async function exportSession(sessionId, format) {
            try {
                console.log(`ÂØºÂá∫‰ºöËØù ${sessionId} ‰∏∫ ${format} Ê†ºÂºè`);

                // Ëé∑Âèñ‰ºöËØùÊï∞ÊçÆ
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`Ëé∑Âèñ‰ºöËØùÂ§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                const messages = data.messages || [];
                const title = data.title || 'Êú™ÂëΩÂêç‰ºöËØù';
                const createdAt = data.created_at || new Date().toISOString();

                let content, filename, mimeType;

                if (format === 'markdown') {
                    // ÁîüÊàêMarkdownÊ†ºÂºè
                    content = generateMarkdown(title, createdAt, messages);
                    filename = `${sanitizeFilename(title)}_${getTimestamp()}.md`;
                    mimeType = 'text/markdown';
                } else if (format === 'json') {
                    // ÁîüÊàêJSONÊ†ºÂºè
                    content = JSON.stringify({
                        session_id: sessionId,
                        title: title,
                        created_at: createdAt,
                        exported_at: new Date().toISOString(),
                        message_count: messages.length,
                        messages: messages.map(msg => ({
                            role: msg.role,
                            content: msg.content,
                            timestamp: msg.timestamp || msg.created_at
                        }))
                    }, null, 2);
                    filename = `${sanitizeFilename(title)}_${getTimestamp()}.json`;
                    mimeType = 'application/json';
                } else {
                    throw new Error('‰∏çÊîØÊåÅÁöÑÂØºÂá∫Ê†ºÂºè');
                }

                // ‰∏ãËΩΩÊñá‰ª∂
                downloadFile(content, filename, mimeType);
                showToast(`‚úÖ ÂØºÂá∫ÊàêÂäü: ${filename}`, 'success');

            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showToast(`‚ùå ÂØºÂá∫Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        /**
         * ÁîüÊàêMarkdownÊ†ºÂºèÁöÑ‰ºöËØùÂÜÖÂÆπ
         */
        function generateMarkdown(title, createdAt, messages) {
            let md = `# ${title}\n\n`;
            md += `**ÂàõÂª∫Êó∂Èó¥**: ${createdAt}\n`;
            md += `**ÂØºÂá∫Êó∂Èó¥**: ${new Date().toLocaleString('zh-CN')}\n`;
            md += `**Ê∂àÊÅØÊï∞Èáè**: ${messages.length}\n\n`;
            md += `---\n\n`;

            messages.forEach((msg, index) => {
                const role = msg.role === 'user' ? 'üë§ Áî®Êà∑' : 'ü§ñ Â∞è‰πêAI';
                const timestamp = msg.timestamp || msg.created_at || '';

                md += `## ${role}\n\n`;
                if (timestamp) {
                    md += `*${timestamp}*\n\n`;
                }
                md += `${msg.content}\n\n`;

                if (index < messages.length - 1) {
                    md += `---\n\n`;
                }
            });

            return md;
        }

        /**
         * Ê∏ÖÁêÜÊñá‰ª∂ÂêçÔºàÁßªÈô§ÈùûÊ≥ïÂ≠óÁ¨¶Ôºâ
         */
        function sanitizeFilename(name) {
            return name
                .replace(/[<>:"/\\|?*]/g, '') // ÁßªÈô§WindowsÈùûÊ≥ïÂ≠óÁ¨¶
                .replace(/\s+/g, '_')         // Á©∫Ê†ºÊõøÊç¢‰∏∫‰∏ãÂàíÁ∫ø
                .substring(0, 50);            // ÈôêÂà∂ÈïøÂ∫¶
        }

        /**
         * Ëé∑ÂèñÊó∂Èó¥Êà≥Â≠óÁ¨¶‰∏≤ÔºàÁî®‰∫éÊñá‰ª∂ÂêçÔºâ
         */
        function getTimestamp() {
            const now = new Date();
            return now.toISOString()
                .replace(/[:.]/g, '-')
                .replace('T', '_')
                .substring(0, 19);
        }

        /**
         * ‰∏ãËΩΩÊñá‰ª∂Âà∞Êú¨Âú∞
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Âä†ËΩΩÊåáÂÆö‰ºöËØù
        async function loadSession(sessionId) {
            console.log('Ê≠£Âú®Âä†ËΩΩ‰ºöËØù:', sessionId);

            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‰ºöËØùÊï∞ÊçÆ:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                currentSessionId = sessionId;
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';

                // ÊòæÁ§∫‰ºöËØù‰ø°ÊÅØ
                const sessionInfo = document.getElementById('sessionInfo');
                const titleSpan = document.getElementById('currentSessionTitle');
                titleSpan.textContent = data.title || 'Êú™ÂëΩÂêç‰ºöËØù';
                sessionInfo.style.display = 'block';

                // Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ
                const messages = data.messages || data.history || [];
                if (messages.length > 0) {
                    messages.forEach(msg => {
                        addMessage(msg.role, msg.content, null, null, false);  // ÂéÜÂè≤Ê∂àÊÅØ‰∏çÊí≠ÊîæËØ≠Èü≥
                    });
                }

                // ÂàáÊç¢Âà∞ËÅäÂ§©Ê†áÁ≠æÈ°µ
                switchTab('chat');

                // Êõ¥Êñ∞‰ºöËØùÂàóË°®ÁöÑactiveÁä∂ÊÄÅ
                document.querySelectorAll('.session-item').forEach(item => {
                    if (item.getAttribute('data-session-id') === sessionId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                console.log('‰ºöËØùÂä†ËΩΩÊàêÂäü');
            } catch (error) {
                console.error('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•:', error);
                alert('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âä†ËΩΩËÆ∞ÂøÜÁªüËÆ°
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats`);
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                const tags = data.by_tag || {};

                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${data.total}</div>
                        <div class="stat-label">ÊÄªËÆ∞ÂøÜÊï∞</div>
                    </div>
                    ${Object.entries(tags).map(([tag, count]) => `
                        <div class="stat-item">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${tag}</div>
                        </div>
                    `).join('')}
                `;

                loadRecentMemories();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML =
                    `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩÊúÄËøëËÆ∞ÂøÜ
        async function loadRecentMemories() {
            console.log('üìã loadRecentMemories ÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
            const container = document.getElementById('memoryList');
            console.log('üì¶ ÂÆπÂô®ÂÖÉÁ¥†:', container);
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                console.log('üåê ÂèëËµ∑ËØ∑Ê±Ç: /memory/recent');
                const response = await fetch(`${API_BASE}/memory/recent?hours=24&limit=20`);
                console.log('üì° ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                const data = await response.json();
                console.log('üìä ËøîÂõûÊï∞ÊçÆ:', data);

                // APIËøîÂõûÁöÑÂ≠óÊÆµÊòØmemoryÔºå‰∏çÊòØmemories
                const memories = data.memory || data.memories || [];
                console.log('üìã Ëß£ÊûêÂà∞ÁöÑËÆ∞ÂøÜÊï∞Èáè:', memories.length);

                if (memories.length > 0) {
                    container.innerHTML = memories.map(mem => `
                        <div class="memory-item" id="memory-${mem.id}">
                            <div class="memory-content" id="content-${mem.id}">${marked.parse(mem.content)}</div>
                            <div class="memory-meta">
                                <span>üè∑Ô∏è ${mem.tag}</span>
                                <span>üïê ${mem.timestamp}</span>
                            </div>
                            <div class="memory-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                                <button data-memory-id="${mem.id}" data-memory-tag="${mem.tag}" class="edit-memory-btn"
                                    style="padding: 5px 12px; background: #667eea; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ‚úèÔ∏è ÁºñËæë
                                </button>
                                <button data-memory-id="${mem.id}" class="delete-memory-btn"
                                    style="padding: 5px 12px; background: #f56565; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                    console.log('üîó [loadRecentMemories] ÂºÄÂßãÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®...');
                    const editButtons = container.querySelectorAll('.edit-memory-btn');
                    const deleteButtons = container.querySelectorAll('.delete-memory-btn');
                    console.log(`‚úÖ ÊâæÂà∞ ${editButtons.length} ‰∏™ÁºñËæëÊåâÈíÆ, ${deleteButtons.length} ‰∏™Âà†Èô§ÊåâÈíÆ`);

                    editButtons.forEach(btn => {
                        btn.addEventListener('click', function () {
                            console.log('‚úèÔ∏è ÁºñËæëÊåâÈíÆË¢´ÁÇπÂáª, ID:', this.dataset.memoryId);
                            editMemory(this.dataset.memoryId, this.dataset.memoryTag);
                        });
                    });
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', function () {
                            console.log('üóëÔ∏è Âà†Èô§ÊåâÈíÆË¢´ÁÇπÂáª, ID:', this.dataset.memoryId);
                            deleteMemory(this.dataset.memoryId);
                        });
                    });
                } else {
                    container.innerHTML = '<div class="loading">Ê≤°ÊúâËÆ∞ÂøÜËÆ∞ÂΩï</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ÊêúÁ¥¢ËÆ∞ÂøÜÔºàÂÖ≥ÈîÆËØçÔºâ
        async function searchMemories() {
            const keywords = document.getElementById('searchInput').value.trim();
            if (!keywords) {
                loadRecentMemories();
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">ÂÖ≥ÈîÆËØçÊêúÁ¥¢‰∏≠...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/search?keywords=${encodeURIComponent(keywords)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item" id="memory-${mem.id}">
                            <div class="memory-content" id="content-${mem.id}">${marked.parse(mem.content)}</div>
                            <div class="memory-meta">
                                <span>üè∑Ô∏è ${mem.tag}</span>
                                <span>üïê ${mem.timestamp}</span>
                            </div>
                            <div class="memory-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                                <button data-memory-id="${mem.id}" data-memory-tag="${mem.tag}" class="edit-memory-btn"
                                    style="padding: 5px 12px; background: #667eea; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ‚úèÔ∏è ÁºñËæë
                                </button>
                                <button data-memory-id="${mem.id}" class="delete-memory-btn"
                                    style="padding: 5px 12px; background: #f56565; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                    console.log('üîó [searchMemories] ÁªëÂÆö‰∫ã‰ª∂...');
                    setTimeout(() => {
                        const editButtons = container.querySelectorAll('.edit-memory-btn');
                        const deleteButtons = container.querySelectorAll('.delete-memory-btn');
                        console.log(`‚úÖ [ÊêúÁ¥¢] ÊâæÂà∞ ${editButtons.length} ‰∏™ÁºñËæë, ${deleteButtons.length} ‰∏™Âà†Èô§ÊåâÈíÆ`);

                        editButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                editMemory(this.dataset.memoryId, this.dataset.memoryTag);
                            });
                        });
                        deleteButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                deleteMemory(this.dataset.memoryId);
                            });
                        });
                    }, 0);
                } else {
                    container.innerHTML = '<div class="loading">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ËÆ∞ÂøÜ</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">ÊêúÁ¥¢Â§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ËØ≠‰πâÊêúÁ¥¢ËÆ∞ÂøÜ
        async function semanticSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('ËØ∑ËæìÂÖ•Êü•ËØ¢ÂÜÖÂÆπ');
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">üß† ËØ≠‰πâÊêúÁ¥¢‰∏≠...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/semantic?query=${encodeURIComponent(query)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item" id="memory-${mem.id}">
                            <div class="memory-content" id="content-${mem.id}">${marked.parse(mem.content)}</div>
                            <div class="memory-meta">
                                <span>üè∑Ô∏è ${mem.tag}</span>
                                <span>üïê ${mem.timestamp}</span>
                                <span>üìä Áõ∏‰ººÂ∫¶: ${(mem.score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="memory-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                                <button data-memory-id="${mem.id}" data-memory-tag="${mem.tag}" class="edit-memory-btn"
                                    style="padding: 5px 12px; background: #667eea; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ‚úèÔ∏è ÁºñËæë
                                </button>
                                <button data-memory-id="${mem.id}" class="delete-memory-btn"
                                    style="padding: 5px 12px; background: #f56565; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                    console.log('üîó [semanticSearch] ÁªëÂÆö‰∫ã‰ª∂...');
                    setTimeout(() => {
                        const editButtons = container.querySelectorAll('.edit-memory-btn');
                        const deleteButtons = container.querySelectorAll('.delete-memory-btn');
                        console.log(`‚úÖ [ËØ≠‰πâ] ÊâæÂà∞ ${editButtons.length} ‰∏™ÁºñËæë, ${deleteButtons.length} ‰∏™Âà†Èô§ÊåâÈíÆ`);

                        editButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                editMemory(this.dataset.memoryId, this.dataset.memoryTag);
                            });
                        });
                        deleteButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                deleteMemory(this.dataset.memoryId);
                            });
                        });
                    }, 0);
                } else {
                    container.innerHTML = '<div class="loading">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ËÆ∞ÂøÜ</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">ÊêúÁ¥¢Â§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ============ v0.7.0 ËÆ∞ÂøÜÁÆ°ÁêÜ CRUD ÂäüËÉΩ ============

        // ÁºñËæëËÆ∞ÂøÜ
        async function editMemory(memoryId, currentTag) {
            const contentEl = document.getElementById(`content-${memoryId}`);
            const currentContent = contentEl.textContent;

            // ÂàõÂª∫ÁºñËæëË°®Âçï
            const newContent = prompt('ÁºñËæëËÆ∞ÂøÜÂÜÖÂÆπ:', currentContent);
            if (newContent === null || newContent.trim() === '') {
                return;  // Áî®Êà∑ÂèñÊ∂àÊàñÂÜÖÂÆπ‰∏∫Á©∫
            }

            const newTag = prompt('ÁºñËæëÊ†áÁ≠æ (facts/image/conversation/scheduleÁ≠â):', currentTag);
            if (newTag === null || newTag.trim() === '') {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/memory/${memoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: newContent.trim(),
                        tag: newTag.trim()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ ËÆ∞ÂøÜÊõ¥Êñ∞ÊàêÂäü', 'success');
                    // Âà∑Êñ∞ÂàóË°®
                    loadRecentMemories();
                } else {
                    showNotification('‚ùå Êõ¥Êñ∞Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'), 'error');
                }

            } catch (error) {
                console.error('ÁºñËæëËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showNotification('‚ùå Êõ¥Êñ∞Â§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Âà†Èô§ËÆ∞ÂøÜ
        async function deleteMemory(memoryId) {
            console.log('üóëÔ∏è deleteMemory Ë¢´Ë∞ÉÁî®, ID:', memoryId);

            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂøÜÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                console.log('‚ö†Ô∏è Áî®Êà∑ÂèñÊ∂àÂà†Èô§');
                return;
            }

            console.log('‚úÖ Áî®Êà∑Á°ÆËÆ§Âà†Èô§');
            console.log('üì° ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç...');

            try {
                const response = await fetch(`${API_BASE}/api/memory/${memoryId}`, {
                    method: 'DELETE'
                });

                console.log('üì° ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);

                const data = await response.json();
                console.log('üìã ÂìçÂ∫îÊï∞ÊçÆ:', data);

                if (data.success) {
                    showNotification('‚úÖ ËÆ∞ÂøÜÂ∑≤Âà†Èô§', 'success');
                    // ‰ªéDOM‰∏≠ÁßªÈô§
                    const memoryEl = document.getElementById(`memory-${memoryId}`);
                    if (memoryEl) {
                        memoryEl.style.opacity = '0';
                        setTimeout(() => memoryEl.remove(), 300);
                    }
                } else {
                    showNotification('‚ùå Âà†Èô§Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'), 'error');
                }

            } catch (error) {
                console.error('Âà†Èô§ËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showNotification('‚ùå Âà†Èô§Â§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ============ ËÆ∞ÂøÜÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ============

        // Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥ÂèòÈáè
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        // ÂàáÊç¢Ëá™Âä®Âà∑Êñ∞
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('refreshStatus');

            if (checkbox.checked) {
                // ÂêØÁî®Ëá™Âä®Âà∑Êñ∞
                loadBehaviorAnalytics();
                lastRefreshTime = Date.now();
                updateRefreshStatus();

                autoRefreshInterval = setInterval(() => {
                    loadBehaviorAnalytics();
                    lastRefreshTime = Date.now();
                    updateRefreshStatus();
                }, 30000); // 30Áßí

                statusSpan.style.color = '#51cf66';
                console.log('‚úÖ Ëá™Âä®Âà∑Êñ∞Â∑≤ÂêØÁî® (30Áßí)');
            } else {
                // Á¶ÅÁî®Ëá™Âä®Âà∑Êñ∞
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = '';
                console.log('‚è∏Ô∏è Ëá™Âä®Âà∑Êñ∞Â∑≤Á¶ÅÁî®');
            }
        }

        // Êõ¥Êñ∞Âà∑Êñ∞Áä∂ÊÄÅ
        function updateRefreshStatus() {
            const statusSpan = document.getElementById('refreshStatus');
            if (lastRefreshTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - lastRefreshTime) / 1000);
                statusSpan.textContent = `‰∏äÊ¨°Âà∑Êñ∞: ${elapsed}ÁßíÂâç`;
            }
        }

        // ÂÆöÊúüÊõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
        setInterval(() => {
            if (autoRefreshInterval && lastRefreshTime) {
                updateRefreshStatus();
            }
        }, 1000);

        // Âä†ËΩΩË°å‰∏∫ÂàÜÊûêÊï∞ÊçÆ
        async function loadBehaviorAnalytics() {
            const userId = 'default_user';

            // Âä†ËΩΩÊ¥ªË∑ÉÊó∂Èó¥ÂàÜÂ∏É
            loadActivityPattern(userId);

            // Âä†ËΩΩËØùÈ¢òÂÅèÂ•Ω
            loadTopicPreferences(userId);

            // Âä†ËΩΩÂØπËØùÁªüËÆ°
            loadBehaviorStats(userId);

            // Âä†ËΩΩÂÜ≤Á™ÅÊ£ÄÊµã
            loadConflictDetection();

            // Âä†ËΩΩ‰∏ªÂä®ÈóÆÁ≠îÂéÜÂè≤
            loadProactiveQA(userId);

            // Âä†ËΩΩÂ≠¶‰π†Ê®°Âºè
            loadLearningPatterns(userId);
        }

        // Âä†ËΩΩÊ¥ªË∑ÉÊó∂Èó¥ÂàÜÂ∏É
        async function loadActivityPattern(userId) {
            const container = document.getElementById('activityPattern');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/activity?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">ÊöÇÊó†Êï∞ÊçÆ</div>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

                // Â∞èÊó∂ÂàÜÂ∏É
                if (data.hourly_distribution && Object.keys(data.hourly_distribution).length > 0) {
                    html += '<div><strong>üìÖ Ê¥ªË∑ÉÊó∂ÊÆµÔºàÂ∞èÊó∂Ôºâ</strong><div style="margin-top: 8px;">';
                    const sortedHours = Object.entries(data.hourly_distribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    sortedHours.forEach(([hour, count]) => {
                        html += `<div style="margin: 5px 0;">üïê ${hour}:00 - ${count}Ê¨°</div>`;
                    });
                    html += '</div></div>';
                }

                // ÊòüÊúüÂàÜÂ∏É
                if (data.daily_distribution && Object.keys(data.daily_distribution).length > 0) {
                    const weekdays = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'];
                    html += '<div><strong>üìÜ Ê¥ªË∑ÉÊòüÊúü</strong><div style="margin-top: 8px;">';
                    const sortedDays = Object.entries(data.daily_distribution).sort((a, b) => b[1] - a[1]);
                    sortedDays.forEach(([day, count]) => {
                        html += `<div style="margin: 5px 0;">${weekdays[day] || 'Âë®' + day} - ${count}Ê¨°</div>`;
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html || '<div style="color: #999;">ÊöÇÊó†Êï∞ÊçÆ</div>';
            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩËØùÈ¢òÂÅèÂ•Ω
        async function loadTopicPreferences(userId) {
            const container = document.getElementById('topicPreferences');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/topics?user_id=${userId}`);
                const data = await response.json();

                if (data.error || !data.top_topics || data.top_topics.length === 0) {
                    container.innerHTML = '<div style="color: #999;">ÊöÇÊó†ËØùÈ¢òÊï∞ÊçÆ</div>';
                    return;
                }

                let html = '<div>';
                data.top_topics.slice(0, 10).forEach((item, index) => {
                    const [topic, count] = item;
                    html += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${index + 1}. üè∑Ô∏è ${topic}</span>
                            <span style="color: #667eea; font-weight: bold;">${count}Ê¨°</span>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩÂØπËØùÁªüËÆ°
        async function loadBehaviorStats(userId) {
            const container = document.getElementById('behaviorStats');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/behavior?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">ÊöÇÊó†Êï∞ÊçÆ</div>';
                    return;
                }

                // ‰øÆÂ§çÔºö‰ΩøÁî® conversation_stats ËÄå‰∏çÊòØ stats
                const stats = data.conversation_stats || {};
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_sessions || 0}</div>
                            <div style="color: #999; margin-top: 5px;">ÊÄª‰ºöËØùÊï∞</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_messages || 0}</div>
                            <div style="color: #999; margin-top: 5px;">ÊÄªÊ∂àÊÅØÊï∞</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_messages_per_session || 0}</div>
                            <div style="color: #999; margin-top: 5px;">Âπ≥ÂùáÊ∂àÊÅØ/‰ºöËØù</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_message_length || 0}</div>
                            <div style="color: #999; margin-top: 5px;">Âπ≥ÂùáÊ∂àÊÅØÈïøÂ∫¶</div>
                        </div>
                    </div>
                `;

                if (stats.last_session_time) {
                    html += `<div style="margin-top: 15px; text-align: center; color: #666;">
                        ÊúÄÂêéÊ¥ªË∑É: ${new Date(stats.last_session_time).toLocaleString('zh-CN')}
                    </div>`;
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩÂÜ≤Á™ÅÊ£ÄÊµã
        async function loadConflictDetection() {
            const container = document.getElementById('conflictDetection');
            container.innerHTML = '<div class="loading">Ê£ÄÊµã‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/conflicts`);
                const data = await response.json();

                if (data.conflicts && data.conflicts.length > 0) {
                    let html = `<div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">
                        ‚ö†Ô∏è ÂèëÁé∞ ${data.conflicts.length} ÁªÑÂÜ≤Á™ÅËÆ∞ÂøÜ
                    </div>`;

                    data.conflicts.forEach((conflict, index) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #ff6b6b; border-radius: 5px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">ÂÜ≤Á™Å ${index + 1}: ${conflict.type_cn}</div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    üìÑ ÊóßÂÄº: ${conflict.old_value} - ${conflict.old_memory}
                                </div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    üìÑ Êñ∞ÂÄº: ${conflict.new_value} - ${conflict.new_memory}
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 12px;">
                                    Ê£ÄÊµãÊó∂Èó¥: ${conflict.conflict_detected_at}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #51cf66; text-align: center;">‚úÖ Ê≤°ÊúâÂèëÁé∞ÂÜ≤Á™ÅËÆ∞ÂøÜ</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Ê£ÄÊµãÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩ‰∏ªÂä®ÈóÆÁ≠îÂéÜÂè≤
        async function loadProactiveQA(userId) {
            const container = document.getElementById('proactiveQA');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/proactive/history?user_id=${userId}&limit=10`);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    let html = `<div style="color: #764ba2; font-weight: bold; margin-bottom: 10px;">
                        üí° ÂÖ± ${data.total} Êù°ËøΩÈóÆËÆ∞ÂΩïÔºàÊòæÁ§∫ÊúÄËøë10Êù°Ôºâ
                    </div>`;

                    data.history.forEach((item, index) => {
                        const confidenceColor = item.confidence >= 70 ? '#51cf66' : item.confidence >= 50 ? '#ffd43b' : '#ff6b6b';
                        const askedBadge = item.followup_asked
                            ? '<span style="background: #51cf66; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Â∑≤ËøΩÈóÆ</span>'
                            : '<span style="background: #999; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">ÂæÖËøΩÈóÆ</span>';

                        // ÂæÖËøΩÈóÆÁöÑËÆ∞ÂΩïÊòæÁ§∫ÂèëÈÄÅÊåâÈíÆ
                        const actionButton = !item.followup_asked
                            ? `<button class="send-followup-btn" data-id="${item.id}" data-text="${item.followup_question.replace(/"/g, '&quot;')}" data-user="${userId}"
                                style="margin-top: 8px; padding: 6px 12px; background: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                üì§ ÂèëÈÄÅËøΩÈóÆ
                               </button>`
                            : '';

                        html += `
                            <div style="margin: 10px 0; padding: 12px; background: white; border-left: 3px solid #764ba2; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold;">ËÆ∞ÂΩï ${index + 1}</span>
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        ${askedBadge}
                                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                            ÁΩÆ‰ø°Â∫¶ ${item.confidence}%
                                        </span>
                                    </div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #f8f4ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">ÂéüÂßãÈóÆÈ¢ò:</div>
                                    <div>‚ùì ${item.original_question}</div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #e7f5ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Âª∫ËÆÆËøΩÈóÆ:</div>
                                    <div>üí¨ ${item.followup_question}</div>
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 11px;">
                                    ÂàõÂª∫Êó∂Èó¥: ${new Date(item.created_at).toLocaleString('zh-CN')}
                                    ${item.asked_at ? ` | ËøΩÈóÆÊó∂Èó¥: ${new Date(item.asked_at).toLocaleString('zh-CN')}` : ''}
                                </div>
                                ${actionButton}
                            </div>
                        `;
                    });

                    container.innerHTML = html;

                    // ‰∏∫ÊâÄÊúâÂèëÈÄÅÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                    container.querySelectorAll('.send-followup-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            const text = this.getAttribute('data-text');
                            const user = this.getAttribute('data-user');
                            sendFollowupFromHistory(id, text, user);
                        });
                    });
                } else {
                    container.innerHTML = '<div style="color: #999; text-align: center;">ÊöÇÊó†ËøΩÈóÆËÆ∞ÂΩï</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩÂ≠¶‰π†Ê®°Âºè
        async function loadLearningPatterns(userId) {
            const container = document.getElementById('learningPatterns');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                // Âπ∂Ë°åËé∑Âèñ‰∏â‰∏™APIÊï∞ÊçÆ
                const [frequentRes, questionsRes, insightsRes] = await Promise.all([
                    fetch(`${API_BASE}/patterns/frequent?user_id=${userId}&limit=10`),
                    fetch(`${API_BASE}/patterns/common_questions?user_id=${userId}&limit=5`),
                    fetch(`${API_BASE}/patterns/insights?user_id=${userId}`)
                ]);

                const frequentData = await frequentRes.json();
                const questionsData = await questionsRes.json();
                const insightsData = await insightsRes.json();

                let html = '';

                // ÊòæÁ§∫ÁªüËÆ°Ê¶ÇËßà
                if (insightsData && insightsData.statistics) {
                    const stats = insightsData.statistics;
                    html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.total_patterns || 0}</div>
                        <div style="font-size: 12px; color: #999;">ÊÄªÂ≠¶‰π†Ê®°Âºè</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.frequent_words_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">È´òÈ¢ëËØçÊ±á</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.common_questions_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">Â∏∏ËßÅÈóÆÈ¢ò</div>
                    </div>`;
                    html += `</div>`;
                }

                // ÊòæÁ§∫È´òÈ¢ëËØç
                if (frequentData.frequent_words && frequentData.frequent_words.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">üìù È´òÈ¢ëËØçÊ±á TOP10</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                    frequentData.frequent_words.forEach(item => {
                        const confidence = item.confidence || 50;
                        const bgColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#3b82f6' : '#6b7280';
                        html += `<span style="background: ${bgColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                            ${item.word} (${item.frequency}Ê¨°)
                        </span>`;
                    });

                    html += `</div></div>`;
                }

                // ÊòæÁ§∫Â∏∏ËßÅÈóÆÈ¢òÂàÜÁ±ª
                if (questionsData.common_questions && questionsData.common_questions.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">‚ùì Â∏∏ËßÅÈóÆÈ¢òÂàÜÁ±ª</div>`;

                    questionsData.common_questions.forEach(item => {
                        const typeEmoji = {
                            'Â§©Ê∞îÊü•ËØ¢': 'üå§Ô∏è',
                            'Êó∂Èó¥Êó•Êúü': '‚è∞',
                            '‰∏™‰∫∫‰ø°ÊÅØ': 'üë§',
                            'ÂäüËÉΩÂí®ËØ¢': 'üîß',
                            'Êé®ËçêÂª∫ËÆÆ': 'üí°',
                            'Èó≤ËÅä': 'üí¨'
                        };

                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #10b981; border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${typeEmoji[item.category] || 'üìå'} ${item.category} 
                                <span style="color: #999; font-size: 12px; font-weight: normal;">(${item.frequency}Ê¨°)</span>
                            </div>`;

                        if (item.examples && item.examples.length > 0) {
                            html += `<div style="font-size: 12px; color: #666; margin-top: 5px;">`;
                            item.examples.slice(0, 2).forEach(example => {
                                html += `<div style="margin: 3px 0;">‚Ä¢ ${example}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                }

                if (!html) {
                    html = '<div style="color: #999; text-align: center;">ÊöÇÊó†Â≠¶‰π†Êï∞ÊçÆÔºåÂ§öËÅäÂá†Âè•ËÆ©Â∞è‰πê‰∫ÜËß£‰Ω†Âêß~</div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ============ Â∑•ÂÖ∑ÁÆ°ÁêÜÂäüËÉΩ (v0.4.0) ============

        // Âä†ËΩΩÂ∑•ÂÖ∑ÂàóË°®
        async function loadTools() {
            const container = document.getElementById('toolsList');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/list?enabled_only=true`);
                const data = await response.json();

                if (!data.tools || data.tools.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">ÊöÇÊó†ÂèØÁî®Â∑•ÂÖ∑</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                data.tools.forEach(tool => {
                    const categoryEmoji = {
                        'weather': 'üå§Ô∏è',
                        'system': 'üíª',
                        'search': 'üîç',
                        'file': 'üìÅ'
                    };

                    const emoji = categoryEmoji[tool.category] || 'üîß';
                    const statusColor = tool.enabled ? '#10b981' : '#9ca3af';
                    const statusText = tool.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®';

                    html += `
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${emoji} ${tool.name}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        ${tool.description}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            üì¶ ${tool.category}
                                        </span>
                                        <span style="background: ${tool.enabled ? '#d1fae5' : '#f3f4f6'}; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            ‚óè ${statusText}
                                        </span>
                                        ${tool.version ? `<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">v${tool.version}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${tool.parameters && tool.parameters.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">üìù ÂèÇÊï∞:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                        ${tool.parameters.map(p => `
                                            <span style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: #4b5563;">
                                                ${p.name}${p.required ? '*' : ''}: ${p.type}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // ÊòæÁ§∫Â∑•ÂÖ∑ÊÄªÊï∞
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `üìã ÂèØÁî®Â∑•ÂÖ∑ <span style="font-size: 12px; color: #999; font-weight: normal;">(ÂÖ± ${data.tools.length} ‰∏™)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Âä†ËΩΩÂ∑•ÂÖ∑ÊâßË°åÂéÜÂè≤
        async function loadToolHistory() {
            const container = document.getElementById('toolHistory');
            const limit = document.getElementById('historyLimit').value;

            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/history?user_id=default_user&limit=${limit}`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">ÊöÇÊó†ÊâßË°åÂéÜÂè≤</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach((record, index) => {
                    const statusColor = record.success ? '#10b981' : '#ef4444';
                    const statusIcon = record.success ? '‚úÖ' : '‚ùå';
                    const executionTime = record.execution_time ? record.execution_time.toFixed(3) : 'N/A';

                    // Ê†ºÂºèÂåñÊó∂Èó¥
                    const date = new Date(record.executed_at);
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 16px;">${statusIcon}</span>
                                    <span style="font-weight: bold; color: #333;">${record.tool_name}</span>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 11px; color: #999;">${timeStr}</span>
                                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        ${executionTime}s
                                    </span>
                                </div>
                            </div>
                            
                            ${record.error_message ? `
                                <div style="margin-top: 5px; padding: 8px; background: #fef2f2; border-radius: 5px; font-size: 12px; color: #991b1b;">
                                    ‚ö†Ô∏è ${record.error_message}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // Êõ¥Êñ∞Ê†áÈ¢òÊòæÁ§∫ÊÄªÊï∞
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `üìä Â∑•ÂÖ∑ÊâßË°åÂéÜÂè≤ <span style="font-size: 12px; color: #999; font-weight: normal;">(ÂÖ± ${data.total} Êù°)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ============ Â∑•ÂÖ∑ÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ============

        // ============ v0.5.0 ÊèêÈÜíÁÆ°ÁêÜÂäüËÉΩ ============

        // Âä†ËΩΩÊèêÈÜíÂàóË°®
        // ÂÖ®Â±ÄÂèòÈáèÔºöÊéßÂà∂ÊòØÂê¶ÊòæÁ§∫Â∑≤ËøáÊúüÊèêÈÜí
        let showExpired = false;

        // ==================== v0.8.0 Phase 3: ÊñáÊ°£ÊÄªÁªìÂäüËÉΩ ====================

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Êñá‰ª∂Á±ªÂûãÊ£ÄÊü•
            const allowedTypes = ['.pdf', '.docx', '.txt', '.md'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExt)) {
                showNotification('‚ùå ‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºÅ‰ªÖÊîØÊåÅ PDF, DOCX, TXT, MD', 'error');
                return;
            }

            // Êñá‰ª∂Â§ßÂ∞èÊ£ÄÊü• (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('‚ùå Êñá‰ª∂ËøáÂ§ßÔºÅÊúÄÂ§ßÊîØÊåÅ 10MB', 'error');
                return;
            }

            // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
            const formData = new FormData();
            formData.append('file', file);

            try {
                showNotification('‚è≥ ‰∏ä‰º†Âπ∂ÂàÜÊûê‰∏≠...', 'info');

                const response = await fetch(`${API_BASE}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`‚úÖ ÊñáÊ°£‰∏ä‰º†ÊàêÂäüÔºÅÊ≠£Âú®ÁîüÊàêÊÄªÁªì...`, 'success');
                    // ÊòæÁ§∫ÊÄªÁªìÁªìÊûú
                    showDocumentSummary(data.document);
                    // Âà∑Êñ∞ÂàóË°®
                    loadDocuments();
                } else {
                    showNotification(`‚ùå ${data.error || '‰∏ä‰º†Â§±Ë¥•'}`, 'error');
                }
            } catch (error) {
                console.error('‰∏ä‰º†ÊñáÊ°£Â§±Ë¥•:', error);
                showNotification('‚ùå ‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú', 'error');
            }

            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            event.target.value = '';
        }

        // Âä†ËΩΩÊñáÊ°£ÂàóË°®
        async function loadDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const userId = 'default_user';
                const response = await fetch(`${API_BASE}/api/users/${userId}/documents?limit=50`);
                const data = await response.json();

                if (data.success && data.documents.length > 0) {
                    let html = '<div style="display: grid; gap: 15px;">';

                    data.documents.forEach(doc => {
                        const statusColor = {
                            'completed': '#10b981',
                            'processing': '#3b82f6',
                            'failed': '#ef4444',
                            'pending': '#f59e0b'
                        }[doc.status] || '#6b7280';

                        const statusText = {
                            'completed': '‚úÖ Â∑≤ÂÆåÊàê',
                            'processing': '‚ö° Â§ÑÁêÜ‰∏≠',
                            'failed': '‚ùå Â§±Ë¥•',
                            'pending': '‚è≥ ÂæÖÂ§ÑÁêÜ'
                        }[doc.status] || doc.status;

                        html += `
                            <div style="background: white; padding: 15px; border-radius: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">
                                            üìÑ ${escapeHtml(doc.original_filename)}
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            ${doc.file_type.toUpperCase()} ¬∑ ${(doc.file_size / 1024).toFixed(1)} KB ¬∑ 
                                            ${new Date(doc.created_at).toLocaleString('zh-CN')}
                                        </div>
                                    </div>
                                    <div style="background: ${statusColor}; color: white; padding: 4px 12px; 
                                                border-radius: 12px; font-size: 12px; white-space: nowrap;">
                                        ${statusText}
                                    </div>
                                </div>
                                
                                ${doc.summary ? `
                                    <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin: 10px 0; 
                                                font-size: 13px; color: #374151; line-height: 1.6;">
                                        ${escapeHtml(doc.summary.substring(0, 200))}${doc.summary.length > 200 ? '...' : ''}
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    ${doc.status === 'completed' ? `
                                        <button onclick="viewDocumentSummary(${doc.id})"
                                            style="padding: 6px 12px; background: #667eea; color: white; border: none; 
                                                   border-radius: 6px; cursor: pointer; font-size: 13px;">
                                            üîç Êü•ÁúãËØ¶ÊÉÖ
                                        </button>
                                        <button onclick="exportDocumentSummary(${doc.id})"
                                            style="padding: 6px 12px; background: #10b981; color: white; border: none; 
                                                   border-radius: 6px; cursor: pointer; font-size: 13px;">
                                            üíæ ÂØºÂá∫
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteDocument(${doc.id})"
                                        style="padding: 6px 12px; background: #ef4444; color: white; border: none; 
                                               border-radius: 6px; cursor: pointer; font-size: 13px;">
                                        üóëÔ∏è Âà†Èô§
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">üì≠ ËøòÊ≤°Êúâ‰∏ä‰º†‰ªª‰ΩïÊñáÊ°£</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊñáÊ°£ÂàóË°®Â§±Ë¥•:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">‚ùå Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        // Êü•ÁúãÊñáÊ°£ÊÄªÁªìËØ¶ÊÉÖ
        async function viewDocumentSummary(docId) {
            try {
                const response = await fetch(`${API_BASE}/api/documents/${docId}`);
                const data = await response.json();

                console.log('ÊñáÊ°£ËØ¶ÊÉÖAPIÂìçÂ∫î:', data);

                if (data.success) {
                    showDocumentSummary(data.document);
                } else {
                    console.error('Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•:', data.error);
                    showNotification(`‚ùå Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•: ${data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•:', error);
                showNotification(`‚ùå Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÊòæÁ§∫ÊñáÊ°£ÊÄªÁªì
        function showDocumentSummary(doc) {
            // key_points ÂèØËÉΩÊòØÂ≠óÁ¨¶‰∏≤ÊàñÊï∞ÁªÑ
            let keyPoints = [];
            try {
                if (typeof doc.key_points === 'string') {
                    keyPoints = JSON.parse(doc.key_points);
                } else if (Array.isArray(doc.key_points)) {
                    keyPoints = doc.key_points;
                }
            } catch (e) {
                console.error('Ëß£Êûêkey_pointsÂ§±Ë¥•:', e);
            }

            let html = `
                <div style="max-width: 700px;">
                    <h3>üìÑ ${escapeHtml(doc.original_filename)}</h3>
                    
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                            <div><strong>Êñá‰ª∂Á±ªÂûã:</strong> ${doc.file_type.toUpperCase()}</div>
                            <div><strong>Êñá‰ª∂Â§ßÂ∞è:</strong> ${(doc.file_size / 1024).toFixed(1)} KB</div>
                            <div><strong>ÂéüÊñáÈïøÂ∫¶:</strong> ${doc.content_length || 0} Â≠ó</div>
                            <div><strong>ÊÄªÁªìÈïøÂ∫¶:</strong> ${doc.summary_length || 0} Â≠ó</div>
                            <div><strong>ÂàÜÂùóÊï∞:</strong> ${doc.chunk_count || 1}</div>
                            <div><strong>Â§ÑÁêÜÊó∂Èó¥:</strong> ${doc.processing_time ? doc.processing_time.toFixed(2) + 'Áßí' : 'N/A'}</div>
                        </div>
                    </div>

                    ${keyPoints.length > 0 ? `
                        <div style="margin: 20px 0;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">‚ú® ÂÖ≥ÈîÆË¶ÅÁÇπ</h4>
                            <ul style="background: #f9fafb; padding: 15px 15px 15px 35px; border-radius: 8px; 
                                       line-height: 1.8; margin: 0;">
                                ${keyPoints.map(point => `<li>${escapeHtml(point)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div style="margin: 20px 0;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìù Êô∫ËÉΩÊÄªÁªì</h4>
                        <div class="markdown-content" style="background: #f9fafb; padding: 25px 30px; 
                                    border-radius: 8px; line-height: 1.8; color: #374151;">
                            ${marked.parse(doc.summary || 'ÊÄªÁªìÁîüÊàê‰∏≠...')}
                        </div>
                    </div>
                </div>
            `;

            showCustomNotification('ÊñáÊ°£ÊÄªÁªì', html);

            // ‰∏∫MarkdownÂÜÖÂÆπÊ∑ªÂä†Ê†∑Âºè
            setTimeout(() => {
                const markdownContent = document.querySelector('.custom-notification .markdown-content');
                if (markdownContent) {
                    // Ê†áÈ¢òÊ†∑Âºè
                    markdownContent.querySelectorAll('h1, h2, h3, h4').forEach(h => {
                        h.style.color = '#1f2937';
                        h.style.marginTop = '16px';
                        h.style.marginBottom = '8px';
                        h.style.fontWeight = 'bold';
                    });
                    // ÂàóË°®Ê†∑Âºè
                    markdownContent.querySelectorAll('ol, ul').forEach(list => {
                        list.style.marginLeft = '20px';
                        list.style.marginTop = '8px';
                        list.style.marginBottom = '8px';
                    });
                    markdownContent.querySelectorAll('li').forEach(li => {
                        li.style.marginBottom = '4px';
                    });
                    // ÊÆµËêΩÊ†∑Âºè
                    markdownContent.querySelectorAll('p').forEach(p => {
                        p.style.marginBottom = '12px';
                    });
                    // Á≤ó‰ΩìÊ†∑Âºè
                    markdownContent.querySelectorAll('strong').forEach(strong => {
                        strong.style.color = '#374151';
                        strong.style.fontWeight = '600';
                    });
                }
            }, 100);
        }

        // ÂØºÂá∫ÊñáÊ°£ÊÄªÁªì
        async function exportDocumentSummary(docId) {
            try {
                window.open(`${API_BASE}/api/documents/${docId}/export?format=md`, '_blank');
                showNotification('‚úÖ Ê≠£Âú®‰∏ãËΩΩ...', 'success');
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showNotification('‚ùå ÂØºÂá∫Â§±Ë¥•', 'error');
            }
        }

        // Âà†Èô§ÊñáÊ°£
        async function deleteDocument(docId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£ÂêóÔºü')) return;

            try {
                const response = await fetch(`${API_BASE}/api/documents/${docId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ ÊñáÊ°£Â∑≤Âà†Èô§', 'success');
                    loadDocuments();
                } else {
                    showNotification('‚ùå Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§ÊñáÊ°£Â§±Ë¥•:', error);
                showNotification('‚ùå Âà†Èô§Â§±Ë¥•', 'error');
            }
        }

        // ==================== ÊèêÈÜíÁÆ°ÁêÜ ====================

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders?user_id=default_user&enabled_only=false`);
                const data = await response.json();

                if (!data.reminders || data.reminders.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ËøòÊ≤°ÊúâÊèêÈÜíÔºåÁÇπÂáª"ÂàõÂª∫ÊèêÈÜí"Êù•Ê∑ªÂä†ÔºÅ</div>';
                    updateReminderStats(0, 0, 0);
                    return;
                }

                // ÁªüËÆ°Êï∞ÊçÆ
                let activeCount = 0;
                let disabledCount = 0;
                let triggeredCount = 0;

                data.reminders.forEach(r => {
                    if (r.trigger_count > 0 || r.last_triggered) {
                        triggeredCount++;
                    } else if (r.enabled) {
                        activeCount++;
                    } else {
                        disabledCount++;
                    }
                });

                updateReminderStats(activeCount, disabledCount, triggeredCount);

                // ËøáÊª§ÔºöÊ†πÊçÆshowExpiredÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫Â∑≤Ëß¶ÂèëÁöÑÊèêÈÜí
                let displayReminders;
                if (showExpired) {
                    displayReminders = data.reminders;
                } else {
                    // Âè™ÊòæÁ§∫Êú™Ëß¶ÂèëÁöÑÊèêÈÜíÔºàÂåÖÊã¨ÂêØÁî®ÂíåÁ¶ÅÁî®Ôºâ
                    displayReminders = data.reminders.filter(r => !r.trigger_count && !r.last_triggered);
                }

                if (displayReminders.length === 0) {
                    if (showExpired) {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Ê≤°ÊúâÊèêÈÜíËÆ∞ÂΩï„ÄÇ</div>';
                    } else {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Ê≤°ÊúâÂæÖËß¶ÂèëÁöÑÊèêÈÜí„ÄÇ<br><br>ÁÇπÂáª"üëÅÔ∏è ÊòæÁ§∫Â∑≤ËøáÊúü"Êü•ÁúãÂ∑≤Ëß¶ÂèëÁöÑÊèêÈÜí„ÄÇ</div>';
                    }
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                displayReminders.forEach(reminder => {
                    const priorityColors = {
                        1: { color: '#ef4444', emoji: 'üî¥', label: 'ÊúÄÈ´ò' },
                        2: { color: '#f59e0b', emoji: 'üü†', label: 'È´ò' },
                        3: { color: '#eab308', emoji: 'üü°', label: '‰∏≠' },
                        4: { color: '#10b981', emoji: 'üü¢', label: '‰Ωé' },
                        5: { color: '#6b7280', emoji: '‚ö™', label: 'ÊúÄ‰Ωé' }
                    };

                    const priority = priorityColors[reminder.priority] || priorityColors[3];

                    // Âà§Êñ≠ÊòØÂê¶Â∑≤Ëß¶Âèë
                    const isTriggered = reminder.trigger_count > 0 || reminder.last_triggered;
                    const statusColor = isTriggered ? '#9ca3af' : (reminder.enabled ? '#10b981' : '#9ca3af');
                    const statusText = isTriggered ? 'Â∑≤Ëß¶Âèë' : (reminder.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®');

                    // Â∑≤Ëß¶ÂèëÁöÑÊèêÈÜíÁî®ÁÅ∞Ëâ≤ËÉåÊôØ
                    const cardBg = isTriggered ? '#f3f4f6' : 'white';
                    const cardOpacity = isTriggered ? 'opacity: 0.8;' : '';

                    const typeEmoji = {
                        'time': '‚è∞',
                        'weather': 'üå§Ô∏è',
                        'behavior': 'üë§',
                        'habit': 'üéØ'
                    };

                    html += `
                        <div style="background: ${cardBg}; padding: 15px; border-radius: 10px; border-left: 4px solid ${priority.color}; ${cardOpacity}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${priority.emoji} ${reminder.title || 'Êó†Ê†áÈ¢ò'}
                                        ${isTriggered ? '<span style="font-size: 12px; color: #9ca3af; margin-left: 8px;">üìú Â∑≤Ëß¶Âèë</span>' : ''}
                                    </div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                        ${reminder.content}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            ${typeEmoji[reminder.reminder_type] || 'üìå'} ${reminder.reminder_type}
                                        </span>
                                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            ‚óè ${statusText}
                                        </span>
                                        <span style="background: ${priority.color}20; color: ${priority.color}; padding: 3px 8px; border-radius: 4px;">
                                            ‰ºòÂÖàÁ∫ß: ${priority.label}
                                        </span>
                                        ${reminder.repeat ? '<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">üîÑ ÈáçÂ§ç</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px; margin-left: 10px;">
                                    ${!isTriggered ? `
                                        <button onclick="toggleReminder(${reminder.reminder_id})" 
                                            style="padding: 6px 12px; background: ${reminder.enabled ? '#ef4444' : '#10b981'}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                            ${reminder.enabled ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteReminder(${reminder.reminder_id})" 
                                        style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        Âà†Èô§
                                    </button>
                                </div>
                            </div>
                            ${reminder.last_triggered ? `
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    ‰∏äÊ¨°Ëß¶Âèë: ${new Date(reminder.last_triggered).toLocaleString('zh-CN')}
                                    ${reminder.trigger_count ? ` | Ëß¶ÂèëÊ¨°Êï∞: ${reminder.trigger_count}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
        function updateReminderStats(activeCount, disabledCount, triggeredCount) {
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('disabledCount').textContent = disabledCount;
            document.getElementById('triggeredCount').textContent = triggeredCount;
        }

        // ÂàáÊç¢ÊòØÂê¶ÊòæÁ§∫Â∑≤ËøáÊúüÊèêÈÜí
        function toggleExpiredReminders() {
            showExpired = !showExpired;
            const btn = document.getElementById('toggleExpiredBtn');
            btn.textContent = showExpired ? 'üö´ ÈöêËóèÂ∑≤ËøáÊúü' : 'üëÅÔ∏è ÊòæÁ§∫Â∑≤ËøáÊúü';
            loadReminders();
        }

        // Âä†ËΩΩÊèêÈÜíÂéÜÂè≤
        async function loadReminderHistory() {
            const container = document.getElementById('reminderHistory');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders/history/default_user?limit=20`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach(record => {
                    const typeEmoji = {
                        'time': '‚è∞',
                        'weather': 'üå§Ô∏è',
                        'behavior': 'üë§',
                        'habit': 'üéØ'
                    };

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                ${typeEmoji[record.reminder_type] || 'üìå'} ${record.title || 'Êó†Ê†áÈ¢ò'}
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                ${record.content}
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                Ëß¶ÂèëÊó∂Èó¥: ${new Date(record.triggered_at).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // ÂàõÂª∫ÊèêÈÜíÂØπËØùÊ°Ü
        function showCreateReminderDialog() {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="reminderDialog">
                    <div style="background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">‚ûï ÂàõÂª∫Êñ∞ÊèêÈÜí</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ê†áÈ¢ò:</label>
                            <input type="text" id="reminderTitle" placeholder="‰æãÂ¶ÇÔºöÂõ¢Èòü‰ºöËÆÆ" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÂÜÖÂÆπ:</label>
                            <textarea id="reminderContent" placeholder="ÊèêÈÜíÁöÑËØ¶ÁªÜÂÜÖÂÆπ..." rows="3"
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ëß¶ÂèëÊó∂Èó¥:</label>
                            <input type="datetime-local" id="reminderTime" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">‰ºòÂÖàÁ∫ß:</label>
                            <select id="reminderPriority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="1">üî¥ ÊúÄÈ´ò</option>
                                <option value="2">üü† È´ò</option>
                                <option value="3" selected>üü° ‰∏≠</option>
                                <option value="4">üü¢ ‰Ωé</option>
                                <option value="5">‚ö™ ÊúÄ‰Ωé</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button onclick="closeReminderDialog()" 
                                style="padding: 10px 20px; background: #9ca3af; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ÂèñÊ∂à
                            </button>
                            <button onclick="createReminder()" 
                                style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ÂàõÂª∫
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialog);
        }

        function closeReminderDialog() {
            const dialog = document.getElementById('reminderDialog');
            if (dialog) dialog.remove();
        }

        // ÂàõÂª∫ÊèêÈÜí
        async function createReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const content = document.getElementById('reminderContent').value.trim();
            const time = document.getElementById('reminderTime').value;
            const priority = parseInt(document.getElementById('reminderPriority').value);

            if (!content) {
                alert('ËØ∑ËæìÂÖ•ÊèêÈÜíÂÜÖÂÆπ');
                return;
            }

            if (!time) {
                alert('ËØ∑ÈÄâÊã©Ëß¶ÂèëÊó∂Èó¥');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        reminder_type: 'time',
                        trigger_condition: { datetime: time.replace('T', ' ') + ':00' },
                        title: title || 'Êñ∞ÊèêÈÜí',
                        content: content,
                        priority: priority,
                        repeat: false
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeReminderDialog();
                    loadReminders();
                    alert('‚úÖ ÊèêÈÜíÂàõÂª∫ÊàêÂäüÔºÅ');
                } else {
                    alert('‚ùå ÂàõÂª∫Â§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå ÂàõÂª∫Â§±Ë¥•: ' + error.message);
            }
        }

        // ÂàáÊç¢ÊèêÈÜíÁä∂ÊÄÅ
        async function toggleReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•');
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âà†Èô§ÊèêÈÜí
        async function deleteReminder(reminderId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÊèêÈÜíÂêóÔºü')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                    alert('‚úÖ Âà†Èô§ÊàêÂäü');
                } else {
                    alert('‚ùå Âà†Èô§Â§±Ë¥•');
                }
            } catch (error) {
                alert('‚ùå Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // Á´ãÂç≥Ê£ÄÊü•ÊèêÈÜí
        async function checkReminders() {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'default_user' })
                });

                const data = await response.json();

                if (data.triggered && data.triggered.length > 0) {
                    alert(`‚úÖ Ê£ÄÊü•ÂÆåÊàêÔºÅËß¶Âèë‰∫Ü ${data.triggered.length} Êù°ÊèêÈÜí`);
                    loadReminderHistory();
                } else {
                    alert('‚úÖ Ê£ÄÊü•ÂÆåÊàêÔºÅÂΩìÂâçÊ≤°ÊúâÈúÄË¶ÅËß¶ÂèëÁöÑÊèêÈÜí');
                }
            } catch (error) {
                alert('‚ùå Ê£ÄÊü•Â§±Ë¥•: ' + error.message);
            }
        }

        // ============ ÊèêÈÜíÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ============

        // ============ v0.8.0 ‰ªªÂä°ÁÆ°ÁêÜÂäüËÉΩ ============

        // HTMLËΩ¨‰πâÂáΩÊï∞ÔºåÈò≤Ê≠¢XSSÊîªÂáª
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Âä†ËΩΩ‰ªªÂä°ÂàóË°®
        async function loadTasks() {
            const container = document.getElementById('tasksList');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const statusFilter = document.getElementById('taskStatusFilter').value;
                const userId = 'default_user'; // ‰ΩøÁî®ÈªòËÆ§Áî®Êà∑ID

                let url = `${API_BASE}/api/users/${userId}/tasks?limit=50`;
                if (statusFilter) {
                    url += `&status=${statusFilter}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•');
                }

                const tasks = data.tasks || [];

                // Êõ¥Êñ∞ÁªüËÆ°
                updateTaskStats(tasks);

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="loading">ÊöÇÊó†‰ªªÂä°</div>';
                    return;
                }

                // Êåâ‰ºòÂÖàÁ∫ßÂíåÁä∂ÊÄÅÊéíÂ∫è
                tasks.sort((a, b) => {
                    if (a.priority !== b.priority) return b.priority - a.priority;
                    if (a.status !== b.status) {
                        const order = ['in_progress', 'pending', 'waiting', 'failed', 'completed', 'cancelled'];
                        return order.indexOf(a.status) - order.indexOf(b.status);
                    }
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                // Ê∏≤Êüì‰ªªÂä°Âç°Áâá
                let html = '<div>';
                tasks.forEach(task => {
                    html += renderTaskCard(task);
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•:', error);
                container.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
            }
        }

        // Ê∏≤Êüì‰ªªÂä°Âç°Áâá
        function renderTaskCard(task) {
            const statusMap = {
                'pending': 'ÂæÖÂ§ÑÁêÜ',
                'in_progress': 'ÊâßË°å‰∏≠',
                'waiting': 'Á≠âÂæÖ‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê',
                'failed': 'Â§±Ë¥•',
                'cancelled': 'Â∑≤ÂèñÊ∂à'
            };

            const priorityMap = {
                0: 'ÊôÆÈÄö',
                1: 'ÈáçË¶Å',
                2: 'Á¥ßÊÄ•'
            };

            const progress = task.total_steps > 0
                ? Math.round((task.current_step / task.total_steps) * 100)
                : 0;

            const statusClass = task.status;
            const statusText = statusMap[task.status] || task.status;
            const priorityClass = `priority-${task.priority}`;
            const priorityText = priorityMap[task.priority] || 'ÊôÆÈÄö';

            const createdTime = new Date(task.created_at).toLocaleString('zh-CN');
            const updatedTime = task.updated_at ? new Date(task.updated_at).toLocaleString('zh-CN') : '-';

            return `
                <div class="task-card status-${statusClass}">
                    <div class="task-header">
                        <div style="flex: 1;">
                            <div class="task-title">${escapeHtml(task.title)}</div>
                            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <span class="priority-badge ${priorityClass}">${priorityText}</span>
                            <span class="task-status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>

                    ${task.total_steps > 0 ? `
                    <div class="task-progress">
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="task-progress-text">${task.current_step}/${task.total_steps}</div>
                    </div>
                    ` : ''}

                    <div class="task-meta">
                        <span>üìÖ ÂàõÂª∫: ${createdTime}</span>
                        <span>üîÑ Êõ¥Êñ∞: ${updatedTime}</span>
                        ${task.retry_count > 0 ? `<span>üîÅ ÈáçËØï: ${task.retry_count}Ê¨°</span>` : ''}
                    </div>

                    <div class="task-actions">
                        <button class="task-btn task-btn-primary" onclick="showTaskDetails(${task.id})">üìã ËØ¶ÊÉÖ</button>
                        ${task.status === 'pending' || task.status === 'waiting' ? `
                        <button class="task-btn task-btn-success" onclick="executeTask(${task.id})">‚ñ∂Ô∏è ÊâßË°å</button>
                        ` : ''}
                        ${task.status === 'in_progress' || task.status === 'waiting' ? `
                        <button class="task-btn task-btn-secondary" onclick="cancelTask(${task.id})">‚è∏Ô∏è ÂèñÊ∂à</button>
                        ` : ''}
                        ${task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled' ? `
                        <button class="task-btn task-btn-danger" onclick="deleteTask(${task.id})">üóëÔ∏è Âà†Èô§</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Êõ¥Êñ∞‰ªªÂä°ÁªüËÆ°
        function updateTaskStats(tasks) {
            const stats = {
                pending: 0,
                in_progress: 0,
                completed: 0,
                failed: 0
            };

            tasks.forEach(task => {
                if (stats.hasOwnProperty(task.status)) {
                    stats[task.status]++;
                }
            });

            document.getElementById('taskPendingCount').textContent = stats.pending;
            document.getElementById('taskInProgressCount').textContent = stats.in_progress;
            document.getElementById('taskCompletedCount').textContent = stats.completed;
            document.getElementById('taskFailedCount').textContent = stats.failed;
        }

        // ÊòæÁ§∫‰ªªÂä°ËØ¶ÊÉÖ
        async function showTaskDetails(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•');
                }

                const task = data.task;
                const steps = data.steps || [];

                let stepsHtml = '';
                if (steps.length > 0) {
                    stepsHtml = '<div style="margin-top: 15px;"><h4>‰ªªÂä°Ê≠•È™§:</h4>';
                    steps.forEach((step, index) => {
                        const stepStatus = step.status || 'pending';
                        const stepClass = stepStatus === 'completed' ? 'completed' : (stepStatus === 'failed' ? 'failed' : '');
                        stepsHtml += `
                            <div class="task-step ${stepClass}">
                                <div class="task-step-header">
                                    <span class="task-step-title">${index + 1}. ${escapeHtml(step.description)}</span>
                                    <span class="task-step-status">${stepStatus}</span>
                                </div>
                                ${step.action_type ? `<div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Á±ªÂûã: ${step.action_type}</div>` : ''}
                                ${step.error ? `<div style="font-size: 12px; color: #ef4444; margin-top: 5px;">ÈîôËØØ: ${escapeHtml(step.error)}</div>` : ''}
                            </div>
                        `;
                    });
                    stepsHtml += '</div>';
                }

                const detailHtml = `
                    <div style="max-width: 600px;">
                        <h3>${escapeHtml(task.title)}</h3>
                        ${task.description ? `<p style="color: #6b7280; margin: 10px 0;">${escapeHtml(task.description)}</p>` : ''}
                        
                        <div style="margin: 15px 0; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                            <div><strong>Áä∂ÊÄÅ:</strong> ${task.status}</div>
                            <div><strong>‰ºòÂÖàÁ∫ß:</strong> ${task.priority}</div>
                            <div><strong>ËøõÂ∫¶:</strong> ${task.current_step}/${task.total_steps}</div>
                            <div><strong>ÂàõÂª∫Êó∂Èó¥:</strong> ${new Date(task.created_at).toLocaleString('zh-CN')}</div>
                            ${task.started_at ? `<div><strong>ÂºÄÂßãÊó∂Èó¥:</strong> ${new Date(task.started_at).toLocaleString('zh-CN')}</div>` : ''}
                            ${task.completed_at ? `<div><strong>ÂÆåÊàêÊó∂Èó¥:</strong> ${new Date(task.completed_at).toLocaleString('zh-CN')}</div>` : ''}
                        </div>

                        ${stepsHtml}
                    </div>
                `;

                // ‰ΩøÁî®Áé∞ÊúâÁöÑÈÄöÁü•ÂºπÁ™óÊòæÁ§∫ËØ¶ÊÉÖ
                showCustomNotification('‰ªªÂä°ËØ¶ÊÉÖ', detailHtml);

            } catch (error) {
                console.error('Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•:', error);
                showNotification('‚ùå Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•', 'error');
            }
        }

        // ÊâßË°å‰ªªÂä°
        async function executeTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÊâßË°åËøô‰∏™‰ªªÂä°Âêó?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        session_id: currentSessionId || ''
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'ÊâßË°å‰ªªÂä°Â§±Ë¥•');
                }

                showNotification('‚úÖ ‰ªªÂä°ÊâßË°åÊàêÂäü', 'success');
                loadTasks(); // Âà∑Êñ∞ÂàóË°®

            } catch (error) {
                console.error('ÊâßË°å‰ªªÂä°Â§±Ë¥•:', error);
                showNotification(`‚ùå ÊâßË°åÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÂèñÊ∂à‰ªªÂä°
        async function cancelTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àËøô‰∏™‰ªªÂä°Âêó?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'ÂèñÊ∂à‰ªªÂä°Â§±Ë¥•');
                }

                showNotification('‚úÖ ‰ªªÂä°Â∑≤ÂèñÊ∂à', 'success');
                loadTasks(); // Âà∑Êñ∞ÂàóË°®

            } catch (error) {
                console.error('ÂèñÊ∂à‰ªªÂä°Â§±Ë¥•:', error);
                showNotification(`‚ùå ÂèñÊ∂àÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Âà†Èô§‰ªªÂä°
        async function deleteTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°Âêó? Ê≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç!')) return;

            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Âà†Èô§‰ªªÂä°Â§±Ë¥•');
                }

                showNotification('‚úÖ ‰ªªÂä°Â∑≤Âà†Èô§', 'success');
                loadTasks(); // Âà∑Êñ∞ÂàóË°®

            } catch (error) {
                console.error('Âà†Èô§‰ªªÂä°Â§±Ë¥•:', error);
                showNotification(`‚ùå Âà†Èô§Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÊòæÁ§∫ÂàõÂª∫‰ªªÂä°ÂØπËØùÊ°Ü
        function showCreateTaskDialog() {
            const html = `
                <div style="max-width: 500px;">
                    <h3>ÂàõÂª∫Êñ∞‰ªªÂä°</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">‰ªªÂä°Ê†áÈ¢ò:</label>
                        <input type="text" id="newTaskTitle" placeholder="ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò" 
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">‰ªªÂä°ÊèèËø∞:</label>
                        <textarea id="newTaskDesc" placeholder="ËæìÂÖ•‰ªªÂä°ÊèèËø∞ÔºàÂèØÈÄâÔºâ" rows="3"
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">‰ºòÂÖàÁ∫ß:</label>
                        <select id="newTaskPriority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="0">ÊôÆÈÄö</option>
                            <option value="1">ÈáçË¶Å</option>
                            <option value="2">Á¥ßÊÄ•</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="createTask()" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚úÖ ÂàõÂª∫
                        </button>
                        <button onclick="closeCustomNotification()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚ùå ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            `;
            showCustomNotification('ÂàõÂª∫‰ªªÂä°', html);
        }

        // ÂàõÂª∫‰ªªÂä°
        async function createTask() {
            const title = document.getElementById('newTaskTitle').value.trim();
            const description = document.getElementById('newTaskDesc').value.trim();
            const priority = parseInt(document.getElementById('newTaskPriority').value);

            if (!title) {
                showNotification('‚ùå ËØ∑ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        session_id: currentSessionId || '',
                        title: title,
                        description: description,
                        priority: priority
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'ÂàõÂª∫‰ªªÂä°Â§±Ë¥•');
                }

                showNotification('‚úÖ ‰ªªÂä°ÂàõÂª∫ÊàêÂäü', 'success');
                closeCustomNotification();
                loadTasks(); // Âà∑Êñ∞ÂàóË°®

            } catch (error) {
                console.error('ÂàõÂª∫‰ªªÂä°Â§±Ë¥•:', error);
                showNotification(`‚ùå ÂàõÂª∫Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÊòæÁ§∫Ëá™ÂÆö‰πâÈÄöÁü•ÂºπÁ™ó
        function showCustomNotification(title, content) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÂºπÁ™ó
            const existing = document.querySelector('.custom-notification-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.className = 'custom-notification-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--card-bg);
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 8px 24px var(--shadow-heavy);
                max-width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            modal.innerHTML = content;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // ÁÇπÂáªoverlayÂÖ≥Èó≠
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeCustomNotification();
                }
            });
        }

        // ÂÖ≥Èó≠Ëá™ÂÆö‰πâÈÄöÁü•
        function closeCustomNotification() {
            const overlay = document.querySelector('.custom-notification-overlay');
            if (overlay) overlay.remove();
        }

        // ============ v0.8.0 ‰ªªÂä°ÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ============

        // ============ v0.7.0 ËØæÁ®ãË°®ÁÆ°ÁêÜÂäüËÉΩ ============

        // ËØæÁ®ãË°®Êï∞ÊçÆÁªìÊûÑ
        let scheduleData = {
            periods: ['Á¨¨1ËäÇ', 'Á¨¨2ËäÇ', 'Á¨¨3ËäÇ', 'Á¨¨4ËäÇ', 'Á¨¨5ËäÇ', 'Á¨¨6ËäÇ', 'Á¨¨7ËäÇ'],
            weekdays: ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î'],
            courses: {} // {period_day: 'course_name'}
        };

        // Âä†ËΩΩËØæÁ®ãË°®
        async function loadSchedule() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Âä†ËΩΩ‰∏≠...</td></tr>';

            try {
                const response = await fetch(`${API_BASE}/api/schedule?user_id=default_user`);
                const data = await response.json();

                console.log('üìÖ ËØæÁ®ãË°®APIÂìçÂ∫î:', data);

                if (data.success && data.schedule) {
                    scheduleData = data.schedule;
                    console.log('‚úÖ ËØæÁ®ãË°®Âä†ËΩΩÊàêÂäü:', scheduleData);
                    console.log('üìä ËØæÁ®ãÊï∞Èáè:', Object.keys(scheduleData.courses).length);
                } else {
                    console.warn('‚ö†Ô∏è APIÊú™ËøîÂõûËØæÁ®ãË°®ÔºåÂ∞ùËØï‰ªéËÆ∞ÂøÜËß£Êûê');
                    // Â∞ùËØï‰ªéËÆ∞ÂøÜ‰∏≠Ëß£ÊûêËØæÁ®ãË°®
                    await parseScheduleFromMemory();
                }

                // Ê∏≤ÊüìËØæÁ®ãË°®
                renderSchedule();
                showNotification('‚úÖ ËØæÁ®ãË°®Âä†ËΩΩÊàêÂäü', 'success');

            } catch (error) {
                console.error('‚ùå Âä†ËΩΩËØæÁ®ãË°®Â§±Ë¥•:', error);
                // Â∞ùËØï‰ªéËÆ∞ÂøÜ‰∏≠Ëß£Êûê
                await parseScheduleFromMemory();
                renderSchedule();
            }
        }

        // ‰ªéËÆ∞ÂøÜ‰∏≠Ëß£ÊûêËØæÁ®ãË°®
        async function parseScheduleFromMemory() {
            try {
                const response = await fetch(`${API_BASE}/memory/search?keywords=ËØæÁ®ãË°®`);
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    const scheduleMemory = data.memories[0];
                    const content = scheduleMemory.content;

                    // Ëß£ÊûêËØæÁ®ãË°®ÊñáÊú¨ÔºàÊ†ºÂºèÔºöÂë®‰∏ÄÔºöÊô®ËØª-ÁßëÂ≠¶(5)-...Ôºâ
                    const lines = content.split('\n');
                    scheduleData.courses = {};

                    lines.forEach(line => {
                        const match = line.match(/^(Âë®[‰∏Ä‰∫å‰∏âÂõõ‰∫î])[:Ôºö](.*)/);
                        if (match) {
                            const day = match[1];
                            const courses = match[2].split('-');

                            courses.forEach((course, index) => {
                                if (course && course.trim()) {
                                    const key = `${index}_${day}`;
                                    scheduleData.courses[key] = course.trim();
                                }
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('‰ªéËÆ∞ÂøÜËß£ÊûêËØæÁ®ãË°®Â§±Ë¥•:', error);
            }
        }

        // Ê∏≤ÊüìËØæÁ®ãË°®
        function renderSchedule() {
            const tbody = document.getElementById('scheduleBody');
            let html = '';

            scheduleData.periods.forEach((period, periodIndex) => {
                html += '<tr>';
                html += `<td style="font-weight: bold; background: var(--background);">${period}</td>`;

                scheduleData.weekdays.forEach((day, dayIndex) => {
                    const key = `${periodIndex}_${day}`;
                    const course = scheduleData.courses[key] || '';
                    html += `<td><input type="text" value="${course}" 
                        onchange="updateCourse(${periodIndex}, '${day}', this.value)"
                        placeholder=""
                        style="width: 100%; padding: 8px; border: 1px solid var(--border-color); 
                               border-radius: 4px; background: var(--background); color: var(--text-color);">
                    </td>`;
                });

                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // Êõ¥Êñ∞Âçï‰∏™ËØæÁ®ã
        function updateCourse(periodIndex, day, value) {
            const key = `${periodIndex}_${day}`;
            if (value && value.trim()) {
                scheduleData.courses[key] = value.trim();
            } else {
                delete scheduleData.courses[key];
            }
            console.log('ËØæÁ®ãÂ∑≤Êõ¥Êñ∞:', key, value);
        }

        // ‰øùÂ≠òËØæÁ®ãË°®
        async function saveSchedule() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        schedule: scheduleData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ ËØæÁ®ãË°®‰øùÂ≠òÊàêÂäü', 'success');
                } else {
                    showNotification('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'), 'error');
                }

            } catch (error) {
                console.error('‰øùÂ≠òËØæÁ®ãË°®Â§±Ë¥•:', error);
                showNotification('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ============ ËØæÁ®ãË°®ÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ============

        // ============ WebSocketÂÆûÊó∂Êé®ÈÄÅ ============
        let ws = null;
        let wsReconnectTimer = null;
        let unreadReminderCount = 0;

        function connectWebSocket() {
            try {
                // Âª∫Á´ãWebSocketËøûÊé•
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('‚úÖ WebSocketÂ∑≤ËøûÊé•');
                    clearTimeout(wsReconnectTimer);

                    // ÂèëÈÄÅÂøÉË∑≥
                    setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send('ping');
                        }
                    }, 30000); // ÊØè30ÁßíÂèëÈÄÅÂøÉË∑≥
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'reminder') {
                            // Êî∂Âà∞ÊèêÈÜíÊé®ÈÄÅ
                            handleReminderPush(message.data);
                        } else if (message.type === 'proactive_chat') {
                            // Êî∂Âà∞‰∏ªÂä®ÂØπËØùÊé®ÈÄÅ
                            handleProactiveChatPush(message);
                        } else if (message.type === 'pong') {
                            // ÂøÉË∑≥ÂìçÂ∫î
                            console.log('ÂøÉË∑≥ÂìçÂ∫î');
                        }
                    } catch (error) {
                        console.error('Ëß£ÊûêWebSocketÊ∂àÊÅØÂ§±Ë¥•:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocketÈîôËØØ:', error);
                };

                ws.onclose = () => {
                    console.log('‚ùå WebSocketÂ∑≤Êñ≠ÂºÄÔºå5ÁßíÂêéÈáçËøû...');
                    wsReconnectTimer = setTimeout(connectWebSocket, 5000);
                };

            } catch (error) {
                console.error('WebSocketËøûÊé•Â§±Ë¥•:', error);
                wsReconnectTimer = setTimeout(connectWebSocket, 5000);
            }
        }

        function handleReminderPush(reminder) {
            console.log('Êî∂Âà∞ÊèêÈÜíÊé®ÈÄÅ:', reminder);

            // Êí≠ÊîæÊèêÁ§∫Èü≥
            playReminderSound();

            // Â¢ûÂä†Êú™ËØªËÆ°Êï∞
            unreadReminderCount++;
            updateReminderBadge();

            // ÊòæÁ§∫ÊèêÈÜíÂºπÁ™ó
            showReminderNotification(reminder);

            // Â¶ÇÊûúÈ°µÈù¢‰∏çÂú®ÂâçÂè∞ÔºåÂèëÈÄÅÊµèËßàÂô®ÈÄöÁü•
            if (document.hidden) {
                sendBrowserNotification(reminder);
            }

            // Âà∑Êñ∞ÊèêÈÜíÂàóË°®
            if (document.getElementById('reminders').style.display !== 'none') {
                loadReminders();
            }
        }

        // Êí≠ÊîæÊèêÈÜíÂ£∞Èü≥
        function playReminderSound() {
            try {
                // ‰ºòÂÖà‰ΩøÁî®Èü≥È¢ëÊñá‰ª∂ÔºàÊõ¥ÂèØÈù†Ôºâ
                const audio = new Audio('/static/sounds/dingdong.mp3');
                audio.volume = 0.8;
                audio.play().then(() => {
                    console.log('‚úÖ ÊèêÈÜíÈü≥ÊïàÊí≠ÊîæÊàêÂäü');
                }).catch(e => {
                    console.warn('‚ö†Ô∏è Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•ÔºåÂ∞ùËØïWeb Audio API:', e);
                    // ÂõûÈÄÄÂà∞Web Audio API
                    playWebAudioTone();
                });
            } catch (error) {
                console.error('‚ùå Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:', error);
                // ÂõûÈÄÄÂà∞Web Audio API
                playWebAudioTone();
            }
        }

        function playWebAudioTone() {
            try {
                // Ê£ÄÊü•Web Audio APIÊîØÊåÅ
                if (typeof window.AudioContext !== "function" && typeof window.webkitAudioContext !== "function") {
                    console.warn('‰∏çÊîØÊåÅWeb Audio API');
                    return;
                }

                // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // ÂàõÂª∫ÈúáËç°Âô®ÔºàÁîüÊàêÂ£∞Èü≥Ôºâ
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                // ÈáäÊîæËµÑÊ∫ê
                oscillator.onended = () => {
                    audioContext.close();
                };

                // Á¨¨‰∫åÂ£∞ÔºàÂèåÂìçÔºâ
                setTimeout(() => {
                    const audioContext2 = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator2 = audioContext2.createOscillator();
                    const gainNode2 = audioContext2.createGain();

                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext2.destination);

                    oscillator2.type = 'sine';
                    oscillator2.frequency.setValueAtTime(1000, audioContext2.currentTime);

                    gainNode2.gain.setValueAtTime(0, audioContext2.currentTime);
                    gainNode2.gain.linearRampToValueAtTime(0.3, audioContext2.currentTime + 0.1);
                    gainNode2.gain.linearRampToValueAtTime(0, audioContext2.currentTime + 0.5);

                    oscillator2.start(audioContext2.currentTime);
                    oscillator2.stop(audioContext2.currentTime + 0.5);

                    oscillator2.onended = () => {
                        audioContext2.close();
                    };
                }, 200);

            } catch (error) {
                // ÂõûÈÄÄÂà∞Èü≥È¢ëÊñá‰ª∂
                const audio = new Audio('/static/sounds/dingdong.mp3');
                audio.volume = 0.8;
                audio.play().catch(e => {
                    console.warn('Â§áÁî®Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
                });
                console.error('Êí≠ÊîæÊèêÁ§∫Èü≥Â§±Ë¥•:', error);
            }
        }

        function showReminderNotification(reminder) {
            // ÂàõÂª∫ÊèêÈÜíÂºπÁ™ó
            const notification = document.createElement('div');
            notification.className = 'reminder-notification';
            notification.id = `reminder-notif-${reminder.reminder_id}`;

            const priorityEmoji = { 1: 'üî¥', 2: 'üü†', 3: 'üü°', 4: 'üü¢', 5: '‚ö™' };
            const emoji = priorityEmoji[reminder.priority] || 'üîî';

            notification.innerHTML = `
                <div class="reminder-notification-content">
                    <div class="reminder-notification-header">
                        <span class="reminder-notification-icon">${emoji}</span>
                        <span class="reminder-notification-title">${reminder.title || 'ÊèêÈÜí'}</span>
                        <button class="reminder-notification-close" onclick="closeReminderNotif(${reminder.reminder_id})">‚úï</button>
                    </div>
                    <div class="reminder-notification-body">
                        ${reminder.content}
                    </div>
                    <div class="reminder-notification-actions">
                        <button onclick="handleReminderRead(${reminder.reminder_id})">
                            ‚úÖ Â∑≤Áü•ÈÅì
                        </button>
                        <button onclick="handleReminderSnooze(${reminder.reminder_id})">
                            ‚è∞ Á®çÂêéÊèêÈÜí
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 30ÁßíÂêéËá™Âä®Ê∑°Âá∫ÔºàÁªôÁî®Êà∑Êõ¥Â§öÊó∂Èó¥Êü•ÁúãÔºâ
            setTimeout(() => {
                if (document.getElementById(`reminder-notif-${reminder.reminder_id}`)) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 30000);
        }

        // ÂÖ≥Èó≠ÊèêÈÜíÈÄöÁü•
        function closeReminderNotif(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (notif) {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }
        }

        // Â§ÑÁêÜ"Â∑≤Áü•ÈÅì"
        async function handleReminderRead(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;

            // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠Áä∂ÊÄÅ
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #10b981;">‚úÖ Â∑≤Ê†áËÆ∞‰∏∫Â∑≤ËØª</span>';

            // Ê†áËÆ∞Â∑≤ËØª
            markReminderAsRead(reminderId);

            // 1ÁßíÂêéÂÖ≥Èó≠
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        // Â§ÑÁêÜ"Á®çÂêéÊèêÈÜí"
        async function handleReminderSnooze(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;

            // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠Áä∂ÊÄÅ
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #f59e0b;">‚è∞ Ê≠£Âú®Âª∂Ëøü...</span>';

            // ÊâßË°åÂª∂ËøüÊìç‰Ωú
            await snoozeReminder(reminderId, 5);

            // ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
            actionsDiv.innerHTML = '<span style="color: #10b981;">‚úÖ Â∑≤Âª∂Ëøü5ÂàÜÈíü</span>';

            // 1ÁßíÂêéÂÖ≥Èó≠
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        function sendBrowserNotification(reminder) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(reminder.title || 'Â∞è‰πêÊèêÈÜí', {
                    body: reminder.content,
                    icon: '/static/favicon.ico',
                    tag: `reminder-${reminder.reminder_id}`,
                    requireInteraction: false
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        function updateReminderBadge() {
            // Êõ¥Êñ∞ÊèêÈÜíÊï∞ÈáèÁ∫¢ÁÇπÔºàÂêéÁª≠ÂÆûÁé∞Ôºâ
            console.log(`Êú™ËØªÊèêÈÜí: ${unreadReminderCount}`);
        }

        function markReminderAsRead(reminderId) {
            // Ë∞ÉÁî®confirm APIÔºåÂÜôÂÖ•ÂéÜÂè≤Âπ∂Á¶ÅÁî®ÈùûÈáçÂ§çÊèêÈÜí
            confirmReminder(reminderId);

            // Êõ¥Êñ∞Êú™ËØªËÆ°Êï∞
            unreadReminderCount = Math.max(0, unreadReminderCount - 1);
            updateReminderBadge();
        }

        // Á°ÆËÆ§ÊèêÈÜíÔºàÂÜôÂÖ•ÂéÜÂè≤Ôºâ
        async function confirmReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/confirm`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ ÊèêÈÜíÂ∑≤Á°ÆËÆ§: ${reminderId}`);
                } else {
                    console.error('‚ùå Á°ÆËÆ§ÊèêÈÜíÂ§±Ë¥•:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Á°ÆËÆ§ÊèêÈÜíËØ∑Ê±ÇÂ§±Ë¥•:', error);
            }
        }

        // Âª∂ËøüÊèêÈÜíÔºàÁ®çÂêéÊèêÈÜíÔºâ
        async function snoozeReminder(reminderId, minutes = 5) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/snooze?minutes=${minutes}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ ÊèêÈÜíÂ∑≤Âª∂Ëøü ${minutes} ÂàÜÈíüÔºåÊñ∞Ëß¶ÂèëÊó∂Èó¥: ${data.new_trigger_time}`);

                    // ÊòæÁ§∫ÊèêÁ§∫
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
                    toast.textContent = `‚è∞ ÊèêÈÜíÂ∑≤Âª∂Ëøü ${minutes} ÂàÜÈíü`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s';
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);

                    // Âà∑Êñ∞ÊèêÈÜíÂàóË°®
                    if (document.getElementById('reminders').style.display !== 'none') {
                        loadReminders();
                    }
                } else {
                    console.error('‚ùå Âª∂ËøüÊèêÈÜíÂ§±Ë¥•:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Âª∂ËøüÊèêÈÜíÂ§±Ë¥•:', error);
            }
        }

        // ËØ∑Ê±ÇÊµèËßàÂô®ÈÄöÁü•ÊùÉÈôê
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('ÈÄöÁü•ÊùÉÈôê:', permission);
                });
            }
        }

        // ============ ‰∏ªÂä®ÂØπËØùÂ§ÑÁêÜ ============

        function handleProactiveChatPush(message) {
            console.log('Êî∂Âà∞‰∏ªÂä®ÂØπËØùÊé®ÈÄÅ:', message);

            // Êí≠ÊîæÊüîÂíåÁöÑÊèêÁ§∫Èü≥Ôºà‰∏çÂêå‰∫éÊèêÈÜíÁöÑÂ£∞Èü≥Ôºâ
            playProactiveChatSound();

            // ÊòæÁ§∫‰∏ªÂä®ÂØπËØùÈÄöÁü•
            showProactiveChatNotification(message);

            // Â¶ÇÊûúÈ°µÈù¢‰∏çÂú®ÂâçÂè∞ÔºåÂèëÈÄÅÊµèËßàÂô®ÈÄöÁü•
            if (document.hidden) {
                sendProactiveChatBrowserNotification(message);
            }
        }

        function playProactiveChatSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Êõ¥ÊüîÂíåÁöÑÈü≥Ë∞ÉÔºà600HzÔºâ
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);

                // Ê∏êÂèòÈü≥Èáè
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.15);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.error('Êí≠Êîæ‰∏ªÂä®ÂØπËØùÊèêÁ§∫Èü≥Â§±Ë¥•:', error);
            }
        }

        function showProactiveChatNotification(message) {
            // ÂàõÂª∫‰∏ªÂä®ÂØπËØùÈÄöÁü•Âç°Áâá
            const notification = document.createElement('div');
            notification.className = 'proactive-chat-notification';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                max-width: 400px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;

            const reasonEmoji = {
                'pending_question': 'ü§î',
                'long_inactive': 'üëã',
                'moderate_inactive': 'üí≠',
                'active_time': '‚è∞',
                'interesting_topic': 'üí°'
            };

            const emoji = reasonEmoji[message.reason] || 'üí¨';

            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 32px;">${emoji}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">
                            Â∞è‰πêÊÉ≥Âíå‰Ω†ËÅäËÅäÔΩû
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
                            ${message.message}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="respondToProactiveChat('${message.reason}')" 
                                style="flex: 1; background: white; color: #667eea; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                üí¨ ÂéªËÅäÂ§©
                            </button>
                            <button onclick="dismissProactiveChat(this)" 
                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                                Á®çÂêé
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 10ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);
        }

        function respondToProactiveChat(reason) {
            // ÂÖ≥Èó≠ÈÄöÁü•
            const notification = document.querySelector('.proactive-chat-notification');
            if (notification) {
                notification.remove();
            }

            // ÂàáÊç¢Âà∞ËÅäÂ§©Ê†áÁ≠æ
            switchTab('chat');

            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // ÂèØ‰ª•Ê†πÊçÆreasonÈ¢ÑÂ°´ÂÖÖ‰∏Ä‰∫õÂÜÖÂÆπ
            // messageInput.textContent = '';
        }

        function dismissProactiveChat(button) {
            const notification = button.closest('.proactive-chat-notification');
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }
        }

        function sendProactiveChatBrowserNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const reasonText = {
                    'pending_question': 'ÂÖ≥‰∫é‰πãÂâçÁöÑÈóÆÈ¢ò',
                    'long_inactive': 'Â•Ω‰πÖ‰∏çËßÅ',
                    'moderate_inactive': 'ÊúÄËøëËøòÂ•ΩÂêó',
                    'active_time': 'ÈóÆÂÄôÊó∂Èó¥',
                    'interesting_topic': 'ÊúâË∂£ÁöÑËØùÈ¢ò'
                };

                new Notification('Â∞è‰πêÊÉ≥Âíå‰Ω†ËÅäËÅä', {
                    body: message.message,
                    icon: '/static/icon.png',
                    tag: 'proactive-chat',
                    requireInteraction: false
                });
            }
        }

        // ÊòæÁ§∫ËøΩÈóÆÊèêÁ§∫
        function showFollowupSuggestion(followupInfo) {
            // ÂàõÂª∫ËøΩÈóÆÊèêÁ§∫Âç°Áâá
            const notification = document.createElement('div');
            notification.className = 'followup-suggestion';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                max-width: 500px;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 18px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(245, 87, 108, 0.4);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
                cursor: pointer;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">ü§î</div>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">
                            üí° Â∞è‰πêÊúâ‰∏™ÁñëÈóÆ
                        </div>
                        <div style="font-size: 15px; font-weight: 500; line-height: 1.5;">
                            ${followupInfo.followup}
                        </div>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        ÁÇπÂáªÂõûÁ≠î
                    </div>
                </div>
            `;

            // ÁÇπÂáªÂèëÈÄÅËøΩÈóÆ
            notification.onclick = async () => {
                notification.remove();

                // Ëá™Âä®ÂèëÈÄÅËøΩÈóÆ‰Ωú‰∏∫Áî®Êà∑Ê∂àÊÅØ
                const input = document.getElementById('messageInput');
                input.textContent = followupInfo.followup;

                // ÂèëÈÄÅÊ∂àÊÅØ
                await sendMessageFromDiv();

                // Ê†áËÆ∞ËøΩÈóÆÂ∑≤ÂèëÈÄÅ
                try {
                    await fetch(`${API_BASE}/proactive/mark_asked/${followupInfo.id}`, {
                        method: 'POST'
                    });
                    // Âà∑Êñ∞‰∏ªÂä®ÈóÆÁ≠îÂàóË°®
                    loadProactiveQA('default_user');
                } catch (error) {
                    console.error('Ê†áËÆ∞ËøΩÈóÆÂ§±Ë¥•:', error);
                }
            };

            document.body.appendChild(notification);

            // Êí≠ÊîæÊèêÁ§∫Èü≥
            playFollowupSound();

            // 8ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutDown 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
        }

        // Êí≠ÊîæËøΩÈóÆÊèêÁ§∫Èü≥
        function playFollowupSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;  // Êõ¥È´òÈü≥Ë∞É
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (error) {
                console.error('Êí≠ÊîæËøΩÈóÆÊèêÁ§∫Èü≥Â§±Ë¥•:', error);
            }
        }

        // ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÂèëÈÄÅËøΩÈóÆ
        async function sendFollowupFromHistory(questionId, followupText, userId) {
            // Ëá™Âä®Â°´ÂÖÖÂà∞ËæìÂÖ•Ê°Ü
            const input = document.getElementById('messageInput');
            input.textContent = followupText;

            // ÂèëÈÄÅÊ∂àÊÅØ
            await sendMessageFromDiv();

            // Ê†áËÆ∞‰∏∫Â∑≤ËøΩÈóÆ
            try {
                await fetch(`${API_BASE}/proactive/mark_asked/${questionId}`, {
                    method: 'POST'
                });
                // Âà∑Êñ∞‰∏ªÂä®ÈóÆÁ≠îÂàóË°®
                setTimeout(() => loadProactiveQA(userId), 1000);
            } catch (error) {
                console.error('Ê†áËÆ∞ËøΩÈóÆÂ§±Ë¥•:', error);
            }
        }

        // ============ WebSocketÂäüËÉΩÁªìÊùü ============

        // ============ v0.6.0 ÂÖ®Â±ÄÂø´Êç∑ÈîÆÊîØÊåÅ ============

        // ÂÖ®Â±ÄÂø´Êç∑ÈîÆÁõëÂê¨
        document.addEventListener('keydown', (event) => {
            // Ê£ÄÊü•Âø´Êç∑ÈîÆÊòØÂê¶ÂêØÁî®
            const settings = getSettings();
            if (!settings.keyboardShortcuts) {
                return; // Âø´Êç∑ÈîÆÂ∑≤Á¶ÅÁî®ÔºåÁõ¥Êé•ËøîÂõû
            }

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const ctrlKey = isMac ? event.metaKey : event.ctrlKey;

            // Á©∫Ê†ºÈîÆ: Âú®ËøûÁª≠ÂØπËØùÊ®°Âºè‰∏ãÊâìÊñ≠AIËØ¥ËØù
            if (event.code === 'Space' && isConversationMode && isSpeaking && !isRecording) {
                // Á°Æ‰øù‰∏çÊòØÂú®ËæìÂÖ•Ê°Ü‰∏≠ÊåâÁ©∫Ê†º
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.id !== 'messageInput') {
                    event.preventDefault();
                    console.log('‚å®Ô∏è ÊåâÁ©∫Ê†ºÈîÆÊâìÊñ≠AI');
                    stopSpeaking();
                    // Á´ãÂç≥ÂºÄÂßãÂΩïÈü≥
                    setTimeout(() => {
                        if (isConversationMode && !isRecording) {
                            toggleBaiduVoiceInput();
                        }
                    }, 100);
                    return;
                }
            }

            // Ctrl+Enter / Cmd+Enter: ÂèëÈÄÅÊ∂àÊÅØ
            if (ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab && currentTab.id === 'chat') {
                    sendMessageFromDiv();
                }
                return;
            }

            // Esc: Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            if (event.key === 'Escape') {
                const messageInput = document.getElementById('messageInput');
                if (messageInput && document.activeElement === messageInput) {
                    event.preventDefault();
                    messageInput.textContent = '';
                    messageInput.focus();
                }
                return;
            }

            // Ctrl+K / Cmd+K: Êñ∞Âª∫ÂØπËØù
            if (ctrlKey && event.key === 'k') {
                event.preventDefault();
                newChat();
                return;
            }

            // Ctrl+/ / Cmd+/: ÂàáÊç¢Âà∞ËÅäÂ§©Ê†áÁ≠æ
            if (ctrlKey && event.key === '/') {
                event.preventDefault();
                const chatTab = document.querySelector('[onclick*="chat"]');
                if (chatTab) {
                    chatTab.click();
                }
                return;
            }

            // Ctrl+1-6 / Cmd+1-6: Âø´ÈÄüÂàáÊç¢Ê†áÁ≠æ
            if (ctrlKey && event.key >= '1' && event.key <= '6') {
                event.preventDefault();
                const tabs = ['chat', 'sessions', 'memory', 'analytics', 'reminders', 'tools'];
                const tabIndex = parseInt(event.key) - 1;
                if (tabIndex < tabs.length) {
                    const tabButton = document.querySelector(`[onclick*="${tabs[tabIndex]}"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }
                return;
            }
        });

        // ÊòæÁ§∫Âø´Êç∑ÈîÆÊèêÁ§∫ÔºàÈº†Ê†áÊÇ¨ÂÅúÂú®ËæìÂÖ•Ê°ÜÊó∂Ôºâ
        function showShortcutHints() {
            const messageInput = document.getElementById('messageInput');
            const hintsBar = document.getElementById('shortcutHints');
            if (!messageInput || !hintsBar) return;

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const cmdKey = isMac ? '‚åò' : 'Ctrl';

            // Êõ¥Êñ∞MacÁ≥ªÁªüÁöÑÂø´Êç∑ÈîÆÊòæÁ§∫
            if (isMac) {
                hintsBar.querySelectorAll('kbd').forEach(kbd => {
                    kbd.textContent = kbd.textContent.replace('Ctrl', '‚åò');
                });
            }

            // ËæìÂÖ•Ê°ÜËÅöÁÑ¶Êó∂ÊòæÁ§∫ÊèêÁ§∫Ê†è
            messageInput.addEventListener('focus', () => {
                hintsBar.style.opacity = '1';
            });

            // ËæìÂÖ•Ê°ÜÂ§±ÁÑ¶Êó∂ÈöêËóèÊèêÁ§∫Ê†èÔºàÂª∂ËøüÈöêËóèÔºâ
            messageInput.addEventListener('blur', () => {
                setTimeout(() => {
                    hintsBar.style.opacity = '0';
                }, 2000);
            });

            // È°µÈù¢Âä†ËΩΩÂêé3ÁßíÊòæÁ§∫ÊèêÁ§∫Ê†èÔºàÈ¶ñÊ¨°ÊèêÁ§∫Ôºâ
            setTimeout(() => {
                hintsBar.style.opacity = '1';
                setTimeout(() => {
                    hintsBar.style.opacity = '0';
                }, 3000);
            }, 1000);
        }        // ============ Âø´Êç∑ÈîÆÂäüËÉΩÁªìÊùü ============

        // È°µÈù¢Âä†ËΩΩÊó∂ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
        window.onload = () => {
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // ÊòæÁ§∫Âø´Êç∑ÈîÆÊèêÁ§∫
            showShortcutHints();

            // ÂõæÁâá‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈ¢ùÂ§ñÊ∑ªÂä†‰ª•Á°Æ‰øùÊçïËé∑Ôºâ
            const imageUploadInput = document.getElementById('imageUpload');
            if (imageUploadInput) {
                console.log('‚úÖ ÂõæÁâá‰∏ä‰º†inputÂ∑≤ÊâæÂà∞ÔºåÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®');
                imageUploadInput.addEventListener('change', (event) => {
                    console.log('üéØ Change event triggered (addEventListener)');
                    handleImageUpload(event);
                });
                imageUploadInput.addEventListener('cancel', () => {
                    console.log('‚ùå Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂ÈÄâÊã©');
                });
            } else {
                console.error('‚ùå Êú™ÊâæÂà∞ÂõæÁâá‰∏ä‰º†inputÂÖÉÁ¥†ÔºÅ');
            }

            // EnterÂèëÈÄÅÔºåShift+EnterÊç¢Ë°å
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessageFromDiv();
                }
            });

            // ÊêúÁ¥¢Ê°ÜÂõûËΩ¶ÊêúÁ¥¢
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchMemories();
                    }
                });
            }

            // Âª∫Á´ãWebSocketËøûÊé•
            connectWebSocket();

            // ËØ∑Ê±ÇÊµèËßàÂô®ÈÄöÁü•ÊùÉÈôê
            requestNotificationPermission();

            // È¢ÑÂä†ËΩΩÈü≥È¢ëÔºàÊøÄÊ¥ªÈü≥È¢ëÊùÉÈôêÔºâ
            const preloadAudio = new Audio('/static/sounds/dingdong.mp3');
            preloadAudio.volume = 0.01; // ÊûÅÂ∞èÈü≥Èáè
            // Âú®Áî®Êà∑Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÈ°µÈù¢Êó∂Êí≠ÊîæÔºàÊøÄÊ¥ªÊùÉÈôêÔºâ
            document.addEventListener('click', function initAudio() {
                preloadAudio.play().then(() => {
                    console.log('‚úÖ Èü≥È¢ëÊùÉÈôêÂ∑≤ÊøÄÊ¥ª');
                    preloadAudio.pause();
                    preloadAudio.currentTime = 0;
                }).catch(e => {
                    console.warn('Èü≥È¢ëÊùÉÈôêÊøÄÊ¥ªÂ§±Ë¥•:', e);
                });
                // Âè™ÊâßË°å‰∏ÄÊ¨°
                document.removeEventListener('click', initAudio);
            }, { once: true });
        };

        // ========================================
        // v0.6.0 Phase 4: ÂõæÁâá‰∏ä‰º†ÂíåËØÜÂà´ÂäüËÉΩ
        // ========================================
        let uploadedImagePath = null;

        /**
         * ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ
         */
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);

            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
                ${type === 'success' ? 'background: #10b981; color: white;' : ''}
                ${type === 'error' ? 'background: #ef4444; color: white;' : ''}
                ${type === 'info' ? 'background: #3b82f6; color: white;' : ''}
                ${type === 'warning' ? 'background: #f59e0b; color: white;' : ''}
            `;

            document.body.appendChild(notification);

            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        /**
         * Ëß¶ÂèëÂõæÁâá‰∏ä‰º†
         */
        function triggerImageUpload() {
            console.log('üì∑ triggerImageUpload called');
            const uploadInput = document.getElementById('imageUpload');
            console.log('üîç Upload input element:', uploadInput);
            if (uploadInput) {
                uploadInput.click();
                console.log('‚úÖ Click triggered');
            } else {
                console.error('‚ùå imageUpload element not found!');
            }
        }

        /**
         * Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
         */
        async function handleImageUpload(event) {
            console.log('üîç handleImageUpload called', event);
            const file = event.target.files[0];
            console.log('üìÅ Selected file:', file);
            if (!file) {
                console.log('‚ùå No file selected');
                return;
            }

            // È™åËØÅÊñá‰ª∂Á±ªÂûã
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            console.log('üîç File type:', file.type);
            if (!validTypes.includes(file.type)) {
                console.log('‚ùå Invalid file type:', file.type);
                showNotification('‚ùå ‰∏çÊîØÊåÅÁöÑÂõæÁâáÊ†ºÂºè', 'error');
                return;
            }

            // È™åËØÅÊñá‰ª∂Â§ßÂ∞è (20MB)
            console.log('üìä File size:', file.size, 'bytes');
            if (file.size > 20 * 1024 * 1024) {
                console.log('‚ùå File too large:', file.size);
                showNotification('‚ùå Êñá‰ª∂ËøáÂ§ßÔºàÊúÄÂ§ß20MBÔºâ', 'error');
                return;
            }

            // ÊòæÁ§∫‰∏ä‰º†‰∏≠Áä∂ÊÄÅ
            console.log('üì§ Starting upload...');
            showNotification('üì§ Ê≠£Âú®‰∏ä‰º†ÂõæÁâá...', 'info');

            try {
                // ÂàõÂª∫FormData
                const formData = new FormData();
                formData.append('file', file);
                console.log('üì¶ FormData created');

                // ‰∏ä‰º†ÂõæÁâá
                console.log('üöÄ Sending request to /api/vision/upload');
                const response = await fetch('/api/vision/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('üì° Response status:', response.status);
                const result = await response.json();
                console.log('üìã Response data:', result);

                if (result.success) {
                    uploadedImagePath = result.file_path;
                    console.log('‚úÖ Upload successful, path:', uploadedImagePath);
                    showNotification('‚úÖ ÂõæÁâá‰∏ä‰º†ÊàêÂäü', 'success');

                    // ÊòæÁ§∫ÂõæÁâáÈ¢ÑËßà
                    console.log('üñºÔ∏è Showing image preview');
                    showImagePreview(file, result.file_path);
                } else {
                    console.log('‚ùå Upload failed:', result.error);
                    showNotification(`‚ùå ‰∏ä‰º†Â§±Ë¥•: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('üí• Upload error:', error);
                showNotification('‚ùå ‰∏ä‰º†Â§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        /**
         * ÊòæÁ§∫ÂõæÁâáÈ¢ÑËßà
         */
        function showImagePreview(file, filePath) {
            console.log('üñºÔ∏è showImagePreview called', { file: file.name, filePath });
            const reader = new FileReader();
            reader.onload = (e) => {
                console.log('üìñ FileReader loaded');
                // ÂàõÂª∫È¢ÑËßàÂÆπÂô®
                const previewHtml = `
                    <div class="image-preview" id="imagePreview">
                        <div class="image-preview-header">
                            <span>üì∑ Â∑≤‰∏ä‰º†ÂõæÁâá</span>
                            <button onclick="removeImagePreview()" class="remove-btn">‚úï</button>
                        </div>
                        <img src="${e.target.result}" alt="È¢ÑËßàÂõæ" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        <div class="image-preview-actions">
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                                üí° ËæìÂÖ•ÈóÆÈ¢òÂêéÁÇπÂáªÂèëÈÄÅÔºåÊàñÁõ¥Êé•ÂèëÈÄÅËØÜÂà´ÂõæÁâáÂÜÖÂÆπ
                            </div>
                        </div>
                    </div>
                `;

                // ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü‰∏äÊñπ
                const inputContainer = document.querySelector('.input-container');
                console.log('üîç Input container:', inputContainer);
                const existing = document.getElementById('imagePreview');
                if (existing) {
                    console.log('üóëÔ∏è Removing existing preview');
                    existing.remove();
                }
                inputContainer.insertAdjacentHTML('beforebegin', previewHtml);
                console.log('‚úÖ Preview inserted');
            };
            reader.onerror = (error) => {
                console.error('‚ùå FileReader error:', error);
            };
            console.log('üìñ Starting FileReader...');
            reader.readAsDataURL(file);
        }

        /**
         * ÁßªÈô§ÂõæÁâáÈ¢ÑËßà
         */
        function removeImagePreview() {
            const preview = document.getElementById('imagePreview');
            if (preview) {
                preview.remove();
            }
            uploadedImagePath = null;
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        /**
         * ÂàÜÊûê‰∏ä‰º†ÁöÑÂõæÁâá
         */
    </script>
</body>

</html>