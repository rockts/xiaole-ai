<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¹ AI ç®¡å®¶ v0.5.0</title>
    <style>
        /* CSS å˜é‡ - äº®è‰²ä¸»é¢˜ */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #dddddd;
            --tab-bg: #f5f5f5;
            --tab-hover: #e8e8e8;
            --tab-active-bg: #ffffff;
            --input-bg: #f8f8f8;
            --input-border: #ddd;
            --button-gradient-start: #667eea;
            --button-gradient-end: #764ba2;
            --message-user-bg: #667eea;
            --message-ai-bg: #f0f0f0;
            --message-ai-text: #333333;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --shadow-heavy: rgba(0, 0, 0, 0.3);
            --card-bg: #ffffff;
            --card-border: #e0e0e0;
            --code-bg: #f5f5f5;
            --code-text: #d63384;
            --success-bg: #f0fdf4;
            --success-border: #10b981;
            --warning-bg: #fef3c7;
            --warning-border: #f59e0b;
            --info-bg: #f8f4ff;
            --info-border: #764ba2;
            --danger-bg: #fff5f5;
            --danger-border: #ff6b6b;
        }

        /* æš—è‰²ä¸»é¢˜ */
        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #1f1f1f;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border-color: #3a3a3a;
            --tab-bg: #2a2a2a;
            --tab-hover: #333333;
            --tab-active-bg: #1f1f1f;
            --input-bg: #2a2a2a;
            --input-border: #3a3a3a;
            --button-gradient-start: #667eea;
            --button-gradient-end: #764ba2;
            --message-user-bg: #667eea;
            --message-ai-bg: #2a2a2a;
            --message-ai-text: #e0e0e0;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-medium: rgba(0, 0, 0, 0.5);
            --shadow-heavy: rgba(0, 0, 0, 0.7);
            --card-bg: #2a2a2a;
            --card-border: #3a3a3a;
            --code-bg: #1a1a1a;
            --code-text: #ff6b9d;
            --success-bg: #1a2e22;
            --success-border: #10b981;
            --warning-bg: #2e2414;
            --warning-border: #f59e0b;
            --info-bg: #25213a;
            --info-border: #764ba2;
            --danger-bg: #2e1a1a;
            --danger-border: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            flex: 1;
            text-align: center;
        }

        .theme-toggle {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 20px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(20deg);
        }

        .tabs {
            display: flex;
            background: var(--tab-bg);
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
        }

        .tab:hover {
            background: var(--tab-hover);
        }

        .tab.active {
            background: var(--tab-active-bg);
            border-bottom: 3px solid var(--button-gradient-start);
            color: var(--button-gradient-start);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ä¼šè¯ä¿¡æ¯æ  */
        .session-info {
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: box-shadow 0.3s ease;
        }

        .session-title-display {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* èŠå¤©ç•Œé¢ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
            position: relative;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }

        .message.user .message-content {
            background: var(--message-user-bg);
            color: white;
        }

        /* æ¶ˆæ¯æ“ä½œæŒ‰é’® v0.6.0 */
        .message-actions {
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .message.user:hover .message-actions {
            opacity: 1;
            pointer-events: all;
        }

        .message-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            padding: 0;
        }

        .message-action-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .message-action-btn.edit:hover {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .message-action-btn.delete:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .message-action-btn.copy:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ç¼–è¾‘çŠ¶æ€æ ‡è¯† */
        .editing-indicator {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFA726;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInUp 0.3s;
        }

        .editing-indicator button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .editing-indicator button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .message.ai .message-content {
            background: var(--message-ai-bg);
            color: var(--message-ai-text);
        }

        .message-content code {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .message.assistant .message-content {
            background: var(--message-ai-bg);
            color: var(--message-ai-text);
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Markdown æ ·å¼ */
        .message.assistant .message-content p {
            margin: 0.5em 0;
        }

        .message.assistant .message-content strong {
            color: var(--button-gradient-start);
            font-weight: bold;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 0.5em 0;
            padding-left: 20px;
        }

        .message.assistant .message-content li {
            margin: 0.3em 0;
        }

        .message.assistant .message-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--code-text);
        }

        .message.assistant .message-content pre {
            background: var(--code-bg);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .message.assistant .message-content blockquote {
            border-left: 3px solid var(--button-gradient-start);
            padding-left: 10px;
            margin: 0.5em 0;
            color: var(--text-secondary);
        }

        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin: 0.8em 0 0.4em 0;
            color: var(--button-gradient-start);
        }

        .input-container {
            padding: 20px;
            background: var(--container-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        #messageInput:focus {
            border-color: var(--button-gradient-start);
        }

        #messageInput:empty:before {
            content: attr(data-placeholder);
            color: var(--text-tertiary);
        }

        #messageInput:focus:before {
            content: none;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ä¼šè¯åˆ—è¡¨ */
        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }

        .session-item {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: all 0.3s;
            border: 1px solid var(--card-border);
            position: relative;
        }

        .session-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }

        .session-item:hover .session-actions {
            opacity: 1;
            pointer-events: all;
        }

        .session-item.active {
            border-left: 4px solid var(--button-gradient-start);
            background: var(--input-bg);
        }

        /* ä¼šè¯æ“ä½œæŒ‰é’® */
        .session-actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .session-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            background: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .session-action-btn:hover {
            transform: scale(1.1);
        }

        .session-action-btn.export-md {
            color: #10b981;
            border: 2px solid #10b981;
        }

        .session-action-btn.export-md:hover {
            background: #10b981;
            color: white;
        }

        .session-action-btn.export-json {
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }

        .session-action-btn.export-json:hover {
            background: #3b82f6;
            color: white;
        }

        .session-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* è®°å¿†æŸ¥çœ‹ */
        .memory-container {
            flex: 1;
            overflow-y: auto;
            background: var(--container-bg);
            transition: background 0.3s ease;
            padding: 20px;
        }

        .stats-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--button-gradient-start);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .memory-item {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .memory-content {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .memory-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        .error {
            background: var(--message-ai-bg);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
            border: 1px solid #ff6b6b;
            transition: all 0.3s ease;
        }

        /* WebSocketæé†’å¼¹çª—æ ·å¼ */
        .reminder-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow-heavy);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            opacity: 1;
            transition: opacity 0.3s, background 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--card-border);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .reminder-notification-content {
            padding: 16px;
        }

        .reminder-notification-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reminder-notification-icon {
            font-size: 24px;
        }

        .reminder-notification-title {
            flex: 1;
            font-weight: bold;
            font-size: 16px;
            color: var(--text-primary);
        }

        .reminder-notification-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .reminder-notification-close:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .reminder-notification-body {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reminder-notification-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reminder-notification-actions button {
            padding: 6px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reminder-notification-actions button:first-child {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .reminder-notification-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* ä¸»åŠ¨å¯¹è¯åŠ¨ç”» */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* è¿½é—®æç¤ºåŠ¨ç”» */
        @keyframes slideInUp {
            from {
                transform: translate(-50%, 20px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideOutDown {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }

            to {
                transform: translate(-50%, 20px);
                opacity: 0;
            }
        }

        /* è®¾ç½®é¢æ¿æ ·å¼ v0.6.0 */
        .settings-section {
            margin: 25px 0;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--button-gradient-start);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .setting-select {
            padding: 8px 15px;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .setting-select:hover {
            border-color: var(--button-gradient-start);
        }

        .setting-select:focus {
            border-color: var(--button-gradient-start);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* å¼€å…³æŒ‰é’®æ ·å¼ */
        .setting-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .setting-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .setting-switch input:checked+.switch-slider {
            background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
        }

        .setting-switch input:checked+.switch-slider:before {
            transform: translateX(24px);
        }

        /* v0.6.0 Phase 4: å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ */
        .upload-image-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .upload-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .image-preview {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
        }

        .image-preview-actions {
            display: flex;
            gap: 8px;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            flex: 1;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="themeIcon">ğŸŒ™</span>
            </button>
            <div class="header-title">
                ğŸ¤– å°ä¹ AI ç®¡å®¶
                <span style="font-size: 12px; opacity: 0.8; margin-left: 10px;">v0.5.0</span>
            </div>
            <div style="width: 40px;"></div> <!-- å ä½ä¿æŒå±…ä¸­ -->
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat', event)">ğŸ’¬ èŠå¤©</div>
            <div class="tab" onclick="switchTab('sessions', event)">ğŸ“‹ ä¼šè¯</div>
            <div class="tab" onclick="switchTab('memory', event)">ğŸ§  è®°å¿†</div>
            <div class="tab" onclick="switchTab('analytics', event)">ğŸ“Š è¡Œä¸ºåˆ†æ</div>
            <div class="tab" onclick="switchTab('reminders', event)">ğŸ”” æé†’</div>
            <div class="tab" onclick="switchTab('tools', event)">ğŸ”§ å·¥å…·ç®¡ç†</div>
            <div class="tab" onclick="switchTab('settings', event)">âš™ï¸ è®¾ç½®</div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div id="chat" class="tab-content active">
            <div id="sessionInfo" class="session-info" style="display: none;">
                <div class="session-title-display">ğŸ’¬ <span id="currentSessionTitle"></span></div>
            </div>
            <div class="chat-container" id="chatContainer"></div>
            <!-- å›¾ç‰‡ä¸Šä¼ è¾“å…¥ï¼ˆéšè—ï¼‰ -->
            <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <div class="input-container">
                <button onclick="triggerImageUpload()" class="upload-image-btn" title="ä¸Šä¼ å›¾ç‰‡">ğŸ“·</button>
                <div id="messageInput" contenteditable="true" data-placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œï¼‰..."
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; min-height: 40px; max-height: 120px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">
                </div>
                <button onclick="sendMessageFromDiv()" id="sendBtn">å‘é€</button>
                <button onclick="newChat()">æ–°å¯¹è¯</button>
            </div>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div id="sessions" class="tab-content">
            <div class="sessions-list" id="sessionsList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è®°å¿†æŸ¥çœ‹ -->
        <div id="memory" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ“Š è®°å¿†ç»Ÿè®¡
                        <span style="font-size: 12px; color: #667eea; font-weight: normal;">
                            v0.2.0 - ğŸ§  æ”¯æŒè¯­ä¹‰æœç´¢
                        </span>
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢è®°å¿†ï¼ˆæ”¯æŒè¯­ä¹‰ç†è§£ï¼‰..."
                        style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                    <button onclick="searchMemories()">ğŸ” å…³é”®è¯</button>
                    <button onclick="semanticSearch()" title="æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œå¦‚'å¤šå¤§å¹´çºª'">ğŸ§  è¯­ä¹‰</button>
                    <button onclick="loadRecentMemories()">ğŸ“‹ å…¨éƒ¨</button>
                </div>

                <div id="memoryList"></div>
            </div>
        </div>

        <!-- è¡Œä¸ºåˆ†æ -->
        <div id="analytics" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ“Š ç”¨æˆ·è¡Œä¸ºåˆ†æ <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.3.0
                            Learningå±‚</span></h3>
                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadBehaviorAnalytics()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„
                            åˆ·æ–°æ•°æ®</button>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()"
                                style="cursor: pointer;">
                            <span>è‡ªåŠ¨åˆ·æ–° (30ç§’)</span>
                        </label>
                        <span id="refreshStatus" style="font-size: 12px; color: #999;"></span>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">â° æ´»è·ƒæ—¶é—´åˆ†å¸ƒ</h4>
                        <div id="activityPattern"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ’¬ è¯é¢˜åå¥½</h4>
                        <div id="topicPreferences"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“ˆ å¯¹è¯ç»Ÿè®¡</h4>
                        <div id="behaviorStats"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #ff6b6b;">âš ï¸ è®°å¿†å†²çªæ£€æµ‹</h4>
                        <div id="conflictDetection"
                            style="background: #fff5f5; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #ff6b6b;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #764ba2;">ğŸ’¡ ä¸»åŠ¨é—®ç­”å†å²</h4>
                        <div id="proactiveQA"
                            style="background: #f8f4ff; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #764ba2;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #10b981;">ğŸ§  å­¦ä¹ æ¨¡å¼</h4>
                        <div id="learningPatterns"
                            style="background: #f0fdf4; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #10b981;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æé†’ç®¡ç† v0.5.0 -->
        <div id="reminders" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ”” æé†’ç®¡ç† <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.5.0
                            Active Perceptionå±‚</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="loadReminders()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”„ åˆ·æ–°
                        </button>
                        <button onclick="showCreateReminderDialog()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            â• åˆ›å»ºæé†’
                        </button>
                        <button onclick="toggleExpiredReminders()"
                            style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <span id="toggleExpiredBtn">ï¿½ï¸ æ˜¾ç¤ºå·²è¿‡æœŸ</span>
                        </button>
                        <button onclick="checkReminders()"
                            style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ï¿½ ç«‹å³æ£€æŸ¥
                        </button>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="reminderStats" style="margin: 15px 0; display: flex; gap: 15px; font-size: 13px;">
                        <span style="color: #10b981;">âœ… æ´»è·ƒ: <strong id="activeCount">0</strong></span>
                        <span style="color: #999;">â¸ï¸ å·²ç¦ç”¨: <strong id="disabledCount">0</strong></span>
                        <span style="color: #f59e0b;">ğŸ“œ å·²è§¦å‘: <strong id="triggeredCount">0</strong></span>
                    </div>

                    <!-- æé†’åˆ—è¡¨ï¼ˆåˆå¹¶ç‰ˆï¼‰ -->
                    <div style="margin: 20px 0;">
                        <div id="remindersList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°"åŠ è½½æé†’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å·¥å…·ç®¡ç† -->
        <div id="tools" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>ğŸ”§ å·¥å…·ç®¡ç† <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.4.0
                            Actionå±‚</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadTools()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”„ åˆ·æ–°å·¥å…·åˆ—è¡¨
                        </button>
                    </div>

                    <!-- å·¥å…·åˆ—è¡¨ -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“‹ å¯ç”¨å·¥å…·</h4>
                        <div id="toolsList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 150px;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°å·¥å…·åˆ—è¡¨"åŠ è½½</div>
                        </div>
                    </div>

                    <!-- å·¥å…·æ‰§è¡Œå†å² -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">ğŸ“Š å·¥å…·æ‰§è¡Œå†å²</h4>
                        <div style="margin-bottom: 10px;">
                            <button onclick="loadToolHistory()"
                                style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                ğŸ”„ åˆ·æ–°å†å²
                            </button>
                            <select id="historyLimit"
                                style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="10">æœ€è¿‘10æ¡</option>
                                <option value="20" selected>æœ€è¿‘20æ¡</option>
                                <option value="50">æœ€è¿‘50æ¡</option>
                            </select>
                        </div>
                        <div id="toolHistory"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <div class="loading">ç‚¹å‡»"åˆ·æ–°å†å²"åŠ è½½</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ v0.6.0 Phase 2 -->
        <div id="settings" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>âš™ï¸ ç”¨æˆ·è®¾ç½® <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.6.0 ç”¨æˆ·ä½“éªŒ</span>
                    </h3>

                    <!-- å¤–è§‚è®¾ç½® -->
                    <div class="settings-section">
                        <h4 class="settings-title">ğŸ¨ å¤–è§‚è®¾ç½®</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ä¸»é¢˜æ¨¡å¼</span>
                                <span class="setting-desc">é€‰æ‹©ç•Œé¢ä¸»é¢˜åå¥½</span>
                            </div>
                            <select id="themePreference" class="setting-select"
                                onchange="updateThemePreference(this.value)">
                                <option value="system">è·Ÿéšç³»ç»Ÿ</option>
                                <option value="light">å§‹ç»ˆäº®è‰²</option>
                                <option value="dark">å§‹ç»ˆæš—è‰²</option>
                            </select>
                        </div>
                    </div>

                    <!-- äº¤äº’è®¾ç½® -->
                    <div class="settings-section">
                        <h4 class="settings-title">âŒ¨ï¸ äº¤äº’è®¾ç½®</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">å¿«æ·é”®</span>
                                <span class="setting-desc">å¯ç”¨/ç¦ç”¨é”®ç›˜å¿«æ·é”®åŠŸèƒ½</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="keyboardShortcuts" checked
                                    onchange="toggleKeyboardShortcuts(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">å¿«æ·é”®æç¤ºæ </span>
                                <span class="setting-desc">æ˜¾ç¤º/éšè—åº•éƒ¨å¿«æ·é”®æç¤º</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="shortcutHintsEnabled" checked
                                    onchange="toggleShortcutHints(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- AIå“åº”è®¾ç½® -->
                    <div class="settings-section">
                        <h4 class="settings-title">ğŸ¤– AIå“åº”è®¾ç½®</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">å›å¤é£æ ¼</span>
                                <span class="setting-desc">é€‰æ‹©AIçš„å›å¤è¯¦ç»†ç¨‹åº¦</span>
                            </div>
                            <select id="responseStyle" class="setting-select"
                                onchange="updateResponseStyle(this.value)">
                                <option value="concise">ç®€æ´æ¨¡å¼</option>
                                <option value="balanced" selected>å¹³è¡¡æ¨¡å¼</option>
                                <option value="detailed">è¯¦ç»†æ¨¡å¼</option>
                                <option value="professional">ä¸“ä¸šæ¨¡å¼</option>
                            </select>
                        </div>
                    </div>

                    <!-- é€šçŸ¥è®¾ç½® -->
                    <div class="settings-section">
                        <h4 class="settings-title">ğŸ”” é€šçŸ¥è®¾ç½®</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">ä¸»åŠ¨é—®ç­”æç¤º</span>
                                <span class="setting-desc">æ˜¾ç¤ºè¿½é—®å»ºè®®æç¤º</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="proactiveQA" checked
                                    onchange="toggleProactiveQA(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">æé†’é€šçŸ¥</span>
                                <span class="setting-desc">å¯ç”¨æé†’å¼¹çª—é€šçŸ¥</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="reminderNotifications" checked
                                    onchange="toggleReminderNotifications(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- é‡ç½®æŒ‰é’® -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
                        <button onclick="resetSettings()" style="
                            padding: 12px 30px;
                            background: #ff6b6b;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.2s;
                        ">
                            ğŸ”„ é‡ç½®æ‰€æœ‰è®¾ç½®
                        </button>
                        <p style="margin-top: 10px; font-size: 12px; color: #999;">
                            å°†æ¢å¤æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- v0.6.0 å¿«æ·é”®æç¤ºæ  -->
    <div id="shortcutHints" style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea15, #764ba215);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 12px;
        color: #666;
        border-top: 1px solid #ddd;
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
    ">
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+Enter</kbd>
            å‘é€
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Esc</kbd>
            æ¸…ç©º
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+K</kbd>
            æ–°å¯¹è¯
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+/</kbd>
            èŠå¤©
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+1-6</kbd>
            åˆ‡æ¢æ ‡ç­¾
        </span>
    </div>

    <!-- v0.6.0 æ€§èƒ½ä¼˜åŒ–æ¨¡å— -->
    <script src="/static/performance.js"></script>

    <script>
        let currentSessionId = null;
        const API_BASE = '';

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // æ›´æ–°å›¾æ ‡
            themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            // æ£€æŸ¥ç”¨æˆ·åå¥½
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // ç¡®å®šä½¿ç”¨çš„ä¸»é¢˜
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

            html.setAttribute('data-theme', theme);
            themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', initTheme);

        // ===== è®¾ç½®ç®¡ç†åŠŸèƒ½ v0.6.0 =====

        // è®¾ç½®é¡¹é»˜è®¤å€¼
        const DEFAULT_SETTINGS = {
            themePreference: 'system',
            keyboardShortcuts: true,
            shortcutHintsEnabled: true,
            responseStyle: 'balanced',
            proactiveQA: true,
            reminderNotifications: true
        };

        // åˆå§‹åŒ–è®¾ç½®
        function initSettings() {
            const settings = getSettings();

            // åº”ç”¨æ‰€æœ‰è®¾ç½®
            document.getElementById('themePreference').value = settings.themePreference;
            document.getElementById('keyboardShortcuts').checked = settings.keyboardShortcuts;
            document.getElementById('shortcutHintsEnabled').checked = settings.shortcutHintsEnabled;
            document.getElementById('responseStyle').value = settings.responseStyle;
            document.getElementById('proactiveQA').checked = settings.proactiveQA;
            document.getElementById('reminderNotifications').checked = settings.reminderNotifications;

            // åº”ç”¨ä¸»é¢˜åå¥½
            applyThemePreference(settings.themePreference);

            // åº”ç”¨å¿«æ·é”®æç¤º
            if (settings.shortcutHintsEnabled) {
                showShortcutHints();
            }
        }

        // è·å–è®¾ç½®
        function getSettings() {
            const saved = localStorage.getItem('userSettings');
            return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings(settings) {
            localStorage.setItem('userSettings', JSON.stringify(settings));
        }

        // æ›´æ–°ä¸»é¢˜åå¥½
        function updateThemePreference(value) {
            const settings = getSettings();
            settings.themePreference = value;
            saveSettings(settings);
            applyThemePreference(value);
            showToast(`âœ… ä¸»é¢˜åå¥½å·²è®¾ç½®ä¸ºï¼š${getThemeLabel(value)}`, 'success');
        }

        // åº”ç”¨ä¸»é¢˜åå¥½
        function applyThemePreference(preference) {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            if (preference === 'system') {
                // è·Ÿéšç³»ç»Ÿ
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = systemPrefersDark ? 'dark' : 'light';
                html.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            } else {
                // å›ºå®šä¸»é¢˜
                html.setAttribute('data-theme', preference);
                themeIcon.textContent = preference === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                localStorage.setItem('theme', preference);
            }
        }

        // è·å–ä¸»é¢˜æ ‡ç­¾
        function getThemeLabel(value) {
            const labels = {
                'system': 'è·Ÿéšç³»ç»Ÿ',
                'light': 'å§‹ç»ˆäº®è‰²',
                'dark': 'å§‹ç»ˆæš—è‰²'
            };
            return labels[value] || value;
        }

        // åˆ‡æ¢å¿«æ·é”®åŠŸèƒ½
        function toggleKeyboardShortcuts(enabled) {
            const settings = getSettings();
            settings.keyboardShortcuts = enabled;
            saveSettings(settings);
            showToast(enabled ? 'âœ… å¿«æ·é”®å·²å¯ç”¨' : 'âš ï¸ å¿«æ·é”®å·²ç¦ç”¨', enabled ? 'success' : 'warning');
        }

        // åˆ‡æ¢å¿«æ·é”®æç¤ºæ 
        function toggleShortcutHints(enabled) {
            const settings = getSettings();
            settings.shortcutHintsEnabled = enabled;
            saveSettings(settings);

            const hints = document.getElementById('shortcutHints');
            if (enabled) {
                showShortcutHints();
            } else {
                hints.style.opacity = '0';
                setTimeout(() => {
                    hints.style.display = 'none';
                }, 300);
            }
            showToast(enabled ? 'âœ… å¿«æ·é”®æç¤ºå·²æ˜¾ç¤º' : 'âš ï¸ å¿«æ·é”®æç¤ºå·²éšè—', enabled ? 'success' : 'warning');
        }

        // æ›´æ–°AIå“åº”é£æ ¼
        function updateResponseStyle(style) {
            const settings = getSettings();
            settings.responseStyle = style;
            saveSettings(settings);

            const labels = {
                'concise': 'ç®€æ´æ¨¡å¼',
                'balanced': 'å¹³è¡¡æ¨¡å¼',
                'detailed': 'è¯¦ç»†æ¨¡å¼',
                'professional': 'ä¸“ä¸šæ¨¡å¼'
            };
            showToast(`âœ… AIå“åº”é£æ ¼å·²è®¾ç½®ä¸ºï¼š${labels[style]}`, 'success');
        }

        // åˆ‡æ¢ä¸»åŠ¨é—®ç­”
        function toggleProactiveQA(enabled) {
            const settings = getSettings();
            settings.proactiveQA = enabled;
            saveSettings(settings);
            showToast(enabled ? 'âœ… ä¸»åŠ¨é—®ç­”æç¤ºå·²å¯ç”¨' : 'âš ï¸ ä¸»åŠ¨é—®ç­”æç¤ºå·²ç¦ç”¨', enabled ? 'success' : 'warning');
        }

        // åˆ‡æ¢æé†’é€šçŸ¥
        function toggleReminderNotifications(enabled) {
            const settings = getSettings();
            settings.reminderNotifications = enabled;
            saveSettings(settings);
            showToast(enabled ? 'âœ… æé†’é€šçŸ¥å·²å¯ç”¨' : 'âš ï¸ æé†’é€šçŸ¥å·²ç¦ç”¨', enabled ? 'success' : 'warning');
        }

        // é‡ç½®æ‰€æœ‰è®¾ç½®
        function resetSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
                localStorage.removeItem('userSettings');
                localStorage.removeItem('theme');
                initSettings();
                applyThemePreference('system');
                showToast('âœ… æ‰€æœ‰è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è®¾ç½®
        document.addEventListener('DOMContentLoaded', function () {
            initSettings();
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName, event) {
            // ç§»é™¤æ‰€æœ‰tabå’Œå†…å®¹çš„activeçŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // æ¿€æ´»å¯¹åº”çš„tabæŒ‰é’®ï¼ˆå¦‚æœæ˜¯é€šè¿‡ç‚¹å‡»è§¦å‘ï¼‰
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // å¦‚æœæ˜¯ç¨‹åºè°ƒç”¨ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„tabæŒ‰é’®å¹¶æ¿€æ´»
                const tabButton = document.querySelector(`.tab[onclick*="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }

            // æ¿€æ´»å¯¹åº”çš„å†…å®¹åŒºåŸŸ
            document.getElementById(tabName).classList.add('active');

            // åŠ è½½å¯¹åº”tabçš„æ•°æ®
            if (tabName === 'sessions') loadSessions();
            if (tabName === 'memory') loadMemoryStats();
            if (tabName === 'analytics') {
                // è‡ªåŠ¨åŠ è½½è¡Œä¸ºåˆ†ææ•°æ®
                loadBehaviorAnalytics();
                // è‡ªåŠ¨åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
                const userId = 'default_user';
                loadProactiveQA(userId);
            }
            if (tabName === 'reminders') {
                // è‡ªåŠ¨åŠ è½½æé†’åˆ—è¡¨
                loadReminders();
                loadReminderHistory();
            }
            if (tabName === 'tools') {
                // è‡ªåŠ¨åŠ è½½å·¥å…·åˆ—è¡¨
                loadTools();
                loadToolHistory();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆä»contenteditable divï¼‰
        async function sendMessageFromDiv() {
            const input = document.getElementById('messageInput');
            const message = input.textContent.trim();
            if (!message) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.contentEditable = 'false';

            // æ£€æŸ¥æ˜¯å¦å¤„äºç¼–è¾‘æ¨¡å¼ v0.6.0
            if (editingMessage) {
                // æ›´æ–°æ¶ˆæ¯å†…å®¹
                const contentDiv = editingMessage.querySelector('.message-content');
                contentDiv.textContent = message;

                // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
                clearEditingState();
                input.textContent = '';
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();

                showToast('æ¶ˆæ¯å·²æ›´æ–°', 'success');
                return;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.textContent = '';

            try {
                const url = currentSessionId
                    ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}`
                    : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}`;

                // è®¾ç½®60ç§’è¶…æ—¶ä»¥å¤„ç†å¤æ‚é—®é¢˜
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(url, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);

                    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸»åŠ¨è¿½é—®å»ºè®®
                    if (data.followup) {
                        showFollowupSuggestion(data.followup);
                    }
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', 'è¯·æ±‚è¶…æ—¶ï¼Œé—®é¢˜å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œè¯·ç¨åå†è¯•ã€‚');
                } else {
                    addMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆä¿ç•™æ—§å‡½æ•°å…¼å®¹æ€§ï¼‰
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            // æ£€æŸ¥æ˜¯å¦æ˜¯contenteditable
            if (input.contentEditable === 'true') {
                sendMessageFromDiv();
                return;
            }

            const message = input.value.trim();
            if (!message) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';
            // é‡ç½®textareaé«˜åº¦
            input.style.height = 'auto';

            try {
                // v0.6.0: è·å–ç”¨æˆ·è®¾ç½®çš„å“åº”é£æ ¼
                const settings = getSettings();
                const responseStyle = settings.responseStyle || 'balanced';

                const url = currentSessionId
                    ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}&response_style=${responseStyle}`
                    : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&response_style=${responseStyle}`;

                // è®¾ç½®60ç§’è¶…æ—¶ä»¥å¤„ç†å¤æ‚é—®é¢˜
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(url, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', 'è¯·æ±‚è¶…æ—¶ï¼Œé—®é¢˜å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œè¯·ç¨åå†è¯•ã€‚');
                } else {
                    addMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, content, messageId = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // è®¾ç½®æ¶ˆæ¯IDç”¨äºç¼–è¾‘/åˆ é™¤
            if (messageId) {
                messageDiv.dataset.messageId = messageId;
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ï¼Œä½¿ç”¨Markdownæ¸²æŸ“ï¼›ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
            if (role === 'assistant') {
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;

                // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ æ“ä½œæŒ‰é’® v0.6.0
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                // ç¼–è¾‘æŒ‰é’®
                const editBtn = document.createElement('button');
                editBtn.className = 'message-action-btn edit';
                editBtn.innerHTML = 'âœï¸';
                editBtn.title = 'ç¼–è¾‘æ¶ˆæ¯';
                editBtn.onclick = () => editMessage(messageDiv, content);

                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn delete';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteBtn.title = 'åˆ é™¤æ¶ˆæ¯';
                deleteBtn.onclick = () => deleteMessage(messageDiv);

                // å¤åˆ¶æŒ‰é’®
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn copy';
                copyBtn.innerHTML = 'ğŸ“‹';
                copyBtn.title = 'å¤åˆ¶æ¶ˆæ¯';
                copyBtn.onclick = () => copyMessage(content, copyBtn);

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                actionsDiv.appendChild(copyBtn);
                messageDiv.appendChild(actionsDiv);
            }

            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ–°å¯¹è¯
        function newChat() {
            currentSessionId = null;
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('messageInput').focus();

            // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
            clearEditingState();
        }

        // ============ v0.6.0 æ¶ˆæ¯æ“ä½œåŠŸèƒ½ ============

        let editingMessage = null;
        let originalContent = '';

        // ç¼–è¾‘æ¶ˆæ¯
        function editMessage(messageDiv, content) {
            const input = document.getElementById('messageInput');

            // ä¿å­˜ç¼–è¾‘çŠ¶æ€
            editingMessage = messageDiv;
            originalContent = input.textContent;

            // å°†æ¶ˆæ¯å†…å®¹åŠ è½½åˆ°è¾“å…¥æ¡†
            input.textContent = content;
            input.focus();

            // æ˜¾ç¤ºç¼–è¾‘æç¤º
            showEditingIndicator();
        }

        // æ˜¾ç¤ºç¼–è¾‘çŠ¶æ€æç¤º
        function showEditingIndicator() {
            // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
            const existing = document.querySelector('.editing-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.className = 'editing-indicator';
            indicator.innerHTML = `
                <span>âœï¸ æ­£åœ¨ç¼–è¾‘æ¶ˆæ¯</span>
                <button onclick="clearEditingState()">å–æ¶ˆ</button>
            `;
            document.body.appendChild(indicator);
        }

        // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
        function clearEditingState() {
            editingMessage = null;
            originalContent = '';

            const indicator = document.querySelector('.editing-indicator');
            if (indicator) indicator.remove();
        }

        // åˆ é™¤æ¶ˆæ¯
        function deleteMessage(messageDiv) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                // æ‰¾åˆ°å¯¹åº”çš„AIå›å¤å¹¶ä¸€èµ·åˆ é™¤
                let nextElement = messageDiv.nextElementSibling;
                if (nextElement && nextElement.classList.contains('message') &&
                    (nextElement.classList.contains('ai') || nextElement.classList.contains('assistant'))) {
                    nextElement.remove();
                }

                // åˆ é™¤ç”¨æˆ·æ¶ˆæ¯
                messageDiv.remove();

                // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
                showToast('æ¶ˆæ¯å·²åˆ é™¤', 'success');
            }
        }

        // å¤åˆ¶æ¶ˆæ¯
        async function copyMessage(content, button) {
            try {
                await navigator.clipboard.writeText(content);

                // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ˜¾ç¤º
                const originalText = button.innerHTML;
                button.innerHTML = 'âœ“';
                button.style.background = '#4CAF50';
                button.style.color = 'white';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.style.color = '';
                }, 1000);

                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#ff6b6b' : '#667eea'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                animation: slideInRight 0.3s;
                font-size: 14px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ============ æ¶ˆæ¯æ“ä½œåŠŸèƒ½ç»“æŸ ============

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions() {
            const container = document.getElementById('sessionsList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/sessions?limit=20`);
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    // æŒ‰æ—¶é—´å»é‡ï¼šå¦‚æœå¤šä¸ªä¼šè¯titleç›¸åŒï¼Œåªæ˜¾ç¤ºæœ€æ–°çš„
                    const uniqueSessions = [];
                    const seenTitles = new Set();

                    for (const session of data.sessions) {
                        if (!seenTitles.has(session.title)) {
                            seenTitles.add(session.title);
                            uniqueSessions.push(session);
                        }
                    }

                    container.innerHTML = uniqueSessions.map(session => `
                        <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}"
                             data-session-id="${session.session_id}"
                             style="cursor: pointer;">
                            <div class="session-title">${session.title}</div>
                            <div class="session-time">
                                åˆ›å»º: ${session.created_at} | æ›´æ–°: ${session.updated_at}
                            </div>
                            <div class="session-actions">
                                <button class="session-action-btn export-md" 
                                        onclick="exportSession('${session.session_id}', 'markdown'); event.stopPropagation();"
                                        title="å¯¼å‡ºä¸ºMarkdown">
                                    ğŸ“
                                </button>
                                <button class="session-action-btn export-json" 
                                        onclick="exportSession('${session.session_id}', 'json'); event.stopPropagation();"
                                        title="å¯¼å‡ºä¸ºJSON">
                                    ğŸ“¦
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // ä¸ºæ¯ä¸ªä¼šè¯é¡¹æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                    container.querySelectorAll('.session-item').forEach(item => {
                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            const sessionId = this.getAttribute('data-session-id');
                            if (sessionId) {
                                loadSession(sessionId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="loading">è¿˜æ²¡æœ‰ä¼šè¯è®°å½•</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ===== ä¼šè¯å¯¼å‡ºåŠŸèƒ½ =====

        /**
         * å¯¼å‡ºä¼šè¯ä¸ºæŒ‡å®šæ ¼å¼
         * @param {string} sessionId - ä¼šè¯ID
         * @param {string} format - å¯¼å‡ºæ ¼å¼ ('markdown' æˆ– 'json')
         */
        async function exportSession(sessionId, format) {
            try {
                console.log(`å¯¼å‡ºä¼šè¯ ${sessionId} ä¸º ${format} æ ¼å¼`);

                // è·å–ä¼šè¯æ•°æ®
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`è·å–ä¼šè¯å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                const messages = data.messages || [];
                const title = data.title || 'æœªå‘½åä¼šè¯';
                const createdAt = data.created_at || new Date().toISOString();

                let content, filename, mimeType;

                if (format === 'markdown') {
                    // ç”ŸæˆMarkdownæ ¼å¼
                    content = generateMarkdown(title, createdAt, messages);
                    filename = `${sanitizeFilename(title)}_${getTimestamp()}.md`;
                    mimeType = 'text/markdown';
                } else if (format === 'json') {
                    // ç”ŸæˆJSONæ ¼å¼
                    content = JSON.stringify({
                        session_id: sessionId,
                        title: title,
                        created_at: createdAt,
                        exported_at: new Date().toISOString(),
                        message_count: messages.length,
                        messages: messages.map(msg => ({
                            role: msg.role,
                            content: msg.content,
                            timestamp: msg.timestamp || msg.created_at
                        }))
                    }, null, 2);
                    filename = `${sanitizeFilename(title)}_${getTimestamp()}.json`;
                    mimeType = 'application/json';
                } else {
                    throw new Error('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼');
                }

                // ä¸‹è½½æ–‡ä»¶
                downloadFile(content, filename, mimeType);
                showToast(`âœ… å¯¼å‡ºæˆåŠŸ: ${filename}`, 'success');

            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        /**
         * ç”ŸæˆMarkdownæ ¼å¼çš„ä¼šè¯å†…å®¹
         */
        function generateMarkdown(title, createdAt, messages) {
            let md = `# ${title}\n\n`;
            md += `**åˆ›å»ºæ—¶é—´**: ${createdAt}\n`;
            md += `**å¯¼å‡ºæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n`;
            md += `**æ¶ˆæ¯æ•°é‡**: ${messages.length}\n\n`;
            md += `---\n\n`;

            messages.forEach((msg, index) => {
                const role = msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– å°ä¹AI';
                const timestamp = msg.timestamp || msg.created_at || '';

                md += `## ${role}\n\n`;
                if (timestamp) {
                    md += `*${timestamp}*\n\n`;
                }
                md += `${msg.content}\n\n`;

                if (index < messages.length - 1) {
                    md += `---\n\n`;
                }
            });

            return md;
        }

        /**
         * æ¸…ç†æ–‡ä»¶åï¼ˆç§»é™¤éæ³•å­—ç¬¦ï¼‰
         */
        function sanitizeFilename(name) {
            return name
                .replace(/[<>:"/\\|?*]/g, '') // ç§»é™¤Windowséæ³•å­—ç¬¦
                .replace(/\s+/g, '_')         // ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                .substring(0, 50);            // é™åˆ¶é•¿åº¦
        }

        /**
         * è·å–æ—¶é—´æˆ³å­—ç¬¦ä¸²ï¼ˆç”¨äºæ–‡ä»¶åï¼‰
         */
        function getTimestamp() {
            const now = new Date();
            return now.toISOString()
                .replace(/[:.]/g, '-')
                .replace('T', '_')
                .substring(0, 19);
        }

        /**
         * ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // åŠ è½½æŒ‡å®šä¼šè¯
        async function loadSession(sessionId) {
            console.log('æ­£åœ¨åŠ è½½ä¼šè¯:', sessionId);

            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ä¼šè¯æ•°æ®:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                currentSessionId = sessionId;
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';

                // æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
                const sessionInfo = document.getElementById('sessionInfo');
                const titleSpan = document.getElementById('currentSessionTitle');
                titleSpan.textContent = data.title || 'æœªå‘½åä¼šè¯';
                sessionInfo.style.display = 'block';

                // åŠ è½½å†å²æ¶ˆæ¯
                const messages = data.messages || data.history || [];
                if (messages.length > 0) {
                    messages.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                }

                // åˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾é¡µ
                switchTab('chat');

                // æ›´æ–°ä¼šè¯åˆ—è¡¨çš„activeçŠ¶æ€
                document.querySelectorAll('.session-item').forEach(item => {
                    if (item.getAttribute('data-session-id') === sessionId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                console.log('ä¼šè¯åŠ è½½æˆåŠŸ');
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                alert('åŠ è½½ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½è®°å¿†ç»Ÿè®¡
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats`);
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                const tags = data.by_tag || {};

                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${data.total}</div>
                        <div class="stat-label">æ€»è®°å¿†æ•°</div>
                    </div>
                    ${Object.entries(tags).map(([tag, count]) => `
                        <div class="stat-item">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${tag}</div>
                        </div>
                    `).join('')}
                `;

                loadRecentMemories();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML =
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æœ€è¿‘è®°å¿†
        async function loadRecentMemories() {
            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/recent?hours=24&limit=20`);
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰è®°å¿†è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æœç´¢è®°å¿†ï¼ˆå…³é”®è¯ï¼‰
        async function searchMemories() {
            const keywords = document.getElementById('searchInput').value.trim();
            if (!keywords) {
                loadRecentMemories();
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">å…³é”®è¯æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/search?keywords=${encodeURIComponent(keywords)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¯­ä¹‰æœç´¢è®°å¿†
        async function semanticSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">ğŸ§  è¯­ä¹‰æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/semantic?query=${encodeURIComponent(query)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item">
                            <div class="memory-content">${mem.content}</div>
                            <div class="memory-meta">
                                <span>ğŸ·ï¸ ${mem.tag}</span>
                                <span>ğŸ• ${mem.timestamp}</span>
                                <span>ğŸ“Š ç›¸ä¼¼åº¦: ${(mem.score * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('refreshStatus');

            if (checkbox.checked) {
                // å¯ç”¨è‡ªåŠ¨åˆ·æ–°
                loadBehaviorAnalytics();
                lastRefreshTime = Date.now();
                updateRefreshStatus();

                autoRefreshInterval = setInterval(() => {
                    loadBehaviorAnalytics();
                    lastRefreshTime = Date.now();
                    updateRefreshStatus();
                }, 30000); // 30ç§’

                statusSpan.style.color = '#51cf66';
                console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨ (30ç§’)');
            } else {
                // ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = '';
                console.log('â¸ï¸ è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
            }
        }

        // æ›´æ–°åˆ·æ–°çŠ¶æ€
        function updateRefreshStatus() {
            const statusSpan = document.getElementById('refreshStatus');
            if (lastRefreshTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - lastRefreshTime) / 1000);
                statusSpan.textContent = `ä¸Šæ¬¡åˆ·æ–°: ${elapsed}ç§’å‰`;
            }
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€æ˜¾ç¤º
        setInterval(() => {
            if (autoRefreshInterval && lastRefreshTime) {
                updateRefreshStatus();
            }
        }, 1000);

        // åŠ è½½è¡Œä¸ºåˆ†ææ•°æ®
        async function loadBehaviorAnalytics() {
            const userId = 'default_user';

            // åŠ è½½æ´»è·ƒæ—¶é—´åˆ†å¸ƒ
            loadActivityPattern(userId);

            // åŠ è½½è¯é¢˜åå¥½
            loadTopicPreferences(userId);

            // åŠ è½½å¯¹è¯ç»Ÿè®¡
            loadBehaviorStats(userId);

            // åŠ è½½å†²çªæ£€æµ‹
            loadConflictDetection();

            // åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
            loadProactiveQA(userId);

            // åŠ è½½å­¦ä¹ æ¨¡å¼
            loadLearningPatterns(userId);
        }

        // åŠ è½½æ´»è·ƒæ—¶é—´åˆ†å¸ƒ
        async function loadActivityPattern(userId) {
            const container = document.getElementById('activityPattern');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/activity?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

                // å°æ—¶åˆ†å¸ƒ
                if (data.hourly_distribution && Object.keys(data.hourly_distribution).length > 0) {
                    html += '<div><strong>ğŸ“… æ´»è·ƒæ—¶æ®µï¼ˆå°æ—¶ï¼‰</strong><div style="margin-top: 8px;">';
                    const sortedHours = Object.entries(data.hourly_distribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    sortedHours.forEach(([hour, count]) => {
                        html += `<div style="margin: 5px 0;">ğŸ• ${hour}:00 - ${count}æ¬¡</div>`;
                    });
                    html += '</div></div>';
                }

                // æ˜ŸæœŸåˆ†å¸ƒ
                if (data.daily_distribution && Object.keys(data.daily_distribution).length > 0) {
                    const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                    html += '<div><strong>ğŸ“† æ´»è·ƒæ˜ŸæœŸ</strong><div style="margin-top: 8px;">';
                    const sortedDays = Object.entries(data.daily_distribution).sort((a, b) => b[1] - a[1]);
                    sortedDays.forEach(([day, count]) => {
                        html += `<div style="margin: 5px 0;">${weekdays[day] || 'å‘¨' + day} - ${count}æ¬¡</div>`;
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html || '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½è¯é¢˜åå¥½
        async function loadTopicPreferences(userId) {
            const container = document.getElementById('topicPreferences');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/topics?user_id=${userId}`);
                const data = await response.json();

                if (data.error || !data.top_topics || data.top_topics.length === 0) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— è¯é¢˜æ•°æ®</div>';
                    return;
                }

                let html = '<div>';
                data.top_topics.slice(0, 10).forEach((item, index) => {
                    const [topic, count] = item;
                    html += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${index + 1}. ğŸ·ï¸ ${topic}</span>
                            <span style="color: #667eea; font-weight: bold;">${count}æ¬¡</span>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å¯¹è¯ç»Ÿè®¡
        async function loadBehaviorStats(userId) {
            const container = document.getElementById('behaviorStats');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/behavior?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">æš‚æ— æ•°æ®</div>';
                    return;
                }

                // ä¿®å¤ï¼šä½¿ç”¨ conversation_stats è€Œä¸æ˜¯ stats
                const stats = data.conversation_stats || {};
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_sessions || 0}</div>
                            <div style="color: #999; margin-top: 5px;">æ€»ä¼šè¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_messages || 0}</div>
                            <div style="color: #999; margin-top: 5px;">æ€»æ¶ˆæ¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_messages_per_session || 0}</div>
                            <div style="color: #999; margin-top: 5px;">å¹³å‡æ¶ˆæ¯/ä¼šè¯</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_message_length || 0}</div>
                            <div style="color: #999; margin-top: 5px;">å¹³å‡æ¶ˆæ¯é•¿åº¦</div>
                        </div>
                    </div>
                `;

                if (stats.last_session_time) {
                    html += `<div style="margin-top: 15px; text-align: center; color: #666;">
                        æœ€åæ´»è·ƒ: ${new Date(stats.last_session_time).toLocaleString('zh-CN')}
                    </div>`;
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å†²çªæ£€æµ‹
        async function loadConflictDetection() {
            const container = document.getElementById('conflictDetection');
            container.innerHTML = '<div class="loading">æ£€æµ‹ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/conflicts`);
                const data = await response.json();

                if (data.conflicts && data.conflicts.length > 0) {
                    let html = `<div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">
                        âš ï¸ å‘ç° ${data.conflicts.length} ç»„å†²çªè®°å¿†
                    </div>`;

                    data.conflicts.forEach((conflict, index) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #ff6b6b; border-radius: 5px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">å†²çª ${index + 1}: ${conflict.type_cn}</div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    ğŸ“„ æ—§å€¼: ${conflict.old_value} - ${conflict.old_memory}
                                </div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    ğŸ“„ æ–°å€¼: ${conflict.new_value} - ${conflict.new_memory}
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 12px;">
                                    æ£€æµ‹æ—¶é—´: ${conflict.conflict_detected_at}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #51cf66; text-align: center;">âœ… æ²¡æœ‰å‘ç°å†²çªè®°å¿†</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½ä¸»åŠ¨é—®ç­”å†å²
        async function loadProactiveQA(userId) {
            const container = document.getElementById('proactiveQA');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/proactive/history?user_id=${userId}&limit=10`);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    let html = `<div style="color: #764ba2; font-weight: bold; margin-bottom: 10px;">
                        ğŸ’¡ å…± ${data.total} æ¡è¿½é—®è®°å½•ï¼ˆæ˜¾ç¤ºæœ€è¿‘10æ¡ï¼‰
                    </div>`;

                    data.history.forEach((item, index) => {
                        const confidenceColor = item.confidence >= 70 ? '#51cf66' : item.confidence >= 50 ? '#ffd43b' : '#ff6b6b';
                        const askedBadge = item.followup_asked
                            ? '<span style="background: #51cf66; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">å·²è¿½é—®</span>'
                            : '<span style="background: #999; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">å¾…è¿½é—®</span>';

                        // å¾…è¿½é—®çš„è®°å½•æ˜¾ç¤ºå‘é€æŒ‰é’®
                        const actionButton = !item.followup_asked
                            ? `<button class="send-followup-btn" data-id="${item.id}" data-text="${item.followup_question.replace(/"/g, '&quot;')}" data-user="${userId}"
                                style="margin-top: 8px; padding: 6px 12px; background: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ğŸ“¤ å‘é€è¿½é—®
                               </button>`
                            : '';

                        html += `
                            <div style="margin: 10px 0; padding: 12px; background: white; border-left: 3px solid #764ba2; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold;">è®°å½• ${index + 1}</span>
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        ${askedBadge}
                                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                            ç½®ä¿¡åº¦ ${item.confidence}%
                                        </span>
                                    </div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #f8f4ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">åŸå§‹é—®é¢˜:</div>
                                    <div>â“ ${item.original_question}</div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #e7f5ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">å»ºè®®è¿½é—®:</div>
                                    <div>ğŸ’¬ ${item.followup_question}</div>
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 11px;">
                                    åˆ›å»ºæ—¶é—´: ${new Date(item.created_at).toLocaleString('zh-CN')}
                                    ${item.asked_at ? ` | è¿½é—®æ—¶é—´: ${new Date(item.asked_at).toLocaleString('zh-CN')}` : ''}
                                </div>
                                ${actionButton}
                            </div>
                        `;
                    });

                    container.innerHTML = html;

                    // ä¸ºæ‰€æœ‰å‘é€æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    container.querySelectorAll('.send-followup-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            const text = this.getAttribute('data-text');
                            const user = this.getAttribute('data-user');
                            sendFollowupFromHistory(id, text, user);
                        });
                    });
                } else {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— è¿½é—®è®°å½•</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å­¦ä¹ æ¨¡å¼
        async function loadLearningPatterns(userId) {
            const container = document.getElementById('learningPatterns');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // å¹¶è¡Œè·å–ä¸‰ä¸ªAPIæ•°æ®
                const [frequentRes, questionsRes, insightsRes] = await Promise.all([
                    fetch(`${API_BASE}/patterns/frequent?user_id=${userId}&limit=10`),
                    fetch(`${API_BASE}/patterns/common_questions?user_id=${userId}&limit=5`),
                    fetch(`${API_BASE}/patterns/insights?user_id=${userId}`)
                ]);

                const frequentData = await frequentRes.json();
                const questionsData = await questionsRes.json();
                const insightsData = await insightsRes.json();

                let html = '';

                // æ˜¾ç¤ºç»Ÿè®¡æ¦‚è§ˆ
                if (insightsData && insightsData.statistics) {
                    const stats = insightsData.statistics;
                    html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.total_patterns || 0}</div>
                        <div style="font-size: 12px; color: #999;">æ€»å­¦ä¹ æ¨¡å¼</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.frequent_words_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">é«˜é¢‘è¯æ±‡</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.common_questions_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">å¸¸è§é—®é¢˜</div>
                    </div>`;
                    html += `</div>`;
                }

                // æ˜¾ç¤ºé«˜é¢‘è¯
                if (frequentData.frequent_words && frequentData.frequent_words.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">ğŸ“ é«˜é¢‘è¯æ±‡ TOP10</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                    frequentData.frequent_words.forEach(item => {
                        const confidence = item.confidence || 50;
                        const bgColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#3b82f6' : '#6b7280';
                        html += `<span style="background: ${bgColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                            ${item.word} (${item.frequency}æ¬¡)
                        </span>`;
                    });

                    html += `</div></div>`;
                }

                // æ˜¾ç¤ºå¸¸è§é—®é¢˜åˆ†ç±»
                if (questionsData.common_questions && questionsData.common_questions.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">â“ å¸¸è§é—®é¢˜åˆ†ç±»</div>`;

                    questionsData.common_questions.forEach(item => {
                        const typeEmoji = {
                            'å¤©æ°”æŸ¥è¯¢': 'ğŸŒ¤ï¸',
                            'æ—¶é—´æ—¥æœŸ': 'â°',
                            'ä¸ªäººä¿¡æ¯': 'ğŸ‘¤',
                            'åŠŸèƒ½å’¨è¯¢': 'ğŸ”§',
                            'æ¨èå»ºè®®': 'ğŸ’¡',
                            'é—²èŠ': 'ğŸ’¬'
                        };

                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #10b981; border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${typeEmoji[item.category] || 'ğŸ“Œ'} ${item.category} 
                                <span style="color: #999; font-size: 12px; font-weight: normal;">(${item.frequency}æ¬¡)</span>
                            </div>`;

                        if (item.examples && item.examples.length > 0) {
                            html += `<div style="font-size: 12px; color: #666; margin-top: 5px;">`;
                            item.examples.slice(0, 2).forEach(example => {
                                html += `<div style="margin: 3px 0;">â€¢ ${example}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                }

                if (!html) {
                    html = '<div style="color: #999; text-align: center;">æš‚æ— å­¦ä¹ æ•°æ®ï¼Œå¤šèŠå‡ å¥è®©å°ä¹äº†è§£ä½ å§~</div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ============ å·¥å…·ç®¡ç†åŠŸèƒ½ (v0.4.0) ============

        // åŠ è½½å·¥å…·åˆ—è¡¨
        async function loadTools() {
            const container = document.getElementById('toolsList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/list?enabled_only=true`);
                const data = await response.json();

                if (!data.tools || data.tools.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— å¯ç”¨å·¥å…·</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                data.tools.forEach(tool => {
                    const categoryEmoji = {
                        'weather': 'ğŸŒ¤ï¸',
                        'system': 'ğŸ’»',
                        'search': 'ğŸ”',
                        'file': 'ğŸ“'
                    };

                    const emoji = categoryEmoji[tool.category] || 'ğŸ”§';
                    const statusColor = tool.enabled ? '#10b981' : '#9ca3af';
                    const statusText = tool.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';

                    html += `
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${emoji} ${tool.name}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        ${tool.description}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            ğŸ“¦ ${tool.category}
                                        </span>
                                        <span style="background: ${tool.enabled ? '#d1fae5' : '#f3f4f6'}; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            â— ${statusText}
                                        </span>
                                        ${tool.version ? `<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">v${tool.version}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${tool.parameters && tool.parameters.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ“ å‚æ•°:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                        ${tool.parameters.map(p => `
                                            <span style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: #4b5563;">
                                                ${p.name}${p.required ? '*' : ''}: ${p.type}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // æ˜¾ç¤ºå·¥å…·æ€»æ•°
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `ğŸ“‹ å¯ç”¨å·¥å…· <span style="font-size: 12px; color: #999; font-weight: normal;">(å…± ${data.tools.length} ä¸ª)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å·¥å…·æ‰§è¡Œå†å²
        async function loadToolHistory() {
            const container = document.getElementById('toolHistory');
            const limit = document.getElementById('historyLimit').value;

            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/history?user_id=default_user&limit=${limit}`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— æ‰§è¡Œå†å²</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach((record, index) => {
                    const statusColor = record.success ? '#10b981' : '#ef4444';
                    const statusIcon = record.success ? 'âœ…' : 'âŒ';
                    const executionTime = record.execution_time ? record.execution_time.toFixed(3) : 'N/A';

                    // æ ¼å¼åŒ–æ—¶é—´
                    const date = new Date(record.executed_at);
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 16px;">${statusIcon}</span>
                                    <span style="font-weight: bold; color: #333;">${record.tool_name}</span>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 11px; color: #999;">${timeStr}</span>
                                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        ${executionTime}s
                                    </span>
                                </div>
                            </div>
                            
                            ${record.error_message ? `
                                <div style="margin-top: 5px; padding: 8px; background: #fef2f2; border-radius: 5px; font-size: 12px; color: #991b1b;">
                                    âš ï¸ ${record.error_message}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæ€»æ•°
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `ğŸ“Š å·¥å…·æ‰§è¡Œå†å² <span style="font-size: 12px; color: #999; font-weight: normal;">(å…± ${data.total} æ¡)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ============ å·¥å…·ç®¡ç†åŠŸèƒ½ç»“æŸ ============

        // ============ v0.5.0 æé†’ç®¡ç†åŠŸèƒ½ ============

        // åŠ è½½æé†’åˆ—è¡¨
        // å…¨å±€å˜é‡ï¼šæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºå·²è¿‡æœŸæé†’
        let showExpired = false;

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders?user_id=default_user&enabled_only=false`);
                const data = await response.json();

                if (!data.reminders || data.reminders.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">è¿˜æ²¡æœ‰æé†’ï¼Œç‚¹å‡»"åˆ›å»ºæé†’"æ¥æ·»åŠ ï¼</div>';
                    updateReminderStats(0, 0, 0);
                    return;
                }

                // ç»Ÿè®¡æ•°æ®
                let activeCount = 0;
                let disabledCount = 0;
                let triggeredCount = 0;

                data.reminders.forEach(r => {
                    if (r.trigger_count > 0 || r.last_triggered) {
                        triggeredCount++;
                    } else if (r.enabled) {
                        activeCount++;
                    } else {
                        disabledCount++;
                    }
                });

                updateReminderStats(activeCount, disabledCount, triggeredCount);

                // è¿‡æ»¤ï¼šæ ¹æ®showExpiredå†³å®šæ˜¯å¦æ˜¾ç¤ºå·²è§¦å‘çš„æé†’
                let displayReminders;
                if (showExpired) {
                    displayReminders = data.reminders;
                } else {
                    // åªæ˜¾ç¤ºæœªè§¦å‘çš„æé†’ï¼ˆåŒ…æ‹¬å¯ç”¨å’Œç¦ç”¨ï¼‰
                    displayReminders = data.reminders.filter(r => !r.trigger_count && !r.last_triggered);
                }

                if (displayReminders.length === 0) {
                    if (showExpired) {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æ²¡æœ‰æé†’è®°å½•ã€‚</div>';
                    } else {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æ²¡æœ‰å¾…è§¦å‘çš„æé†’ã€‚<br><br>ç‚¹å‡»"ğŸ‘ï¸ æ˜¾ç¤ºå·²è¿‡æœŸ"æŸ¥çœ‹å·²è§¦å‘çš„æé†’ã€‚</div>';
                    }
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                displayReminders.forEach(reminder => {
                    const priorityColors = {
                        1: { color: '#ef4444', emoji: 'ğŸ”´', label: 'æœ€é«˜' },
                        2: { color: '#f59e0b', emoji: 'ğŸŸ ', label: 'é«˜' },
                        3: { color: '#eab308', emoji: 'ğŸŸ¡', label: 'ä¸­' },
                        4: { color: '#10b981', emoji: 'ğŸŸ¢', label: 'ä½' },
                        5: { color: '#6b7280', emoji: 'âšª', label: 'æœ€ä½' }
                    };

                    const priority = priorityColors[reminder.priority] || priorityColors[3];

                    // åˆ¤æ–­æ˜¯å¦å·²è§¦å‘
                    const isTriggered = reminder.trigger_count > 0 || reminder.last_triggered;
                    const statusColor = isTriggered ? '#9ca3af' : (reminder.enabled ? '#10b981' : '#9ca3af');
                    const statusText = isTriggered ? 'å·²è§¦å‘' : (reminder.enabled ? 'å¯ç”¨' : 'ç¦ç”¨');

                    // å·²è§¦å‘çš„æé†’ç”¨ç°è‰²èƒŒæ™¯
                    const cardBg = isTriggered ? '#f3f4f6' : 'white';
                    const cardOpacity = isTriggered ? 'opacity: 0.8;' : '';

                    const typeEmoji = {
                        'time': 'â°',
                        'weather': 'ğŸŒ¤ï¸',
                        'behavior': 'ğŸ‘¤',
                        'habit': 'ğŸ¯'
                    };

                    html += `
                        <div style="background: ${cardBg}; padding: 15px; border-radius: 10px; border-left: 4px solid ${priority.color}; ${cardOpacity}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${priority.emoji} ${reminder.title || 'æ— æ ‡é¢˜'}
                                        ${isTriggered ? '<span style="font-size: 12px; color: #9ca3af; margin-left: 8px;">ğŸ“œ å·²è§¦å‘</span>' : ''}
                                    </div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                        ${reminder.content}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            ${typeEmoji[reminder.reminder_type] || 'ğŸ“Œ'} ${reminder.reminder_type}
                                        </span>
                                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            â— ${statusText}
                                        </span>
                                        <span style="background: ${priority.color}20; color: ${priority.color}; padding: 3px 8px; border-radius: 4px;">
                                            ä¼˜å…ˆçº§: ${priority.label}
                                        </span>
                                        ${reminder.repeat ? '<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">ğŸ”„ é‡å¤</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px; margin-left: 10px;">
                                    ${!isTriggered ? `
                                        <button onclick="toggleReminder(${reminder.reminder_id})" 
                                            style="padding: 6px 12px; background: ${reminder.enabled ? '#ef4444' : '#10b981'}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                            ${reminder.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteReminder(${reminder.reminder_id})" 
                                        style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            ${reminder.last_triggered ? `
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    ä¸Šæ¬¡è§¦å‘: ${new Date(reminder.last_triggered).toLocaleString('zh-CN')}
                                    ${reminder.trigger_count ? ` | è§¦å‘æ¬¡æ•°: ${reminder.trigger_count}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateReminderStats(activeCount, disabledCount, triggeredCount) {
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('disabledCount').textContent = disabledCount;
            document.getElementById('triggeredCount').textContent = triggeredCount;
        }

        // åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºå·²è¿‡æœŸæé†’
        function toggleExpiredReminders() {
            showExpired = !showExpired;
            const btn = document.getElementById('toggleExpiredBtn');
            btn.textContent = showExpired ? 'ğŸš« éšè—å·²è¿‡æœŸ' : 'ğŸ‘ï¸ æ˜¾ç¤ºå·²è¿‡æœŸ';
            loadReminders();
        }

        // åŠ è½½æé†’å†å²
        async function loadReminderHistory() {
            const container = document.getElementById('reminderHistory');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders/history/default_user?limit=20`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach(record => {
                    const typeEmoji = {
                        'time': 'â°',
                        'weather': 'ğŸŒ¤ï¸',
                        'behavior': 'ğŸ‘¤',
                        'habit': 'ğŸ¯'
                    };

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                ${typeEmoji[record.reminder_type] || 'ğŸ“Œ'} ${record.title || 'æ— æ ‡é¢˜'}
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                ${record.content}
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                è§¦å‘æ—¶é—´: ${new Date(record.triggered_at).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºæé†’å¯¹è¯æ¡†
        function showCreateReminderDialog() {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="reminderDialog">
                    <div style="background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">â• åˆ›å»ºæ–°æé†’</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡é¢˜:</label>
                            <input type="text" id="reminderTitle" placeholder="ä¾‹å¦‚ï¼šå›¢é˜Ÿä¼šè®®" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å†…å®¹:</label>
                            <textarea id="reminderContent" placeholder="æé†’çš„è¯¦ç»†å†…å®¹..." rows="3"
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">è§¦å‘æ—¶é—´:</label>
                            <input type="datetime-local" id="reminderTime" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¼˜å…ˆçº§:</label>
                            <select id="reminderPriority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="1">ğŸ”´ æœ€é«˜</option>
                                <option value="2">ğŸŸ  é«˜</option>
                                <option value="3" selected>ğŸŸ¡ ä¸­</option>
                                <option value="4">ğŸŸ¢ ä½</option>
                                <option value="5">âšª æœ€ä½</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button onclick="closeReminderDialog()" 
                                style="padding: 10px 20px; background: #9ca3af; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                            <button onclick="createReminder()" 
                                style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                åˆ›å»º
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialog);
        }

        function closeReminderDialog() {
            const dialog = document.getElementById('reminderDialog');
            if (dialog) dialog.remove();
        }

        // åˆ›å»ºæé†’
        async function createReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const content = document.getElementById('reminderContent').value.trim();
            const time = document.getElementById('reminderTime').value;
            const priority = parseInt(document.getElementById('reminderPriority').value);

            if (!content) {
                alert('è¯·è¾“å…¥æé†’å†…å®¹');
                return;
            }

            if (!time) {
                alert('è¯·é€‰æ‹©è§¦å‘æ—¶é—´');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        reminder_type: 'time',
                        trigger_condition: { datetime: time.replace('T', ' ') + ':00' },
                        title: title || 'æ–°æé†’',
                        content: content,
                        priority: priority,
                        repeat: false
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeReminderDialog();
                    loadReminders();
                    alert('âœ… æé†’åˆ›å»ºæˆåŠŸï¼');
                } else {
                    alert('âŒ åˆ›å»ºå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢æé†’çŠ¶æ€
        async function toggleReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤æé†’
        async function deleteReminder(reminderId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æé†’å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç«‹å³æ£€æŸ¥æé†’
        async function checkReminders() {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'default_user' })
                });

                const data = await response.json();

                if (data.triggered && data.triggered.length > 0) {
                    alert(`âœ… æ£€æŸ¥å®Œæˆï¼è§¦å‘äº† ${data.triggered.length} æ¡æé†’`);
                    loadReminderHistory();
                } else {
                    alert('âœ… æ£€æŸ¥å®Œæˆï¼å½“å‰æ²¡æœ‰éœ€è¦è§¦å‘çš„æé†’');
                }
            } catch (error) {
                alert('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // ============ æé†’ç®¡ç†åŠŸèƒ½ç»“æŸ ============

        // ============ WebSocketå®æ—¶æ¨é€ ============
        let ws = null;
        let wsReconnectTimer = null;
        let unreadReminderCount = 0;

        function connectWebSocket() {
            try {
                // å»ºç«‹WebSocketè¿æ¥
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('âœ… WebSocketå·²è¿æ¥');
                    clearTimeout(wsReconnectTimer);

                    // å‘é€å¿ƒè·³
                    setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send('ping');
                        }
                    }, 30000); // æ¯30ç§’å‘é€å¿ƒè·³
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'reminder') {
                            // æ”¶åˆ°æé†’æ¨é€
                            handleReminderPush(message.data);
                        } else if (message.type === 'proactive_chat') {
                            // æ”¶åˆ°ä¸»åŠ¨å¯¹è¯æ¨é€
                            handleProactiveChatPush(message);
                        } else if (message.type === 'pong') {
                            // å¿ƒè·³å“åº”
                            console.log('å¿ƒè·³å“åº”');
                        }
                    } catch (error) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                };

                ws.onclose = () => {
                    console.log('âŒ WebSocketå·²æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
                    wsReconnectTimer = setTimeout(connectWebSocket, 5000);
                };

            } catch (error) {
                console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                wsReconnectTimer = setTimeout(connectWebSocket, 5000);
            }
        }

        function handleReminderPush(reminder) {
            console.log('æ”¶åˆ°æé†’æ¨é€:', reminder);

            // æ’­æ”¾æç¤ºéŸ³
            playReminderSound();

            // å¢åŠ æœªè¯»è®¡æ•°
            unreadReminderCount++;
            updateReminderBadge();

            // æ˜¾ç¤ºæé†’å¼¹çª—
            showReminderNotification(reminder);

            // å¦‚æœé¡µé¢ä¸åœ¨å‰å°ï¼Œå‘é€æµè§ˆå™¨é€šçŸ¥
            if (document.hidden) {
                sendBrowserNotification(reminder);
            }

            // åˆ·æ–°æé†’åˆ—è¡¨
            if (document.getElementById('reminders').style.display !== 'none') {
                loadReminders();
            }
        }

        // æ’­æ”¾æé†’å£°éŸ³
        function playReminderSound() {
            try {
                // ç”¨æˆ·äº¤äº’æ£€æµ‹å’ŒWeb Audio APIæ”¯æŒ
                if (typeof window.AudioContext !== "function" && typeof window.webkitAudioContext !== "function") {
                    // ä¸æ”¯æŒWeb Audio APIï¼Œå›é€€åˆ°éŸ³é¢‘æ–‡ä»¶
                    const audio = new Audio('/static/sounds/dingdong.mp3');
                    audio.volume = 0.8;
                    audio.play().catch(e => {
                        console.warn('å¤‡ç”¨éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                    });
                    return;
                }

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // åˆ›å»ºéœ‡è¡å™¨ï¼ˆç”Ÿæˆå£°éŸ³ï¼‰
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                // é‡Šæ”¾èµ„æº
                oscillator.onended = () => {
                    audioContext.close();
                };

                // ç¬¬äºŒå£°ï¼ˆåŒå“ï¼‰
                setTimeout(() => {
                    const audioContext2 = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator2 = audioContext2.createOscillator();
                    const gainNode2 = audioContext2.createGain();

                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext2.destination);

                    oscillator2.type = 'sine';
                    oscillator2.frequency.setValueAtTime(1000, audioContext2.currentTime);

                    gainNode2.gain.setValueAtTime(0, audioContext2.currentTime);
                    gainNode2.gain.linearRampToValueAtTime(0.3, audioContext2.currentTime + 0.1);
                    gainNode2.gain.linearRampToValueAtTime(0, audioContext2.currentTime + 0.5);

                    oscillator2.start(audioContext2.currentTime);
                    oscillator2.stop(audioContext2.currentTime + 0.5);

                    oscillator2.onended = () => {
                        audioContext2.close();
                    };
                }, 200);

            } catch (error) {
                // å›é€€åˆ°éŸ³é¢‘æ–‡ä»¶
                const audio = new Audio('/static/sounds/dingdong.mp3');
                audio.volume = 0.8;
                audio.play().catch(e => {
                    console.warn('å¤‡ç”¨éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                });
                console.error('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
            }
        }

        function showReminderNotification(reminder) {
            // åˆ›å»ºæé†’å¼¹çª—
            const notification = document.createElement('div');
            notification.className = 'reminder-notification';
            notification.id = `reminder-notif-${reminder.reminder_id}`;

            const priorityEmoji = { 1: 'ğŸ”´', 2: 'ğŸŸ ', 3: 'ğŸŸ¡', 4: 'ğŸŸ¢', 5: 'âšª' };
            const emoji = priorityEmoji[reminder.priority] || 'ğŸ””';

            notification.innerHTML = `
                <div class="reminder-notification-content">
                    <div class="reminder-notification-header">
                        <span class="reminder-notification-icon">${emoji}</span>
                        <span class="reminder-notification-title">${reminder.title || 'æé†’'}</span>
                        <button class="reminder-notification-close" onclick="closeReminderNotif(${reminder.reminder_id})">âœ•</button>
                    </div>
                    <div class="reminder-notification-body">
                        ${reminder.content}
                    </div>
                    <div class="reminder-notification-actions">
                        <button onclick="handleReminderRead(${reminder.reminder_id})">
                            âœ… å·²çŸ¥é“
                        </button>
                        <button onclick="handleReminderSnooze(${reminder.reminder_id})">
                            â° ç¨åæé†’
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 30ç§’åè‡ªåŠ¨æ·¡å‡ºï¼ˆç»™ç”¨æˆ·æ›´å¤šæ—¶é—´æŸ¥çœ‹ï¼‰
            setTimeout(() => {
                if (document.getElementById(`reminder-notif-${reminder.reminder_id}`)) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 30000);
        }

        // å…³é—­æé†’é€šçŸ¥
        function closeReminderNotif(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (notif) {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }
        }

        // å¤„ç†"å·²çŸ¥é“"
        async function handleReminderRead(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;

            // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #10b981;">âœ… å·²æ ‡è®°ä¸ºå·²è¯»</span>';

            // æ ‡è®°å·²è¯»
            markReminderAsRead(reminderId);

            // 1ç§’åå…³é—­
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        // å¤„ç†"ç¨åæé†’"
        async function handleReminderSnooze(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;

            // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #f59e0b;">â° æ­£åœ¨å»¶è¿Ÿ...</span>';

            // æ‰§è¡Œå»¶è¿Ÿæ“ä½œ
            await snoozeReminder(reminderId, 5);

            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            actionsDiv.innerHTML = '<span style="color: #10b981;">âœ… å·²å»¶è¿Ÿ5åˆ†é’Ÿ</span>';

            // 1ç§’åå…³é—­
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        function sendBrowserNotification(reminder) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(reminder.title || 'å°ä¹æé†’', {
                    body: reminder.content,
                    icon: '/static/favicon.ico',
                    tag: `reminder-${reminder.reminder_id}`,
                    requireInteraction: false
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        function updateReminderBadge() {
            // æ›´æ–°æé†’æ•°é‡çº¢ç‚¹ï¼ˆåç»­å®ç°ï¼‰
            console.log(`æœªè¯»æé†’: ${unreadReminderCount}`);
        }

        function markReminderAsRead(reminderId) {
            // æ ‡è®°æé†’å·²è¯»ï¼ˆåç»­å¯æ‰©å±•ï¼‰
            unreadReminderCount = Math.max(0, unreadReminderCount - 1);
            updateReminderBadge();
        }

        // å»¶è¿Ÿæé†’ï¼ˆç¨åæé†’ï¼‰
        async function snoozeReminder(reminderId, minutes = 5) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/snooze?minutes=${minutes}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`âœ… æé†’å·²å»¶è¿Ÿ ${minutes} åˆ†é’Ÿï¼Œæ–°è§¦å‘æ—¶é—´: ${data.new_trigger_time}`);

                    // æ˜¾ç¤ºæç¤º
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
                    toast.textContent = `â° æé†’å·²å»¶è¿Ÿ ${minutes} åˆ†é’Ÿ`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s';
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);

                    // åˆ·æ–°æé†’åˆ—è¡¨
                    if (document.getElementById('reminders').style.display !== 'none') {
                        loadReminders();
                    }
                } else {
                    console.error('âŒ å»¶è¿Ÿæé†’å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('âŒ å»¶è¿Ÿæé†’å¤±è´¥:', error);
            }
        }

        // è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('é€šçŸ¥æƒé™:', permission);
                });
            }
        }

        // ============ ä¸»åŠ¨å¯¹è¯å¤„ç† ============

        function handleProactiveChatPush(message) {
            console.log('æ”¶åˆ°ä¸»åŠ¨å¯¹è¯æ¨é€:', message);

            // æ’­æ”¾æŸ”å’Œçš„æç¤ºéŸ³ï¼ˆä¸åŒäºæé†’çš„å£°éŸ³ï¼‰
            playProactiveChatSound();

            // æ˜¾ç¤ºä¸»åŠ¨å¯¹è¯é€šçŸ¥
            showProactiveChatNotification(message);

            // å¦‚æœé¡µé¢ä¸åœ¨å‰å°ï¼Œå‘é€æµè§ˆå™¨é€šçŸ¥
            if (document.hidden) {
                sendProactiveChatBrowserNotification(message);
            }
        }

        function playProactiveChatSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // æ›´æŸ”å’Œçš„éŸ³è°ƒï¼ˆ600Hzï¼‰
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);

                // æ¸å˜éŸ³é‡
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.15);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.error('æ’­æ”¾ä¸»åŠ¨å¯¹è¯æç¤ºéŸ³å¤±è´¥:', error);
            }
        }

        function showProactiveChatNotification(message) {
            // åˆ›å»ºä¸»åŠ¨å¯¹è¯é€šçŸ¥å¡ç‰‡
            const notification = document.createElement('div');
            notification.className = 'proactive-chat-notification';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                max-width: 400px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;

            const reasonEmoji = {
                'pending_question': 'ğŸ¤”',
                'long_inactive': 'ğŸ‘‹',
                'moderate_inactive': 'ğŸ’­',
                'active_time': 'â°',
                'interesting_topic': 'ğŸ’¡'
            };

            const emoji = reasonEmoji[message.reason] || 'ğŸ’¬';

            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 32px;">${emoji}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">
                            å°ä¹æƒ³å’Œä½ èŠèŠï½
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
                            ${message.message}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="respondToProactiveChat('${message.reason}')" 
                                style="flex: 1; background: white; color: #667eea; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                ğŸ’¬ å»èŠå¤©
                            </button>
                            <button onclick="dismissProactiveChat(this)" 
                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                                ç¨å
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);
        }

        function respondToProactiveChat(reason) {
            // å…³é—­é€šçŸ¥
            const notification = document.querySelector('.proactive-chat-notification');
            if (notification) {
                notification.remove();
            }

            // åˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾
            switchTab('chat');

            // èšç„¦è¾“å…¥æ¡†
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // å¯ä»¥æ ¹æ®reasoné¢„å¡«å……ä¸€äº›å†…å®¹
            // messageInput.textContent = '';
        }

        function dismissProactiveChat(button) {
            const notification = button.closest('.proactive-chat-notification');
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }
        }

        function sendProactiveChatBrowserNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const reasonText = {
                    'pending_question': 'å…³äºä¹‹å‰çš„é—®é¢˜',
                    'long_inactive': 'å¥½ä¹…ä¸è§',
                    'moderate_inactive': 'æœ€è¿‘è¿˜å¥½å—',
                    'active_time': 'é—®å€™æ—¶é—´',
                    'interesting_topic': 'æœ‰è¶£çš„è¯é¢˜'
                };

                new Notification('å°ä¹æƒ³å’Œä½ èŠèŠ', {
                    body: message.message,
                    icon: '/static/icon.png',
                    tag: 'proactive-chat',
                    requireInteraction: false
                });
            }
        }

        // æ˜¾ç¤ºè¿½é—®æç¤º
        function showFollowupSuggestion(followupInfo) {
            // åˆ›å»ºè¿½é—®æç¤ºå¡ç‰‡
            const notification = document.createElement('div');
            notification.className = 'followup-suggestion';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                max-width: 500px;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 18px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(245, 87, 108, 0.4);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
                cursor: pointer;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">ğŸ¤”</div>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">
                            ğŸ’¡ å°ä¹æœ‰ä¸ªç–‘é—®
                        </div>
                        <div style="font-size: 15px; font-weight: 500; line-height: 1.5;">
                            ${followupInfo.followup}
                        </div>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        ç‚¹å‡»å›ç­”
                    </div>
                </div>
            `;

            // ç‚¹å‡»å‘é€è¿½é—®
            notification.onclick = async () => {
                notification.remove();

                // è‡ªåŠ¨å‘é€è¿½é—®ä½œä¸ºç”¨æˆ·æ¶ˆæ¯
                const input = document.getElementById('messageInput');
                input.textContent = followupInfo.followup;

                // å‘é€æ¶ˆæ¯
                await sendMessageFromDiv();

                // æ ‡è®°è¿½é—®å·²å‘é€
                try {
                    await fetch(`${API_BASE}/proactive/mark_asked/${followupInfo.id}`, {
                        method: 'POST'
                    });
                    // åˆ·æ–°ä¸»åŠ¨é—®ç­”åˆ—è¡¨
                    loadProactiveQA('default_user');
                } catch (error) {
                    console.error('æ ‡è®°è¿½é—®å¤±è´¥:', error);
                }
            };

            document.body.appendChild(notification);

            // æ’­æ”¾æç¤ºéŸ³
            playFollowupSound();

            // 8ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutDown 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
        }

        // æ’­æ”¾è¿½é—®æç¤ºéŸ³
        function playFollowupSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;  // æ›´é«˜éŸ³è°ƒ
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (error) {
                console.error('æ’­æ”¾è¿½é—®æç¤ºéŸ³å¤±è´¥:', error);
            }
        }

        // ä»å†å²è®°å½•å‘é€è¿½é—®
        async function sendFollowupFromHistory(questionId, followupText, userId) {
            // è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
            const input = document.getElementById('messageInput');
            input.textContent = followupText;

            // å‘é€æ¶ˆæ¯
            await sendMessageFromDiv();

            // æ ‡è®°ä¸ºå·²è¿½é—®
            try {
                await fetch(`${API_BASE}/proactive/mark_asked/${questionId}`, {
                    method: 'POST'
                });
                // åˆ·æ–°ä¸»åŠ¨é—®ç­”åˆ—è¡¨
                setTimeout(() => loadProactiveQA(userId), 1000);
            } catch (error) {
                console.error('æ ‡è®°è¿½é—®å¤±è´¥:', error);
            }
        }

        // ============ WebSocketåŠŸèƒ½ç»“æŸ ============

        // ============ v0.6.0 å…¨å±€å¿«æ·é”®æ”¯æŒ ============

        // å…¨å±€å¿«æ·é”®ç›‘å¬
        document.addEventListener('keydown', (event) => {
            // æ£€æŸ¥å¿«æ·é”®æ˜¯å¦å¯ç”¨
            const settings = getSettings();
            if (!settings.keyboardShortcuts) {
                return; // å¿«æ·é”®å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const ctrlKey = isMac ? event.metaKey : event.ctrlKey;

            // Ctrl+Enter / Cmd+Enter: å‘é€æ¶ˆæ¯
            if (ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab && currentTab.id === 'chat') {
                    sendMessageFromDiv();
                }
                return;
            }

            // Esc: æ¸…ç©ºè¾“å…¥æ¡†
            if (event.key === 'Escape') {
                const messageInput = document.getElementById('messageInput');
                if (messageInput && document.activeElement === messageInput) {
                    event.preventDefault();
                    messageInput.textContent = '';
                    messageInput.focus();
                }
                return;
            }

            // Ctrl+K / Cmd+K: æ–°å»ºå¯¹è¯
            if (ctrlKey && event.key === 'k') {
                event.preventDefault();
                newChat();
                return;
            }

            // Ctrl+/ / Cmd+/: åˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾
            if (ctrlKey && event.key === '/') {
                event.preventDefault();
                const chatTab = document.querySelector('[onclick*="chat"]');
                if (chatTab) {
                    chatTab.click();
                }
                return;
            }

            // Ctrl+1-6 / Cmd+1-6: å¿«é€Ÿåˆ‡æ¢æ ‡ç­¾
            if (ctrlKey && event.key >= '1' && event.key <= '6') {
                event.preventDefault();
                const tabs = ['chat', 'sessions', 'memory', 'analytics', 'reminders', 'tools'];
                const tabIndex = parseInt(event.key) - 1;
                if (tabIndex < tabs.length) {
                    const tabButton = document.querySelector(`[onclick*="${tabs[tabIndex]}"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }
                return;
            }
        });

        // æ˜¾ç¤ºå¿«æ·é”®æç¤ºï¼ˆé¼ æ ‡æ‚¬åœåœ¨è¾“å…¥æ¡†æ—¶ï¼‰
        function showShortcutHints() {
            const messageInput = document.getElementById('messageInput');
            const hintsBar = document.getElementById('shortcutHints');
            if (!messageInput || !hintsBar) return;

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const cmdKey = isMac ? 'âŒ˜' : 'Ctrl';

            // æ›´æ–°Macç³»ç»Ÿçš„å¿«æ·é”®æ˜¾ç¤º
            if (isMac) {
                hintsBar.querySelectorAll('kbd').forEach(kbd => {
                    kbd.textContent = kbd.textContent.replace('Ctrl', 'âŒ˜');
                });
            }

            // è¾“å…¥æ¡†èšç„¦æ—¶æ˜¾ç¤ºæç¤ºæ 
            messageInput.addEventListener('focus', () => {
                hintsBar.style.opacity = '1';
            });

            // è¾“å…¥æ¡†å¤±ç„¦æ—¶éšè—æç¤ºæ ï¼ˆå»¶è¿Ÿéšè—ï¼‰
            messageInput.addEventListener('blur', () => {
                setTimeout(() => {
                    hintsBar.style.opacity = '0';
                }, 2000);
            });

            // é¡µé¢åŠ è½½å3ç§’æ˜¾ç¤ºæç¤ºæ ï¼ˆé¦–æ¬¡æç¤ºï¼‰
            setTimeout(() => {
                hintsBar.style.opacity = '1';
                setTimeout(() => {
                    hintsBar.style.opacity = '0';
                }, 3000);
            }, 1000);
        }        // ============ å¿«æ·é”®åŠŸèƒ½ç»“æŸ ============

        // é¡µé¢åŠ è½½æ—¶èšç„¦è¾“å…¥æ¡†
        window.onload = () => {
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // æ˜¾ç¤ºå¿«æ·é”®æç¤º
            showShortcutHints();

            // Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessageFromDiv();
                }
            });

            // æœç´¢æ¡†å›è½¦æœç´¢
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchMemories();
                    }
                });
            }

            // å»ºç«‹WebSocketè¿æ¥
            connectWebSocket();

            // è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
            requestNotificationPermission();
        };

        // ========================================
        // v0.6.0 Phase 4: å›¾ç‰‡ä¸Šä¼ å’Œè¯†åˆ«åŠŸèƒ½
        // ========================================
        let uploadedImagePath = null;

        /**
         * è§¦å‘å›¾ç‰‡ä¸Šä¼ 
         */
        function triggerImageUpload() {
            document.getElementById('imageUpload').click();
        }

        /**
         * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
         */
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showNotification('âŒ ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (20MB)
            if (file.size > 20 * 1024 * 1024) {
                showNotification('âŒ æ–‡ä»¶è¿‡å¤§ï¼ˆæœ€å¤§20MBï¼‰', 'error');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            showNotification('ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');

            try {
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('file', file);

                // ä¸Šä¼ å›¾ç‰‡
                const response = await fetch('/api/vision/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    uploadedImagePath = result.file_path;
                    showNotification('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');

                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                    showImagePreview(file, result.file_path);
                } else {
                    showNotification(`âŒ ä¸Šä¼ å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('âŒ ä¸Šä¼ å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        /**
         * æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
         */
        function showImagePreview(file, filePath) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // åˆ›å»ºé¢„è§ˆå®¹å™¨
                const previewHtml = `
                    <div class="image-preview" id="imagePreview">
                        <div class="image-preview-header">
                            <span>ğŸ“· å·²ä¸Šä¼ å›¾ç‰‡</span>
                            <button onclick="removeImagePreview()" class="remove-btn">âœ•</button>
                        </div>
                        <img src="${e.target.result}" alt="é¢„è§ˆå›¾" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        <div class="image-preview-actions">
                            <button onclick="analyzeUploadedImage()" class="analyze-btn">ğŸ” è¯†åˆ«å›¾ç‰‡</button>
                        </div>
                    </div>
                `;

                // æ’å…¥åˆ°è¾“å…¥æ¡†ä¸Šæ–¹
                const inputContainer = document.querySelector('.input-container');
                const existing = document.getElementById('imagePreview');
                if (existing) {
                    existing.remove();
                }
                inputContainer.insertAdjacentHTML('beforebegin', previewHtml);
            };
            reader.readAsDataURL(file);
        }

        /**
         * ç§»é™¤å›¾ç‰‡é¢„è§ˆ
         */
        function removeImagePreview() {
            const preview = document.getElementById('imagePreview');
            if (preview) {
                preview.remove();
            }
            uploadedImagePath = null;
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        /**
         * åˆ†æä¸Šä¼ çš„å›¾ç‰‡
         */
        async function analyzeUploadedImage() {
            if (!uploadedImagePath) {
                showNotification('âŒ æ²¡æœ‰ä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }

            showNotification('ğŸ” æ­£åœ¨åˆ†æå›¾ç‰‡...', 'info');

            try {
                const response = await fetch('/api/vision/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_path: uploadedImagePath,
                        prompt: 'è¯·è¯¦ç»†æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // åœ¨èŠå¤©ä¸­æ˜¾ç¤ºåˆ†æç»“æœ
                    addMessage('assistant', `ğŸ“· **å›¾ç‰‡åˆ†æç»“æœï¼š**\n\n${result.description}\n\n_ä½¿ç”¨æ¨¡å‹: ${result.model}_`);
                    showNotification('âœ… å›¾ç‰‡è¯†åˆ«å®Œæˆ', 'success');
                    
                    // æ¸…ç†é¢„è§ˆ
                    removeImagePreview();
                } else {
                    showNotification(`âŒ è¯†åˆ«å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Analyze error:', error);
                showNotification('âŒ è¯†åˆ«å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
        }
    </script>
</body>

</html>