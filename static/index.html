<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小乐 AI 管家 v0.8.0</title>
    <style>
        /* CSS 变量 - 亮色主题 */
        :root {
            --bg-gradient-start: #10a37f;
            --bg-gradient-end: #10a37f;
            --container-bg: #ffffff;
            --text-primary: #2d333a;
            --text-secondary: #676b79;
            --text-tertiary: #acacbe;
            --border-color: #ececf1;
            --tab-bg: #ffffff;
            --tab-hover: #f7f7f8;
            --tab-active-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --button-gradient-start: #10a37f;
            --button-gradient-end: #10a37f;
            --message-user-bg: #f4f4f4;
            --message-ai-bg: #f7f7f8;
            --message-ai-text: #2d333a;
            --shadow-light: rgba(0, 0, 0, 0.02);
            --shadow-medium: rgba(0, 0, 0, 0.05);
            --shadow-heavy: rgba(0, 0, 0, 0.08);
            --card-bg: #ffffff;
            --card-border: #ececf1;
            --code-bg: #f4f4f4;
            --code-text: #2d333a;
            --success-bg: #d1fae5;
            --success-border: #10a37f;
            --warning-bg: #fef3c7;
            --warning-border: #f59e0b;
            --info-bg: #e0e7ff;
            --info-border: #6366f1;
            --danger-bg: #fee2e2;
            --danger-border: #ef4444;
        }

        /* 暗色主题 */
        [data-theme="dark"] {
            --bg-gradient-start: #10a37f;
            --bg-gradient-end: #10a37f;
            --container-bg: #212121;
            --text-primary: #ececf1;
            --text-secondary: #c5c5d2;
            --text-tertiary: #8e8ea0;
            --border-color: #2f2f2f;
            --tab-bg: #212121;
            --tab-hover: #2f2f2f;
            --tab-active-bg: #212121;
            --input-bg: #2f2f2f;
            --input-border: #4d4d4f;
            --button-gradient-start: #10a37f;
            --button-gradient-end: #10a37f;
            --message-user-bg: #2f2f2f;
            --message-ai-bg: #444654;
            --message-ai-text: #ececf1;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --shadow-heavy: rgba(0, 0, 0, 0.3);
            --card-bg: #2f2f2f;
            --card-border: #4d4d4f;
            --code-bg: #1a1a1a;
            --code-text: #ececf1;
            --success-bg: #1a4d2e;
            --success-border: #10a37f;
            --warning-bg: #4d3800;
            --warning-border: #f59e0b;
            --info-bg: #1e3a8a;
            --info-border: #6366f1;
            --danger-bg: #4d1a1a;
            --danger-border: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--container-bg);
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .app-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.2s ease;
            z-index: 100;
        }

        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            border-right: none;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-logo {
            font-size: 18px;
            font-weight: 600;
            color: var(--button-gradient-start);
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--container-bg);
            overflow: hidden;
        }

        /* 保留旧的container类用于兼容 */
        .container {
            background: var(--container-bg);
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .top-bar {
            height: 60px;
            padding: 0 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 18px;
        }

        .menu-toggle:hover {
            background: var(--tab-hover);
        }

        .new-chat-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .new-chat-btn:hover {
            background: var(--tab-hover);
            border-color: var(--button-gradient-start);
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .theme-toggle {
            cursor: pointer;
            background: transparent;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .theme-toggle:hover {
            background: var(--tab-hover);
        }

        /* 兼容旧的header样式 */
        .header {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* 侧边栏导航 */
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
            transition: all 0.15s;
        }

        .nav-item:hover {
            background: var(--tab-hover);
        }

        .nav-item.active {
            background: var(--tab-hover);
            color: var(--button-gradient-start);
        }

        .nav-icon {
            font-size: 16px;
            width: 18px;
            text-align: center;
        }

        /* 旧的tab样式保留用于兼容 */
        .tabs {
            display: none;
            /* 隐藏旧的tabs */
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* 会话信息栏 */
        .session-info {
            background: var(--button-gradient-start);
            color: white;
            padding: 12px 20px;
        }

        .session-title-display {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* 聊天界面 */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 32px 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
            position: relative;
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 16px;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            transition: all 0.2s ease;
            position: relative;
            line-height: 1.6;
            font-size: 15px;
        }

        .message-image {
            margin-bottom: 10px;
        }

        .message-image img {
            display: block;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            max-width: 100%;
        }

        .message.user .message-content {
            background: var(--message-user-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* 消息操作按钮 v0.6.0 */
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .message-actions:hover {
            opacity: 1;
        }

        /* AI消息的操作按钮位置 */
        .message-actions.ai-actions {
            justify-content: flex-start;
        }

        .message.user .message-actions {
            justify-content: flex-end;
        }

        .message-action-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            transition: all 0.2s;
            padding: 0;
        }

        .message-action-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .message-action-btn.edit:hover {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .message-action-btn.speak:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .message-action-btn.good:hover {
            background: #fbbf24;
            color: white;
            border-color: #fbbf24;
        }

        .message-action-btn.bad:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .message-action-btn.delete:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .message-action-btn.copy:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* 编辑状态标识 */
        .editing-indicator {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFA726;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInUp 0.3s;
        }

        .editing-indicator button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .editing-indicator button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .message.search-highlight {
            background: rgba(255, 235, 59, 0.2);
            border-left: 3px solid #FFC107;
            animation: highlightPulse 0.5s ease-in-out;
        }

        @keyframes highlightPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .message .search-match {
            background: #FFEB3B;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .message.ai .message-content {
            background: var(--message-ai-bg);
            color: var(--message-ai-text);
        }

        .message-content code {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.9em;
        }

        .message.assistant .message-content {
            background: var(--message-ai-bg);
            color: var(--message-ai-text);
        }

        /* Markdown 样式 */
        .message.assistant .message-content p {
            margin: 0.5em 0;
        }

        .message.assistant .message-content strong {
            color: var(--button-gradient-start);
            font-weight: bold;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 0.5em 0;
            padding-left: 20px;
        }

        .message.assistant .message-content li {
            margin: 0.3em 0;
        }

        .message.assistant .message-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--code-text);
        }

        .message.assistant .message-content pre {
            background: var(--code-bg);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .message.assistant .message-content blockquote {
            border-left: 3px solid var(--button-gradient-start);
            padding-left: 10px;
            margin: 0.5em 0;
            color: var(--text-secondary);
        }

        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin: 0.8em 0 0.4em 0;
            color: var(--button-gradient-start);
        }

        .input-container {
            padding: 20px 32px;
            background: var(--container-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            transition: background 0.3s ease, border-color 0.3s ease;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        #messageInput {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            line-height: 1.5;
            resize: none;
        }

        #messageInput:focus {
            border-color: var(--button-gradient-start);
            outline: none;
        }

        #messageInput:empty:before {
            content: attr(data-placeholder);
            color: var(--text-tertiary);
        }

        #messageInput:focus:before {
            content: none;
        }

        button {
            padding: 10px 16px;
            background: var(--button-gradient-start);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            opacity: 0.8;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 会话列表 */
        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }

        .session-item {
            background: var(--card-bg);
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
            position: relative;
        }

        .session-item:hover {
            background: var(--tab-hover);
            border-color: var(--border-color);
        }

        .session-item:hover .session-actions {
            opacity: 1;
            pointer-events: all;
        }

        .session-item.active {
            border-left: 4px solid var(--button-gradient-start);
            background: var(--input-bg);
        }

        /* 会话操作按钮 */
        .session-actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .session-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            background: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .session-action-btn:hover {
            transform: scale(1.1);
        }

        .session-action-btn.export-md {
            color: #10b981;
            border: 2px solid #10b981;
        }

        .session-action-btn.export-md:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .session-action-btn.export-json {
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }

        .session-action-btn.export-json:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .session-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* 记忆查看 */
        .memory-container {
            flex: 1;
            overflow-y: auto;
            background: var(--container-bg);
            transition: background 0.3s ease;
            padding: 20px;
        }

        .stats-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--input-bg);
            border-radius: 8px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--button-gradient-start);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .memory-item {
            background: var(--card-bg);
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        .memory-content {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .memory-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        .error {
            background: var(--message-ai-bg);
            color: #ff6b6b;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px;
            border: 1px solid #ff6b6b;
        }

        /* WebSocket提醒弹窗样式 */
        .reminder-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-heavy);
            z-index: 10000;
            animation: slideIn 0.25s ease-out;
            border: 1px solid var(--card-border);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .reminder-notification-content {
            padding: 16px;
        }

        .reminder-notification-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reminder-notification-icon {
            font-size: 24px;
        }

        .reminder-notification-title {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .reminder-notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .reminder-notification-close:hover {
            background: var(--tab-hover);
        }

        .reminder-notification-body {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reminder-notification-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reminder-notification-actions button {
            padding: 6px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reminder-notification-actions button:first-child {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .reminder-notification-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 主动对话动画 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* 追问提示动画 */
        @keyframes slideInUp {
            from {
                transform: translate(-50%, 20px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* 反馈标记动画 */
        @keyframes fadeInDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutDown {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }

            to {
                transform: translate(-50%, 20px);
                opacity: 0;
            }
        }

        /* 设置面板样式 v0.6.0 */
        .settings-section {
            margin: 25px 0;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--button-gradient-start);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .setting-select {
            padding: 8px 15px;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .setting-select:hover {
            border-color: var(--button-gradient-start);
        }

        .setting-select:focus {
            border-color: var(--button-gradient-start);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 开关按钮样式 */
        .setting-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .setting-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .setting-switch input:checked+.switch-slider {
            background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
        }

        .setting-switch input:checked+.switch-slider:before {
            transform: translateX(24px);
        }

        /* v0.6.0 Phase 4: 图片上传功能 */
        .upload-image-btn {
            background: var(--button-gradient-start);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .upload-image-btn:hover {
            opacity: 0.9;
        }

        /* v0.8.0 语音输入功能 */
        .voice-input-btn {
            background: var(--button-gradient-start);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .voice-input-btn:hover {
            opacity: 0.9;
        }

        .voice-input-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* 连续对话模式按钮 */
        .conversation-mode-btn {
            background: var(--button-gradient-start);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .conversation-mode-btn:hover {
            opacity: 0.9;
        }

        .conversation-mode-btn.active {
            background: #0ea5e9;
            animation: breathe 2s ease-in-out infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(79, 172, 254, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(79, 172, 254, 0);
            }
        }

        /* 连续对话状态指示器 */
        .conversation-mode-status {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(79, 172, 254, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 999;
            text-align: center;
        }

        .conversation-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .conversation-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        #conversationHint {
            font-size: 12px;
            opacity: 0.9;
        }

        /* 停止语音按钮 */
        .stop-speaking-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .stop-speaking-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .stop-speaking-btn:active {
            transform: scale(0.95);
        }

        /* 全局停止语音按钮 */
        .global-stop-speaking {
            position: fixed;
            bottom: 150px;
            right: 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            animation: shake 0.5s ease-in-out infinite;
        }

        .global-stop-speaking:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }

        .global-stop-speaking:active {
            transform: scale(0.95);
        }

        .global-stop-speaking span:first-child {
            font-size: 20px;
        }

        .stop-text {
            font-weight: 600;
            font-size: 14px;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-3px);
            }

            75% {
                transform: translateX(3px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(245, 87, 108, 0);
            }
        }

        .voice-status {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(245, 87, 108, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .voice-wave span {
            width: 3px;
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) {
            animation-delay: 0s;
        }

        .voice-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .voice-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .voice-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .voice-wave span:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes wave {

            0%,
            100% {
                height: 30%;
            }

            50% {
                height: 100%;
            }
        }

        .voice-status #voiceText {
            font-size: 14px;
            font-weight: 500;
        }

        /* 语音播放状态样式 */
        .speaking-status {
            position: fixed;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        .speaking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speaking-icon {
            font-size: 20px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .speaking-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .speaking-wave span {
            display: inline-block;
            width: 3px;
            background: white;
            border-radius: 3px;
            animation: speakWave 1s ease-in-out infinite;
        }

        .speaking-wave span:nth-child(1) {
            animation-delay: 0s;
        }

        .speaking-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .speaking-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .speaking-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        @keyframes speakWave {

            0%,
            100% {
                height: 30%;
            }

            50% {
                height: 100%;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .speaking-status #speakingText {
            font-size: 14px;
            font-weight: 500;
        }

        .image-preview {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
        }

        .image-preview-actions {
            display: flex;
            gap: 8px;
        }

        /* v0.8.0 任务管理样式 */
        .task-card {
            background: var(--card-bg);
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            border: 1px solid var(--card-border);
            border-left: 3px solid #667eea;
        }

        .task-card:hover {
            border-color: var(--button-gradient-start);
        }

        .task-card.status-pending {
            border-left-color: #f59e0b;
        }

        .task-card.status-in_progress {
            border-left-color: #3b82f6;
        }

        .task-card.status-completed {
            border-left-color: #10b981;
        }

        .task-card.status-failed {
            border-left-color: #ef4444;
        }

        .task-card.status-cancelled {
            border-left-color: #6b7280;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .task-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .task-status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .task-status-badge.in_progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .task-status-badge.waiting {
            background: #e0e7ff;
            color: #3730a3;
        }

        .task-status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .task-status-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .task-status-badge.cancelled {
            background: #f3f4f6;
            color: #374151;
        }

        .task-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .task-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .task-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--input-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .task-progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            min-width: 50px;
            text-align: right;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .task-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-btn-primary {
            background: #667eea;
            color: white;
        }

        .task-btn-primary:hover {
            background: #5568d3;
        }

        .task-btn-success {
            background: #10b981;
            color: white;
        }

        .task-btn-success:hover {
            background: #059669;
        }

        .task-btn-danger {
            background: #ef4444;
            color: white;
        }

        .task-btn-danger:hover {
            background: #dc2626;
        }

        .task-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .task-btn-secondary:hover {
            background: #4b5563;
        }

        .task-step {
            background: var(--input-bg);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #cbd5e1;
        }

        .task-step.completed {
            border-left-color: #10b981;
            opacity: 0.7;
        }

        .task-step.failed {
            border-left-color: #ef4444;
        }

        .task-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .task-step-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .task-step-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 8px;
            background: var(--card-bg);
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-0 {
            background: #f3f4f6;
            color: #6b7280;
        }

        .priority-1 {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-2 {
            background: #fee2e2;
            color: #991b1b;
        }

        /* 图片查看器模态框 */
        .image-viewer-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            animation: fadeIn 0.2s;
        }

        .image-viewer-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            animation: zoomIn 0.3s;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .image-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .image-viewer-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .message-image img {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .message-image img:hover {
            opacity: 0.95;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                max-width: 100%;
                width: 100%;
                border-radius: 0;
                box-shadow: none;
                height: 100vh;
            }

            header {
                padding: 12px 16px;
                border-radius: 0;
            }

            header h1 {
                font-size: 18px;
            }

            .tabs {
                padding: 0 8px;
            }

            .tab {
                padding: 10px 8px;
                font-size: 13px;
            }

            .chat-container {
                padding: 16px;
            }

            .message-content {
                max-width: 85%;
                padding: 12px 14px;
                font-size: 14px;
            }

            .input-container {
                padding: 12px;
                gap: 8px;
            }

            #messageInput {
                font-size: 15px;
            }

            button {
                padding: 8px 12px;
                font-size: 14px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .stat-item {
                padding: 10px;
            }

            .stat-number {
                font-size: 22px;
            }

            .session-actions {
                opacity: 1;
                position: relative;
                right: 0;
                transform: none;
            }

            .reminder-notification {
                left: 10px;
                right: 10px;
                width: auto;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .message-actions {
                flex-wrap: wrap;
                gap: 4px;
            }

            .message-action-btn {
                width: 24px;
                height: 24px;
                font-size: 13px;
            }
        }
    </style>
    <!-- Markdown 解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <!-- 图片查看器模态框 -->
    <div id="imageViewerModal" class="image-viewer-modal" onclick="closeImageViewer(event)">
        <div class="image-viewer-content">
            <button class="image-viewer-close" onclick="closeImageViewer(event)" title="关闭 (ESC)">✕</button>
            <img id="imageViewerImg" src="" alt="查看图片">
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="切换主题">
                <span id="themeIcon">🌙</span>
            </button>
            <div class="header-title">
                🤖 小乐 AI 管家
                <span style="font-size: 12px; opacity: 0.8; margin-left: 10px;">v0.8.0</span>
            </div>
            <div style="width: 40px;"></div> <!-- 占位保持居中 -->
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat', event)">💬 聊天</div>
            <div class="tab" onclick="switchTab('sessions', event)">📋 会话</div>
            <div class="tab" onclick="switchTab('memory', event)">🧠 记忆</div>
            <!-- <div class="tab" onclick="switchTab('analytics', event)">📊 行为分析</div> -->
            <div class="tab" onclick="switchTab('tasks', event)">✅ 任务</div>
            <div class="tab" onclick="switchTab('reminders', event)">🔔 提醒</div>
            <div class="tab" onclick="switchTab('documents', event)">📄 文档总结</div>
            <div class="tab" onclick="switchTab('schedule', event)">📅 课程表</div>
            <div class="tab" onclick="switchTab('tools', event)">🔧 工具管理</div>
            <div class="tab" onclick="switchTab('settings', event)">⚙️ 设置</div>
        </div>

        <!-- 聊天界面 -->
        <div id="chat" class="tab-content active">
            <div id="sessionInfo" class="session-info" style="display: none;">
                <div class="session-title-display">💬 <span id="currentSessionTitle"></span></div>
            </div>
            <div class="chat-container" id="chatContainer"></div>
            <!-- 图片上传输入（隐藏） -->
            <input type="file" id="imageUpload" accept="image/*" style="display: none;"
                onchange="handleImageUpload(event)" onclick="console.log('📂 File input clicked')"
                oncancel="console.log('❌ File selection cancelled')">
            <div class="input-container">
                <button onclick="triggerImageUpload()" class="upload-image-btn" title="上传图片">📷</button>
                <button onclick="toggleVoiceInput()" class="voice-input-btn" id="voiceBtn"
                    title="语音输入（可打断AI）">🎤</button>
                <button onclick="toggleConversationMode()" class="conversation-mode-btn" id="conversationModeBtn"
                    title="连续对话模式">💬</button>
                <div id="messageInput" contenteditable="true" data-placeholder="输入消息（Enter发送，Shift+Enter换行）..."
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; min-height: 40px; max-height: 120px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">
                </div>
                <button onclick="sendMessageFromDiv()" id="sendBtn">发送</button>
                <button onclick="newChat()">新对话</button>
            </div>
            <!-- 全局停止语音按钮 -->
            <div id="globalStopSpeakingBtn" class="global-stop-speaking" style="display: none;" onclick="stopSpeaking()"
                title="停止语音播放（或点击录音按钮打断）">
                <span>🔇</span>
                <span class="stop-text">停止播放</span>
            </div>
            <!-- 连续对话模式状态 -->
            <div id="conversationModeStatus" class="conversation-mode-status" style="display: none;">
                <div class="conversation-indicator">
                    <span class="conversation-dot"></span>
                    <span id="conversationStateText">对话模式已开启</span>
                    <button onclick="stopSpeaking()" class="stop-speaking-btn" title="停止语音">🔇</button>
                </div>
                <span id="conversationHint">说完话后会自动识别并发送</span>
            </div>
            <!-- 语音识别状态提示 -->
            <div id="voiceStatus" class="voice-status" style="display: none;">
                <div class="voice-wave">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
                <span id="voiceText">正在聆听...</span>
            </div>
            <!-- 语音播放状态提示 -->
            <div id="speakingStatus" class="speaking-status" style="display: none;">
                <div class="speaking-indicator">
                    <span class="speaking-icon">🔊</span>
                    <div class="speaking-wave">
                        <span></span><span></span><span></span><span></span>
                    </div>
                </div>
                <span id="speakingText">正在播放...</span>
            </div>
        </div>

        <!-- 会话列表 -->
        <div id="sessions" class="tab-content">
            <div class="sessions-list" id="sessionsList">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 记忆查看 -->
        <div id="memory" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>📊 记忆统计
                        <span style="font-size: 12px; color: #667eea; font-weight: normal;">
                            v0.2.0 - 🧠 支持语义搜索
                        </span>
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <div class="loading">加载中...</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索记忆（支持语义理解）..."
                        style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px;">
                    <button onclick="searchMemories()">🔍 关键词</button>
                    <button onclick="semanticSearch()" title="支持自然语言查询，如'多大年纪'">🧠 语义</button>
                    <button onclick="loadRecentMemories()">📋 全部</button>
                </div>

                <div id="memoryList"></div>
            </div>
        </div>

        <!-- 行为分析 - 已隐藏，代码保留 -->
        <div id="analytics" class="tab-content" style="display: none !important;">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>📊 用户行为分析 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.3.0
                            Learning层</span></h3>
                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadBehaviorAnalytics()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">🔄
                            刷新数据</button>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()"
                                style="cursor: pointer;">
                            <span>自动刷新 (30秒)</span>
                        </label>
                        <span id="refreshStatus" style="font-size: 12px; color: #999;"></span>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">⏰ 活跃时间分布</h4>
                        <div id="activityPattern"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">点击"刷新数据"加载</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">💬 话题偏好</h4>
                        <div id="topicPreferences"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">点击"刷新数据"加载</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">📈 对话统计</h4>
                        <div id="behaviorStats"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">
                            <div class="loading">点击"刷新数据"加载</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #ff6b6b;">⚠️ 记忆冲突检测</h4>
                        <div id="conflictDetection"
                            style="background: #fff5f5; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #ff6b6b;">
                            <div class="loading">点击"刷新数据"加载</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #764ba2;">💡 主动问答历史</h4>
                        <div id="proactiveQA"
                            style="background: #f8f4ff; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #764ba2;">
                            <div class="loading">点击"刷新数据"加载</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #10b981;">🧠 学习模式</h4>
                        <div id="learningPatterns"
                            style="background: #f0fdf4; padding: 15px; border-radius: 10px; min-height: 100px; border: 1px solid #10b981;">
                            <div class="loading">点击"刷新数据"加载</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务管理 v0.8.0 -->
        <div id="tasks" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>✅ 任务管理 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.8.0 多轮任务规划</span>
                    </h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="loadTasks()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🔄 刷新
                        </button>
                        <button onclick="showCreateTaskDialog()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ➕ 创建任务
                        </button>
                        <select id="taskStatusFilter" onchange="loadTasks()"
                            style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <option value="">全部状态</option>
                            <option value="pending">待处理</option>
                            <option value="in_progress">执行中</option>
                            <option value="waiting">等待中</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>

                    <!-- 统计信息 -->
                    <div id="taskStats"
                        style="margin: 15px 0; display: flex; gap: 15px; font-size: 13px; flex-wrap: wrap;">
                        <span style="color: #f59e0b;">📋 待处理: <strong id="taskPendingCount">0</strong></span>
                        <span style="color: #3b82f6;">⚡ 执行中: <strong id="taskInProgressCount">0</strong></span>
                        <span style="color: #10b981;">✅ 已完成: <strong id="taskCompletedCount">0</strong></span>
                        <span style="color: #ef4444;">❌ 失败: <strong id="taskFailedCount">0</strong></span>
                    </div>

                    <!-- 任务列表 -->
                    <div style="margin: 20px 0;">
                        <div id="tasksList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">正在加载任务...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提醒管理 v0.5.0 -->
        <div id="reminders" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>🔔 提醒管理 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.5.0
                            Active Perception层</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="loadReminders()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🔄 刷新
                        </button>
                        <button onclick="showCreateReminderDialog()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ➕ 创建提醒
                        </button>
                        <button onclick="toggleExpiredReminders()"
                            style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <span id="toggleExpiredBtn">�️ 显示已过期</span>
                        </button>
                        <button onclick="checkReminders()"
                            style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            � 立即检查
                        </button>
                    </div>

                    <!-- 统计信息 -->
                    <div id="reminderStats" style="margin: 15px 0; display: flex; gap: 15px; font-size: 13px;">
                        <span style="color: #10b981;">✅ 活跃: <strong id="activeCount">0</strong></span>
                        <span style="color: #999;">⏸️ 已禁用: <strong id="disabledCount">0</strong></span>
                        <span style="color: #f59e0b;">📜 已触发: <strong id="triggeredCount">0</strong></span>
                    </div>

                    <!-- 提醒列表（合并版） -->
                    <div style="margin: 20px 0;">
                        <div id="remindersList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">点击"刷新"加载提醒</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文档总结 v0.8.0 Phase 3 -->
        <div id="documents" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>📄 文档总结 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.8.0 Phase
                            3</span></h3>

                    <!-- 上传区域 -->
                    <div style="margin: 20px 0;">
                        <div
                            style="border: 2px dashed #667eea; border-radius: 12px; padding: 40px; text-align: center; background: #f8f9fa;">
                            <div style="font-size: 48px; margin-bottom: 15px;">📤</div>
                            <h4 style="margin: 10px 0; color: #333;">上传文档进行智能总结</h4>
                            <p style="color: #666; margin: 10px 0; font-size: 14px;">
                                支持 PDF、Word (DOCX)、文本文件 (TXT、MD)<br>
                                最大文件大小: 10 MB
                            </p>
                            <input type="file" id="documentFileInput" accept=".pdf,.docx,.txt,.md"
                                style="display: none;" onchange="handleDocumentUpload(event)">
                            <button onclick="document.getElementById('documentFileInput').click()"
                                style="margin-top: 15px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                       color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                📁 选择文件
                            </button>
                        </div>
                    </div>

                    <!-- 文档列表 -->
                    <div style="margin: 20px 0;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">📚 文档列表</h4>
                            <button onclick="loadDocuments()"
                                style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                🔄 刷新
                            </button>
                        </div>
                        <div id="documentsList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px;">
                            <div class="loading">点击"刷新"加载文档列表</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 课程表管理 v0.7.0 -->
        <div id="schedule" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>📅 课程表管理 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.7.0</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px;">
                        <button onclick="loadSchedule()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🔄 刷新课程表
                        </button>
                        <button onclick="saveSchedule()"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            💾 保存修改
                        </button>
                    </div>

                    <!-- 课程表格 -->
                    <div id="scheduleTable" style="overflow-x: auto; margin-top: 20px;">
                        <table
                            style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead style="background: #667eea; color: white;">
                                <tr>
                                    <th style="padding: 12px; border: 1px solid #ddd;">时段</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">周一</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">周二</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">周三</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">周四</th>
                                    <th style="padding: 12px; border: 1px solid #ddd;">周五</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody">
                                <!-- 将由JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 工具管理 -->
        <div id="tools" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>🔧 工具管理 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.4.0
                            Action层</span></h3>

                    <div style="margin: 15px 0; display: flex; gap: 10px; align-items: center;">
                        <button onclick="loadTools()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🔄 刷新工具列表
                        </button>
                    </div>

                    <!-- 工具列表 -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">📋 可用工具</h4>
                        <div id="toolsList"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 150px;">
                            <div class="loading">点击"刷新工具列表"加载</div>
                        </div>
                    </div>

                    <!-- 工具执行历史 -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">📊 工具执行历史</h4>
                        <div style="margin-bottom: 10px;">
                            <button onclick="loadToolHistory()"
                                style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                🔄 刷新历史
                            </button>
                            <select id="historyLimit"
                                style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="10">最近10条</option>
                                <option value="20" selected>最近20条</option>
                                <option value="50">最近50条</option>
                            </select>
                        </div>
                        <div id="toolHistory"
                            style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <div class="loading">点击"刷新历史"加载</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设置面板 v0.6.0 Phase 2 -->
        <div id="settings" class="tab-content">
            <div class="memory-container">
                <div class="stats-card">
                    <h3>⚙️ 用户设置 <span style="font-size: 12px; color: #667eea; font-weight: normal;">v0.6.0 用户体验</span>
                    </h3>

                    <!-- 外观设置 -->
                    <div class="settings-section">
                        <h4 class="settings-title">🎨 外观设置</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">主题模式</span>
                                <span class="setting-desc">选择界面主题偏好</span>
                            </div>
                            <select id="themePreference" class="setting-select"
                                onchange="updateThemePreference(this.value)">
                                <option value="system">跟随系统</option>
                                <option value="light">始终亮色</option>
                                <option value="dark">始终暗色</option>
                            </select>
                        </div>
                    </div>

                    <!-- 交互设置 -->
                    <div class="settings-section">
                        <h4 class="settings-title">⌨️ 交互设置</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">快捷键</span>
                                <span class="setting-desc">启用/禁用键盘快捷键功能</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="keyboardShortcuts" checked
                                    onchange="toggleKeyboardShortcuts(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">快捷键提示栏</span>
                                <span class="setting-desc">显示/隐藏底部快捷键提示</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="shortcutHintsEnabled" checked
                                    onchange="toggleShortcutHints(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- AI响应设置 -->
                    <div class="settings-section">
                        <h4 class="settings-title">🤖 AI响应设置</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">回复风格</span>
                                <span class="setting-desc">选择AI的回复详细程度</span>
                            </div>
                            <select id="responseStyle" class="setting-select"
                                onchange="updateResponseStyle(this.value)">
                                <option value="concise">简洁模式</option>
                                <option value="balanced" selected>平衡模式</option>
                                <option value="detailed">详细模式</option>
                                <option value="professional">专业模式</option>
                            </select>
                        </div>
                    </div>

                    <!-- 通知设置 -->
                    <div class="settings-section">
                        <h4 class="settings-title">🔔 通知设置</h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">主动问答提示</span>
                                <span class="setting-desc">显示追问建议提示</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="proactiveQA" checked
                                    onchange="toggleProactiveQA(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">提醒通知</span>
                                <span class="setting-desc">启用提醒弹窗通知</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="reminderNotifications" checked
                                    onchange="toggleReminderNotifications(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- v0.8.0 语音设置 -->
                    <div class="settings-section">
                        <h4 class="settings-title">🎤 语音交互设置 <span
                                style="font-size: 11px; color: #f5576c; font-weight: normal;">新功能</span></h4>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">语音识别服务</span>
                                <span class="setting-desc">选择语音识别提供商</span>
                            </div>
                            <select id="voiceProvider" class="setting-select"
                                onchange="updateVoiceProvider(this.value)">
                                <option value="google">Google (需科学上网)</option>
                                <option value="baidu">百度语音 (推荐)</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">自动播放AI回复</span>
                                <span class="setting-desc">AI回复后自动播放语音</span>
                            </div>
                            <label class="setting-switch">
                                <input type="checkbox" id="voiceAutoPlay" onchange="updateVoiceAutoPlay(this.checked)">
                                <span class="switch-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">语音合成服务</span>
                                <span class="setting-desc">选择AI回复的语音合成方式</span>
                            </div>
                            <select id="ttsProvider" class="setting-select" onchange="updateTTSProvider(this.value)">
                                <option value="web">浏览器语音 (免费)</option>
                                <option value="baidu">百度语音 (更自然)</option>
                            </select>
                        </div>

                        <div class="setting-item" id="baiduTTSPersonSetting" style="display: none;">
                            <div class="setting-label">
                                <span class="setting-name">百度TTS音色</span>
                                <span class="setting-desc">选择AI回复的声音（基础免费版）</span>
                            </div>
                            <select id="ttsPerson" class="setting-select" onchange="updateTTSPerson(this.value)">
                                <option value="0">度小美（女声，温柔）</option>
                                <option value="1">度小宇（男声，温和）</option>
                                <option value="3">度逍遥（男声，年轻活力）</option>
                                <option value="4">度丫丫（女声，活泼可爱）</option>
                            </select>
                            <div
                                style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 6px; font-size: 12px; color: #856404;">
                                💡 提示：仅显示基础免费版音色。高级音色（度小娇、度小鹿等）需要付费版本。
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">语速</span>
                                <span class="setting-desc">调节语音播放速度</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1.0"
                                    oninput="updateVoiceRate(this.value)"
                                    style="flex: 1; height: 4px; border-radius: 2px; outline: none; cursor: pointer;">
                                <span id="voiceRateValue"
                                    style="min-width: 40px; text-align: right; font-weight: 500;">1.0x</span>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">音量</span>
                                <span class="setting-desc">调节语音播放音量</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="voiceVolume" min="0" max="1" step="0.1" value="1.0"
                                    oninput="updateVoiceVolume(this.value)"
                                    style="flex: 1; height: 4px; border-radius: 2px; outline: none; cursor: pointer;">
                                <span id="voiceVolumeValue"
                                    style="min-width: 40px; text-align: right; font-weight: 500;">100%</span>
                            </div>
                        </div>

                        <div class="setting-item" style="background: #f8f9fa; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">💡</span>
                                <span style="font-weight: 500; color: #333;">语音功能使用提示</span>
                            </div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #666; line-height: 1.8;">
                                <li>点击输入框旁的 🎤 按钮开始语音输入</li>
                                <li>支持中文语音识别，识别后自动填入输入框</li>
                                <li>开启自动播放后，AI回复会自动朗读</li>
                                <li>建议使用 Chrome、Edge 或 Safari 浏览器</li>
                                <li>首次使用需授予麦克风权限</li>
                                <li><strong style="color: #f5576c;">⚠️ 语音识别需要网络连接</strong></li>
                            </ul>
                        </div>

                        <div class="setting-item"
                            style="background: #fff3cd; border-radius: 8px; padding: 12px; border-left: 4px solid #f5576c;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">⚠️</span>
                                <span style="font-weight: 500; color: #856404;">遇到"network"错误？</span>
                            </div>
                            <ul
                                style="margin: 0; padding-left: 20px; font-size: 12px; color: #856404; line-height: 1.8;">
                                <li>语音识别使用Google的Web Speech API，需要网络连接</li>
                                <li>请确保网络连接正常，可以访问Google服务</li>
                                <li>如果在国内使用，可能需要科学上网</li>
                                <li>备选方案：可以手动输入文字，或等待后续版本集成国内语音API</li>
                            </ul>
                        </div>
                    </div>

                    <!-- 重置按钮 -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
                        <button onclick="resetSettings()" style="
                            padding: 12px 30px;
                            background: #ff6b6b;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.2s;
                        ">
                            🔄 重置所有设置
                        </button>
                        <p style="margin-top: 10px; font-size: 12px; color: #999;">
                            将恢复所有设置为默认值
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- v0.6.0 快捷键提示栏 -->
    <div id="shortcutHints" style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea15, #764ba215);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 12px;
        color: #666;
        border-top: 1px solid #ddd;
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
    ">
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+Enter</kbd>
            发送
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Esc</kbd>
            清空
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+K</kbd>
            新对话
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+/</kbd>
            聊天
        </span>
        <span style="display: flex; align-items: center; gap: 5px;">
            <kbd
                style="background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 11px;">Ctrl+1-6</kbd>
            切换标签
        </span>
    </div>

    <!-- v0.6.0 性能优化模块 -->
    <script src="/static/performance.js"></script>

    <script>
        let currentSessionId = null;
        const API_BASE = '';

        // 主题切换功能
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // 更新图标
            themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

        // 初始化主题
        function initTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            // 检查用户偏好
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // 确定使用的主题
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

            html.setAttribute('data-theme', theme);
            themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
        }

        // 页面加载时初始化主题
        document.addEventListener('DOMContentLoaded', initTheme);

        // ===== 设置管理功能 v0.6.0 =====

        // 设置项默认值
        const DEFAULT_SETTINGS = {
            themePreference: 'system',
            keyboardShortcuts: true,
            shortcutHintsEnabled: true,
            responseStyle: 'balanced',
            proactiveQA: true,
            reminderNotifications: true
        };

        // 初始化设置
        function initSettings() {
            const settings = getSettings();

            // 应用所有设置
            document.getElementById('themePreference').value = settings.themePreference;
            document.getElementById('keyboardShortcuts').checked = settings.keyboardShortcuts;
            document.getElementById('shortcutHintsEnabled').checked = settings.shortcutHintsEnabled;
            document.getElementById('responseStyle').value = settings.responseStyle;
            document.getElementById('proactiveQA').checked = settings.proactiveQA;
            document.getElementById('reminderNotifications').checked = settings.reminderNotifications;

            // 应用主题偏好
            applyThemePreference(settings.themePreference);

            // 应用快捷键提示
            if (settings.shortcutHintsEnabled) {
                showShortcutHints();
            }

            // 初始化语音设置 v0.8.0
            initVoiceSettings();
        }

        // 获取设置
        function getSettings() {
            const saved = localStorage.getItem('userSettings');
            return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
        }

        // 保存设置
        function saveSettings(settings) {
            localStorage.setItem('userSettings', JSON.stringify(settings));
        }

        // 更新主题偏好
        function updateThemePreference(value) {
            const settings = getSettings();
            settings.themePreference = value;
            saveSettings(settings);
            applyThemePreference(value);
            showToast(`✅ 主题偏好已设置为：${getThemeLabel(value)}`, 'success');
        }

        // 应用主题偏好
        function applyThemePreference(preference) {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            if (preference === 'system') {
                // 跟随系统
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = systemPrefersDark ? 'dark' : 'light';
                html.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
            } else {
                // 固定主题
                html.setAttribute('data-theme', preference);
                themeIcon.textContent = preference === 'dark' ? '☀️' : '🌙';
                localStorage.setItem('theme', preference);
            }
        }

        // 获取主题标签
        function getThemeLabel(value) {
            const labels = {
                'system': '跟随系统',
                'light': '始终亮色',
                'dark': '始终暗色'
            };
            return labels[value] || value;
        }

        // 切换快捷键功能
        function toggleKeyboardShortcuts(enabled) {
            const settings = getSettings();
            settings.keyboardShortcuts = enabled;
            saveSettings(settings);
            showToast(enabled ? '✅ 快捷键已启用' : '⚠️ 快捷键已禁用', enabled ? 'success' : 'warning');
        }

        // 切换快捷键提示栏
        function toggleShortcutHints(enabled) {
            const settings = getSettings();
            settings.shortcutHintsEnabled = enabled;
            saveSettings(settings);

            const hints = document.getElementById('shortcutHints');
            if (enabled) {
                showShortcutHints();
            } else {
                hints.style.opacity = '0';
                setTimeout(() => {
                    hints.style.display = 'none';
                }, 300);
            }
            showToast(enabled ? '✅ 快捷键提示已显示' : '⚠️ 快捷键提示已隐藏', enabled ? 'success' : 'warning');
        }

        // 更新AI响应风格
        function updateResponseStyle(style) {
            const settings = getSettings();
            settings.responseStyle = style;
            saveSettings(settings);

            const labels = {
                'concise': '简洁模式',
                'balanced': '平衡模式',
                'detailed': '详细模式',
                'professional': '专业模式'
            };
            showToast(`✅ AI响应风格已设置为：${labels[style]}`, 'success');
        }

        // 切换主动问答
        function toggleProactiveQA(enabled) {
            const settings = getSettings();
            settings.proactiveQA = enabled;
            saveSettings(settings);
            showToast(enabled ? '✅ 主动问答提示已启用' : '⚠️ 主动问答提示已禁用', enabled ? 'success' : 'warning');
        }

        // 切换提醒通知
        function toggleReminderNotifications(enabled) {
            const settings = getSettings();
            settings.reminderNotifications = enabled;
            saveSettings(settings);
            showToast(enabled ? '✅ 提醒通知已启用' : '⚠️ 提醒通知已禁用', enabled ? 'success' : 'warning');
        }

        // ==================== v0.8.0 语音设置功能 ====================

        // 更新语音服务提供商
        function updateVoiceProvider(provider) {
            localStorage.setItem('useBaiduVoice', provider === 'baidu');
            const providerName = provider === 'baidu' ? '百度语音' : 'Google语音';
            showToast(`✅ 已切换到${providerName}识别`, 'success');
        }

        // 更新TTS提供商
        function updateTTSProvider(provider) {
            localStorage.setItem('ttsProvider', provider);
            const ttsName = provider === 'baidu' ? '百度语音合成' : '浏览器语音合成';
            showToast(`✅ 已切换到${ttsName}`, 'success');

            // 显示/隐藏百度TTS音色选择
            const personSetting = document.getElementById('baiduTTSPersonSetting');
            if (personSetting) {
                personSetting.style.display = provider === 'baidu' ? 'flex' : 'none';
            }
        }

        // 更新TTS音色
        function updateTTSPerson(person) {
            localStorage.setItem('ttsPerson', person);
            const personNames = {
                '0': '度小美（女声，温柔）',
                '1': '度小宇（男声，温和）',
                '3': '度逍遥（男声，年轻活力）',
                '4': '度丫丫（女声，活泼可爱）'
            };
            showToast(`✅ 音色已设置为：${personNames[person] || '度小美'}`, 'success');
        }

        // 更新语音自动播放设置
        function updateVoiceAutoPlay(enabled) {
            localStorage.setItem('voiceAutoPlay', enabled);
            showToast(enabled ? '✅ 已开启语音自动播放' : '❌ 已关闭语音自动播放', 'info');
        }

        // 更新语速
        function updateVoiceRate(value) {
            localStorage.setItem('voiceRate', value);
            document.getElementById('voiceRateValue').textContent = value + 'x';
        }

        // 更新音量
        function updateVoiceVolume(value) {
            localStorage.setItem('voiceVolume', value);
            const percentage = Math.round(value * 100);
            document.getElementById('voiceVolumeValue').textContent = percentage + '%';
        }

        // 初始化语音设置
        function initVoiceSettings() {
            // 首次访问时默认使用百度语音（国内更稳定）
            if (localStorage.getItem('useBaiduVoice') === null) {
                localStorage.setItem('useBaiduVoice', 'true');
            }

            const useBaiduVoice = localStorage.getItem('useBaiduVoice') === 'true';
            const ttsProvider = localStorage.getItem('ttsProvider') || 'web';
            const ttsPerson = localStorage.getItem('ttsPerson') || '0'; // 默认度小美(女声)
            const autoPlay = localStorage.getItem('voiceAutoPlay') === 'true';
            const rate = localStorage.getItem('voiceRate') || '1.0';
            const volume = localStorage.getItem('voiceVolume') || '1.0';

            document.getElementById('voiceProvider').value = useBaiduVoice ? 'baidu' : 'google';
            document.getElementById('ttsProvider').value = ttsProvider;
            document.getElementById('ttsPerson').value = ttsPerson;
            document.getElementById('voiceAutoPlay').checked = autoPlay;
            document.getElementById('voiceRate').value = rate;
            document.getElementById('voiceRateValue').textContent = rate + 'x';
            document.getElementById('voiceVolume').value = volume;
            document.getElementById('voiceVolumeValue').textContent = Math.round(volume * 100) + '%';

            // 显示/隐藏百度TTS音色选择
            const personSetting = document.getElementById('baiduTTSPersonSetting');
            if (personSetting) {
                personSetting.style.display = ttsProvider === 'baidu' ? 'flex' : 'none';
            }
        }

        // ==================== 设置管理功能 ====================

        // 重置所有设置
        function resetSettings() {
            if (confirm('确定要重置所有设置为默认值吗？')) {
                localStorage.removeItem('userSettings');
                localStorage.removeItem('theme');
                initSettings();
                applyThemePreference('system');
                showToast('✅ 所有设置已重置为默认值', 'success');
            }
        }

        // 页面加载时初始化设置
        document.addEventListener('DOMContentLoaded', function () {
            initSettings();
        });

        // 切换标签页
        function switchTab(tabName, event) {
            // 移除所有tab和内容的active状态
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 激活对应的tab按钮（如果是通过点击触发）
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // 如果是程序调用，查找对应的tab按钮并激活
                const tabButton = document.querySelector(`.tab[onclick*="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }

            // 激活对应的内容区域
            document.getElementById(tabName).classList.add('active');

            // 加载对应tab的数据
            if (tabName === 'sessions') loadSessions();
            if (tabName === 'memory') loadMemoryStats();
            if (tabName === 'analytics') {
                // 自动加载行为分析数据
                loadBehaviorAnalytics();
                // 自动加载主动问答历史
                const userId = 'default_user';
                loadProactiveQA(userId);
            }
            if (tabName === 'tasks') {
                // 自动加载任务列表，默认显示待完成任务
                document.getElementById('taskStatusFilter').value = 'pending';
                loadTasks();
            }
            if (tabName === 'reminders') {
                // 自动加载提醒列表
                loadReminders();
                loadReminderHistory();
            }
            if (tabName === 'documents') {
                // 自动加载文档列表
                loadDocuments();
            }
            if (tabName === 'tools') {
                // 自动加载工具列表
                loadTools();
                loadToolHistory();
            }
            if (tabName === 'schedule') {
                // 自动加载课程表
                loadSchedule();
            }
        }

        // ==================== v0.8.0 语音交互功能 ====================

        let recognition = null;
        let isRecording = false;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let recognitionRetryCount = 0;
        const MAX_RETRY = 2;

        // v0.8.1 连续对话模式
        let isConversationMode = false;
        let isSpeaking = false; // AI正在说话
        let currentAudio = null; // 当前播放的音频

        // 监听网络状态
        window.addEventListener('online', function () {
            console.log('✅ 网络已连接，语音识别可用');
        });

        window.addEventListener('offline', function () {
            console.warn('⚠️ 网络已断开，语音识别不可用');
            if (isRecording) {
                stopVoiceInput();
                showToast('网络断开，语音识别已停止', 'error');
            }
        });

        // 页面卸载时清理语音资源
        window.addEventListener('beforeunload', function () {
            console.log('🧹 页面卸载，清理语音资源...');

            // 停止语音合成
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            // 停止音频播放
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // 停止录音
            if (isRecording) {
                stopVoiceInput();
            }

            // 关闭对话模式
            if (isConversationMode) {
                isConversationMode = false;
            }
        });

        // 页面隐藏时暂停语音（切换标签页、最小化窗口等）
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                console.log('📵 页面隐藏，暂停语音播放');

                // 暂停语音合成
                if (speechSynthesis.speaking) {
                    speechSynthesis.pause();
                }

                // 暂停音频
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                }
            } else {
                console.log('📱 页面显示，恢复语音播放');

                // 恢复语音合成
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                }

                // 恢复音频（可选，避免突然播放）
                // if (currentAudio && currentAudio.paused) {
                //     currentAudio.play();
                // }
            }
        });

        // 初始化语音识别
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('浏览器不支持语音识别');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.lang = 'zh-CN';  // 中文识别
            recognition.continuous = false;  // 不持续识别
            recognition.interimResults = true;  // 显示临时结果
            recognition.maxAlternatives = 1;  // 只返回最佳结果

            // 添加详细日志
            console.log('🔧 语音识别配置:', {
                lang: recognition.lang,
                continuous: recognition.continuous,
                interimResults: recognition.interimResults
            });

            recognition.onstart = function () {
                console.log('🎤 语音识别开始');
                isRecording = true;
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceStatus = document.getElementById('voiceStatus');
                const voiceText = document.getElementById('voiceText');

                voiceBtn.classList.add('recording');
                voiceStatus.style.display = 'flex';
                voiceText.textContent = '正在聆听...';
            };

            recognition.onresult = function (event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const voiceText = document.getElementById('voiceText');
                if (interimTranscript) {
                    voiceText.textContent = interimTranscript;
                }

                if (finalTranscript) {
                    console.log('✅ 识别结果:', finalTranscript);
                    const input = document.getElementById('messageInput');
                    input.textContent = finalTranscript;
                    input.focus();

                    // 连续对话模式：自动发送
                    if (isConversationMode) {
                        setTimeout(() => autoSendInConversationMode(finalTranscript), 500);
                    }
                }
            };

            recognition.onerror = function (event) {
                console.error('❌ 语音识别错误:', event.error, event);
                const voiceText = document.getElementById('voiceText');

                switch (event.error) {
                    case 'no-speech':
                        voiceText.textContent = '没有检测到语音，请重试';
                        break;
                    case 'audio-capture':
                        voiceText.textContent = '无法访问麦克风';
                        break;
                    case 'not-allowed':
                        voiceText.textContent = '麦克风权限被拒绝';
                        break;
                    case 'network':
                        voiceText.textContent = '网络连接失败，请检查网络后重试';
                        console.warn('💡 提示: 语音识别需要网络连接，请确保网络正常');
                        break;
                    case 'service-not-allowed':
                        voiceText.textContent = '语音服务不可用';
                        break;
                    case 'aborted':
                        voiceText.textContent = '识别已取消';
                        break;
                    default:
                        voiceText.textContent = `识别出错: ${event.error}`;
                        console.error('未知错误类型:', event.error);
                }

                setTimeout(() => {
                    stopVoiceInput();
                }, 3000);
            };

            recognition.onend = function () {
                console.log('🎤 语音识别结束');
                stopVoiceInput();
            };

            return recognition;
        }

        // 切换语音输入
        function toggleVoiceInput() {
            // 优先使用百度语音识别
            const useBaiduVoice = localStorage.getItem('useBaiduVoice') === 'true';

            if (useBaiduVoice) {
                toggleBaiduVoiceInput();
            } else {
                toggleGoogleVoiceInput();
            }
        }

        // Google 语音识别（原方法）
        function toggleGoogleVoiceInput() {
            // 检查网络连接
            if (!navigator.onLine) {
                alert('⚠️ 网络未连接\n\n语音识别需要网络连接，请检查您的网络设置。');
                return;
            }

            // 诊断语音识别可用性
            console.log('🔍 Google语音识别诊断:');
            console.log('- 浏览器:', navigator.userAgent);
            console.log('- 在线状态:', navigator.onLine);
            console.log('- 语音识别支持:', 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window);

            if (!recognition) {
                recognition = initSpeechRecognition();
                if (!recognition) {
                    alert('❌ 浏览器不支持语音识别\n\n建议使用:\n✅ Chrome 浏览器（推荐）\n✅ Edge 浏览器\n✅ Safari 浏览器\n\n💡 提示：语音识别需要网络连接');
                    return;
                }
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    // 显示准备提示
                    const voiceStatus = document.getElementById('voiceStatus');
                    const voiceText = document.getElementById('voiceText');
                    voiceStatus.style.display = 'flex';
                    voiceText.textContent = '正在准备...';

                    recognition.start();
                } catch (e) {
                    console.error('启动语音识别失败:', e);

                    // 更友好的错误提示
                    let errorMsg = '启动语音识别失败';
                    if (e.message.includes('already started')) {
                        errorMsg = '语音识别已经在运行中，请稍候';
                        // 重置状态
                        stopVoiceInput();
                        setTimeout(() => {
                            toggleVoiceInput();
                        }, 500);
                        return;
                    } else if (e.message.includes('not allowed')) {
                        errorMsg = '麦克风权限被拒绝\n\n请在浏览器设置中允许麦克风访问';
                    } else {
                        errorMsg += '\n\n' + e.message;
                    }

                    alert('❌ ' + errorMsg + '\n\n💡 建议：刷新页面后重试');
                    stopVoiceInput();
                }
            }
        }

        // 停止语音输入
        function stopVoiceInput() {
            isRecording = false;
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');

            voiceBtn.classList.remove('recording');
            voiceStatus.style.display = 'none';

            // 停止百度录音器
            if (baiduRecorder && baiduRecorder.recording) {
                baiduRecorder.recording = false;

                try {
                    if (baiduRecorder.processor) {
                        baiduRecorder.processor.disconnect();
                        baiduRecorder.processor = null;
                    }
                    if (baiduRecorder.source) {
                        baiduRecorder.source.disconnect();
                        baiduRecorder.source = null;
                    }
                    if (baiduRecorder.stream) {
                        baiduRecorder.stream.getTracks().forEach(t => t.stop());
                        baiduRecorder.stream = null;
                    }
                    if (baiduRecorder.audioContext) {
                        baiduRecorder.audioContext.close();
                        baiduRecorder.audioContext = null;
                    }
                    baiduRecorder.bufferL = [];
                } catch (e) {
                    console.error('停止百度录音器出错:', e);
                }
            }
        }

        // ==================== 百度语音识别 ====================

        // 基于 Web Audio API 的 WAV(PCM16) 录音器，采样率 16k 以适配百度ASR
        let baiduRecorder = {
            audioContext: null,
            source: null,
            processor: null,
            analyser: null,
            stream: null,
            bufferL: [],
            sampleRate: 16000,
            recording: false,
            silenceStart: 0,
            silenceThreshold: 0.01, // 静音阈值
            silenceDuration: 1500,  // 静音持续时间（毫秒），1.5秒后自动停止
            hasSpoken: false,       // 是否检测到说话
            listeningMode: false,   // 监听模式：等待用户打断AI说话
        };

        function mergeBuffers(bufferArray) {
            let length = 0;
            bufferArray.forEach(b => length += b.length);
            const result = new Float32Array(length);
            let offset = 0;
            bufferArray.forEach(b => { result.set(b, offset); offset += b.length; });
            return result;
        }

        // 音频归一化和增益
        function normalizeAndBoost(buffer, targetPeak = 0.95, minGain = 1.5) {
            // 找到最大振幅
            let max = 0;
            for (let i = 0; i < buffer.length; i++) {
                const abs = Math.abs(buffer[i]);
                if (abs > max) max = abs;
            }

            // 计算增益
            let gain = 1.0;
            if (max > 0) {
                gain = Math.max(targetPeak / max, minGain);
            } else {
                gain = minGain;
            }

            // 限制最大增益，避免过度放大噪音
            gain = Math.min(gain, 8.0);

            console.log(`🔊 音频增益: ${gain.toFixed(2)}x (原始峰值: ${(max * 100).toFixed(1)}%)`);

            // 应用增益
            const result = new Float32Array(buffer.length);
            for (let i = 0; i < buffer.length; i++) {
                result[i] = Math.max(-1, Math.min(1, buffer[i] * gain));
            }

            return result;
        }

        function downsampleBuffer(buffer, inSampleRate, outSampleRate) {
            if (outSampleRate === inSampleRate) return buffer;
            const ratio = inSampleRate / outSampleRate;
            const newLength = Math.round(buffer.length / ratio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
                let accum = 0, count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            const bytesPerSample = 2;
            const numChannels = 1;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');

            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // PCM
            view.setUint16(20, 1, true);  // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // 16-bit

            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * bytesPerSample, true);

            // PCM samples
            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // 🎧 启动监听模式：在AI说话时监听用户打断
        async function startListeningForInterrupt() {
            if (!isConversationMode || !isSpeaking) return;
            if (baiduRecorder.listeningMode) return; // 已经在监听中

            console.log('🎧 启动打断监听模式...');

            try {
                // 请求麦克风权限
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // 创建音频分析器
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                // 保存到全局对象
                baiduRecorder.listeningStream = stream;
                baiduRecorder.listeningContext = audioContext;
                baiduRecorder.listeningSource = source;
                baiduRecorder.listeningAnalyser = analyser;
                baiduRecorder.listeningProcessor = processor;
                baiduRecorder.listeningMode = true;

                // 打断检测参数
                let interruptThreshold = 0.05; // 提高阈值，避免误触发（原来0.01太低）
                let interruptCount = 0;        // 连续检测计数
                let requiredCount = 3;         // 需要连续3次检测到声音才触发（约0.3秒）
                let startDelay = 500;          // 启动后延迟500ms才开始检测，避免回声
                let startTime = Date.now();

                // 监听音频输入
                processor.onaudioprocess = function (e) {
                    if (!baiduRecorder.listeningMode) return;

                    // 启动延迟保护：前500ms不检测
                    if (Date.now() - startTime < startDelay) {
                        return;
                    }

                    const channel = e.inputBuffer.getChannelData(0);

                    // 计算音量
                    let sum = 0;
                    for (let i = 0; i < channel.length; i++) {
                        sum += channel[i] * channel[i];
                    }
                    const rms = Math.sqrt(sum / channel.length);

                    // 连续性检测：需要连续多次检测到声音才触发
                    if (rms > interruptThreshold) {
                        interruptCount++;
                        console.log(`🎤 检测到声音 (${interruptCount}/${requiredCount}): RMS=${rms.toFixed(4)}`);

                        if (interruptCount >= requiredCount) {
                            console.log('✅ 确认用户说话，打断AI');

                            // 停止监听模式
                            stopListeningMode();

                            // 打断AI并开始正式录音
                            if (isSpeaking) {
                                stopSpeaking();
                            }

                            // 立即开始录音
                            setTimeout(() => {
                                if (isConversationMode && !isRecording) {
                                    console.log('🎤 从监听模式切换到录音模式');
                                    toggleBaiduVoiceInput();
                                }
                            }, 100);
                        }
                    } else {
                        // 没有声音，重置计数
                        if (interruptCount > 0) {
                            console.log(`🔇 声音中断，重置计数 (之前: ${interruptCount})`);
                        }
                        interruptCount = 0;
                    }
                };

                // 连接音频节点
                source.connect(analyser);
                analyser.connect(processor);
                processor.connect(audioContext.destination);

                console.log('✅ 打断监听模式已激活');

            } catch (error) {
                console.error('❌ 启动监听模式失败:', error);
                baiduRecorder.listeningMode = false;
            }
        }

        // 停止监听模式
        function stopListeningMode() {
            if (!baiduRecorder.listeningMode) return;

            console.log('🛑 停止打断监听模式');

            try {
                if (baiduRecorder.listeningProcessor) {
                    baiduRecorder.listeningProcessor.disconnect();
                    baiduRecorder.listeningProcessor = null;
                }
                if (baiduRecorder.listeningAnalyser) {
                    baiduRecorder.listeningAnalyser.disconnect();
                    baiduRecorder.listeningAnalyser = null;
                }
                if (baiduRecorder.listeningSource) {
                    baiduRecorder.listeningSource.disconnect();
                    baiduRecorder.listeningSource = null;
                }
                if (baiduRecorder.listeningStream) {
                    baiduRecorder.listeningStream.getTracks().forEach(track => track.stop());
                    baiduRecorder.listeningStream = null;
                }
                if (baiduRecorder.listeningContext) {
                    baiduRecorder.listeningContext.close();
                    baiduRecorder.listeningContext = null;
                }
            } catch (e) {
                console.log('清理监听模式资源:', e);
            }

            baiduRecorder.listeningMode = false;
        }

        async function toggleBaiduVoiceInput() {
            if (isRecording) {
                // 手动停止录音并识别
                await processBaiduRecording();
                return;
            }

            // 如果AI正在说话，先停止
            if (isSpeaking) {
                console.log('⏸️ 打断AI说话，开始录音');
                stopSpeaking();
            }

            try {
                // 先清理之前的录音器状态
                if (baiduRecorder.audioContext) {
                    try {
                        await baiduRecorder.audioContext.close();
                    } catch (e) {
                        console.log('关闭旧AudioContext:', e);
                    }
                }

                // 重置录音器对象
                baiduRecorder = {
                    audioContext: null,
                    source: null,
                    processor: null,
                    analyser: null,
                    stream: null,
                    bufferL: [],
                    sampleRate: 16000,
                    recording: false,
                    silenceStart: 0,
                    silenceThreshold: 0.01,
                    silenceDuration: 1500,
                    hasSpoken: false,
                };

                // 请求麦克风权限
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // 显示录音状态
                isRecording = true;
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceStatus = document.getElementById('voiceStatus');
                const voiceText = document.getElementById('voiceText');

                voiceBtn.classList.add('recording');
                voiceStatus.style.display = 'flex';
                voiceText.textContent = '请开始说话...';

                // 创建 Web Audio 录音流程
                baiduRecorder.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                baiduRecorder.stream = stream;
                baiduRecorder.source = baiduRecorder.audioContext.createMediaStreamSource(stream);
                baiduRecorder.analyser = baiduRecorder.audioContext.createAnalyser();
                baiduRecorder.analyser.fftSize = 2048;
                baiduRecorder.processor = baiduRecorder.audioContext.createScriptProcessor(4096, 1, 1);
                baiduRecorder.bufferL = [];
                baiduRecorder.recording = true;
                baiduRecorder.silenceStart = Date.now();

                // 音频处理和静音检测
                baiduRecorder.processor.onaudioprocess = function (e) {
                    if (!baiduRecorder.recording) return;

                    const channel = e.inputBuffer.getChannelData(0);
                    // 拷贝数据
                    baiduRecorder.bufferL.push(new Float32Array(channel));

                    // 计算音量（RMS）
                    let sum = 0;
                    for (let i = 0; i < channel.length; i++) {
                        sum += channel[i] * channel[i];
                    }
                    const rms = Math.sqrt(sum / channel.length);

                    // 静音检测
                    if (rms > baiduRecorder.silenceThreshold) {
                        // 检测到声音
                        if (!baiduRecorder.hasSpoken) {
                            // 第一次检测到声音
                            baiduRecorder.hasSpoken = true;

                            // 🎯 连续对话模式：检测到用户说话，立即打断AI
                            if (isConversationMode && isSpeaking) {
                                console.log('👂 检测到用户说话，打断AI播放');
                                stopSpeaking();
                                const stateText = document.getElementById('conversationStateText');
                                if (stateText) {
                                    stateText.textContent = '正在录音...';
                                }
                            }
                        }

                        baiduRecorder.silenceStart = Date.now();
                        voiceText.textContent = '正在录音...🎤';
                    } else if (baiduRecorder.hasSpoken) {
                        // 说话后的静音
                        const silenceDuration = Date.now() - baiduRecorder.silenceStart;
                        if (silenceDuration > baiduRecorder.silenceDuration) {
                            console.log('🔇 检测到静音，自动停止录音');
                            voiceText.textContent = '检测到静音，正在识别...';
                            // 自动停止并识别
                            setTimeout(() => processBaiduRecording(), 100);
                        }
                    }
                };

                // 连接音频节点
                baiduRecorder.source.connect(baiduRecorder.analyser);
                baiduRecorder.analyser.connect(baiduRecorder.processor);
                baiduRecorder.processor.connect(baiduRecorder.audioContext.destination);

                console.log('🎤 百度语音录音开始 (自动静音检测)');
                console.log('   AudioContext采样率:', baiduRecorder.audioContext.sampleRate);
                console.log('   静音阈值:', baiduRecorder.silenceThreshold);
                console.log('   静音时长:', baiduRecorder.silenceDuration + 'ms');

            } catch (error) {
                console.error('❌ 麦克风访问失败:', error);

                let errorMsg = '无法访问麦克风';
                if (error.name === 'NotAllowedError') {
                    errorMsg = '麦克风权限被拒绝\n\n请在浏览器设置中允许麦克风访问';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '未找到麦克风设备\n\n请检查麦克风是否正常连接';
                } else if (error.name === 'NotReadableError') {
                    errorMsg = '麦克风被其他程序占用\n\n请关闭其他使用麦克风的程序';
                }

                showToast('❌ ' + errorMsg, 'error');
                stopVoiceInput();
            }
        }

        // 处理百度录音识别
        async function processBaiduRecording() {
            if (!baiduRecorder || !baiduRecorder.recording) return;

            try {
                baiduRecorder.recording = false;

                if (baiduRecorder.processor) {
                    baiduRecorder.processor.disconnect();
                }
                if (baiduRecorder.analyser) {
                    baiduRecorder.analyser.disconnect();
                }
                if (baiduRecorder.source) {
                    baiduRecorder.source.disconnect();
                }
                if (baiduRecorder.stream) {
                    baiduRecorder.stream.getTracks().forEach(t => t.stop());
                }

                // 检查是否录到音频
                if (baiduRecorder.bufferL.length === 0) {
                    showToast('⚠️ 未检测到音频输入', 'warning');
                    stopVoiceInput();
                    return;
                }

                // 合并、增益、降采样并编码为 WAV 16k
                const raw = mergeBuffers(baiduRecorder.bufferL);
                const boosted = normalizeAndBoost(raw);
                const inRate = baiduRecorder.audioContext.sampleRate;
                const down = downsampleBuffer(boosted, inRate, 16000);
                const wavBlob = encodeWAV(down, 16000);

                // 上传识别
                const voiceText = document.getElementById('voiceText');
                voiceText.textContent = '正在识别...';

                const formData = new FormData();
                formData.append('file', wavBlob, 'audio.wav');
                const response = await fetch('/api/voice/recognize', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    const input = document.getElementById('messageInput');
                    input.textContent = result.text;
                    input.focus();
                    showToast('✅ 识别成功', 'success');

                    // 连续对话模式：自动发送
                    if (isConversationMode) {
                        setTimeout(() => autoSendInConversationMode(result.text), 500);
                    }
                } else {
                    showToast('❌ 识别失败: ' + (result.error || '未知错误'), 'error');
                }
            } catch (e) {
                console.error('停止或识别出错:', e);
                showToast('❌ 识别请求失败', 'error');
            } finally {
                stopVoiceInput();
            }
        }

        // ==================== v0.8.1 连续对话模式 ====================

        // 切换连续对话模式
        function toggleConversationMode() {
            isConversationMode = !isConversationMode;

            const btn = document.getElementById('conversationModeBtn');
            const statusDiv = document.getElementById('conversationModeStatus');
            const stateText = document.getElementById('conversationStateText');

            if (isConversationMode) {
                // 开启对话模式
                btn.classList.add('active');
                statusDiv.style.display = 'block';
                stateText.textContent = '对话模式已开启';
                showToast('🎤 连续对话模式已开启', 'success');
                console.log('🔊 连续对话模式：已开启');

                // 自动开始第一轮录音
                setTimeout(() => {
                    if (isConversationMode && !isRecording && !isSpeaking) {
                        startConversationRound();
                    }
                }, 500);
            } else {
                // 关闭对话模式
                btn.classList.remove('active');
                statusDiv.style.display = 'none';
                showToast('⏸️ 连续对话模式已关闭', 'info');
                console.log('🔇 连续对话模式：已关闭');

                // 停止当前录音
                if (isRecording) {
                    stopVoiceInput();
                }
                // 停止当前播放
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                if (currentUtterance) {
                    speechSynthesis.cancel();
                    currentUtterance = null;
                }
                isSpeaking = false;
            }
        }

        // 开始一轮对话（录音）
        function startConversationRound() {
            if (!isConversationMode) return;
            if (isRecording) return; // 只检查录音状态，允许打断AI说话

            // 如果AI正在说话，先停止
            if (isSpeaking) {
                console.log('⏸️ 打断AI说话，开始新录音');
                stopSpeaking();
            }

            console.log('🎤 开始新一轮对话录音...');
            const stateText = document.getElementById('conversationStateText');
            stateText.textContent = '请开始说话...';

            // 触发语音输入
            toggleVoiceInput();
        }

        // 在识别成功后自动发送（连续对话模式专用）
        async function autoSendInConversationMode(text) {
            if (!isConversationMode) return;

            console.log('📤 连续对话模式：自动发送消息');
            const stateText = document.getElementById('conversationStateText');
            stateText.textContent = 'AI正在思考...';

            // 填入输入框
            const input = document.getElementById('messageInput');
            input.textContent = text;

            // 自动发送
            await sendMessageFromDiv();
        }

        // 在AI回复播放完成后继续下一轮
        function onSpeechEnd() {
            isSpeaking = false;
            console.log('🔚 语音播放完成');

            // 停止监听模式
            stopListeningMode();

            if (isConversationMode) {
                console.log('♻️ 连续对话模式：准备下一轮');
                const stateText = document.getElementById('conversationStateText');
                stateText.textContent = '请继续说话...';

                // 等待1秒后开始下一轮
                setTimeout(() => {
                    if (isConversationMode && !isRecording && !isSpeaking) {
                        startConversationRound();
                    }
                }, 1000);
            }
        }

        // 语音播放AI回复（支持 WebSpeech 或 百度TTS）
        async function speakText(text, forcePlay = false) {
            // 检查是否启用自动播放（连续对话模式强制播放）
            const autoPlay = localStorage.getItem('voiceAutoPlay') === 'true' || isConversationMode || forcePlay;
            if (!autoPlay) return;

            isSpeaking = true;

            // 显示全局停止按钮
            const globalStopBtn = document.getElementById('globalStopSpeakingBtn');
            if (globalStopBtn) {
                globalStopBtn.style.display = 'flex';
            }

            // 显示播放状态指示器
            const speakingStatus = document.getElementById('speakingStatus');
            if (speakingStatus) {
                speakingStatus.style.display = 'flex';
            }

            if (isConversationMode) {
                const stateText = document.getElementById('conversationStateText');
                stateText.textContent = 'AI正在回复...（点击🎤或按空格打断）';

                // 不再自动启动监听模式，改为用户主动打断
                // startListeningForInterrupt();
            }

            const ttsProvider = (localStorage.getItem('ttsProvider') || 'web').toLowerCase();
            if (ttsProvider === 'baidu') {
                try {
                    const resp = await fetch('/api/voice/synthesize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text,
                            person: parseInt(localStorage.getItem('ttsPerson') || '0', 10),
                            speed: parseInt(localStorage.getItem('voiceRateNum') || '5', 10),
                            pitch: 5,
                            volume: Math.round(parseFloat(localStorage.getItem('voiceVolume') || '1.0') * 10),
                            audio_format: 'mp3'
                        })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        currentAudio = new Audio(`data:${data.mime};base64,${data.audio_base64}`);
                        currentAudio.onended = () => {
                            currentAudio = null;
                            // 隐藏停止按钮和播放状态
                            if (globalStopBtn) {
                                globalStopBtn.style.display = 'none';
                            }
                            const speakingStatus = document.getElementById('speakingStatus');
                            if (speakingStatus) {
                                speakingStatus.style.display = 'none';
                            }
                            onSpeechEnd();
                        };
                        currentAudio.onerror = () => {
                            currentAudio = null;
                            isSpeaking = false;
                            // 隐藏停止按钮和播放状态
                            if (globalStopBtn) {
                                globalStopBtn.style.display = 'none';
                            }
                            const speakingStatus = document.getElementById('speakingStatus');
                            if (speakingStatus) {
                                speakingStatus.style.display = 'none';
                            }
                        };
                        currentAudio.play().catch(e => {
                            console.warn('自动播放受阻:', e);
                            isSpeaking = false;
                            // 隐藏停止按钮和播放状态
                            if (globalStopBtn) {
                                globalStopBtn.style.display = 'none';
                            }
                            const speakingStatus = document.getElementById('speakingStatus');
                            if (speakingStatus) {
                                speakingStatus.style.display = 'none';
                            }
                        });
                        return;
                    } else {
                        console.warn('百度TTS失败，回退到WebSpeech:', data.error);
                    }
                } catch (e) {
                    console.warn('百度TTS调用异常，回退到WebSpeech:', e);
                }
            }

            // 停止当前播放
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            // 创建新的语音合成实例
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'zh-CN';
            currentUtterance.rate = parseFloat(localStorage.getItem('voiceRate') || '1.0');
            currentUtterance.volume = parseFloat(localStorage.getItem('voiceVolume') || '1.0');

            currentUtterance.onstart = function () {
                console.log('🔊 开始播放语音');
            };

            currentUtterance.onend = function () {
                console.log('🔊 播放结束');
                currentUtterance = null;
                // 隐藏停止按钮和播放状态
                if (globalStopBtn) {
                    globalStopBtn.style.display = 'none';
                }
                const speakingStatus = document.getElementById('speakingStatus');
                if (speakingStatus) {
                    speakingStatus.style.display = 'none';
                }
                onSpeechEnd();
            };

            currentUtterance.onerror = function (event) {
                console.error('语音播放错误:', event.error);
                currentUtterance = null;
                isSpeaking = false;
                // 隐藏停止按钮和播放状态
                if (globalStopBtn) {
                    globalStopBtn.style.display = 'none';
                }
                const speakingStatus = document.getElementById('speakingStatus');
                if (speakingStatus) {
                    speakingStatus.style.display = 'none';
                }
            };

            speechSynthesis.speak(currentUtterance);
        }

        // 停止语音播放
        // 停止语音播放
        function stopSpeaking() {
            console.log('🛑 停止所有语音播放');

            // 停止 Web Speech API
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                currentUtterance = null;
            }

            // 停止百度TTS音频
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0; // 重置播放位置
                currentAudio = null;
            }

            // 停止监听模式
            stopListeningMode();

            // 重置说话状态
            isSpeaking = false;

            // 隐藏全局停止按钮和播放状态
            const globalStopBtn = document.getElementById('globalStopSpeakingBtn');
            if (globalStopBtn) {
                globalStopBtn.style.display = 'none';
            }

            const speakingStatus = document.getElementById('speakingStatus');
            if (speakingStatus) {
                speakingStatus.style.display = 'none';
            }

            showToast('⏸️ 语音播放已停止', 'info');
        }

        // ==================== 发送消息功能 ====================

        // 发送消息（从contenteditable div）
        async function sendMessageFromDiv() {
            const input = document.getElementById('messageInput');
            const message = input.textContent.trim();

            // 如果既没有文字也没有图片，直接返回
            if (!message && !uploadedImagePath) return;

            // 如果有图片但没有文字，使用默认提示词
            const actualMessage = message || '请详细描述这张图片的内容';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.contentEditable = 'false';

            // 检查是否处于编辑模式 v0.6.0
            if (editingMessage) {
                // 删除原来的消息及其后续的AI回复
                const messageId = editingMessage.dataset.messageId;

                // 找到该消息后的第一条AI回复并删除
                let nextElement = editingMessage.nextElementSibling;
                if (nextElement && nextElement.classList.contains('assistant')) {
                    nextElement.remove();
                }

                // 删除原用户消息
                editingMessage.remove();

                // 清除编辑状态
                clearEditingState();

                // 继续正常发送流程，触发新的回复
                // 不要 return，让代码继续执行下面的发送逻辑
            }

            // 显示用户消息（包含图片）
            let displayMessage = message || '识别图片';
            addMessage('user', displayMessage, null, uploadedImagePath);
            input.textContent = '';

            // 保存当前图片路径（用于API调用）
            const currentImagePath = uploadedImagePath;

            // 立即清除图片预览和上传状态
            removeImagePreview();

            try {
                // 获取设置
                const settings = getSettings();
                const responseStyle = settings.responseStyle || 'balanced';

                // 检测是否包含"记住"等关键词
                const memorizeKeywords = ['记住', '保存', '记下', '存一下', '记录'];
                const shouldMemorize = message && memorizeKeywords.some(kw => message.includes(kw));

                // 构建请求 URL（添加图片路径和记忆标志）
                let url = `${API_BASE}/chat?prompt=${encodeURIComponent(message || '')}&response_style=${responseStyle}`;

                if (currentSessionId) {
                    url += `&session_id=${currentSessionId}`;
                }

                if (currentImagePath) {
                    url += `&image_path=${encodeURIComponent(currentImagePath)}`;
                }

                if (shouldMemorize) {
                    url += `&memorize=true`;
                    console.log('🧠 检测到记忆关键词，将保存图片内容到记忆库');
                }

                console.log('📤 发送请求:', url);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(url, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    addMessage('assistant', data.reply);

                    // v0.7.1: 已禁用追问弹窗，小乐通过正常对话主动提问
                    // if (data.followup) {
                    //     showFollowupSuggestion(data.followup);
                    // }
                } else {
                    addMessage('assistant', '抱歉，出现错误：' + (data.detail || '未知错误'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', '请求超时，问题可能比较复杂，请稍后再试。');
                } else {
                    addMessage('assistant', '网络错误：' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.contentEditable = 'true';
                input.focus();
            }
        }

        // 发送消息（保留旧函数兼容性）
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            // 检查是否是contenteditable
            if (input.contentEditable === 'true') {
                sendMessageFromDiv();
                return;
            }

            const message = input.value.trim();

            // 如果有图片但没有文字，提示用户
            if (!message && uploadedImagePath) {
                showNotification('请输入对图片的提问', 'warning');
                return;
            }

            if (!message && !uploadedImagePath) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            // 显示用户消息
            let displayMessage = message;
            if (uploadedImagePath) {
                displayMessage = `📷 [图片]\n${message}`;
            }
            addMessage('user', displayMessage);
            input.value = '';
            // 重置textarea高度
            input.style.height = 'auto';

            try {
                // 如果有上传的图片，先调用图片识别API并将分析结果作为上下文发送到聊天接口
                if (uploadedImagePath) {
                    console.log('🖼️ 发送图片识别请求:', uploadedImagePath);
                    const response = await fetch('/api/vision/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            image_path: uploadedImagePath,
                            prompt: message || '请详细描述这张图片的内容'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 在聊天中显示图片的分析（作为可见的上下文）
                        addMessage('assistant', `📷 图片分析：${result.description}\n\n_${result.model}_`);

                        // 将用户的文本和图片分析合并，发送到聊天接口，让小乐基于图片与问题作答
                        const settings = getSettings();
                        const responseStyle = settings.responseStyle || 'balanced';

                        const combinedPrompt = message
                            ? `${message}\n\n根据上面的图片分析，回答用户的问题。图片分析摘要：${result.description}`
                            : `请基于图片内容给出详细描述：${result.description}`;

                        const url = currentSessionId
                            ? `${API_BASE}/chat?prompt=${encodeURIComponent(combinedPrompt)}&session_id=${currentSessionId}&response_style=${responseStyle}`
                            : `${API_BASE}/chat?prompt=${encodeURIComponent(combinedPrompt)}&response_style=${responseStyle}`;

                        // 设置60秒超时
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 60000);

                        const chatResp = await fetch(url, {
                            method: 'POST',
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        const chatData = await chatResp.json();

                        if (chatResp.ok) {
                            currentSessionId = chatData.session_id;
                            addMessage('assistant', chatData.reply);
                        } else {
                            addMessage('assistant', '抱歉，图片相关的问题处理失败：' + (chatData.detail || chatData.error || '未知错误'));
                        }

                        // 清理图片预览（保留，如需历史可改为保留）
                        removeImagePreview();
                    } else {
                        addMessage('assistant', `❌ 图片识别失败: ${result.error}`);
                    }
                } else {
                    // 普通文本消息
                    // v0.6.0: 获取用户设置的响应风格
                    const settings = getSettings();
                    const responseStyle = settings.responseStyle || 'balanced';

                    const url = currentSessionId
                        ? `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&session_id=${currentSessionId}&response_style=${responseStyle}`
                        : `${API_BASE}/chat?prompt=${encodeURIComponent(message)}&response_style=${responseStyle}`;

                    // 设置60秒超时以处理复杂问题
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);

                    const response = await fetch(url, {
                        method: 'POST',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    const data = await response.json();

                    if (response.ok) {
                        currentSessionId = data.session_id;
                        addMessage('assistant', data.reply);
                    } else {
                        addMessage('assistant', '抱歉，出现错误：' + (data.detail || '未知错误'));
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('assistant', '请求超时，问题可能比较复杂，请稍后再试。');
                } else {
                    addMessage('assistant', '网络错误：' + error.message);
                }
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // 添加消息到界面
        function addMessage(role, content, messageId = null, imagePath = null, shouldPlayVoice = true) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // 设置消息ID用于编辑/删除
            if (messageId) {
                messageDiv.dataset.messageId = messageId;
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // 如果有图片，先显示图片
            if (imagePath && role === 'user') {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'message-image';
                const img = document.createElement('img');
                img.src = `/${imagePath}`;
                img.alt = '上传的图片';
                img.style.cssText = 'max-width: 300px; max-height: 300px; border-radius: 8px; margin-bottom: 8px;';
                img.onclick = () => openImageViewer(`/${imagePath}`);
                imageDiv.appendChild(img);
                contentDiv.appendChild(imageDiv);

                // 清理消息内容：移除视觉识别结果的XML标签
                // 只保留用户问题部分
                const userQuestionMatch = content.match(/用户问题：(.+?)(?=\n\n请基于|$)/s);
                if (userQuestionMatch) {
                    content = userQuestionMatch[1].trim();
                } else {
                    // 兼容旧格式：移除 [图片内容]: 和 [用户问题]: 标记
                    const oldFormatMatch = content.match(/\[用户问题\]:\s*(.+)/s);
                    if (oldFormatMatch) {
                        content = oldFormatMatch[1].trim();
                    } else {
                        // 移除 <vision_result> 标签内容
                        content = content.replace(/<vision_result>[\s\S]*?<\/vision_result>/g, '').trim();
                        // 移除"请基于..."等系统提示
                        content = content.replace(/\n\n请基于.*?问题。?$/s, '').trim();
                    }
                }
            }

            // 添加文本内容
            const textDiv = document.createElement('div');
            // 如果是助手消息，使用Markdown渲染；用户消息保持纯文本
            if (role === 'assistant') {
                textDiv.innerHTML = marked.parse(content);

                // v0.8.0 语音播放AI回复（检查自动播放设置）
                const autoPlayEnabled = localStorage.getItem('voiceAutoPlay') === 'true';
                if (shouldPlayVoice && autoPlayEnabled) {
                    setTimeout(() => {
                        speakText(content);
                    }, 100);
                }

                // 为AI消息添加操作按钮
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions ai-actions';

                // 复制按钮
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn copy';
                copyBtn.innerHTML = '📋';
                copyBtn.title = '复制内容';
                copyBtn.onclick = () => copyMessage(content, copyBtn);

                // 朗读按钮
                const speakBtn = document.createElement('button');
                speakBtn.className = 'message-action-btn speak';
                speakBtn.innerHTML = '🔊';
                speakBtn.title = '朗读内容';
                speakBtn.onclick = () => speakText(content, true);  // 强制播放

                // 最佳回复按钮
                const goodBtn = document.createElement('button');
                goodBtn.className = 'message-action-btn good';
                goodBtn.innerHTML = '⭐';
                goodBtn.title = '标记为最佳回复';
                goodBtn.onclick = () => markAsGoodResponse(messageDiv, content);

                // 错误回复按钮
                const badBtn = document.createElement('button');
                badBtn.className = 'message-action-btn bad';
                badBtn.innerHTML = '❌';
                badBtn.title = '标记为错误回复';
                badBtn.onclick = () => markAsBadResponse(messageDiv, content);

                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(speakBtn);
                actionsDiv.appendChild(goodBtn);
                actionsDiv.appendChild(badBtn);

                // 先添加文本，再添加按钮
                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(actionsDiv);
            } else {
                textDiv.textContent = content;

                // 为用户消息添加操作按钮
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                // 复制按钮
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn copy';
                copyBtn.innerHTML = '📋';
                copyBtn.title = '复制消息';
                copyBtn.onclick = () => copyMessage(content, copyBtn);

                // 编辑按钮
                const editBtn = document.createElement('button');
                editBtn.className = 'message-action-btn edit';
                editBtn.innerHTML = '✏️';
                editBtn.title = '编辑消息';
                editBtn.onclick = () => editMessage(messageDiv, content, imagePath);

                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(editBtn);

                // 先添加文本，再添加按钮
                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(actionsDiv);
            }

            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 新对话
        function newChat() {
            currentSessionId = null;
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('messageInput').focus();

            // 清除编辑状态
            clearEditingState();
        }

        // ============ v0.6.0 消息操作功能 ============

        let editingMessage = null;
        let originalContent = '';
        let editingImagePath = null;

        // 编辑消息
        function editMessage(messageDiv, content, imagePath = null) {
            const input = document.getElementById('messageInput');

            // 保存编辑状态
            editingMessage = messageDiv;
            originalContent = input.textContent;
            editingImagePath = imagePath;

            // 将消息内容加载到输入框
            input.textContent = content;
            input.focus();

            // 如果有图片，显示图片预览
            if (imagePath) {
                showImagePreviewInInput(imagePath);
            }

            // 显示编辑提示
            showEditingIndicator();
        }

        // 显示编辑状态提示
        function showEditingIndicator() {
            // 移除已存在的提示
            const existing = document.querySelector('.editing-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.className = 'editing-indicator';
            indicator.innerHTML = `
                <span>✏️ 正在编辑消息</span>
                <button onclick="clearEditingState()">取消</button>
            `;
            document.body.appendChild(indicator);
        }

        // 清除编辑状态
        function clearEditingState() {
            editingMessage = null;
            editingImagePath = null;
            originalContent = '';

            const indicator = document.querySelector('.editing-indicator');
            if (indicator) indicator.remove();
        }

        // 删除消息
        function deleteMessage(messageDiv) {
            if (confirm('确定要删除这条消息吗？')) {
                // 找到对应的AI回复并一起删除
                let nextElement = messageDiv.nextElementSibling;
                if (nextElement && nextElement.classList.contains('message') &&
                    (nextElement.classList.contains('ai') || nextElement.classList.contains('assistant'))) {
                    nextElement.remove();
                }

                // 删除用户消息
                messageDiv.remove();

                // 显示删除成功提示
                showToast('消息已删除', 'success');
            }
        }

        // 复制消息
        async function copyMessage(content, button) {
            try {
                // 如果content包含HTML标签，提取纯文本
                let textToCopy = content;

                // 创建临时div来解析HTML并提取纯文本
                if (content.includes('<') || content.includes('>')) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;

                    // 处理代码块：直接提取文本，不修改DOM
                    const codeBlocks = tempDiv.querySelectorAll('pre code');
                    let processedText = tempDiv.innerHTML;
                    codeBlocks.forEach(code => {
                        const codeText = code.textContent;
                        const pre = code.closest('pre');
                        if (pre) {
                            const placeholder = `___CODE_BLOCK___${codeText}___END_CODE___`;
                            processedText = processedText.replace(pre.outerHTML, placeholder);
                        }
                    });

                    // 重新设置HTML
                    tempDiv.innerHTML = processedText;

                    // 获取纯文本
                    textToCopy = tempDiv.textContent
                        .replace(/___CODE_BLOCK___/g, '\n```\n')
                        .replace(/___END_CODE___/g, '\n```\n')
                        .replace(/\n{3,}/g, '\n\n')  // 移除多余空行
                        .trim();
                }

                await navigator.clipboard.writeText(textToCopy);

                // 临时改变按钮显示
                const originalText = button.innerHTML;
                button.innerHTML = '✓';
                button.style.background = '#4CAF50';
                button.style.color = 'white';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.style.color = '';
                }, 1000);

                showToast('已复制到剪贴板', 'success');
            } catch (err) {
                console.error('复制失败:', err);
                showToast('复制失败', 'error');
            }
        }

        // 标记为最佳回复
        async function markAsGoodResponse(messageDiv, content) {
            console.log('🎯 markAsGoodResponse 被调用', { messageDiv, content: content.substring(0, 50) });

            try {
                // 视觉反馈：添加标记
                const contentDiv = messageDiv.querySelector('.message-content');
                if (!contentDiv) {
                    console.error('❌ 找不到 .message-content');
                    return;
                }

                const existingMark = contentDiv.querySelector('.feedback-mark');
                if (existingMark) {
                    existingMark.remove();
                }

                const markDiv = document.createElement('div');
                markDiv.className = 'feedback-mark good';
                markDiv.innerHTML = '⭐ 最佳回复';
                markDiv.style.cssText = `
                    display: inline-block;
                    padding: 2px 8px;
                    background: linear-gradient(135deg, #fbbf24, #f59e0b);
                    color: white;
                    border-radius: 10px;
                    font-size: 11px;
                    font-weight: 500;
                    margin-left: 8px;
                    box-shadow: 0 2px 6px rgba(251, 191, 36, 0.3);
                    animation: fadeInDown 0.3s;
                `;

                // 添加到操作按钮区域前
                const actionsDiv = contentDiv.querySelector('.message-actions');
                if (actionsDiv) {
                    contentDiv.insertBefore(markDiv, actionsDiv);
                    console.log('✅ 标记已添加');
                }

                console.log('📡 发送反馈到服务器...', { session_id: currentSessionId });

                // 调用后端API存储反馈
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message_content: content,
                        feedback_type: 'good',
                        timestamp: new Date().toISOString()
                    })
                });

                console.log('📡 服务器响应:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('❌ 服务器错误:', errorData);
                    throw new Error('反馈提交失败: ' + (errorData.detail || response.statusText));
                }

                const result = await response.json();
                console.log('✅ 反馈成功:', result);

                showToast('✅ 感谢反馈！这将帮助小乐变得更好', 'success');
            } catch (err) {
                console.error('❌ 标记失败:', err);
                showToast('标记失败: ' + err.message, 'error');
            }
        }

        // 标记为错误回复
        async function markAsBadResponse(messageDiv, content) {
            console.log('🎯 markAsBadResponse 被调用', { messageDiv, content: content.substring(0, 50) });

            try {
                // 视觉反馈：添加标记
                const contentDiv = messageDiv.querySelector('.message-content');
                if (!contentDiv) {
                    console.error('❌ 找不到 .message-content');
                    return;
                }

                const existingMark = contentDiv.querySelector('.feedback-mark');
                if (existingMark) {
                    existingMark.remove();
                }

                const markDiv = document.createElement('div');
                markDiv.className = 'feedback-mark bad';
                markDiv.innerHTML = '❌ 需要改进';
                markDiv.style.cssText = `
                    display: inline-block;
                    padding: 2px 8px;
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    border-radius: 10px;
                    font-size: 11px;
                    font-weight: 500;
                    margin-left: 8px;
                    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
                    animation: fadeInDown 0.3s;
                `;

                // 添加到操作按钮区域前
                const actionsDiv = contentDiv.querySelector('.message-actions');
                if (actionsDiv) {
                    contentDiv.insertBefore(markDiv, actionsDiv);
                    console.log('✅ 标记已添加');
                }

                console.log('📡 发送反馈到服务器...', { session_id: currentSessionId });

                // 调用后端API存储反馈
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message_content: content,
                        feedback_type: 'bad',
                        timestamp: new Date().toISOString()
                    })
                });

                console.log('📡 服务器响应:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('❌ 服务器错误:', errorData);
                    throw new Error('反馈提交失败: ' + (errorData.detail || response.statusText));
                }

                const result = await response.json();
                console.log('✅ 反馈成功:', result);

                showToast('✅ 感谢反馈！小乐会努力改进', 'success');
            } catch (err) {
                console.error('❌ 标记失败:', err);
                showToast('标记失败: ' + err.message, 'error');
            }
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#ff6b6b' : '#667eea'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                animation: slideInRight 0.3s;
                font-size: 14px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ============ 消息操作功能结束 ============


        // 加载会话列表
        async function loadSessions() {
            const container = document.getElementById('sessionsList');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/sessions?limit=20`);
                const data = await response.json();

                if (data.sessions && data.sessions.length > 0) {
                    // 按时间去重：如果多个会话title相同，只显示最新的
                    const uniqueSessions = [];
                    const seenTitles = new Set();

                    for (const session of data.sessions) {
                        if (!seenTitles.has(session.title)) {
                            seenTitles.add(session.title);
                            uniqueSessions.push(session);
                        }
                    }

                    container.innerHTML = uniqueSessions.map(session => `
                        <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}"
                             data-session-id="${session.session_id}"
                             style="cursor: pointer;">
                            <div class="session-title">${session.title}</div>
                            <div class="session-time">
                                创建: ${session.created_at} | 更新: ${session.updated_at}
                            </div>
                            <div class="session-actions">
                                <button class="session-action-btn export-md" 
                                        onclick="exportSession('${session.session_id}', 'markdown'); event.stopPropagation();"
                                        title="导出为Markdown">
                                    📝
                                </button>
                                <button class="session-action-btn export-json" 
                                        onclick="exportSession('${session.session_id}', 'json'); event.stopPropagation();"
                                        title="导出为JSON">
                                    📦
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // 为每个会话项添加事件监听器（更安全的方式）
                    container.querySelectorAll('.session-item').forEach(item => {
                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            const sessionId = this.getAttribute('data-session-id');
                            if (sessionId) {
                                loadSession(sessionId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="loading">还没有会话记录</div>';
                }
            } catch (error) {
                console.error('加载会话失败:', error);
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // ===== 会话导出功能 =====

        /**
         * 导出会话为指定格式
         * @param {string} sessionId - 会话ID
         * @param {string} format - 导出格式 ('markdown' 或 'json')
         */
        async function exportSession(sessionId, format) {
            try {
                console.log(`导出会话 ${sessionId} 为 ${format} 格式`);

                // 获取会话数据
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`获取会话失败: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                const messages = data.messages || [];
                const title = data.title || '未命名会话';
                const createdAt = data.created_at || new Date().toISOString();

                let content, filename, mimeType;

                if (format === 'markdown') {
                    // 生成Markdown格式
                    content = generateMarkdown(title, createdAt, messages);
                    filename = `${sanitizeFilename(title)}_${getTimestamp()}.md`;
                    mimeType = 'text/markdown';
                } else if (format === 'json') {
                    // 生成JSON格式
                    content = JSON.stringify({
                        session_id: sessionId,
                        title: title,
                        created_at: createdAt,
                        exported_at: new Date().toISOString(),
                        message_count: messages.length,
                        messages: messages.map(msg => ({
                            role: msg.role,
                            content: msg.content,
                            timestamp: msg.timestamp || msg.created_at
                        }))
                    }, null, 2);
                    filename = `${sanitizeFilename(title)}_${getTimestamp()}.json`;
                    mimeType = 'application/json';
                } else {
                    throw new Error('不支持的导出格式');
                }

                // 下载文件
                downloadFile(content, filename, mimeType);
                showToast(`✅ 导出成功: ${filename}`, 'success');

            } catch (error) {
                console.error('导出失败:', error);
                showToast(`❌ 导出失败: ${error.message}`, 'error');
            }
        }

        /**
         * 生成Markdown格式的会话内容
         */
        function generateMarkdown(title, createdAt, messages) {
            let md = `# ${title}\n\n`;
            md += `**创建时间**: ${createdAt}\n`;
            md += `**导出时间**: ${new Date().toLocaleString('zh-CN')}\n`;
            md += `**消息数量**: ${messages.length}\n\n`;
            md += `---\n\n`;

            messages.forEach((msg, index) => {
                const role = msg.role === 'user' ? '👤 用户' : '🤖 小乐AI';
                const timestamp = msg.timestamp || msg.created_at || '';

                md += `## ${role}\n\n`;
                if (timestamp) {
                    md += `*${timestamp}*\n\n`;
                }
                md += `${msg.content}\n\n`;

                if (index < messages.length - 1) {
                    md += `---\n\n`;
                }
            });

            return md;
        }

        /**
         * 清理文件名（移除非法字符）
         */
        function sanitizeFilename(name) {
            return name
                .replace(/[<>:"/\\|?*]/g, '') // 移除Windows非法字符
                .replace(/\s+/g, '_')         // 空格替换为下划线
                .substring(0, 50);            // 限制长度
        }

        /**
         * 获取时间戳字符串（用于文件名）
         */
        function getTimestamp() {
            const now = new Date();
            return now.toISOString()
                .replace(/[:.]/g, '-')
                .replace('T', '_')
                .substring(0, 19);
        }

        /**
         * 下载文件到本地
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 加载指定会话
        async function loadSession(sessionId) {
            console.log('正在加载会话:', sessionId);

            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('会话数据:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                currentSessionId = sessionId;
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';

                // 显示会话信息
                const sessionInfo = document.getElementById('sessionInfo');
                const titleSpan = document.getElementById('currentSessionTitle');
                titleSpan.textContent = data.title || '未命名会话';
                sessionInfo.style.display = 'block';

                // 加载历史消息
                const messages = data.messages || data.history || [];
                if (messages.length > 0) {
                    messages.forEach(msg => {
                        // 传递 image_path 参数，历史消息不播放语音
                        addMessage(msg.role, msg.content, null, msg.image_path, false);
                    });
                }

                // 切换到聊天标签页
                switchTab('chat');

                // 更新会话列表的active状态
                document.querySelectorAll('.session-item').forEach(item => {
                    if (item.getAttribute('data-session-id') === sessionId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                console.log('会话加载成功');
            } catch (error) {
                console.error('加载会话失败:', error);
                alert('加载会话失败: ' + error.message);
            }
        }

        // 加载记忆统计
        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_BASE}/memory/stats`);
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                const tags = data.by_tag || {};

                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${data.total}</div>
                        <div class="stat-label">总记忆数</div>
                    </div>
                    ${Object.entries(tags).map(([tag, count]) => `
                        <div class="stat-item">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${tag}</div>
                        </div>
                    `).join('')}
                `;

                loadRecentMemories();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML =
                    `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 加载最近记忆
        async function loadRecentMemories() {
            console.log('📋 loadRecentMemories 函数被调用');
            const container = document.getElementById('memoryList');
            console.log('📦 容器元素:', container);
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                console.log('🌐 发起请求: /memory/recent');
                const response = await fetch(`${API_BASE}/memory/recent?hours=24&limit=20`);
                console.log('📡 响应状态:', response.status);
                const data = await response.json();
                console.log('📊 返回数据:', data);

                // API返回的字段是memory，不是memories
                const memories = data.memory || data.memories || [];
                console.log('📋 解析到的记忆数量:', memories.length);

                if (memories.length > 0) {
                    container.innerHTML = memories.map(mem => `
                        <div class="memory-item" id="memory-${mem.id}">
                            <div class="memory-content" id="content-${mem.id}">${marked.parse(mem.content)}</div>
                            <div class="memory-meta">
                                <span>🏷️ ${mem.tag}</span>
                                <span>🕐 ${mem.timestamp}</span>
                            </div>
                            <div class="memory-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                                <button data-memory-id="${mem.id}" data-memory-tag="${mem.tag}" class="edit-memory-btn"
                                    style="padding: 5px 12px; background: #667eea; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ✏️ 编辑
                                </button>
                                <button data-memory-id="${mem.id}" class="delete-memory-btn"
                                    style="padding: 5px 12px; background: #f56565; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // 添加事件监听器
                    console.log('🔗 [loadRecentMemories] 开始绑定事件监听器...');
                    const editButtons = container.querySelectorAll('.edit-memory-btn');
                    const deleteButtons = container.querySelectorAll('.delete-memory-btn');
                    console.log(`✅ 找到 ${editButtons.length} 个编辑按钮, ${deleteButtons.length} 个删除按钮`);

                    editButtons.forEach(btn => {
                        btn.addEventListener('click', function () {
                            console.log('✏️ 编辑按钮被点击, ID:', this.dataset.memoryId);
                            editMemory(this.dataset.memoryId, this.dataset.memoryTag);
                        });
                    });
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', function () {
                            console.log('🗑️ 删除按钮被点击, ID:', this.dataset.memoryId);
                            deleteMemory(this.dataset.memoryId);
                        });
                    });
                } else {
                    container.innerHTML = '<div class="loading">没有记忆记录</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 搜索记忆（关键词）
        async function searchMemories() {
            const keywords = document.getElementById('searchInput').value.trim();
            if (!keywords) {
                loadRecentMemories();
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">关键词搜索中...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/search?keywords=${encodeURIComponent(keywords)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item" id="memory-${mem.id}">
                            <div class="memory-content" id="content-${mem.id}">${marked.parse(mem.content)}</div>
                            <div class="memory-meta">
                                <span>🏷️ ${mem.tag}</span>
                                <span>🕐 ${mem.timestamp}</span>
                            </div>
                            <div class="memory-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                                <button data-memory-id="${mem.id}" data-memory-tag="${mem.tag}" class="edit-memory-btn"
                                    style="padding: 5px 12px; background: #667eea; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ✏️ 编辑
                                </button>
                                <button data-memory-id="${mem.id}" class="delete-memory-btn"
                                    style="padding: 5px 12px; background: #f56565; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // 添加事件监听器
                    console.log('🔗 [searchMemories] 绑定事件...');
                    setTimeout(() => {
                        const editButtons = container.querySelectorAll('.edit-memory-btn');
                        const deleteButtons = container.querySelectorAll('.delete-memory-btn');
                        console.log(`✅ [搜索] 找到 ${editButtons.length} 个编辑, ${deleteButtons.length} 个删除按钮`);

                        editButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                editMemory(this.dataset.memoryId, this.dataset.memoryTag);
                            });
                        });
                        deleteButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                deleteMemory(this.dataset.memoryId);
                            });
                        });
                    }, 0);
                } else {
                    container.innerHTML = '<div class="loading">没有找到相关记忆</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">搜索失败: ${error.message}</div>`;
            }
        }

        // 语义搜索记忆
        async function semanticSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('请输入查询内容');
                return;
            }

            const container = document.getElementById('memoryList');
            container.innerHTML = '<div class="loading">🧠 语义搜索中...</div>';

            try {
                const response = await fetch(
                    `${API_BASE}/memory/semantic?query=${encodeURIComponent(query)}&limit=20`
                );
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    container.innerHTML = data.memories.map(mem => `
                        <div class="memory-item" id="memory-${mem.id}">
                            <div class="memory-content" id="content-${mem.id}">${marked.parse(mem.content)}</div>
                            <div class="memory-meta">
                                <span>🏷️ ${mem.tag}</span>
                                <span>🕐 ${mem.timestamp}</span>
                                <span>📊 相似度: ${(mem.score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="memory-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                                <button data-memory-id="${mem.id}" data-memory-tag="${mem.tag}" class="edit-memory-btn"
                                    style="padding: 5px 12px; background: #667eea; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ✏️ 编辑
                                </button>
                                <button data-memory-id="${mem.id}" class="delete-memory-btn"
                                    style="padding: 5px 12px; background: #f56565; color: white; 
                                           border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // 添加事件监听器
                    console.log('🔗 [semanticSearch] 绑定事件...');
                    setTimeout(() => {
                        const editButtons = container.querySelectorAll('.edit-memory-btn');
                        const deleteButtons = container.querySelectorAll('.delete-memory-btn');
                        console.log(`✅ [语义] 找到 ${editButtons.length} 个编辑, ${deleteButtons.length} 个删除按钮`);

                        editButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                editMemory(this.dataset.memoryId, this.dataset.memoryTag);
                            });
                        });
                        deleteButtons.forEach(btn => {
                            btn.addEventListener('click', function () {
                                deleteMemory(this.dataset.memoryId);
                            });
                        });
                    }, 0);
                } else {
                    container.innerHTML = '<div class="loading">没有找到相关记忆</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">搜索失败: ${error.message}</div>`;
            }
        }

        // ============ v0.7.0 记忆管理 CRUD 功能 ============

        // 编辑记忆
        async function editMemory(memoryId, currentTag) {
            const contentEl = document.getElementById(`content-${memoryId}`);
            const currentContent = contentEl.textContent;

            // 创建编辑表单
            const newContent = prompt('编辑记忆内容:', currentContent);
            if (newContent === null || newContent.trim() === '') {
                return;  // 用户取消或内容为空
            }

            const newTag = prompt('编辑标签 (facts/image/conversation/schedule等):', currentTag);
            if (newTag === null || newTag.trim() === '') {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/memory/${memoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: newContent.trim(),
                        tag: newTag.trim()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('✅ 记忆更新成功', 'success');
                    // 刷新列表
                    loadRecentMemories();
                } else {
                    showNotification('❌ 更新失败: ' + (data.error || '未知错误'), 'error');
                }

            } catch (error) {
                console.error('编辑记忆失败:', error);
                showNotification('❌ 更新失败: 网络错误', 'error');
            }
        }

        // 删除记忆
        async function deleteMemory(memoryId) {
            console.log('🗑️ deleteMemory 被调用, ID:', memoryId);

            if (!confirm('确定要删除这条记忆吗？此操作不可恢复！')) {
                console.log('⚠️ 用户取消删除');
                return;
            }

            console.log('✅ 用户确认删除');
            console.log('📡 发送删除请求...');

            try {
                const response = await fetch(`${API_BASE}/api/memory/${memoryId}`, {
                    method: 'DELETE'
                });

                console.log('📡 响应状态:', response.status);

                const data = await response.json();
                console.log('📋 响应数据:', data);

                if (data.success) {
                    showNotification('✅ 记忆已删除', 'success');
                    // 从DOM中移除
                    const memoryEl = document.getElementById(`memory-${memoryId}`);
                    if (memoryEl) {
                        memoryEl.style.opacity = '0';
                        setTimeout(() => memoryEl.remove(), 300);
                    }
                } else {
                    showNotification('❌ 删除失败: ' + (data.error || '未知错误'), 'error');
                }

            } catch (error) {
                console.error('删除记忆失败:', error);
                showNotification('❌ 删除失败: 网络错误', 'error');
            }
        }

        // ============ 记忆管理功能结束 ============

        // 自动刷新相关变量
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        // 切换自动刷新
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('refreshStatus');

            if (checkbox.checked) {
                // 启用自动刷新
                loadBehaviorAnalytics();
                lastRefreshTime = Date.now();
                updateRefreshStatus();

                autoRefreshInterval = setInterval(() => {
                    loadBehaviorAnalytics();
                    lastRefreshTime = Date.now();
                    updateRefreshStatus();
                }, 30000); // 30秒

                statusSpan.style.color = '#51cf66';
                console.log('✅ 自动刷新已启用 (30秒)');
            } else {
                // 禁用自动刷新
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = '';
                console.log('⏸️ 自动刷新已禁用');
            }
        }

        // 更新刷新状态
        function updateRefreshStatus() {
            const statusSpan = document.getElementById('refreshStatus');
            if (lastRefreshTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - lastRefreshTime) / 1000);
                statusSpan.textContent = `上次刷新: ${elapsed}秒前`;
            }
        }

        // 定期更新状态显示
        setInterval(() => {
            if (autoRefreshInterval && lastRefreshTime) {
                updateRefreshStatus();
            }
        }, 1000);

        // 加载行为分析数据
        async function loadBehaviorAnalytics() {
            const userId = 'default_user';

            // 加载活跃时间分布
            loadActivityPattern(userId);

            // 加载话题偏好
            loadTopicPreferences(userId);

            // 加载对话统计
            loadBehaviorStats(userId);

            // 加载冲突检测
            loadConflictDetection();

            // 加载主动问答历史
            loadProactiveQA(userId);

            // 加载学习模式
            loadLearningPatterns(userId);
        }

        // 加载活跃时间分布
        async function loadActivityPattern(userId) {
            const container = document.getElementById('activityPattern');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/activity?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">暂无数据</div>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

                // 小时分布
                if (data.hourly_distribution && Object.keys(data.hourly_distribution).length > 0) {
                    html += '<div><strong>📅 活跃时段（小时）</strong><div style="margin-top: 8px;">';
                    const sortedHours = Object.entries(data.hourly_distribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    sortedHours.forEach(([hour, count]) => {
                        html += `<div style="margin: 5px 0;">🕐 ${hour}:00 - ${count}次</div>`;
                    });
                    html += '</div></div>';
                }

                // 星期分布
                if (data.daily_distribution && Object.keys(data.daily_distribution).length > 0) {
                    const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                    html += '<div><strong>📆 活跃星期</strong><div style="margin-top: 8px;">';
                    const sortedDays = Object.entries(data.daily_distribution).sort((a, b) => b[1] - a[1]);
                    sortedDays.forEach(([day, count]) => {
                        html += `<div style="margin: 5px 0;">${weekdays[day] || '周' + day} - ${count}次</div>`;
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html || '<div style="color: #999;">暂无数据</div>';
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 加载话题偏好
        async function loadTopicPreferences(userId) {
            const container = document.getElementById('topicPreferences');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/topics?user_id=${userId}`);
                const data = await response.json();

                if (data.error || !data.top_topics || data.top_topics.length === 0) {
                    container.innerHTML = '<div style="color: #999;">暂无话题数据</div>';
                    return;
                }

                let html = '<div>';
                data.top_topics.slice(0, 10).forEach((item, index) => {
                    const [topic, count] = item;
                    html += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${index + 1}. 🏷️ ${topic}</span>
                            <span style="color: #667eea; font-weight: bold;">${count}次</span>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 加载对话统计
        async function loadBehaviorStats(userId) {
            const container = document.getElementById('behaviorStats');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics/behavior?user_id=${userId}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: #999;">暂无数据</div>';
                    return;
                }

                // 修复：使用 conversation_stats 而不是 stats
                const stats = data.conversation_stats || {};
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_sessions || 0}</div>
                            <div style="color: #999; margin-top: 5px;">总会话数</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_messages || 0}</div>
                            <div style="color: #999; margin-top: 5px;">总消息数</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_messages_per_session || 0}</div>
                            <div style="color: #999; margin-top: 5px;">平均消息/会话</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.avg_message_length || 0}</div>
                            <div style="color: #999; margin-top: 5px;">平均消息长度</div>
                        </div>
                    </div>
                `;

                if (stats.last_session_time) {
                    html += `<div style="margin-top: 15px; text-align: center; color: #666;">
                        最后活跃: ${new Date(stats.last_session_time).toLocaleString('zh-CN')}
                    </div>`;
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 加载冲突检测
        async function loadConflictDetection() {
            const container = document.getElementById('conflictDetection');
            container.innerHTML = '<div class="loading">检测中...</div>';

            try {
                const response = await fetch(`${API_BASE}/memory/conflicts`);
                const data = await response.json();

                if (data.conflicts && data.conflicts.length > 0) {
                    let html = `<div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">
                        ⚠️ 发现 ${data.conflicts.length} 组冲突记忆
                    </div>`;

                    data.conflicts.forEach((conflict, index) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #ff6b6b; border-radius: 5px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">冲突 ${index + 1}: ${conflict.type_cn}</div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    📄 旧值: ${conflict.old_value} - ${conflict.old_memory}
                                </div>
                                <div style="margin: 5px 0; padding: 5px; background: #fff5f5; border-radius: 3px;">
                                    📄 新值: ${conflict.new_value} - ${conflict.new_memory}
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 12px;">
                                    检测时间: ${conflict.conflict_detected_at}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #51cf66; text-align: center;">✅ 没有发现冲突记忆</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">检测失败: ${error.message}</div>`;
            }
        }

        // 加载主动问答历史
        async function loadProactiveQA(userId) {
            const container = document.getElementById('proactiveQA');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/proactive/history?user_id=${userId}&limit=10`);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    let html = `<div style="color: #764ba2; font-weight: bold; margin-bottom: 10px;">
                        💡 共 ${data.total} 条追问记录（显示最近10条）
                    </div>`;

                    data.history.forEach((item, index) => {
                        const confidenceColor = item.confidence >= 70 ? '#51cf66' : item.confidence >= 50 ? '#ffd43b' : '#ff6b6b';
                        const askedBadge = item.followup_asked
                            ? '<span style="background: #51cf66; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">已追问</span>'
                            : '<span style="background: #999; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">待追问</span>';

                        // 待追问的记录显示发送按钮
                        const actionButton = !item.followup_asked
                            ? `<button class="send-followup-btn" data-id="${item.id}" data-text="${item.followup_question.replace(/"/g, '&quot;')}" data-user="${userId}"
                                style="margin-top: 8px; padding: 6px 12px; background: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                📤 发送追问
                               </button>`
                            : '';

                        html += `
                            <div style="margin: 10px 0; padding: 12px; background: white; border-left: 3px solid #764ba2; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold;">记录 ${index + 1}</span>
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        ${askedBadge}
                                        <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                            置信度 ${item.confidence}%
                                        </span>
                                    </div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #f8f4ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">原始问题:</div>
                                    <div>❓ ${item.original_question}</div>
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: #e7f5ff; border-radius: 3px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">建议追问:</div>
                                    <div>💬 ${item.followup_question}</div>
                                </div>
                                <div style="margin-top: 5px; color: #999; font-size: 11px;">
                                    创建时间: ${new Date(item.created_at).toLocaleString('zh-CN')}
                                    ${item.asked_at ? ` | 追问时间: ${new Date(item.asked_at).toLocaleString('zh-CN')}` : ''}
                                </div>
                                ${actionButton}
                            </div>
                        `;
                    });

                    container.innerHTML = html;

                    // 为所有发送按钮添加事件监听器
                    container.querySelectorAll('.send-followup-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            const text = this.getAttribute('data-text');
                            const user = this.getAttribute('data-user');
                            sendFollowupFromHistory(id, text, user);
                        });
                    });
                } else {
                    container.innerHTML = '<div style="color: #999; text-align: center;">暂无追问记录</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 加载学习模式
        async function loadLearningPatterns(userId) {
            const container = document.getElementById('learningPatterns');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                // 并行获取三个API数据
                const [frequentRes, questionsRes, insightsRes] = await Promise.all([
                    fetch(`${API_BASE}/patterns/frequent?user_id=${userId}&limit=10`),
                    fetch(`${API_BASE}/patterns/common_questions?user_id=${userId}&limit=5`),
                    fetch(`${API_BASE}/patterns/insights?user_id=${userId}`)
                ]);

                const frequentData = await frequentRes.json();
                const questionsData = await questionsRes.json();
                const insightsData = await insightsRes.json();

                let html = '';

                // 显示统计概览
                if (insightsData && insightsData.statistics) {
                    const stats = insightsData.statistics;
                    html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.total_patterns || 0}</div>
                        <div style="font-size: 12px; color: #999;">总学习模式</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.frequent_words_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">高频词汇</div>
                    </div>`;
                    html += `<div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.common_questions_count || 0}</div>
                        <div style="font-size: 12px; color: #999;">常见问题</div>
                    </div>`;
                    html += `</div>`;
                }

                // 显示高频词
                if (frequentData.frequent_words && frequentData.frequent_words.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">📝 高频词汇 TOP10</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                    frequentData.frequent_words.forEach(item => {
                        const confidence = item.confidence || 50;
                        const bgColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#3b82f6' : '#6b7280';
                        html += `<span style="background: ${bgColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                            ${item.word} (${item.frequency}次)
                        </span>`;
                    });

                    html += `</div></div>`;
                }

                // 显示常见问题分类
                if (questionsData.common_questions && questionsData.common_questions.length > 0) {
                    html += `<div style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">❓ 常见问题分类</div>`;

                    questionsData.common_questions.forEach(item => {
                        const typeEmoji = {
                            '天气查询': '🌤️',
                            '时间日期': '⏰',
                            '个人信息': '👤',
                            '功能咨询': '🔧',
                            '推荐建议': '💡',
                            '闲聊': '💬'
                        };

                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #10b981; border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${typeEmoji[item.category] || '📌'} ${item.category} 
                                <span style="color: #999; font-size: 12px; font-weight: normal;">(${item.frequency}次)</span>
                            </div>`;

                        if (item.examples && item.examples.length > 0) {
                            html += `<div style="font-size: 12px; color: #666; margin-top: 5px;">`;
                            item.examples.slice(0, 2).forEach(example => {
                                html += `<div style="margin: 3px 0;">• ${example}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                }

                if (!html) {
                    html = '<div style="color: #999; text-align: center;">暂无学习数据，多聊几句让小乐了解你吧~</div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // ============ 工具管理功能 (v0.4.0) ============

        // 加载工具列表
        async function loadTools() {
            const container = document.getElementById('toolsList');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/list?enabled_only=true`);
                const data = await response.json();

                if (!data.tools || data.tools.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">暂无可用工具</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                data.tools.forEach(tool => {
                    const categoryEmoji = {
                        'weather': '🌤️',
                        'system': '💻',
                        'search': '🔍',
                        'file': '📁'
                    };

                    const emoji = categoryEmoji[tool.category] || '🔧';
                    const statusColor = tool.enabled ? '#10b981' : '#9ca3af';
                    const statusText = tool.enabled ? '启用' : '禁用';

                    html += `
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${emoji} ${tool.name}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        ${tool.description}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            📦 ${tool.category}
                                        </span>
                                        <span style="background: ${tool.enabled ? '#d1fae5' : '#f3f4f6'}; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            ● ${statusText}
                                        </span>
                                        ${tool.version ? `<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">v${tool.version}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${tool.parameters && tool.parameters.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">📝 参数:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                        ${tool.parameters.map(p => `
                                            <span style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: #4b5563;">
                                                ${p.name}${p.required ? '*' : ''}: ${p.type}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // 显示工具总数
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `📋 可用工具 <span style="font-size: 12px; color: #999; font-weight: normal;">(共 ${data.tools.length} 个)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 加载工具执行历史
        async function loadToolHistory() {
            const container = document.getElementById('toolHistory');
            const limit = document.getElementById('historyLimit').value;

            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/tools/history?user_id=default_user&limit=${limit}`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">暂无执行历史</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach((record, index) => {
                    const statusColor = record.success ? '#10b981' : '#ef4444';
                    const statusIcon = record.success ? '✅' : '❌';
                    const executionTime = record.execution_time ? record.execution_time.toFixed(3) : 'N/A';

                    // 格式化时间
                    const date = new Date(record.executed_at);
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 16px;">${statusIcon}</span>
                                    <span style="font-weight: bold; color: #333;">${record.tool_name}</span>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 11px; color: #999;">${timeStr}</span>
                                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        ${executionTime}s
                                    </span>
                                </div>
                            </div>
                            
                            ${record.error_message ? `
                                <div style="margin-top: 5px; padding: 8px; background: #fef2f2; border-radius: 5px; font-size: 12px; color: #991b1b;">
                                    ⚠️ ${record.error_message}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // 更新标题显示总数
                const title = container.parentElement.querySelector('h4');
                if (title) {
                    title.innerHTML = `📊 工具执行历史 <span style="font-size: 12px; color: #999; font-weight: normal;">(共 ${data.total} 条)</span>`;
                }

            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // ============ 工具管理功能结束 ============

        // ============ v0.5.0 提醒管理功能 ============

        // 加载提醒列表
        // 全局变量：控制是否显示已过期提醒
        let showExpired = false;

        // ==================== v0.8.0 Phase 3: 文档总结功能 ====================

        // 处理文件上传
        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 文件类型检查
            const allowedTypes = ['.pdf', '.docx', '.txt', '.md'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExt)) {
                showNotification('❌ 不支持的文件类型！仅支持 PDF, DOCX, TXT, MD', 'error');
                return;
            }

            // 文件大小检查 (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('❌ 文件过大！最大支持 10MB', 'error');
                return;
            }

            // 显示上传进度
            const formData = new FormData();
            formData.append('file', file);

            try {
                showNotification('⏳ 上传并分析中...', 'info');

                const response = await fetch(`${API_BASE}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`✅ 文档上传成功！正在生成总结...`, 'success');
                    // 显示总结结果
                    showDocumentSummary(data.document);
                    // 刷新列表
                    loadDocuments();
                } else {
                    showNotification(`❌ ${data.error || '上传失败'}`, 'error');
                }
            } catch (error) {
                console.error('上传文档失败:', error);
                showNotification('❌ 上传失败，请检查网络', 'error');
            }

            // 清空文件输入
            event.target.value = '';
        }

        // 加载文档列表
        async function loadDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const userId = 'default_user';
                const response = await fetch(`${API_BASE}/api/users/${userId}/documents?limit=50`);
                const data = await response.json();

                if (data.success && data.documents.length > 0) {
                    let html = '<div style="display: grid; gap: 15px;">';

                    data.documents.forEach(doc => {
                        const statusColor = {
                            'completed': '#10b981',
                            'processing': '#3b82f6',
                            'failed': '#ef4444',
                            'pending': '#f59e0b'
                        }[doc.status] || '#6b7280';

                        const statusText = {
                            'completed': '✅ 已完成',
                            'processing': '⚡ 处理中',
                            'failed': '❌ 失败',
                            'pending': '⏳ 待处理'
                        }[doc.status] || doc.status;

                        html += `
                            <div style="background: white; padding: 15px; border-radius: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">
                                            📄 ${escapeHtml(doc.original_filename)}
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            ${doc.file_type.toUpperCase()} · ${(doc.file_size / 1024).toFixed(1)} KB · 
                                            ${new Date(doc.created_at).toLocaleString('zh-CN')}
                                        </div>
                                    </div>
                                    <div style="background: ${statusColor}; color: white; padding: 4px 12px; 
                                                border-radius: 12px; font-size: 12px; white-space: nowrap;">
                                        ${statusText}
                                    </div>
                                </div>
                                
                                ${doc.summary ? `
                                    <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin: 10px 0; 
                                                font-size: 13px; color: #374151; line-height: 1.6;">
                                        ${escapeHtml(doc.summary.substring(0, 200))}${doc.summary.length > 200 ? '...' : ''}
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    ${doc.status === 'completed' ? `
                                        <button onclick="viewDocumentSummary(${doc.id})"
                                            style="padding: 6px 12px; background: #667eea; color: white; border: none; 
                                                   border-radius: 6px; cursor: pointer; font-size: 13px;">
                                            🔍 查看详情
                                        </button>
                                        <button onclick="exportDocumentSummary(${doc.id})"
                                            style="padding: 6px 12px; background: #10b981; color: white; border: none; 
                                                   border-radius: 6px; cursor: pointer; font-size: 13px;">
                                            💾 导出
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteDocument(${doc.id})"
                                        style="padding: 6px 12px; background: #ef4444; color: white; border: none; 
                                               border-radius: 6px; cursor: pointer; font-size: 13px;">
                                        🗑️ 删除
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">📭 还没有上传任何文档</div>';
                }
            } catch (error) {
                console.error('加载文档列表失败:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">❌ 加载失败</div>';
            }
        }

        // 查看文档总结详情
        async function viewDocumentSummary(docId) {
            try {
                const response = await fetch(`${API_BASE}/api/documents/${docId}`);
                const data = await response.json();

                console.log('文档详情API响应:', data);

                if (data.success) {
                    showDocumentSummary(data.document);
                } else {
                    console.error('获取文档失败:', data.error);
                    showNotification(`❌ 获取文档失败: ${data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('获取文档失败:', error);
                showNotification(`❌ 获取文档失败: ${error.message}`, 'error');
            }
        }

        // 显示文档总结
        function showDocumentSummary(doc) {
            // key_points 可能是字符串或数组
            let keyPoints = [];
            try {
                if (typeof doc.key_points === 'string') {
                    keyPoints = JSON.parse(doc.key_points);
                } else if (Array.isArray(doc.key_points)) {
                    keyPoints = doc.key_points;
                }
            } catch (e) {
                console.error('解析key_points失败:', e);
            }

            let html = `
                <div style="max-width: 700px;">
                    <h3>📄 ${escapeHtml(doc.original_filename)}</h3>
                    
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                            <div><strong>文件类型:</strong> ${doc.file_type.toUpperCase()}</div>
                            <div><strong>文件大小:</strong> ${(doc.file_size / 1024).toFixed(1)} KB</div>
                            <div><strong>原文长度:</strong> ${doc.content_length || 0} 字</div>
                            <div><strong>总结长度:</strong> ${doc.summary_length || 0} 字</div>
                            <div><strong>分块数:</strong> ${doc.chunk_count || 1}</div>
                            <div><strong>处理时间:</strong> ${doc.processing_time ? doc.processing_time.toFixed(2) + '秒' : 'N/A'}</div>
                        </div>
                    </div>

                    ${keyPoints.length > 0 ? `
                        <div style="margin: 20px 0;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">✨ 关键要点</h4>
                            <ul style="background: #f9fafb; padding: 15px 15px 15px 35px; border-radius: 8px; 
                                       line-height: 1.8; margin: 0;">
                                ${keyPoints.map(point => `<li>${escapeHtml(point)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div style="margin: 20px 0;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">📝 智能总结</h4>
                        <div class="markdown-content" style="background: #f9fafb; padding: 25px 30px; 
                                    border-radius: 8px; line-height: 1.8; color: #374151;">
                            ${marked.parse(doc.summary || '总结生成中...')}
                        </div>
                    </div>
                </div>
            `;

            showCustomNotification('文档总结', html);

            // 为Markdown内容添加样式
            setTimeout(() => {
                const markdownContent = document.querySelector('.custom-notification .markdown-content');
                if (markdownContent) {
                    // 标题样式
                    markdownContent.querySelectorAll('h1, h2, h3, h4').forEach(h => {
                        h.style.color = '#1f2937';
                        h.style.marginTop = '16px';
                        h.style.marginBottom = '8px';
                        h.style.fontWeight = 'bold';
                    });
                    // 列表样式
                    markdownContent.querySelectorAll('ol, ul').forEach(list => {
                        list.style.marginLeft = '20px';
                        list.style.marginTop = '8px';
                        list.style.marginBottom = '8px';
                    });
                    markdownContent.querySelectorAll('li').forEach(li => {
                        li.style.marginBottom = '4px';
                    });
                    // 段落样式
                    markdownContent.querySelectorAll('p').forEach(p => {
                        p.style.marginBottom = '12px';
                    });
                    // 粗体样式
                    markdownContent.querySelectorAll('strong').forEach(strong => {
                        strong.style.color = '#374151';
                        strong.style.fontWeight = '600';
                    });
                }
            }, 100);
        }

        // 导出文档总结
        async function exportDocumentSummary(docId) {
            try {
                window.open(`${API_BASE}/api/documents/${docId}/export?format=md`, '_blank');
                showNotification('✅ 正在下载...', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showNotification('❌ 导出失败', 'error');
            }
        }

        // 删除文档
        async function deleteDocument(docId) {
            if (!confirm('确定要删除这个文档吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/api/documents/${docId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('✅ 文档已删除', 'success');
                    loadDocuments();
                } else {
                    showNotification('❌ 删除失败', 'error');
                }
            } catch (error) {
                console.error('删除文档失败:', error);
                showNotification('❌ 删除失败', 'error');
            }
        }

        // ==================== 提醒管理 ====================

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders?user_id=default_user&enabled_only=false`);
                const data = await response.json();

                if (!data.reminders || data.reminders.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">还没有提醒，点击"创建提醒"来添加！</div>';
                    updateReminderStats(0, 0, 0);
                    return;
                }

                // 统计数据
                let activeCount = 0;
                let disabledCount = 0;
                let triggeredCount = 0;

                data.reminders.forEach(r => {
                    if (r.trigger_count > 0 || r.last_triggered) {
                        triggeredCount++;
                    } else if (r.enabled) {
                        activeCount++;
                    } else {
                        disabledCount++;
                    }
                });

                updateReminderStats(activeCount, disabledCount, triggeredCount);

                // 过滤：根据showExpired决定是否显示已触发的提醒
                let displayReminders;
                if (showExpired) {
                    displayReminders = data.reminders;
                } else {
                    // 只显示未触发的提醒（包括启用和禁用）
                    displayReminders = data.reminders.filter(r => !r.trigger_count && !r.last_triggered);
                }

                if (displayReminders.length === 0) {
                    if (showExpired) {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">没有提醒记录。</div>';
                    } else {
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">没有待触发的提醒。<br><br>点击"👁️ 显示已过期"查看已触发的提醒。</div>';
                    }
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                displayReminders.forEach(reminder => {
                    const priorityColors = {
                        1: { color: '#ef4444', emoji: '🔴', label: '最高' },
                        2: { color: '#f59e0b', emoji: '🟠', label: '高' },
                        3: { color: '#eab308', emoji: '🟡', label: '中' },
                        4: { color: '#10b981', emoji: '🟢', label: '低' },
                        5: { color: '#6b7280', emoji: '⚪', label: '最低' }
                    };

                    const priority = priorityColors[reminder.priority] || priorityColors[3];

                    // 判断是否已触发
                    const isTriggered = reminder.trigger_count > 0 || reminder.last_triggered;
                    const statusColor = isTriggered ? '#9ca3af' : (reminder.enabled ? '#10b981' : '#9ca3af');
                    const statusText = isTriggered ? '已触发' : (reminder.enabled ? '启用' : '禁用');

                    // 已触发的提醒用灰色背景
                    const cardBg = isTriggered ? '#f3f4f6' : 'white';
                    const cardOpacity = isTriggered ? 'opacity: 0.8;' : '';

                    const typeEmoji = {
                        'time': '⏰',
                        'weather': '🌤️',
                        'behavior': '👤',
                        'habit': '🎯'
                    };

                    html += `
                        <div style="background: ${cardBg}; padding: 15px; border-radius: 10px; border-left: 4px solid ${priority.color}; ${cardOpacity}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${priority.emoji} ${reminder.title || '无标题'}
                                        ${isTriggered ? '<span style="font-size: 12px; color: #9ca3af; margin-left: 8px;">📜 已触发</span>' : ''}
                                    </div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                        ${reminder.content}
                                    </div>
                                    ${!isTriggered && reminder.reminder_type === 'time' ? `
                                        <div id="countdown-${reminder.reminder_id}" style="font-size: 13px; color: #667eea; margin-bottom: 8px; font-weight: 500;">
                                            ⏳ 计算中...
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <span style="background: #e0e7ff; color: #4f46e5; padding: 3px 8px; border-radius: 4px;">
                                            ${typeEmoji[reminder.reminder_type] || '📌'} ${reminder.reminder_type}
                                        </span>
                                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 3px 8px; border-radius: 4px;">
                                            ● ${statusText}
                                        </span>
                                        <span style="background: ${priority.color}20; color: ${priority.color}; padding: 3px 8px; border-radius: 4px;">
                                            优先级: ${priority.label}
                                        </span>
                                        ${reminder.repeat ? '<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px;">🔄 重复</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px; margin-left: 10px;">
                                    ${!isTriggered ? `
                                        <button onclick="toggleReminder(${reminder.reminder_id})" 
                                            style="padding: 6px 12px; background: ${reminder.enabled ? '#ef4444' : '#10b981'}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                            ${reminder.enabled ? '禁用' : '启用'}
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteReminder(${reminder.reminder_id})" 
                                        style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        删除
                                    </button>
                                </div>
                            </div>
                            ${reminder.last_triggered ? `
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    上次触发: ${new Date(reminder.last_triggered).toLocaleString('zh-CN')}
                                    ${reminder.trigger_count ? ` | 触发次数: ${reminder.trigger_count}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // 更新所有时间提醒的倒计时
                displayReminders.forEach(reminder => {
                    if (!reminder.last_triggered && !reminder.trigger_count && reminder.reminder_type === 'time') {
                        updateCountdown(reminder.reminder_id, reminder.trigger_condition);
                    }
                });

            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 更新倒计时显示
        function updateCountdown(reminderId, triggerCondition) {
            try {
                const condition = JSON.parse(triggerCondition);
                // 处理时区：如果时间字符串没有时区信息，当作本地时间处理
                let timeStr = condition.datetime;
                if (!timeStr.includes('T') && !timeStr.includes('Z') && !timeStr.includes('+')) {
                    // 格式：YYYY-MM-DD HH:MM:SS，当作本地时间
                    timeStr = timeStr.replace(' ', 'T');
                }
                const targetTime = new Date(timeStr);
                const element = document.getElementById(`countdown-${reminderId}`);

                if (!element) return;

                function update() {
                    const now = new Date();
                    const diff = targetTime - now;

                    if (diff <= 0) {
                        element.innerHTML = '⏰ 即将触发...';
                        element.style.color = '#ef4444';
                        return;
                    }

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    let timeStr = '';
                    if (days > 0) {
                        timeStr = `${days}天${hours}小时`;
                    } else if (hours > 0) {
                        timeStr = `${hours}小时${minutes}分钟`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes}分${seconds}秒`;
                    } else {
                        timeStr = `${seconds}秒`;
                    }

                    element.innerHTML = `⏳ 剩余时间: ${timeStr}`;

                    // 根据剩余时间改变颜色
                    if (diff < 5 * 60 * 1000) {
                        element.style.color = '#ef4444'; // 5分钟内红色
                    } else if (diff < 60 * 60 * 1000) {
                        element.style.color = '#f59e0b'; // 1小时内橙色
                    } else {
                        element.style.color = '#667eea'; // 正常蓝色
                    }
                }

                update();
                // 每秒更新一次
                const intervalId = setInterval(update, 1000);
                // 存储interval ID以便后续清理
                if (!window.countdownIntervals) {
                    window.countdownIntervals = {};
                }
                // 清理旧的interval
                if (window.countdownIntervals[reminderId]) {
                    clearInterval(window.countdownIntervals[reminderId]);
                }
                window.countdownIntervals[reminderId] = intervalId;

            } catch (error) {
                console.error('更新倒计时失败:', error);
            }
        }

        // 更新统计数据
        function updateReminderStats(activeCount, disabledCount, triggeredCount) {
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('disabledCount').textContent = disabledCount;
            document.getElementById('triggeredCount').textContent = triggeredCount;
        }

        // 切换是否显示已过期提醒
        function toggleExpiredReminders() {
            showExpired = !showExpired;
            const btn = document.getElementById('toggleExpiredBtn');
            btn.textContent = showExpired ? '🚫 隐藏已过期' : '👁️ 显示已过期';
            loadReminders();
        }

        // 加载提醒历史
        async function loadReminderHistory() {
            const container = document.getElementById('reminderHistory');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/reminders/history/default_user?limit=20`);
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="color: #999; text-align: center;">暂无历史记录</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';

                data.history.forEach(record => {
                    const typeEmoji = {
                        'time': '⏰',
                        'weather': '🌤️',
                        'behavior': '👤',
                        'habit': '🎯'
                    };

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                ${typeEmoji[record.reminder_type] || '📌'} ${record.title || '无标题'}
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                ${record.content}
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                触发时间: ${new Date(record.triggered_at).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 创建提醒对话框
        function showCreateReminderDialog() {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="reminderDialog">
                    <div style="background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">➕ 创建新提醒</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">标题:</label>
                            <input type="text" id="reminderTitle" placeholder="例如：团队会议" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">内容:</label>
                            <textarea id="reminderContent" placeholder="提醒的详细内容..." rows="3"
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">触发时间:</label>
                            <input type="datetime-local" id="reminderTime" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">优先级:</label>
                            <select id="reminderPriority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="1">🔴 最高</option>
                                <option value="2">🟠 高</option>
                                <option value="3" selected>🟡 中</option>
                                <option value="4">🟢 低</option>
                                <option value="5">⚪ 最低</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button onclick="closeReminderDialog()" 
                                style="padding: 10px 20px; background: #9ca3af; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                取消
                            </button>
                            <button onclick="createReminder()" 
                                style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                创建
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialog);
        }

        function closeReminderDialog() {
            const dialog = document.getElementById('reminderDialog');
            if (dialog) dialog.remove();
        }

        // 创建提醒
        async function createReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const content = document.getElementById('reminderContent').value.trim();
            const time = document.getElementById('reminderTime').value;
            const priority = parseInt(document.getElementById('reminderPriority').value);

            if (!content) {
                alert('请输入提醒内容');
                return;
            }

            if (!time) {
                alert('请选择触发时间');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        reminder_type: 'time',
                        trigger_condition: { datetime: time.replace('T', ' ') + ':00' },
                        title: title || '新提醒',
                        content: content,
                        priority: priority,
                        repeat: false
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeReminderDialog();
                    loadReminders();
                    alert('✅ 提醒创建成功！');
                } else {
                    alert('❌ 创建失败: ' + data.error);
                }
            } catch (error) {
                alert('❌ 创建失败: ' + error.message);
            }
        }

        // 切换提醒状态
        async function toggleReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                } else {
                    alert('操作失败');
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 删除提醒
        async function deleteReminder(reminderId) {
            if (!confirm('确定要删除这条提醒吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadReminders();
                    alert('✅ 删除成功');
                } else {
                    alert('❌ 删除失败');
                }
            } catch (error) {
                alert('❌ 删除失败: ' + error.message);
            }
        }

        // 立即检查提醒
        async function checkReminders() {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'default_user' })
                });

                const data = await response.json();

                if (data.triggered && data.triggered.length > 0) {
                    alert(`✅ 检查完成！触发了 ${data.triggered.length} 条提醒`);
                    loadReminderHistory();
                } else {
                    alert('✅ 检查完成！当前没有需要触发的提醒');
                }
            } catch (error) {
                alert('❌ 检查失败: ' + error.message);
            }
        }

        // ============ 提醒管理功能结束 ============

        // ============ v0.8.0 任务管理功能 ============

        // HTML转义函数，防止XSS攻击
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 加载任务列表
        async function loadTasks() {
            const container = document.getElementById('tasksList');
            container.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const statusFilter = document.getElementById('taskStatusFilter').value;
                const userId = 'default_user'; // 使用默认用户ID

                let url = `${API_BASE}/api/users/${userId}/tasks?limit=50`;
                if (statusFilter) {
                    url += `&status=${statusFilter}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '加载任务失败');
                }

                const tasks = data.tasks || [];

                // 更新统计
                updateTaskStats(tasks);

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="loading">暂无任务</div>';
                    return;
                }

                // 按优先级和状态排序
                tasks.sort((a, b) => {
                    if (a.priority !== b.priority) return b.priority - a.priority;
                    if (a.status !== b.status) {
                        const order = ['in_progress', 'pending', 'waiting', 'failed', 'completed', 'cancelled'];
                        return order.indexOf(a.status) - order.indexOf(b.status);
                    }
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                // 渲染任务卡片
                let html = '<div>';
                tasks.forEach(task => {
                    html += renderTaskCard(task);
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('加载任务失败:', error);
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 渲染任务卡片
        function renderTaskCard(task) {
            const statusMap = {
                'pending': '待处理',
                'in_progress': '执行中',
                'waiting': '等待中',
                'completed': '已完成',
                'failed': '失败',
                'cancelled': '已取消'
            };

            const priorityMap = {
                0: '普通',
                1: '重要',
                2: '紧急'
            };

            const progress = task.total_steps > 0
                ? Math.round((task.current_step / task.total_steps) * 100)
                : 0;

            const statusClass = task.status;
            const statusText = statusMap[task.status] || task.status;
            const priorityClass = `priority-${task.priority}`;
            const priorityText = priorityMap[task.priority] || '普通';

            const createdTime = new Date(task.created_at).toLocaleString('zh-CN');
            const updatedTime = task.updated_at ? new Date(task.updated_at).toLocaleString('zh-CN') : '-';

            return `
                <div class="task-card status-${statusClass}">
                    <div class="task-header">
                        <div style="flex: 1;">
                            <div class="task-title">${escapeHtml(task.title)}</div>
                            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <span class="priority-badge ${priorityClass}">${priorityText}</span>
                            <span class="task-status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>

                    ${task.total_steps > 0 ? `
                    <div class="task-progress">
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="task-progress-text">${task.current_step}/${task.total_steps}</div>
                    </div>
                    ` : ''}

                    <div class="task-meta">
                        <span>📅 创建: ${createdTime}</span>
                        <span>🔄 更新: ${updatedTime}</span>
                        ${task.retry_count > 0 ? `<span>🔁 重试: ${task.retry_count}次</span>` : ''}
                    </div>

                    <div class="task-actions">
                        <button class="task-btn task-btn-primary" onclick="showTaskDetails(${task.id})">📋 详情</button>
                        ${task.status === 'pending' || task.status === 'waiting' ? `
                        <button class="task-btn task-btn-success" onclick="executeTask(${task.id})">▶️ 执行</button>
                        ` : ''}
                        ${task.status === 'in_progress' || task.status === 'waiting' ? `
                        <button class="task-btn task-btn-secondary" onclick="cancelTask(${task.id})">⏸️ 取消</button>
                        ` : ''}
                        ${task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled' ? `
                        <button class="task-btn task-btn-danger" onclick="deleteTask(${task.id})">🗑️ 删除</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 更新任务统计
        function updateTaskStats(tasks) {
            const stats = {
                pending: 0,
                in_progress: 0,
                completed: 0,
                failed: 0
            };

            tasks.forEach(task => {
                if (stats.hasOwnProperty(task.status)) {
                    stats[task.status]++;
                }
            });

            document.getElementById('taskPendingCount').textContent = stats.pending;
            document.getElementById('taskInProgressCount').textContent = stats.in_progress;
            document.getElementById('taskCompletedCount').textContent = stats.completed;
            document.getElementById('taskFailedCount').textContent = stats.failed;
        }

        // 显示任务详情
        async function showTaskDetails(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '获取任务详情失败');
                }

                const task = data.task;
                const steps = data.steps || [];

                let stepsHtml = '';
                if (steps.length > 0) {
                    stepsHtml = '<div style="margin-top: 15px;"><h4>任务步骤:</h4>';
                    steps.forEach((step, index) => {
                        const stepStatus = step.status || 'pending';
                        const stepClass = stepStatus === 'completed' ? 'completed' : (stepStatus === 'failed' ? 'failed' : '');
                        stepsHtml += `
                            <div class="task-step ${stepClass}">
                                <div class="task-step-header">
                                    <span class="task-step-title">${index + 1}. ${escapeHtml(step.description)}</span>
                                    <span class="task-step-status">${stepStatus}</span>
                                </div>
                                ${step.action_type ? `<div style="font-size: 12px; color: #6b7280; margin-top: 5px;">类型: ${step.action_type}</div>` : ''}
                                ${step.error ? `<div style="font-size: 12px; color: #ef4444; margin-top: 5px;">错误: ${escapeHtml(step.error)}</div>` : ''}
                            </div>
                        `;
                    });
                    stepsHtml += '</div>';
                }

                const detailHtml = `
                    <div style="max-width: 600px;">
                        <h3>${escapeHtml(task.title)}</h3>
                        ${task.description ? `<p style="color: #6b7280; margin: 10px 0;">${escapeHtml(task.description)}</p>` : ''}
                        
                        <div style="margin: 15px 0; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                            <div><strong>状态:</strong> ${task.status}</div>
                            <div><strong>优先级:</strong> ${task.priority}</div>
                            <div><strong>进度:</strong> ${task.current_step}/${task.total_steps}</div>
                            <div><strong>创建时间:</strong> ${new Date(task.created_at).toLocaleString('zh-CN')}</div>
                            ${task.started_at ? `<div><strong>开始时间:</strong> ${new Date(task.started_at).toLocaleString('zh-CN')}</div>` : ''}
                            ${task.completed_at ? `<div><strong>完成时间:</strong> ${new Date(task.completed_at).toLocaleString('zh-CN')}</div>` : ''}
                        </div>

                        ${stepsHtml}
                    </div>
                `;

                // 使用现有的通知弹窗显示详情
                showCustomNotification('任务详情', detailHtml);

            } catch (error) {
                console.error('获取任务详情失败:', error);
                showNotification('❌ 获取任务详情失败', 'error');
            }
        }

        // 执行任务
        async function executeTask(taskId) {
            if (!confirm('确定要执行这个任务吗?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        session_id: currentSessionId || ''
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '执行任务失败');
                }

                showNotification('✅ 任务执行成功', 'success');
                loadTasks(); // 刷新列表

            } catch (error) {
                console.error('执行任务失败:', error);
                showNotification(`❌ 执行失败: ${error.message}`, 'error');
            }
        }

        // 取消任务
        async function cancelTask(taskId) {
            if (!confirm('确定要取消这个任务吗?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '取消任务失败');
                }

                showNotification('✅ 任务已取消', 'success');
                loadTasks(); // 刷新列表

            } catch (error) {
                console.error('取消任务失败:', error);
                showNotification(`❌ 取消失败: ${error.message}`, 'error');
            }
        }

        // 删除任务
        async function deleteTask(taskId) {
            if (!confirm('确定要删除这个任务吗? 此操作不可恢复!')) return;

            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '删除任务失败');
                }

                showNotification('✅ 任务已删除', 'success');
                loadTasks(); // 刷新列表

            } catch (error) {
                console.error('删除任务失败:', error);
                showNotification(`❌ 删除失败: ${error.message}`, 'error');
            }
        }

        // 显示创建任务对话框
        function showCreateTaskDialog() {
            const html = `
                <div style="max-width: 500px;">
                    <h3>创建新任务</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">任务标题:</label>
                        <input type="text" id="newTaskTitle" placeholder="输入任务标题" 
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">任务描述:</label>
                        <textarea id="newTaskDesc" placeholder="输入任务描述（可选）" rows="3"
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">优先级:</label>
                        <select id="newTaskPriority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="0">普通</option>
                            <option value="1">重要</option>
                            <option value="2">紧急</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="createTask()" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ✅ 创建
                        </button>
                        <button onclick="closeCustomNotification()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ❌ 取消
                        </button>
                    </div>
                </div>
            `;
            showCustomNotification('创建任务', html);
        }

        // 创建任务
        async function createTask() {
            const title = document.getElementById('newTaskTitle').value.trim();
            const description = document.getElementById('newTaskDesc').value.trim();
            const priority = parseInt(document.getElementById('newTaskPriority').value);

            if (!title) {
                showNotification('❌ 请输入任务标题', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        session_id: currentSessionId || '',
                        title: title,
                        description: description,
                        priority: priority
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '创建任务失败');
                }

                showNotification('✅ 任务创建成功', 'success');
                closeCustomNotification();
                loadTasks(); // 刷新列表

            } catch (error) {
                console.error('创建任务失败:', error);
                showNotification(`❌ 创建失败: ${error.message}`, 'error');
            }
        }

        // 显示自定义通知弹窗
        function showCustomNotification(title, content) {
            // 移除已存在的弹窗
            const existing = document.querySelector('.custom-notification-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.className = 'custom-notification-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--card-bg);
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 8px 24px var(--shadow-heavy);
                max-width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            modal.innerHTML = content;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // 点击overlay关闭
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeCustomNotification();
                }
            });
        }

        // 关闭自定义通知
        function closeCustomNotification() {
            const overlay = document.querySelector('.custom-notification-overlay');
            if (overlay) overlay.remove();
        }

        // ============ v0.8.0 任务管理功能结束 ============

        // ============ v0.7.0 课程表管理功能 ============

        // 课程表数据结构
        let scheduleData = {
            periods: ['第1节', '第2节', '第3节', '第4节', '第5节', '第6节', '第7节'],
            weekdays: ['周一', '周二', '周三', '周四', '周五'],
            courses: {} // {period_day: 'course_name'}
        };

        // 加载课程表
        async function loadSchedule() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">加载中...</td></tr>';

            try {
                const response = await fetch(`${API_BASE}/api/schedule?user_id=default_user`);
                const data = await response.json();

                console.log('📅 课程表API响应:', data);

                if (data.success && data.schedule) {
                    scheduleData = data.schedule;
                    console.log('✅ 课程表加载成功:', scheduleData);
                    console.log('📊 课程数量:', Object.keys(scheduleData.courses).length);
                } else {
                    console.warn('⚠️ API未返回课程表，尝试从记忆解析');
                    // 尝试从记忆中解析课程表
                    await parseScheduleFromMemory();
                }

                // 渲染课程表
                renderSchedule();
                showNotification('✅ 课程表加载成功', 'success');

            } catch (error) {
                console.error('❌ 加载课程表失败:', error);
                // 尝试从记忆中解析
                await parseScheduleFromMemory();
                renderSchedule();
            }
        }

        // 从记忆中解析课程表
        async function parseScheduleFromMemory() {
            try {
                const response = await fetch(`${API_BASE}/memory/search?keywords=课程表`);
                const data = await response.json();

                if (data.memories && data.memories.length > 0) {
                    const scheduleMemory = data.memories[0];
                    const content = scheduleMemory.content;

                    // 解析课程表文本（格式：周一：晨读-科学(5)-...）
                    const lines = content.split('\n');
                    scheduleData.courses = {};

                    lines.forEach(line => {
                        const match = line.match(/^(周[一二三四五])[:：](.*)/);
                        if (match) {
                            const day = match[1];
                            const courses = match[2].split('-');

                            courses.forEach((course, index) => {
                                if (course && course.trim()) {
                                    const key = `${index}_${day}`;
                                    scheduleData.courses[key] = course.trim();
                                }
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('从记忆解析课程表失败:', error);
            }
        }

        // 渲染课程表
        function renderSchedule() {
            const tbody = document.getElementById('scheduleBody');
            let html = '';

            scheduleData.periods.forEach((period, periodIndex) => {
                html += '<tr>';
                html += `<td style="font-weight: bold; background: var(--background);">${period}</td>`;

                scheduleData.weekdays.forEach((day, dayIndex) => {
                    const key = `${periodIndex}_${day}`;
                    const course = scheduleData.courses[key] || '';
                    html += `<td><input type="text" value="${course}" 
                        onchange="updateCourse(${periodIndex}, '${day}', this.value)"
                        placeholder=""
                        style="width: 100%; padding: 8px; border: 1px solid var(--border-color); 
                               border-radius: 4px; background: var(--background); color: var(--text-color);">
                    </td>`;
                });

                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // 更新单个课程
        function updateCourse(periodIndex, day, value) {
            const key = `${periodIndex}_${day}`;
            if (value && value.trim()) {
                scheduleData.courses[key] = value.trim();
            } else {
                delete scheduleData.courses[key];
            }
            console.log('课程已更新:', key, value);
        }

        // 保存课程表
        async function saveSchedule() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'default_user',
                        schedule: scheduleData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('✅ 课程表保存成功', 'success');
                } else {
                    showNotification('❌ 保存失败: ' + (data.error || '未知错误'), 'error');
                }

            } catch (error) {
                console.error('保存课程表失败:', error);
                showNotification('❌ 保存失败: 网络错误', 'error');
            }
        }

        // ============ 课程表管理功能结束 ============

        // ============ WebSocket实时推送 ============
        let ws = null;
        let wsReconnectTimer = null;
        let unreadReminderCount = 0;

        function connectWebSocket() {
            try {
                // 建立WebSocket连接
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('✅ WebSocket已连接');
                    clearTimeout(wsReconnectTimer);

                    // 发送心跳
                    setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send('ping');
                        }
                    }, 30000); // 每30秒发送心跳
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'reminder') {
                            // 收到提醒推送
                            handleReminderPush(message.data);
                        } else if (message.type === 'proactive_chat') {
                            // 收到主动对话推送
                            handleProactiveChatPush(message);
                        } else if (message.type === 'pong') {
                            // 心跳响应
                            console.log('心跳响应');
                        }
                    } catch (error) {
                        console.error('解析WebSocket消息失败:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                };

                ws.onclose = () => {
                    console.log('❌ WebSocket已断开，5秒后重连...');
                    wsReconnectTimer = setTimeout(connectWebSocket, 5000);
                };

            } catch (error) {
                console.error('WebSocket连接失败:', error);
                wsReconnectTimer = setTimeout(connectWebSocket, 5000);
            }
        }

        function handleReminderPush(reminder) {
            console.log('收到提醒推送:', reminder);

            // 播放提示音
            playReminderSound();

            // 增加未读计数
            unreadReminderCount++;
            updateReminderBadge();

            // 显示提醒弹窗
            showReminderNotification(reminder);

            // 如果页面不在前台，发送浏览器通知
            if (document.hidden) {
                sendBrowserNotification(reminder);
            }

            // 刷新提醒列表
            if (document.getElementById('reminders').style.display !== 'none') {
                loadReminders();
            }
        }

        // 播放提醒声音
        function playReminderSound() {
            try {
                // 优先使用音频文件（更可靠）
                const audio = new Audio('/static/sounds/dingdong.mp3');
                audio.volume = 0.8;
                audio.play().then(() => {
                    console.log('✅ 提醒音效播放成功');
                }).catch(e => {
                    console.warn('⚠️ 音频播放失败，尝试Web Audio API:', e);
                    // 回退到Web Audio API
                    playWebAudioTone();
                });
            } catch (error) {
                console.error('❌ 播放音效失败:', error);
                // 回退到Web Audio API
                playWebAudioTone();
            }
        }

        function playWebAudioTone() {
            try {
                // 检查Web Audio API支持
                if (typeof window.AudioContext !== "function" && typeof window.webkitAudioContext !== "function") {
                    console.warn('不支持Web Audio API');
                    return;
                }

                // 创建音频上下文
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // 创建震荡器（生成声音）
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                // 释放资源
                oscillator.onended = () => {
                    audioContext.close();
                };

                // 第二声（双响）
                setTimeout(() => {
                    const audioContext2 = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator2 = audioContext2.createOscillator();
                    const gainNode2 = audioContext2.createGain();

                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext2.destination);

                    oscillator2.type = 'sine';
                    oscillator2.frequency.setValueAtTime(1000, audioContext2.currentTime);

                    gainNode2.gain.setValueAtTime(0, audioContext2.currentTime);
                    gainNode2.gain.linearRampToValueAtTime(0.3, audioContext2.currentTime + 0.1);
                    gainNode2.gain.linearRampToValueAtTime(0, audioContext2.currentTime + 0.5);

                    oscillator2.start(audioContext2.currentTime);
                    oscillator2.stop(audioContext2.currentTime + 0.5);

                    oscillator2.onended = () => {
                        audioContext2.close();
                    };
                }, 200);

            } catch (error) {
                // 回退到音频文件
                const audio = new Audio('/static/sounds/dingdong.mp3');
                audio.volume = 0.8;
                audio.play().catch(e => {
                    console.warn('备用音频播放失败:', e);
                });
                console.error('播放提示音失败:', error);
            }
        }

        function showReminderNotification(reminder) {
            // 创建提醒弹窗
            const notification = document.createElement('div');
            notification.className = 'reminder-notification';
            notification.id = `reminder-notif-${reminder.reminder_id}`;

            const priorityEmoji = { 1: '🔴', 2: '🟠', 3: '🟡', 4: '🟢', 5: '⚪' };
            const emoji = priorityEmoji[reminder.priority] || '🔔';

            notification.innerHTML = `
                <div class="reminder-notification-content">
                    <div class="reminder-notification-header">
                        <span class="reminder-notification-icon">${emoji}</span>
                        <span class="reminder-notification-title">${reminder.title || '提醒'}</span>
                        <button class="reminder-notification-close" onclick="closeReminderNotif(${reminder.reminder_id})">✕</button>
                    </div>
                    <div class="reminder-notification-body">
                        ${reminder.content}
                    </div>
                    <div class="reminder-notification-actions">
                        <button onclick="handleReminderRead(${reminder.reminder_id})">
                            ✅ 已知道
                        </button>
                        <button onclick="handleReminderSnooze(${reminder.reminder_id})">
                            ⏰ 稍后提醒
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 30秒后自动淡出（给用户更多时间查看）
            setTimeout(() => {
                if (document.getElementById(`reminder-notif-${reminder.reminder_id}`)) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 30000);
        }

        // 关闭提醒通知
        function closeReminderNotif(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (notif) {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }
        }

        // 处理"已知道"
        async function handleReminderRead(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;

            // 显示处理中状态
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #10b981;">✅ 已标记为已读</span>';

            // 标记已读
            await markReminderAsRead(reminderId);

            // 刷新提醒列表（如果在提醒页面）
            if (typeof loadReminders === 'function') {
                loadReminders();
            }

            // 1秒后关闭
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        // 处理"稍后提醒"
        async function handleReminderSnooze(reminderId) {
            const notif = document.getElementById(`reminder-notif-${reminderId}`);
            if (!notif) return;

            // 显示处理中状态
            const actionsDiv = notif.querySelector('.reminder-notification-actions');
            const originalHTML = actionsDiv.innerHTML;
            actionsDiv.innerHTML = '<span style="color: #f59e0b;">⏰ 正在延迟...</span>';

            // 执行延迟操作
            await snoozeReminder(reminderId, 5);

            // 显示成功状态
            actionsDiv.innerHTML = '<span style="color: #10b981;">✅ 已延迟5分钟</span>';

            // 1秒后关闭
            setTimeout(() => {
                closeReminderNotif(reminderId);
            }, 1000);
        }

        function sendBrowserNotification(reminder) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(reminder.title || '小乐提醒', {
                    body: reminder.content,
                    icon: '/static/favicon.ico',
                    tag: `reminder-${reminder.reminder_id}`,
                    requireInteraction: false
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        function updateReminderBadge() {
            // 更新提醒数量红点（后续实现）
            console.log(`未读提醒: ${unreadReminderCount}`);
        }

        async function markReminderAsRead(reminderId) {
            // 调用confirm API，写入历史并禁用非重复提醒
            await confirmReminder(reminderId);

            // 更新未读计数
            unreadReminderCount = Math.max(0, unreadReminderCount - 1);
            updateReminderBadge();
        }

        // 确认提醒（写入历史）
        async function confirmReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/confirm`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`✅ 提醒已确认: ${reminderId}`);
                } else {
                    console.error('❌ 确认提醒失败:', data.message);
                }
            } catch (error) {
                console.error('❌ 确认提醒请求失败:', error);
            }
        }

        // 延迟提醒（稍后提醒）
        async function snoozeReminder(reminderId, minutes = 5) {
            try {
                const response = await fetch(`${API_BASE}/api/reminders/${reminderId}/snooze?minutes=${minutes}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`✅ 提醒已延迟 ${minutes} 分钟，新触发时间: ${data.new_trigger_time}`);

                    // 显示提示
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
                    toast.textContent = `⏰ 提醒已延迟 ${minutes} 分钟`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s';
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);

                    // 刷新提醒列表
                    if (document.getElementById('reminders').style.display !== 'none') {
                        loadReminders();
                    }
                } else {
                    console.error('❌ 延迟提醒失败:', data.error);
                }
            } catch (error) {
                console.error('❌ 延迟提醒失败:', error);
            }
        }

        // 请求浏览器通知权限
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('通知权限:', permission);
                });
            }
        }

        // ============ 主动对话处理 ============

        function handleProactiveChatPush(message) {
            console.log('收到主动对话推送:', message);

            // 播放柔和的提示音（不同于提醒的声音）
            playProactiveChatSound();

            // 显示主动对话通知
            showProactiveChatNotification(message);

            // 如果页面不在前台，发送浏览器通知
            if (document.hidden) {
                sendProactiveChatBrowserNotification(message);
            }
        }

        function playProactiveChatSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // 更柔和的音调（600Hz）
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);

                // 渐变音量
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.15);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.error('播放主动对话提示音失败:', error);
            }
        }

        function showProactiveChatNotification(message) {
            // 创建主动对话通知卡片
            const notification = document.createElement('div');
            notification.className = 'proactive-chat-notification';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                max-width: 400px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;

            const reasonEmoji = {
                'pending_question': '🤔',
                'long_inactive': '👋',
                'moderate_inactive': '💭',
                'active_time': '⏰',
                'interesting_topic': '💡'
            };

            const emoji = reasonEmoji[message.reason] || '💬';

            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 32px;">${emoji}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">
                            小乐想和你聊聊～
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
                            ${message.message}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="respondToProactiveChat('${message.reason}')" 
                                style="flex: 1; background: white; color: #667eea; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                💬 去聊天
                            </button>
                            <button onclick="dismissProactiveChat(this)" 
                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                                稍后
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // 10秒后自动消失
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);
        }

        function respondToProactiveChat(reason) {
            // 关闭通知
            const notification = document.querySelector('.proactive-chat-notification');
            if (notification) {
                notification.remove();
            }

            // 切换到聊天标签
            switchTab('chat');

            // 聚焦输入框
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // 可以根据reason预填充一些内容
            // messageInput.textContent = '';
        }

        function dismissProactiveChat(button) {
            const notification = button.closest('.proactive-chat-notification');
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }
        }

        function sendProactiveChatBrowserNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const reasonText = {
                    'pending_question': '关于之前的问题',
                    'long_inactive': '好久不见',
                    'moderate_inactive': '最近还好吗',
                    'active_time': '问候时间',
                    'interesting_topic': '有趣的话题'
                };

                new Notification('小乐想和你聊聊', {
                    body: message.message,
                    icon: '/static/icon.png',
                    tag: 'proactive-chat',
                    requireInteraction: false
                });
            }
        }

        // 显示追问提示
        function showFollowupSuggestion(followupInfo) {
            // 创建追问提示卡片
            const notification = document.createElement('div');
            notification.className = 'followup-suggestion';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                max-width: 500px;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 18px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(245, 87, 108, 0.4);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
                cursor: pointer;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">🤔</div>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">
                            💡 小乐有个疑问
                        </div>
                        <div style="font-size: 15px; font-weight: 500; line-height: 1.5;">
                            ${followupInfo.followup}
                        </div>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        点击回答
                    </div>
                </div>
            `;

            // 点击发送追问
            notification.onclick = async () => {
                notification.remove();

                // 自动发送追问作为用户消息
                const input = document.getElementById('messageInput');
                input.textContent = followupInfo.followup;

                // 发送消息
                await sendMessageFromDiv();

                // 标记追问已发送
                try {
                    await fetch(`${API_BASE}/proactive/mark_asked/${followupInfo.id}`, {
                        method: 'POST'
                    });
                    // 刷新主动问答列表
                    loadProactiveQA('default_user');
                } catch (error) {
                    console.error('标记追问失败:', error);
                }
            };

            document.body.appendChild(notification);

            // 播放提示音
            playFollowupSound();

            // 8秒后自动消失
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutDown 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
        }

        // 播放追问提示音
        function playFollowupSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;  // 更高音调
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (error) {
                console.error('播放追问提示音失败:', error);
            }
        }

        // 从历史记录发送追问
        async function sendFollowupFromHistory(questionId, followupText, userId) {
            // 自动填充到输入框
            const input = document.getElementById('messageInput');
            input.textContent = followupText;

            // 发送消息
            await sendMessageFromDiv();

            // 标记为已追问
            try {
                await fetch(`${API_BASE}/proactive/mark_asked/${questionId}`, {
                    method: 'POST'
                });
                // 刷新主动问答列表
                setTimeout(() => loadProactiveQA(userId), 1000);
            } catch (error) {
                console.error('标记追问失败:', error);
            }
        }

        // ============ WebSocket功能结束 ============

        // ============ v0.6.0 全局快捷键支持 ============

        // 全局快捷键监听
        document.addEventListener('keydown', (event) => {
            // 检查快捷键是否启用
            const settings = getSettings();
            if (!settings.keyboardShortcuts) {
                return; // 快捷键已禁用，直接返回
            }

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const ctrlKey = isMac ? event.metaKey : event.ctrlKey;

            // 空格键: 在连续对话模式下打断AI说话
            if (event.code === 'Space' && isConversationMode && isSpeaking && !isRecording) {
                // 确保不是在输入框中按空格
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.id !== 'messageInput') {
                    event.preventDefault();
                    console.log('⌨️ 按空格键打断AI');
                    stopSpeaking();
                    // 立即开始录音
                    setTimeout(() => {
                        if (isConversationMode && !isRecording) {
                            toggleBaiduVoiceInput();
                        }
                    }, 100);
                    return;
                }
            }

            // Ctrl+Enter / Cmd+Enter: 发送消息
            if (ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab && currentTab.id === 'chat') {
                    sendMessageFromDiv();
                }
                return;
            }

            // Esc: 清空输入框
            if (event.key === 'Escape') {
                const messageInput = document.getElementById('messageInput');
                if (messageInput && document.activeElement === messageInput) {
                    event.preventDefault();
                    messageInput.textContent = '';
                    messageInput.focus();
                }
                return;
            }

            // Ctrl+K / Cmd+K: 新建对话
            if (ctrlKey && event.key === 'k') {
                event.preventDefault();
                newChat();
                return;
            }

            // Ctrl+/ / Cmd+/: 切换到聊天标签
            if (ctrlKey && event.key === '/') {
                event.preventDefault();
                const chatTab = document.querySelector('[onclick*="chat"]');
                if (chatTab) {
                    chatTab.click();
                }
                return;
            }

            // Ctrl+1-6 / Cmd+1-6: 快速切换标签
            if (ctrlKey && event.key >= '1' && event.key <= '6') {
                event.preventDefault();
                const tabs = ['chat', 'sessions', 'memory', 'analytics', 'reminders', 'tools'];
                const tabIndex = parseInt(event.key) - 1;
                if (tabIndex < tabs.length) {
                    const tabButton = document.querySelector(`[onclick*="${tabs[tabIndex]}"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }
                return;
            }
        });

        // 显示快捷键提示（鼠标悬停在输入框时）
        function showShortcutHints() {
            const messageInput = document.getElementById('messageInput');
            const hintsBar = document.getElementById('shortcutHints');
            if (!messageInput || !hintsBar) return;

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const cmdKey = isMac ? '⌘' : 'Ctrl';

            // 更新Mac系统的快捷键显示
            if (isMac) {
                hintsBar.querySelectorAll('kbd').forEach(kbd => {
                    kbd.textContent = kbd.textContent.replace('Ctrl', '⌘');
                });
            }

            // 输入框聚焦时显示提示栏
            messageInput.addEventListener('focus', () => {
                hintsBar.style.opacity = '1';
            });

            // 输入框失焦时隐藏提示栏（延迟隐藏）
            messageInput.addEventListener('blur', () => {
                setTimeout(() => {
                    hintsBar.style.opacity = '0';
                }, 2000);
            });

            // 页面加载后3秒显示提示栏（首次提示）
            setTimeout(() => {
                hintsBar.style.opacity = '1';
                setTimeout(() => {
                    hintsBar.style.opacity = '0';
                }, 3000);
            }, 1000);
        }        // ============ 快捷键功能结束 ============

        // 页面加载时聚焦输入框
        window.onload = () => {
            const messageInput = document.getElementById('messageInput');
            messageInput.focus();

            // 显示快捷键提示
            showShortcutHints();

            // 图片上传事件监听器（额外添加以确保捕获）
            const imageUploadInput = document.getElementById('imageUpload');
            if (imageUploadInput) {
                console.log('✅ 图片上传input已找到，添加事件监听器');
                imageUploadInput.addEventListener('change', (event) => {
                    console.log('🎯 Change event triggered (addEventListener)');
                    handleImageUpload(event);
                });
                imageUploadInput.addEventListener('cancel', () => {
                    console.log('❌ 用户取消了文件选择');
                });
            } else {
                console.error('❌ 未找到图片上传input元素！');
            }

            // Enter发送，Shift+Enter换行
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessageFromDiv();
                }
            });

            // 搜索框回车搜索
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchMemories();
                    }
                });
            }

            // 建立WebSocket连接
            connectWebSocket();

            // 请求浏览器通知权限
            requestNotificationPermission();

            // 预加载音频（激活音频权限）
            const preloadAudio = new Audio('/static/sounds/dingdong.mp3');
            preloadAudio.volume = 0.01; // 极小音量
            // 在用户第一次点击页面时播放（激活权限）
            document.addEventListener('click', function initAudio() {
                preloadAudio.play().then(() => {
                    console.log('✅ 音频权限已激活');
                    preloadAudio.pause();
                    preloadAudio.currentTime = 0;
                }).catch(e => {
                    console.warn('音频权限激活失败:', e);
                });
                // 只执行一次
                document.removeEventListener('click', initAudio);
            }, { once: true });
        };

        // ========================================
        // v0.6.0 Phase 4: 图片上传和识别功能
        // ========================================
        let uploadedImagePath = null;

        /**
         * 显示通知消息
         */
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);

            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
                ${type === 'success' ? 'background: #10b981; color: white;' : ''}
                ${type === 'error' ? 'background: #ef4444; color: white;' : ''}
                ${type === 'info' ? 'background: #3b82f6; color: white;' : ''}
                ${type === 'warning' ? 'background: #f59e0b; color: white;' : ''}
            `;

            document.body.appendChild(notification);

            // 3秒后自动移除
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        /**
         * 触发图片上传
         */
        function triggerImageUpload() {
            console.log('📷 triggerImageUpload called');
            const uploadInput = document.getElementById('imageUpload');
            console.log('🔍 Upload input element:', uploadInput);
            if (uploadInput) {
                uploadInput.click();
                console.log('✅ Click triggered');
            } else {
                console.error('❌ imageUpload element not found!');
            }
        }

        /**
         * 处理图片上传
         */
        async function handleImageUpload(event) {
            console.log('🔍 handleImageUpload called', event);
            const file = event.target.files[0];
            console.log('📁 Selected file:', file);
            if (!file) {
                console.log('❌ No file selected');
                return;
            }

            // 验证文件类型
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            console.log('🔍 File type:', file.type);
            if (!validTypes.includes(file.type)) {
                console.log('❌ Invalid file type:', file.type);
                showNotification('❌ 不支持的图片格式', 'error');
                return;
            }

            // 验证文件大小 (20MB)
            console.log('📊 File size:', file.size, 'bytes');
            if (file.size > 20 * 1024 * 1024) {
                console.log('❌ File too large:', file.size);
                showNotification('❌ 文件过大（最大20MB）', 'error');
                return;
            }

            // 显示上传中状态
            console.log('📤 Starting upload...');
            showNotification('📤 正在上传图片...', 'info');

            try {
                // 创建FormData
                const formData = new FormData();
                formData.append('file', file);
                console.log('📦 FormData created');

                // 上传图片
                console.log('🚀 Sending request to /api/vision/upload');
                const response = await fetch('/api/vision/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('📡 Response status:', response.status);
                const result = await response.json();
                console.log('📋 Response data:', result);

                if (result.success) {
                    uploadedImagePath = result.file_path;
                    console.log('✅ Upload successful, path:', uploadedImagePath);
                    showNotification('✅ 图片上传成功', 'success');

                    // 显示图片预览
                    console.log('🖼️ Showing image preview');
                    showImagePreview(file, result.file_path);
                } else {
                    console.log('❌ Upload failed:', result.error);
                    showNotification(`❌ 上传失败: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('💥 Upload error:', error);
                showNotification('❌ 上传失败: 网络错误', 'error');
            }
        }

        /**
         * 显示图片预览
         */
        function showImagePreview(file, filePath) {
            console.log('🖼️ showImagePreview called', { file: file.name, filePath });
            const reader = new FileReader();
            reader.onload = (e) => {
                console.log('📖 FileReader loaded');
                // 创建预览容器
                const previewHtml = `
                    <div class="image-preview" id="imagePreview">
                        <div class="image-preview-header">
                            <span>📷 已上传图片</span>
                            <button onclick="removeImagePreview()" class="remove-btn">✕</button>
                        </div>
                        <img src="${e.target.result}" alt="预览图" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        <div class="image-preview-actions">
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                                💡 输入问题后点击发送，或直接发送识别图片内容
                            </div>
                        </div>
                    </div>
                `;

                // 插入到输入框上方
                const inputContainer = document.querySelector('.input-container');
                console.log('🔍 Input container:', inputContainer);
                const existing = document.getElementById('imagePreview');
                if (existing) {
                    console.log('🗑️ Removing existing preview');
                    existing.remove();
                }
                inputContainer.insertAdjacentHTML('beforebegin', previewHtml);
                console.log('✅ Preview inserted');
            };
            reader.onerror = (error) => {
                console.error('❌ FileReader error:', error);
            };
            console.log('📖 Starting FileReader...');
            reader.readAsDataURL(file);
        }

        /**
         * 移除图片预览
         */
        function removeImagePreview() {
            const preview = document.getElementById('imagePreview');
            if (preview) {
                preview.remove();
            }
            uploadedImagePath = null;
            // 重置文件输入
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        /**
         * 在输入框中显示已存在的图片预览（用于编辑消息）
         */
        function showImagePreviewInInput(imagePath) {
            console.log('🖼️ showImagePreviewInInput called', { imagePath });

            // 创建预览容器
            const previewHtml = `
                <div class="image-preview" id="imagePreview">
                    <div class="image-preview-header">
                        <span>📷 原消息图片</span>
                        <button onclick="removeImagePreview()" class="remove-btn">✕</button>
                    </div>
                    <img src="/${imagePath}" alt="预览图" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                    <div class="image-preview-actions">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                            💡 编辑消息时保留原图片
                        </div>
                    </div>
                </div>
            `;

            // 插入到输入框上方
            const inputContainer = document.querySelector('.input-container');
            const existing = document.getElementById('imagePreview');
            if (existing) {
                existing.remove();
            }
            inputContainer.insertAdjacentHTML('beforebegin', previewHtml);

            // 设置上传的图片路径，以便发送时使用
            uploadedImagePath = imagePath;
            console.log('✅ Preview inserted for editing');
        }

        /**
         * 打开图片查看器
         */
        function openImageViewer(imageSrc) {
            const modal = document.getElementById('imageViewerModal');
            const img = document.getElementById('imageViewerImg');
            img.src = imageSrc;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }

        /**
         * 关闭图片查看器
         */
        function closeImageViewer(event) {
            // 只在点击背景或关闭按钮时关闭
            if (event.target.id === 'imageViewerModal' || event.target.classList.contains('image-viewer-close')) {
                const modal = document.getElementById('imageViewerModal');
                modal.classList.remove('active');
                document.body.style.overflow = ''; // 恢复背景滚动
            }
        }

        // 按ESC键关闭图片查看器
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('imageViewerModal');
                if (modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        /**
         * 分析上传的图片
         */
    </script>
</body>

</html>