# 小乐搜索功能问题分析

## 问题描述

用户询问"iPhone 17 Pro Max什么时候发布"时,小乐可能直接用自己的知识回答,而不是调用网络搜索工具。

## 根本原因

### 1. 意图识别不够敏感

**当前代码问题** (`agent.py` 第584-734行):

```python
def _analyze_intent(self, prompt):
    # 快速规则匹配
    quick_match = self._quick_intent_match(prompt)
    
    # 问题: _quick_intent_match 中没有搜索相关的关键词匹配
    # 只匹配了: 时间查询、系统信息等
```

**快速规则匹配缺失**:
- 没有匹配"搜索"、"查一下"、"帮我找"等关键词
- 没有匹配"iPhone 17"、"最新"、"发布"等需要实时信息的词

### 2. AI可能不调用工具

即使有search工具,AI也可能因为以下原因不调用:

1. **AI自认为知道答案** - 虽然知识过时了
2. **意图分析提示词不够明确** - 没有强调"实时信息必须搜索"
3. **工具描述不够清晰** - search工具的使用场景描述不够具体

### 3. 搜索工具描述问题

当前描述 (`tools/search_tool.py`):
```python
self.description = (
    "在互联网上搜索信息。"
    "适用场景：查询实时信息、新闻、百科知识等。"
    "返回搜索结果的标题、摘要和链接。"
)
```

**问题**: 太泛泛,没有明确说明什么情况**必须**使用搜索

## 解决方案

### 方案1: 增强快速规则匹配 ✅ 推荐

在 `_quick_intent_match` 中添加搜索关键词:

```python
# 搜索查询 - 直接模式
search_patterns = [
    '搜索', '查一下', '帮我找', '查找', '搜一下',
    '最新', '发布', 'iphone 17', 'iphone17',
    '新闻', '消息', '资讯', '价格'
]
if any(p in prompt_lower for p in search_patterns):
    # 提取搜索关键词
    query = prompt.strip()
    return {
        "needs_tool": True,
        "tool_name": "search",
        "parameters": {"query": query, "max_results": 5}
    }
```

### 方案2: 改进意图分析提示词

在 `_analyze_intent` 的prompt中强调:

```python
分析规则补充:
8. search工具 - **优先级最高**，以下情况必须使用:
   - 用户明确要求搜索("搜索"、"查一下")
   - 询问最新/实时信息(产品发布、新闻、价格)
   - 询问未来/即将的事件
   - 涉及2024年9月后的信息(AI知识截止日期后)
   
重要: iPhone 17/iPhone 16等新产品信息必须搜索!
```

### 方案3: 改进搜索工具描述

```python
self.description = (
    "网络搜索工具 - **实时信息必用**。"
    "必须使用的场景:"
    "1. 用户明确要求'搜索'、'查找'、'帮我查'"
    "2. 询问最新产品(iPhone 17、iPhone 16等)"
    "3. 询问实时新闻、价格、天气预报外的天气信息"
    "4. 询问2024年9月后的任何事件"
    "5. 不确定答案是否最新时"
    "返回网页搜索结果的标题、摘要和链接。"
)
```

## 为什么这很重要?

DuckDuckGo搜索虽然有延迟,但它能:
- ✅ 获取AI训练数据后的信息
- ✅ 查询实时产品信息
- ✅ 避免AI用过时知识误导用户
- ✅ 提供可验证的信息来源(链接)

**如果不主动调用搜索,网络搜索功能就没有意义!**

## 测试用例

修复后应该能正确触发搜索:
- ✅ "搜索iPhone 17 Pro Max发布时间"
- ✅ "iPhone 17 Pro Max什么时候发布" (包含关键词"17")
- ✅ "查一下最新的Python版本"
- ✅ "帮我找下特斯拉Model Y价格"
- ❌ "什么是Python?" (不需要搜索)
- ❌ "你好" (不需要搜索)
