# 开发对话日志

> 记录与 GitHub Copilot 的重要开发对话和决策  
> 最后更新：2025-11-14

---

## 2025-11-23 - v0.8.1 任务与提醒联动

### 讨论主题

#### 1. 任务删除的数据一致性
**问题**: 用户询问删除任务后，该任务创建的提醒是否会一起删除。
**现状**: 之前版本任务和提醒是独立的，删除任务会残留孤立的提醒。
**解决**:
- **数据库层**: 修改 `reminders` 表，添加 `task_id` 字段，并设置外键约束 `ON DELETE CASCADE`。
- **应用层**:
    - 更新 `ReminderManager.create_reminder` 支持接收 `task_id`。
    - 更新 `ReminderTool` 从参数中提取 `task_id`。
    - 更新 `TaskExecutor` 在调用工具时注入当前任务的 `task_id`。

### 技术决策

#### 级联删除 (Cascade Delete)
选择在数据库层面使用 `ON DELETE CASCADE` 而不是在应用层手动删除，是为了保证数据的一致性和原子性，防止应用层逻辑错误导致的数据残留。

#### 上下文传递
在 `TaskExecutor` 执行步骤时，将 `task_id` 注入到工具调用的 `kwargs` 中，这样工具本身不需要知道任务的具体逻辑，只需要透传参数即可。

### 完成功能清单
- [x] 数据库迁移脚本 (`scripts/add_task_id_to_reminders.py`)
- [x] 提醒表结构变更 (添加 `task_id` FK)
- [x] 任务-提醒关联逻辑实现
- [x] 验证测试 (创建带任务ID的提醒)

---

## 2025-11-14 - v0.8.0 文档整理与版本合并

### 项目维护

#### 1. 文档目录重构
**问题**: docs目录文档过多，版本混杂  
**解决**:
- 创建归档目录结构（archived/v0.5.0, v0.6.0, v0.7.0, issues）
- 移动旧版本文档到对应归档目录
- 移动问题修复文档到issues目录
- 更新INDEX.md索引结构

#### 2. 开发流程规范化
**优化**:
- 明确Git Flow分支策略
- 规范提交信息格式（语义化提交）
- 更新README.md开发流程说明
- 简化自动提交工具文档

#### 3. 版本发布流程
**流程**:
```bash
develop分支开发 → 测试稳定 → 合并到main → 打标签 → 推送
```

### 技术决策

#### 文档归档规则
- 版本计划/完成文档 → archived/vX.X.X/
- 问题修复文档 → archived/issues/
- 保留最新版本发布说明在根目录
- 保留核心配置和测试文档

#### 提交规范
```
feat: ✨ 新功能
fix: 🐛 Bug修复
docs: 📝 文档更新
refactor: ♻️ 代码重构
```

---

## 2025-11-10 - v0.5.0 提醒系统开发

### 讨论主题

#### 1. 聊天中提醒不生效问题
**问题**: 用户在聊天框说"提醒我..."但没有创建提醒  
**原因**: 缺少自动识别提醒意图的工具  
**解决**: 创建 ReminderTool 工具
- 智能时间解析（支持12种格式）
- 自动提取标题和内容
- 集成到 Agent 的工具系统

#### 2. 提醒生命周期讨论
**问题**: 已触发的提醒混在列表中难以区分  
**用户建议**: 合并提醒列表和历史，添加切换按钮  
**实现**:
- 重构界面为单一列表
- 添加"显示已过期"切换按钮
- 实时统计（活跃/已禁用/已触发）
- 视觉区分（已触发=灰色）

#### 3. 稍后提醒功能
**问题**: 点击"稍后提醒"后提醒就消失了  
**解决**:
- 添加 `/api/reminders/{id}/snooze` API
- 延迟时间改为5分钟（用户要求）
- 前端显示确认反馈

#### 4. 提醒声音
**需求**: 给提醒添加声音提示  
**实现**:
- Web Audio API 生成双响"叮咚"
- 正弦波音色（800Hz + 1000Hz）
- 音量渐变，柔和不刺耳

#### 5. 操作反馈优化
**问题**: 点击按钮后弹窗立即消失，用户来不及看清  
**改进**:
- 显示操作确认信息（"✅ 已标记为已读"）
- 延迟1秒后关闭
- 自动消失时间从10秒改为30秒
- 给用户足够时间查看内容

#### 6. 数据持久化讨论
**问题**: 担心关闭 VS Code 或关机后对话丢失  
**澄清**:
- 小乐的对话历史 → PostgreSQL（永久保存）✅
- Copilot Chat 对话 → VS Code 临时内存（不持久化）❌
- 解决方案：通过 Git 提交记录 + 开发日志文档

### 技术决策

#### Tool 系统集成
- Tool 基类不接受 __init__ 参数
- execute 方法签名必须是 `async def execute(self, **kwargs)`
- user_id 需要在 ToolRegistry.execute() 中传递

#### 时间解析支持的格式
```python
"明天下午3点" → 2025-11-11 15:00
"2小时后" → 当前时间 + 2h
"后天早上9点" → 2025-11-12 09:00
"30分钟后" → 当前时间 + 30min
"今天晚上8点" → 2025-11-10 20:00
... 等12种格式
```

#### WebSocket 推送架构
```
客户端连接 → 连接池 → 提醒触发 → 广播 → 所有客户端
     ↓
  自动重连(5秒)
```

### 测试结果

**WebSocket 稳定性测试** ✅
- 基础连接: 通过
- 断线重连: 通过
- 多客户端(5个): 通过
- 消息接收: 通过

### 完成功能清单

- [x] ReminderTool（聊天创建提醒）
- [x] 智能时间解析（12种格式）
- [x] 稍后提醒（5分钟延迟）
- [x] 提醒声音（双响提示）
- [x] 界面重构（合并列表）
- [x] 统计显示（活跃/已禁用/已触发）
- [x] WebSocket 实时推送
- [x] 浏览器原生通知
- [x] 操作反馈优化
- [x] 文档更新（CHANGELOG + v0.5.0文档）
- [x] 稳定性测试脚本

### 待办事项

- [ ] Phase 3: 搜索工具
- [ ] Phase 4: 文件工具
- [ ] Phase 5: 主动对话
- [ ] 天气API集成
- [ ] 长连接稳定性测试

---

## 如何使用本文档

1. **记录重要对话**: 每次与 Copilot 讨论重要功能时更新
2. **记录技术决策**: 为什么这样做，考虑了哪些方案
3. **记录踩过的坑**: 遇到的问题和解决方法
4. **便于回顾**: 下次开发时快速回忆上下文

---

*最后更新: 2025-11-10*
