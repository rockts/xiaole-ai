# 主动问答功能测试指南

## 功能说明

主动问答会自动检测：
1. 用户是否提问
2. AI回答是否不完整
3. 计算置信度
4. 生成追问建议

## 测试步骤

### 方法1: 直接对话测试

在 http://localhost:8000/static/index.html 中测试：

#### 场景1: 回答包含"不知道"（高置信度）

**你说**: "Python的异步编程是什么？"
**期望AI回答**: "我不太清楚具体细节" 或 "不知道"
**期望结果**: 页面底部弹出追问提示，置信度 > 80%

#### 场景2: 回答过短（高置信度）

**你说**: "Docker是什么？"
**期望AI回答**: "容器" （只有2个字）
**期望结果**: 弹出追问，置信度很高（回答少于5个字 +30分）

#### 场景3: 回答包含模糊词（中等置信度）

**你说**: "Go语言怎么样？"
**期望AI回答**: "可能不错，应该挺好的"
**期望结果**: 弹出追问，置信度 50-70%

### 方法2: API测试

```bash
# 1. 查看待追问列表
curl "http://localhost:8000/proactive/pending/你的session_id"

# 2. 查看历史记录（包含置信度）
curl "http://localhost:8000/proactive/history?user_id=default_user&limit=10"

# 3. 分析特定会话
curl "http://localhost:8000/proactive/analyze/你的session_id?user_id=default_user"
```

### 方法3: 数据库检查

```bash
# 查看主动问答记录
psql -h 192.168.88.88 -U xiaole_user -d xiaole_ai -c "
SELECT 
    id, 
    original_question, 
    confidence_score,
    followup_asked,
    created_at
FROM proactive_questions 
ORDER BY created_at DESC 
LIMIT 10;
"
```

## 触发条件详解

### 问题识别（is_question）

满足以下任一条件：
- 包含疑问词：什么、啥、哪、谁、多少、怎么、为什么、如何
- 以语气词结尾：吗、呢、啊
- 包含问号：？

### 不完整回答识别（is_incomplete_answer）

满足以下任一条件：
- 包含标记词：不知道、不清楚、不太确定、不记得、忘了、说不上来、不好说、看情况、再说、以后、可能、大概、应该、或许、也许
- 回答太短：少于5个字

### 置信度计算（0-100%）

基础分：50%
+ 包含不完整标记词：+15%
+ 回答少于5个字：+30%
+ 回答5-10个字：+20%
+ 每个缺失信息点：+5%

示例：
- "不知道" → 基础50% + 标记15% + 超短30% = 95%
- "可能吧" → 基础50% + 标记15% + 超短30% = 95%
- "我不太确定具体是什么" → 基础50% + 标记15% = 65%

## 前端显示

### 追问提示卡片

- 位置：页面底部居中
- 样式：渐变背景，阴影效果
- 内容：原始问题 + 追问建议 + 置信度
- 交互：点击自动发送追问

### 统计面板

右侧"主动问答"标签页显示：
- 待追问记录（灰色标记）
- 已追问记录（绿色标记）
- 置信度标签（颜色编码）
  - 绿色：≥70%
  - 黄色：50-69%
  - 红色：<50%

## 常见问题

### Q1: 为什么没有弹出追问？

**可能原因**:
1. AI回答太完整（没有触发不完整条件）
2. 用户消息不是问句（没有疑问词/问号）
3. 回答虽短但不符合"不完整"特征

**解决方案**: 尝试问开放性问题，并期望AI给出简短回答

### Q2: 如何提高触发率？

在agent.py的提示词中添加：
```python
"如果用户问题很复杂，你可以先简单回答，再询问是否需要详细说明"
```

### Q3: 如何查看置信度？

- 前端：统计面板中每条记录都显示置信度
- API：`/proactive/history` 返回的 `confidence` 字段
- 数据库：`proactive_questions.confidence_score` 字段

## 调试模式

查看agent.py日志：
```bash
tail -f logs/xiaole_ai.log | grep "主动问答"
```

看到以下日志说明功能正常：
```
主动问答分析失败: xxx  # 有错误
ℹ️ 无需存储: xxx  # 没有触发条件
```

## 性能优化

1. **去重机制**: 10分钟内相同问题不重复保存
2. **置信度排序**: 优先显示高置信度问题
3. **自动清理**: 待追问列表限制在5条以内

## 下一步优化建议

v0.6.0可以考虑：
1. 支持多轮追问（追问后继续追问）
2. 学习用户偏好（哪些追问被点击）
3. 智能合并追问（多个相关问题合并）
4. 追问优先级算法（结合用户兴趣度）
