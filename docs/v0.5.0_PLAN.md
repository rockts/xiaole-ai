# v0.5.0 开发规划 - Active Perception层

> 目标：让小乐具备主动感知和响应能力

## 📋 概述

v0.5.0 将实现 Active Perception（主动感知）层，使小乐能够：
- 主动监控和响应环境变化
- 基于记忆的智能提醒
- 主动发起对话
- 定时任务执行

## 🎯 核心功能

### 1. 主动提醒系统 ⭐ 优先级最高

**功能描述**：
- 基于用户记忆和行为模式的智能提醒
- 支持时间触发和事件触发
- 个性化提醒内容

**实现要点**：
```python
# reminders.py
class ReminderManager:
    def create_reminder(self, user_id, trigger_type, content)
    def check_reminders(self)  # 定时检查
    def send_reminder(self, reminder_id)
```

**触发类型**：
- 时间提醒：生日、纪念日、定时任务
- 天气提醒：下雨提醒带伞、温度变化
- 行为提醒：长时间未聊天主动问候
- 习惯提醒：基于用户行为模式

**数据库表**：
```sql
CREATE TABLE reminders (
    reminder_id SERIAL PRIMARY KEY,
    user_id VARCHAR(100),
    trigger_type VARCHAR(50),  -- time, weather, behavior, habit
    trigger_condition JSONB,   -- 触发条件
    content TEXT,              -- 提醒内容
    enabled BOOLEAN DEFAULT true,
    last_triggered TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 定时任务调度器

**功能描述**：
- 支持cron表达式的定时任务
- 后台任务队列
- 任务执行历史

**实现要点**：
```python
# scheduler.py
class TaskScheduler:
    def add_task(self, cron_expr, task_func, params)
    def start(self)  # 启动调度器
    def stop()
```

**任务类型**：
- 定时天气查询
- 定时数据备份
- 定时清理日志
- 定时发送提醒

### 3. 网络搜索工具 🔍

**功能描述**：
- 集成网络搜索API（如DuckDuckGo）
- 搜索结果摘要和整理
- 搜索历史记录

**实现要点**：
```python
# tools/search_tool.py
class SearchTool(Tool):
    async def execute(self, query: str, max_results: int = 5)
```

**API选择**：
- DuckDuckGo API（免费）
- Brave Search API
- Google Custom Search

### 4. 文件操作工具 📁

**功能描述**：
- 读取/写入文件
- 文件搜索
- 文件统计

**安全限制**：
- 只允许操作指定目录
- 文件类型白名单
- 大小限制

**实现要点**：
```python
# tools/file_tool.py
class FileTool(Tool):
    async def read_file(self, path: str)
    async def write_file(self, path: str, content: str)
    async def search_files(self, pattern: str)
```

### 5. 主动对话发起

**功能描述**：
- 基于用户行为模式主动问候
- 重要事件提醒
- 话题推荐

**触发条件**：
- 用户长时间未聊天（如7天）
- 用户生日/纪念日
- 检测到重要天气变化
- 发现感兴趣的话题

## 📊 技术架构

### 后台任务系统
```
APScheduler (定时任务)
    ↓
ReminderManager (提醒管理)
    ↓
NotificationService (通知服务)
    ↓
WebSocket/SSE (推送到前端)
```

### 数据流
```
用户行为 → 行为分析 → 提醒规则匹配 → 创建提醒 → 定时检查 → 发送通知
```

## 🛠️ 技术选型

### 后端依赖
- `APScheduler`: 定时任务调度
- `websockets`: WebSocket支持
- `duckduckgo-search`: 网络搜索（免费）
- `aiofiles`: 异步文件操作

### 前端改动
- 添加通知面板
- WebSocket连接
- 提醒管理界面

## 📅 开发计划

### Phase 1: 主动提醒 (5天) ✅ 已完成
- [x] Day 1: 设计提醒系统架构
- [x] Day 2: 实现ReminderManager
- [x] Day 3: 实现定时检查和触发
- [x] Day 4: 前端提醒面板
- [x] Day 5: 测试和优化

**完成日期**: 2025-11-10  
**额外功能**:
- ✅ WebSocket实时推送
- ✅ 聊天中自动创建提醒（ReminderTool）
- ✅ 智能时间解析（12种格式）
- ✅ 稍后提醒功能（5分钟延迟）
- ✅ 提醒声音（双响提示音）
- ✅ 界面重构（合并列表+切换按钮）
- ✅ 浏览器原生通知

### Phase 2: 定时任务 (3天) ✅ 已完成
- [x] Day 1: 集成APScheduler
- [x] Day 2: 实现任务管理API
- [x] Day 3: 测试和文档

**完成日期**: 2025-11-09  
**已实现**:
- ✅ APScheduler集成
- ✅ 提醒定时检查（每分钟）
- ✅ 后台任务调度

### Phase 3: 搜索工具 (2天) ⏳ 待实现
- [ ] Day 1: 实现搜索工具
- [ ] Day 2: 前端集成和测试

### Phase 4: 文件工具 (2天) ⏳ 待实现
- [ ] Day 1: 实现文件工具（含安全检查）
- [ ] Day 2: 测试和文档

### Phase 5: 主动对话 (3天) ⏳ 待实现
- [ ] Day 1: 设计触发规则
- [ ] Day 2: 实现主动对话逻辑
- [ ] Day 3: WebSocket推送和测试

**总计**: 约15天  
**已完成**: 8天 (Phase 1 + Phase 2)  
**剩余**: 7天

## 🎯 成功标准

1. **提醒功能**: ✅ **已达成**
   - ✅ 支持4种触发类型（时间、天气、行为、习惯）
   - ✅ 提醒准时发送（误差<1分钟）
   - ✅ 用户可管理提醒（增删改查、启用/禁用）
   - ✅ 额外完成：
     * WebSocket实时推送
     * 聊天自动创建提醒
     * 智能时间解析
     * 稍后提醒功能
     * 提醒声音
     * 浏览器通知

2. **定时任务**: ✅ **已达成**
   - ✅ 支持定时调度（APScheduler）
   - ✅ 任务执行稳定可靠
   - ✅ 完整的执行日志

3. **搜索工具**: ⏳ **待实现**
   - ⏳ 搜索结果准确
   - ⏳ 响应时间<3秒
   - ⏳ 结果摘要清晰

4. **文件工具**: ⏳ **待实现**
   - ⏳ 安全限制有效
   - ⏳ 支持常见文件格式
   - ⏳ 错误处理完善

5. **主动对话**: ⏳ **待实现**
   - ⏳ 触发时机合理
   - ⏳ 对话内容自然
   - ⏳ 不会过于频繁打扰

**整体进度**: 40% (2/5)

## 📝 待讨论问题

1. 提醒通知方式: ✅ **已解决**
   - ✅ 采用WebSocket推送
   - ✅ 前端弹窗展示（支持"已知道"和"稍后提醒"）
   - ✅ 集成浏览器通知API

2. 安全考虑: ⏳ **部分解决**
   - ⏳ 文件操作权限控制（待实现）
   - ⏳ 网络搜索内容过滤（待实现）
   - ✅ 定时任务执行（已实现，每分钟检查）

3. 性能优化: ✅ **已优化**
   - ✅ 后台任务对服务器负载影响小（APScheduler单线程）
   - ✅ 提醒检查频率：每分钟
   - ✅ 数据库查询优化（索引、连接池）

---

**开始日期**: 2025-11-09  
**预计完成**: 2025-11-17  
**当前状态**: 开发中 � (Phase 1-2 已完成，Phase 3-5 待实现)
