# 开发日志 (Changelog)

本文件记录 xiaole-ai 项目的详细开发历史。

## 格式说明
- 📝 文档更新
- ✨ 新功能
- 🐛 Bug修复
- 🔧 配置修改
- ♻️ 代码重构
- 🎨 样式优化
- ⚡ 性能优化
- 🔒 安全修复
- 🧪 测试相关

---

## [Unreleased] - develop 分支

### 2025-11-25
#### feat
- ✨ 修复语音功能

- 🎨 优化移动端适配 (ChatView, TopBar, ReminderListPopup)


### 2025-11-24

#### 📱 移动端适配与体验优化
- ✨ 移动端响应式布局：
  - 新增 `SidebarModern` 移动端抽屉模式（左侧滑出、遮罩层点击关闭）
  - 优化 `TopBar` 移动端样式（调整标题输入框宽度、汉堡菜单按钮）
  - 优化 `ChatView` 移动端布局（底部输入框固定、气泡宽度调整、内边距优化）
  - 修复移动端软键盘遮挡问题（`interactive-widget=resizes-content`）
- 🎨 样式优化：
  - 引入 `safe-area-inset-bottom` 适配全面屏手势条
  - 优化消息气泡最大宽度和内边距
  - 确保消息操作栏在移动端始终可见

#### 🐛 Bug修复
- 🐛 修复"僵尸提醒"问题：
  - 提醒确认后通过 WebSocket 广播 `reminder_confirmed` 事件
  - 前端多标签页同步关闭已确认的提醒弹窗，防止重复触发
- 🐛 修复"立马睡觉"幽灵提醒：
  - 清理数据库中异常的持久化提醒数据（ID 77）

### 2025-11-23

#### ✨ 提醒系统增强
- ✨ 提醒工具升级：`ReminderTool` 支持 `list` (查询) 和 `delete` (删除) 操作
- ✨ 任务联动优化：删除任务时自动清除关联的提醒缓存，确保提醒列表实时更新
- 🐛 修复提醒缓存问题：解决任务删除后提醒依然存在的显示问题

### 2025-11-22

#### 🐛 记忆系统修复
- 🐛 修复"幽灵记忆"问题：手动插入的课程表记忆因缺乏向量索引导致无法被语义搜索召回
- ⚡ 优化记忆检索逻辑：`agent.py` 强制检索 `schedule` 标签，确保课程表信息优先召回
- 🐛 修复子女性别/体型记忆丢失问题：优化 `_extract_and_remember` 提示词，增加对"gender"和"body characteristics"的提取权重

#### 🎨 前端体验优化
- 🎨 优化分享卡片关闭按钮：增大尺寸至 56px，提高不透明度，解决移动端点击困难问题
- 🐛 修复分享卡片 Markdown 渲染：引入 `marked` 库，确保预览内容格式正确

#### 🔧 基础设施
- ➕ 添加人脸识别依赖：`face_recognition`, `opencv-python-headless` (为 v0.9.0 视频识别做准备)
- 📝 验证图片记忆机制：确认当前架构支持 `image:` 标签记忆，但需明确触发条件

### 2025-11-15

#### 🎨 前端界面焕新（进行中）
- 🎨 顶部导航透明化并居中会话标题，统一桌面/移动端视觉
- 🎨 侧边栏 + 聊天区重新排布，确保左侧导航右侧对话的主流布局
- 🎨 聊天气泡与头像样式重制，统一删除按钮与交互动画
- 🎨 移动端滚动、间距与输入栏尺寸优化，保证响应式一致性
- ♻️ 抽离布局样式到 `static/css/app.css`，为后续组件化重构打基础
- 🐛 修复 `newChat()` 未自动返回聊天页的问题，创建新会话时同步 URL 状态
- 🐛 对齐删除消息逻辑与最新 DOM 结构，避免按钮失效

### 2025-11-13

#### 🎊 v0.8.0 全部完成 - 智能交互版 ✅

**完成度：100%**
- ✅ Phase 1: 语音交互功能（输入/输出/自动播放）
- ✅ Phase 2: 多轮任务规划（任务拆解/执行引擎）
- ✅ Phase 3: 长文本总结（文档上传/智能总结/导出）

#### ✨ v0.8.0 完整实现 - 智能交互版 🎉

**Phase 1: 语音交互功能** ✅
- ✨ 语音输入增强
  * 支持 Google Web Speech API（需科学上网）
  * 支持百度语音识别（国内推荐）
  * 实时识别结果显示
  * 语音波形动画效果
  * 连续对话模式
- ✨ 语音输出完善
  * 浏览器原生 TTS（免费）
  * 百度语音合成（更自然）
  * 4种音色选择（度小美/度小宇/度逍遥/度丫丫）
  * 语速调节（0.5x - 2.0x）
  * 音量控制（0% - 100%）
- ✨ 自动播放功能
  * AI回复自动朗读开关
  * 播放状态可视化指示器
  * 动态波形播放动画
  * 一键停止播放按钮
- 🐛 Bug修复
  * 修复自动播放开关键名不一致问题
  * 修复播放完成后状态指示器未隐藏
  * 修复百度TTS播放状态同步

**Phase 2: 多轮任务规划** ✅
- ✨ 任务智能识别
  * AI自动识别复杂任务
  * 智能拆解任务步骤
  * 任务依赖关系分析
- ✨ 任务执行引擎
  * 任务队列管理
  * 顺序执行控制
  * 用户确认机制
  * 执行结果反馈
- ✨ 数据库设计
  * tasks表（任务主表）
  * task_steps表（任务步骤）
  * 完整的状态管理
- ✨ 前端任务界面
  * 任务列表展示
  * 任务详情查看
  * 进度实时更新
  * 任务状态标识
- ✨ API接口完善
  * POST /api/tasks - 创建任务
  * GET /api/tasks/{task_id} - 获取任务
  * PUT /api/tasks/{task_id}/status - 更新状态
  * POST /api/tasks/{task_id}/execute - 执行任务
  * POST /api/tasks/{task_id}/cancel - 取消任务
  * DELETE /api/tasks/{task_id} - 删除任务
  * GET /api/tasks/stats/{user_id} - 任务统计

**Phase 3: 长文本总结功能** ✅
- ✨ 文档上传支持
  * 支持 PDF 文件（PyPDF2 + pdfplumber）
  * 支持 Word 文档（python-docx）
  * 支持 TXT 文本（11种编码自动识别）
  * 支持 Markdown 文件
  * 拖拽上传界面
  * 文件大小限制（10MB）
- ✨ 智能总结算法
  * 分块处理（4000字/块）
  * 单块直接总结
  * 多块分级总结（分块总结→合并→再总结）
  * 关键要点提取（5-10个要点）
  * 处理进度显示
- ✨ 数据库设计
  * documents表（20字段）
  * 文件元数据存储
  * 总结内容管理
  * 4个性能索引
- ✨ 前端界面
  * 文档上传区域
  * 文档列表展示（状态/时间/大小）
  * 详情查看弹窗
  * 元数据显示
  * 关键要点列表
  * Markdown格式总结渲染
  * 自动加载优化
- ✨ 导出功能
  * Markdown格式导出
  * 包含文档信息
  * 包含关键要点
  * 包含完整总结
  * 中文文件名支持
- 🐛 Bug修复
  * 修复TXT文件编码识别失败（扩展到11种编码）
  * 修复AI调用参数错误（添加system_prompt）
  * 修复详情查看错误处理
  * 修复Markdown渲染问题
  * 修复导出中文文件名编码
- 🎨 样式优化
  * 智能总结内边距优化（25px 30px）
  * Markdown内容样式增强
  * 标题、列表、段落间距优化

---

### 2025-11-12

#### 🎊 v0.6.0 全部完成 - 智能增强版 ✅

**完成度：100%**
- ✅ Phase 1: 用户体验提升（消息编辑/删除/搜索）
- ✅ Phase 2: 搜索工具优化（代理支持、超时控制）
- ✅ Phase 3: 主动问答优化（去重、冷却时间）
- ✅ Phase 4: 性能优化（数据库索引）

#### ✨ v0.6.0 完整实现 - 智能增强版 🎉

**Phase 1: 用户体验提升** ✅
- ✨ 消息编辑功能
  * 每条用户消息旁添加编辑按钮
  * 点击后内容加载到输入框
  * 显示编辑状态提示条
  * 支持取消编辑操作
- ✨ 消息删除功能
  * 每条用户消息旁添加删除按钮
  * 删除时弹出确认对话框
  * 自动删除对应的AI回复
  * 显示删除成功提示
- ✨ 消息复制功能
  * 一键复制消息到剪贴板
  * 按钮状态反馈（绿色勾号）
- ✨ 消息搜索功能
  * 对话页面顶部添加搜索框
  * 实时搜索历史消息
  * 高亮显示搜索结果
  * 自动滚动到第一个匹配项
  * 显示匹配数量统计

**Phase 2: 搜索工具优化** ✅
- ⚡ 网络搜索优化（v0.6.2）
  * 添加代理支持（从环境变量读取）
  * 优化超时控制（15秒超时）
  * 改进错误处理和重试机制
  * 使用asyncio.wait_for控制超时
- ⚡ 搜索结果改进
  * 将生成器转为列表避免迭代问题
  * 优化三种搜索策略
  * 更详细的日志输出

**Phase 3: 主动问答优化** ✅
- ⚡ 策略优化（v0.6.2）
  * 添加问题去重机制
  * 实现冷却时间（30秒间隔）
  * 使用Jaccard相似度检测重复问题
  * 维护最近10个问题历史
  * 5分钟内相似问题不再追问

**Phase 4: 性能优化** ✅
- ⚡ 数据库索引优化
  * 创建005迁移文件
  * 添加sessions表索引
  * 添加messages role索引
  * 添加memories用户时间索引
  * 添加proactive_questions会话索引
  * 支持schedules表索引（如果存在）
- ⚡ 查询性能提升
  * 使用DO块智能创建索引
  * 检查索引存在性避免重复
  * VACUUM ANALYZE优化统计信息
- 🔧 迁移脚本改进
  * 修复编码问题（UTF-8）
  * 修复DO块解析问题
  * 添加错误容错处理
  * 显示索引统计信息

#### 🎨 前端优化
- 🎨 消息搜索UI
  * 搜索框样式美化
  * 高亮动画效果
  * 清除搜索按钮
  * 结果计数显示
- 🎨 消息操作按钮
  * 悬停显示操作按钮
  * 圆形按钮设计
  * 悬停放大效果
  * 不同颜色区分功能

#### 📝 文档更新
- 📝 更新README v0.6.0状态
  * 标记所有功能为已完成
  * 重新组织功能分类
  * 更新Phase状态
- 📝 创建数据库迁移文档
  * 005_performance_optimization_v0.6.2.sql
  * run_migration_005.py脚本

#### 🧪 测试验证
- ✅ 消息编辑/删除功能测试通过
- ✅ 消息搜索功能测试通过
- ✅ 搜索工具优化测试通过
- ✅ 数据库索引创建成功
- ✅ 主动问答去重测试通过

### 2025-11-11

#### 🐛 Bug修复 (v0.6.0)

**会话导出和显示修复** ✅
- 🐛 修复会话点击后无法显示内容问题
  * API返回字段从 `history` 统一为 `messages`
  * 前端代码兼容新旧字段名
- 🐛 修复会话导出缺少时间戳问题
  * 消息对象增加 `timestamp` 和 `created_at` 字段
  * Markdown导出包含完整时间信息
  * JSON导出包含完整元数据
- 🧪 添加会话加载测试脚本 `test_session_load.py`
- 🧪 添加导出功能测试脚本 `test_export_fix.py`

**搜索功能完善** ✅
- 🐛 修复DuckDuckGo搜索失败问题
  * 升级 ddgs 包到 9.9.0 版本
  * 重写搜索API调用逻辑
  * 移除with语句，改用直接实例化
- ✨ 实现多策略搜索
  * 策略1: 直接搜索原始query
  * 策略2: 简化查询（去除"什么时候"等）
  * 策略3: 英文关键词搜索
- ✨ 增强搜索意图识别
  * 添加实时关键词列表（iphone 17、最新价格等）
  * 快速规则匹配优先于AI分析
  * 详细的调试日志输出
- 🧪 添加改进的搜索测试 `test_improved_search.py`
- 🧪 搜索功能验证通过（找到iPhone 17真实信息）

#### 📝 文档更新
- 📝 创建项目状态总览文档 `docs/PROJECT_STATUS.md`
- 📝 更新CHANGELOG记录最新修复

### 2025-11-10

#### ✨ 新功能 (v0.5.0 开发中)

**Phase 5: 主动对话** ✅
- ✨ 实现 ProactiveChat 类（主动对话逻辑）
- ✨ 4种触发场景（优先级2-5）：
  * 待追问问题（优先级5）
  * 长时间未聊天：7天（优先级4）、3天（优先级3）
  * 用户活跃时间问候（优先级2）
  * 有趣话题讨论（优先级2）
- ✨ 调度器集成（每小时检查一次）
- ✨ WebSocket实时推送主动对话
- ✨ 前端通知卡片（渐变紫色背景）
- ✨ 柔和提示音（600Hz正弦波）
- ✨ 滑入/滑出动画效果
- ✨ 支持快速响应和延迟操作
- ✨ 浏览器原生通知支持
- ✨ 测试脚本

**Phase 3: 搜索工具** ✅
- ✨ 实现 SearchTool 工具类（DuckDuckGo API集成）
- ✨ 添加搜索意图识别规则
- ⚠️ 网络访问受限（待优化）

**Phase 4: 文件工具** ✅
- ✨ 实现 FileTool 工具类（read/write/list/search）
- ✨ 安全限制：路径白名单、文件类型白名单、大小限制
- ✨ 8个测试用例全部通过
- ✨ 5个集成场景测试成功

**提醒系统增强**:
- ✨ 实现聊天中自动创建提醒（ReminderTool）
- ✨ 支持智能时间解析（"明天下午3点"、"2小时后"等12种格式）
- ✨ 添加稍后提醒功能（延迟5分钟）
- ✨ 添加提醒声音（双响"叮咚"提示音）
  
**提醒界面重构**:
- ✨ 合并"提醒列表"和"提醒历史"为单一界面
- ✨ 添加"显示已过期"切换按钮
- ✨ 实时统计：活跃/已禁用/已触发提醒数量
- ✨ 已触发提醒灰色显示，视觉区分明显

**WebSocket实时推送系统**:
- ✨ WebSocket服务端（/ws端点）
- ✨ 提醒触发时实时推送到前端
- ✨ 前端自动重连机制（5秒间隔）
- ✨ 实时提醒弹窗（支持"已知道"和"稍后提醒"）
- ✨ 浏览器原生通知（页面不在前台时）
- ✨ 提醒声音播放（Web Audio API）

#### 🐛 Bug修复
- 🐛 修复工具参数定义错误（字典→ToolParameter列表）
- � 修复semantic_recall返回字典导致unhashable错误
- 🐛 修复主动问答重复记录问题（改为user_id+时间窗口去重）
- 🐛 修复会话去重逻辑（10分钟窗口）
- 🐛 修复Mac/Windows点击会话不跳转问题（onclick→addEventListener）
- 🐛 修复switchTab函数event参数错误
- 🐛 创建清理脚本处理历史重复数据（成功清理47条）

#### �🔧 技术改进
- ♻️ 重构提醒显示逻辑（过滤已触发提醒）
- 🔧 修复Tool系统user_id传递问题
- 🔧 添加API端点：`/api/reminders/{id}/snooze`
- ⚡ 优化提醒列表加载性能
- 🔧 前端会话列表添加去重逻辑（按title）
- 🔧 loadSession添加详细错误处理和日志

#### 🧪 测试
- 🧪 创建WebSocket推送测试脚本
- 🧪 验证提醒创建、触发、延迟功能
- 🧪 SearchTool集成测试
- 🧪 FileTool单元测试和集成测试

#### 📝 文档
- 📝 更新v0.5.0开发计划
- 📝 记录Phase 3-4完成状态
- 📝 记录bug修复详情

### 2025-11-09

#### � Bug修复
- 🐛 修复记忆搜索功能：完善API返回格式和前端交互

#### ✨ 新功能
- ✨ 添加自动提交工具和开发日志系统

#### �🔧 项目初始化
- 创建开发分支 `develop`
- 设置自动提交工具
- 建立开发日志系统

---

## [0.1.0] - 2025-11-09 - 初始版本

### ✨ 核心功能
- **智能对话系统**
  - DeepSeek API 集成
  - 上下文理解和连贯对话
  - 错误重试机制（3次重试，指数退避）

- **记忆管理系统**
  - PostgreSQL 持久化存储
  - 智能记忆提取（区分事实与闲聊）
  - 标签分类（facts/general）
  - 记忆优先级（事实 > 语义 > 时间）
  - 关键词搜索功能

- **对话历史管理**
  - 会话（Session）管理
  - 消息历史记录
  - 上下文窗口控制

- **Web 界面**
  - 响应式设计
  - Markdown 渲染支持
  - 实时对话交互

### 🔧 基础设施
- **数据库**
  - NAS PostgreSQL 9.3.25 远程连接
  - 连接池管理
  - 自动重连机制

- **API 服务**
  - FastAPI 框架
  - CORS 跨域支持
  - 静态文件服务
  - RESTful API 端点

- **错误处理**
  - 装饰器模式的错误处理
  - 详细日志记录
  - 优雅降级

### 📝 文档
- README.md - 项目说明和快速开始
- NAS_POSTGRESQL_SETUP.md - 数据库设置指南
- DEEPSEEK_SETUP.md - DeepSeek API 配置
- CLAUDE_INTEGRATION.md - Claude API 集成文档
- TEST_GUIDE.md - 测试指南

### 🧪 测试
- test_agent.py - Agent 功能测试
- test_api.py - API 端点测试
- test_claude.py - Claude 集成测试
- test_nas_connection.py - 数据库连接测试
- test_retry.py - 重试机制测试

### 🔧 开发工具
- scripts/start.sh - 启动服务脚本
- scripts/setup_nas_postgresql.sh - 数据库设置脚本
- scripts/setup_api_key.sh - API 密钥配置脚本
- .gitignore - Git 忽略规则
- .env.example - 环境变量模板

### 🐛 已知问题修复
- ✅ 修复记忆污染问题（AI 存储对话记录而非事实）
- ✅ 修复记忆优先级问题（改为事实优先）
- ✅ 修复 SSH 推送问题（多账户配置）
- ✅ 清理 43 条错误的对话记录

### ⏳ 待实现功能
- 向量语义搜索（sentence-transformers 依赖问题待解决）
- 天气 API 集成
- 定时提醒功能
- 语音交互（TTS/STT）
- 移动端适配
- 多用户支持

---

## 版本说明

### 版本号规则
遵循语义化版本 (Semantic Versioning 2.0.0)：
- MAJOR.MINOR.PATCH
- MAJOR: 不兼容的 API 修改
- MINOR: 向后兼容的功能性新增
- PATCH: 向后兼容的问题修正

### 分支策略
- `main`: 稳定版本分支，只接受 PR
- `develop`: 开发分支，日常开发在此进行
- `feature/*`: 功能分支
- `hotfix/*`: 紧急修复分支

---

*本日志使用 [Keep a Changelog](https://keepachangelog.com/) 格式*
